{
  "updatedAt": "2025-09-12T04:23:01.000Z",
  "createdAt": "2025-09-07T11:49:31.396Z",
  "id": "Aa0mObAGLoNfAUki",
  "name": "My workflow 11",
  "active": true,
  "isArchived": true,
  "nodes": [
    {
      "parameters": {
        "inputSource": "jsonExample",
        "jsonExample": "{\n  \"date\": null,\n  \n  \"Nama\": null,\n  \"NIK\": null,\n  \"TTL\": null,\n  \"Agama\": null,\n  \"JenisKelamin\": null,\n  \"StatusPerkawinan\": null,\n  \"Pekerjaan\": null,\n  \"Alamat\": null,\n\n  \"Kelurahan/Kampung\": null,\n  \"Kecamatan\": null,\n  \"Kabupaten\": null,\n  \"Provinsi\": null,\n\n  \"WAHA_Trigger_session\": null,\n  \"WAHA_Trigger_payload_from\": null,\n\n  \"LogoURL\": null,\n  \"URL_POST\": null\n}"
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -880,
        160
      ],
      "id": "66a3e4f2-0f5e-479a-99ef-b31646cc0239",
      "name": "Data Input"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://n8n-qz8tp6856ibc.bgxy.sumopod.my.id/webhook/e81bec01-4835-4966-b0b2-2a11835fed44",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "name_file",
              "value": "={{ (Date.now().toString(36) + Math.random().toString(36).slice(2,6)).toUpperCase() }}\n"
            },
            {
              "name": "session_waha",
              "value": "KaweNia"
            },
            {
              "name": "id_waha",
              "value": "={{ $('Data Input').item.json.WAHA_Trigger_payload_from }}"
            },
            {
              "name": "Nama",
              "value": "={{ $('Data Input').item.json.Nama }}"
            },
            {
              "name": "NIK",
              "value": "={{ $('Data Input').item.json.NIK }}"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "=text/html; charset=utf-8",
        "body": "={{ $json.html }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        660,
        160
      ],
      "id": "9fd9d339-dbf0-4ffd-984b-1f7bcf07638b",
      "name": "HTTP Request"
    },
    {
      "parameters": {
        "resource": "Chatting",
        "operation": "Send Text",
        "session": "={{ $('Generate HTML').item.json.query.session_waha }}",
        "chatId": "={{ $('Generate HTML').item.json.query.id_waha }}",
        "text": "=Permohonan Surat Atas Nama {{ $('Generate HTML').item.json.query.Nama }}\nNomor KTP {{ $('Generate HTML').item.json.query.NIK }}\n\nLink Surat\nhttps://distrikwania.com/data/{{ $json.id }}",
        "requestOptions": {}
      },
      "type": "@devlikeapro/n8n-nodes-waha.WAHA",
      "typeVersion": 202502,
      "position": [
        -440,
        560
      ],
      "id": "c9a83860-3883-4252-87f6-c988e2f993f1",
      "name": "Send a text message",
      "credentials": {
        "wahaApi": {
          "id": "uivlaHVGkUY1vyJT",
          "name": "WAHA account"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "e81bec01-4835-4966-b0b2-2a11835fed44",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -880,
        560
      ],
      "id": "d2ace661-6c09-4039-8632-ae79da9af9cf",
      "name": "Generate HTML",
      "webhookId": "e81bec01-4835-4966-b0b2-2a11835fed44"
    },
    {
      "parameters": {
        "jsCode": "/**\n * n8n Code Node ‚Äî Generate Payload Surat (Run Once for Each Item)\n * Input  : $json (object tunggal atau array of object)\n * Output : [{ json: payload }]\n */\n\nconst s = Array.isArray($json) ? ($json[0] ?? {}) : ($json ?? {});\n\n// ---------------- Utils dasar ----------------\nconst has = (o, k) => Object.prototype.hasOwnProperty.call(o ?? {}, k);\nconst val = (k) => {\n  if (!has(s, k)) return null;\n  const v = s[k];\n  if (v === undefined || v === '') return null;\n  return v;\n};\nconst ensureStr = (x, fallback = '-') => {\n  const v = (x ?? '').toString().trim();\n  return v.length ? v : fallback;\n};\n\n// Ubah jadi Title Case\nconst toTitleCase = (str) => {\n  if (!str) return str;\n  return str\n    .toLowerCase()\n    .replace(/\\b\\w/g, (c) => c.toUpperCase());\n};\n\n// Ubah hanya huruf pertama string\nconst capitalizeFirst = (str) => {\n  if (!str) return str;\n  return str.charAt(0).toUpperCase() + str.slice(1);\n};\n\n// ---------------- Kolektor dokumen ----------------\nconst clean = (str) => (str ?? '').toString().normalize('NFKC').trim();\nconst normLabel = (x) =>\n  clean(x).toLowerCase().replace(/\\s+/g, '_').replace(/[^a-z0-9_\\-]/g, '') || 'dokumen';\n\nconst map = new Map();\nif (Array.isArray(s.documents)) {\n  for (const d of s.documents) {\n    const label = normLabel(d?.label);\n    map.set(label, {\n      label,\n      file_id: d?.file_id ?? null,\n      download_url: d?.download_url ?? null,\n      view_url: d?.view_url ?? null,\n    });\n  }\n}\nfor (const [k, v] of Object.entries(s)) {\n  const m = k.match(/^doc[_\\.]?([a-z0-9_\\-]+)[_\\.](file_id|download_url|view_url)$/i);\n  if (!m) continue;\n  const label = normLabel(m[1]);\n  if (!map.has(label)) {\n    map.set(label, { label, file_id: null, download_url: null, view_url: null });\n  }\n  map.get(label)[m[2]] = (v === '' ? null : v);\n}\nconst dokumen = Array.from(map.values());\n\n// ---------------- Alamat/domisili ----------------\nconst kelVal   = ensureStr(val('Kelurahan/Kampung') ?? val('Kelurahan'));\nconst kecVal   = ensureStr(val('Kecamatan'));\nconst kotaKab  = ensureStr(val('Kabupaten') ?? val('Kota'));\nconst provinsi = ensureStr(val('Provinsi') ?? 'Papua Tengah');\n\n// ---------------- Ambil URL_POST dari input ----------------\nconst urlPostIn = val('URL_POST') ?? val('urlpost');\n\n// ---------------- Payload akhir ----------------\nconst payload = {\n  date: val('date') ?? null,\n\n  pemohon: {\n    nama             : toTitleCase(val('Nama')),\n    nik              : val('NIK'),\n    ttl              : toTitleCase(val('TTL')),\n    agama            : toTitleCase(val('Agama')),\n    jenis_kelamin    : toTitleCase(val('JenisKelamin')),\n    status_perkawinan: toTitleCase(val('StatusPerkawinan')),\n    pekerjaan        : toTitleCase(val('Pekerjaan')),\n    alamat           : toTitleCase(val('Alamat')),\n\n    \"kelurahan/kampung\": toTitleCase(kelVal),\n    kecamatan          : toTitleCase(kecVal),\n    kota_kab           : toTitleCase(kotaKab),\n    provinsi           : toTitleCase(provinsi),\n  },\n\n  dokumen,\n\n  WAHA_Trigger_session     : val('WAHA_Trigger_session'),\n  WAHA_Trigger_payload_from: val('WAHA_Trigger_payload_from'),\n  LogoURL                  : val('LogoURL')\n};\n\nif (urlPostIn !== null) {\n  payload.webhook  = urlPostIn; \n}\n\nreturn [{ json: payload }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -660,
        160
      ],
      "id": "4a367f1d-892c-4321-9cae-851d6923d02b",
      "name": "Code"
    },
    {
      "parameters": {
        "operation": "toJson",
        "options": {
          "fileName": "={{ DateTime.now().setZone('Asia/Tokyo').setLocale('id').toFormat('dd_MM_yyyy_HH_mm_ss') + '_' + ($('Data Input').item.json.Nama).trim().replace(/\\s+/g,'-').toUpperCase() + '_' + ($('Data Input').item.json.NIK) }}\n"
        }
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        -440,
        60
      ],
      "id": "842bf36d-4904-486f-aad8-59eae9c9f676",
      "name": "Convert to File"
    },
    {
      "parameters": {
        "jsCode": "/**\n * Generate Payload Surat ‚Äî gabung data form + banyak file Drive\n * Mode   : Run Once for All Items\n * Input  : Kumpulan item: (A) hasil Upload (>=1 item), (B) 1 item berisi body.data (string JSON)\n * Output : 1 item { json: payload }\n */\n\n/* ===================== Utils ===================== */\nconst has     = (o, k) => Object.prototype.hasOwnProperty.call(o ?? {}, k);\nconst clean   = (s) => (s ?? '').toString().normalize('NFKC').trim();\nconst lower   = (s) => clean(s).toLowerCase();\nconst ensure  = (x, f='-') => { const v = clean(x); return v ? v : f; };\n\n/** \n * Normalisasi: jadikan null bila really null/undefined/\"undefined\"/\"null\".\n * (CATATAN: string kosong \"\" juga jadi null. \n * Jika Anda ingin \"\" tetap kosong, pakai varian toNullKeepEmpty di bawah.)\n */\nconst toNull = (x) => {\n  if (x === undefined || x === null) return null;\n  const v = (typeof x === 'string') ? x.trim() : x;\n  if (v === '' || v === 'undefined' || v === 'null') return null;\n  return v;\n};\n\n// // Varian opsional jika ingin \"\" dipertahankan:\n// const toNull = (x) => {\n//   if (x === undefined || x === null) return null;\n//   if (typeof x === 'string') {\n//     const v = x.trim();\n//     if (v === 'undefined' || v === 'null') return null;\n//     return v; // \"\" dipertahankan\n//   }\n//   return x;\n// };\n\nconst baseName = (name) => lower((name || '').replace(/\\.[^./\\\\]+$/, ''));\n\n// Aman parse JSON string (+ decodeURIComponent jika terindikasi urlencoded)\nconst safeParseJSON = (maybeJSON) => {\n  try {\n    if (typeof maybeJSON === 'string') return JSON.parse(maybeJSON);\n    if (typeof maybeJSON === 'object' && maybeJSON !== null) return maybeJSON;\n  } catch {}\n  return {};\n};\n\nconst tryParse = (x) => {\n  if (typeof x === 'string') {\n    let s = x;\n    // jika terlihat urlencoded (mengandung %7B / %5B), coba decodeURIComponent\n    if (/%[0-9A-Fa-f]{2}/.test(x) && (x.includes('%7B') || x.includes('%5B'))) {\n      try { s = decodeURIComponent(x); } catch(e) {}\n    }\n    // parse\n    let obj = safeParseJSON(s);\n    // antisipasi double-stringified\n    if (typeof obj === 'string') obj = safeParseJSON(obj);\n    return obj;\n  }\n  return safeParseJSON(x);\n};\n\n/* ===================== Ambil body.data dari salah satu item ===================== */\nlet rawData = null;\nfor (const it of items) {\n  const s = it.json || {};\n  // umum: Webhook Node ‚Üí it.json.body.data\n  if (s && s.body && s.body.data !== undefined) {\n    rawData = s.body.data;\n    break;\n  }\n  // fallback (kalau Anda kirim sebagai \"data\" langsung)\n  if (s && s.data !== undefined) {\n    rawData = s.data;\n    break;\n  }\n}\n\nlet bodyData = tryParse(rawData);\nif (typeof bodyData !== 'object' || bodyData === null) bodyData = {};\n\n// Jika bodyData berupa array ‚Üí ambil elemen pertamanya sebagai \"head\" objek\nlet bodyArray = null;\nif (Array.isArray(bodyData)) {\n  bodyArray = bodyData;\n  bodyData = bodyData[0] || {};\n}\n\n/* ===================== Kebijakan struktur baru vs lama ===================== */\n// Struktur BARU: field berada di top-level: jenis_surat, pemohon, dokumen, files_info, dll.\n// Struktur LAMA: field utama berada di bodyData.mandatory_data\nlet mdCandidate = bodyData;\nif (bodyData && typeof bodyData.mandatory_data === 'object' && bodyData.mandatory_data !== null) {\n  mdCandidate = bodyData.mandatory_data;\n}\n// Jika mdCandidate masih array (kasus langka), ambil [0]\nif (Array.isArray(mdCandidate)) mdCandidate = mdCandidate[0] || {};\nconst md = (typeof mdCandidate === 'object' && mdCandidate !== null) ? mdCandidate : {};\n\n// Pastikan files_info berupa array ‚Äî cek di beberapa lokasi yang mungkin\nlet filesInfo = [];\nif (Array.isArray(bodyData.files_info)) {\n  filesInfo = bodyData.files_info;\n} else if (Array.isArray(md.files_info)) {\n  filesInfo = md.files_info;\n} else if (bodyArray && Array.isArray(bodyArray[0]?.files_info)) {\n  filesInfo = bodyArray[0].files_info;\n}\n\n/* ===================== Kolektor dokumen ===================== */\nconst map = new Map(); // key unik\n\nconst uniq = (base) => {\n  let k = base || 'lampiran';\n  if (!map.has(k)) return k;\n  let i = 2;\n  while (map.has(`${k}_${i}`)) i++;\n  return `${k}_${i}`;\n};\n\nconst put = (key, obj) => map.set(key, Object.assign(map.get(key) || {}, obj));\n\nconst normKey = (label) => lower(label || 'lampiran')\n  .replace(/\\s+/g,'_')\n  .replace(/[^a-z0-9_\\-]/g,'');\n\nconst add = (label, obj={}) => {\n  const key = uniq(normKey(label || 'lampiran'));\n  put(key, {\n    label: key, file_id:null, download_url:null, view_url:null,\n    name:null, mimeType:null, size:null, iconLink:null, thumbnailLink:null, createdTime:null,\n    ...obj,\n  });\n};\n\n// 1) md.dokumen dari form/editor (bisa kosong)\nif (Array.isArray(md.dokumen)) {\n  for (const d of md.dokumen) {\n    add(d?.label ?? d?.name ?? 'lampiran', {\n      file_id     : toNull(d?.file_id),\n      download_url: toNull(d?.download_url),\n      view_url    : toNull(d?.view_url),\n      name        : toNull(d?.name),\n      mimeType    : toNull(d?.mimeType),\n      size        : (Number.isFinite(+d?.size) ? +d.size : null),\n    });\n  }\n}\n\n// 2) files_info (pre-upload; sumber nama/ukuran sebelum Drive respond)\nfor (const f of (Array.isArray(filesInfo) ? filesInfo : [])) {\n  const key = uniq(baseName(f?.name || 'lampiran'));\n  put(key, {\n    label   : key,\n    name    : toNull(f?.name) ?? null,\n    mimeType: toNull(f?.type) ?? null,\n    size    : (Number.isFinite(+f?.size) ? +f.size : null),\n  });\n}\n\n// Helper: cari entry dokumen yang paling cocok untuk file Drive\nconst findBestSlot = (driveName, driveSize) => {\n  const dBase = baseName(driveName || 'lampiran');\n  let candidateKey = null;\n\n  // a) cocok nama dasar dari files_info / md.dokumen\n  for (const [k, v] of map.entries()) {\n    if (v.name && baseName(v.name) === dBase) { candidateKey = k; break; }\n  }\n  if (candidateKey) return candidateKey;\n\n  // b) cocok label (jika label==nama)\n  for (const [k, v] of map.entries()) {\n    if (v.label && baseName(v.label) === dBase) { candidateKey = k; break; }\n  }\n  if (candidateKey) return candidateKey;\n\n  // c) fallback by size (toleransi ¬±2 KB)\n  if (Number.isFinite(driveSize)) {\n    for (const [k, v] of map.entries()) {\n      if (Number.isFinite(+v.size)) {\n        const diff = Math.abs(+v.size - driveSize);\n        if (diff <= 2048) { candidateKey = k; break; }\n      }\n    }\n  }\n  return candidateKey;\n};\n\n// 3) SEMUA hasil Upload (tiap item = 1 file Drive)\nfor (const it of items) {\n  const s = it.json || {};\n  // deteksi metadata Google Drive/Upload\n  const isDrive = !!(s.id || s.webViewLink || s.webContentLink || s.name || s.originalFilename || s.mimeType);\n  if (!isDrive) continue;\n\n  const dName = s.name || s.originalFilename || 'lampiran';\n  const dSize = Number.isFinite(+s.size) ? +s.size\n              : (s.quotaBytesUsed ? +s.quotaBytesUsed : null);\n\n  let slot = findBestSlot(dName, dSize);\n  if (!slot) {\n    // tidak ketemu pasangan ‚Üí buat entri baru\n    const key = uniq(baseName(dName) || 'lampiran');\n    add(key, { name: dName });\n    slot = key;\n  }\n\n  put(slot, {\n    file_id      : s.id ?? null,\n    download_url : s.webContentLink ?? null,\n    view_url     : s.webViewLink ?? null,\n    name         : s.name ?? s.originalFilename ?? dName,\n    mimeType     : s.mimeType ?? null,\n    size         : dSize ?? null,\n    iconLink     : s.iconLink ?? null,\n    thumbnailLink: s.thumbnailLink ?? null,\n    createdTime  : s.createdTime ?? null,\n  });\n}\n\nconst dokumen = Array.from(map.values());\n\n/* ===================== Normalisasi bidang teks ===================== */\nconst pemohonRaw = md?.pemohon ?? {};\nconst kelurahan  = ensure(toNull(pemohonRaw.kelurahan));\nconst kecamatan  = ensure(toNull(pemohonRaw.kecamatan));\nconst kotaKab    = ensure(toNull(pemohonRaw.kota_kab ?? pemohonRaw.kabupaten));\nconst provinsi   = ensure(toNull(pemohonRaw.provinsi));\n\n// Jika domisili kosong ‚Üí susun dari komponen\nlet domisili = toNull(pemohonRaw.domisili);\nif (!domisili) domisili = `${kelurahan}, ${kecamatan}, ${kotaKab}, ${provinsi}`;\n\n/* ===================== Payload akhir ===================== */\nconst payload = {\n  jenis_surat   : toNull(md?.jenis_surat),\n  nomor_surat   : toNull(md?.nomor_surat),\n  tanggal_surat : toNull(md?.tanggal_surat),\n\n  pemohon: {\n    nama             : toNull(pemohonRaw?.nama),\n    nik              : toNull(pemohonRaw?.nik),\n    ttl              : toNull(pemohonRaw?.ttl),\n    agama            : toNull(pemohonRaw?.agama),\n    jenis_kelamin    : toNull(pemohonRaw?.jenis_kelamin),\n    status_perkawinan: toNull(pemohonRaw?.status_perkawinan),\n    pekerjaan        : toNull(pemohonRaw?.pekerjaan),\n    alamat           : toNull(pemohonRaw?.alamat),\n    kelurahan, kecamatan,\n    kota_kab         : kotaKab,\n    provinsi,\n    domisili,\n  },\n\n  dokumen,\n\n  penandatangan: {\n    nama   : toNull(md?.penandatangan?.nama),\n    nip    : toNull(md?.penandatangan?.nip),\n    jabatan: toNull(md?.penandatangan?.jabatan),\n  },\n\n  operator                 : toNull(md?.operator),\n  ref                      : toNull(md?.ref),\n  WAHA_Trigger_session     : toNull(md?.WAHA_Trigger_session),\n  WAHA_Trigger_payload_from: toNull(md?.WAHA_Trigger_payload_from),\n  LogoURL                  : toNull(md?.LogoURL),\n\n  URL_CREATE     : toNull(md?.URL_CREATE),\n  URL_UPDATE     : toNull(md?.URL_UPDATE),\n  URL_DELETE     : toNull(md?.URL_DELETE),\n  URL_UPLOAD     : toNull(md?.URL_UPLOAD),\n  URL_DELETE_FILE: toNull(md?.URL_DELETE_FILE),\n\n  // Field metadata dari bodyData (string \"undefined\" ‚Üí null)\n  id_user      : toNull((bodyArray ? bodyArray[0]?.id_user : bodyData?.id_user) ?? bodyData?.id_user),\n  url_web_link : toNull((bodyArray ? bodyArray[0]?.url_web_link : bodyData?.url_web_link) ?? bodyData?.url_web_link),\n  action       : toNull((bodyArray ? bodyArray[0]?.action : bodyData?.action) ?? bodyData?.action),\n  timestamp    : toNull((bodyArray ? bodyArray[0]?.timestamp : bodyData?.timestamp) ?? bodyData?.timestamp),\n\n  // Simpan kembali files_info mentah untuk audit (dari data yang Anda kirim)\n  files_info   : filesInfo,\n};\n\n// Opsional log untuk debug di Executions ‚Üí Console\n// console.log('bodyData keys:', Object.keys(bodyData||{}));\n// console.log('filesInfo len :', Array.isArray(filesInfo)?filesInfo.length:'not array');\n// console.log('dokumen len   :', dokumen.length);\n\nreturn [{ json: payload }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        0,
        820
      ],
      "id": "a6bc9ad4-7833-4706-9cef-6214461cdbc8",
      "name": "Code1"
    },
    {
      "parameters": {
        "operation": "toJson",
        "options": {
          "fileName": "={{ DateTime.now().setZone('Asia/Tokyo').setLocale('id').toFormat('dd_MM_yyyy_HH_mm_ss') + '_' + ($json.pemohon.nama).trim().replace(/\\s+/g,'-').toUpperCase() + '_' + ($json.pemohon.nik) }}\n"
        }
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        220,
        820
      ],
      "id": "c904227e-048e-4b9b-ab7f-0d36768db9be",
      "name": "Convert to File1"
    },
    {
      "parameters": {
        "operation": "update",
        "fileId": {
          "__rl": true,
          "value": "={{ $('Code1').item.json.id_user }}",
          "mode": "id"
        },
        "changeFileContent": true,
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        440,
        820
      ],
      "id": "0e22be27-dc5f-44a1-95c1-ec1dc9e766fc",
      "name": "Update file",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "jyiiyKxh6DOyPVt5",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "operation": "fromJson",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        0,
        0
      ],
      "id": "438e0015-b5cd-4ea1-a9ac-2d6530c2df52",
      "name": "Extract from File1"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -220,
        820
      ],
      "id": "3327edb4-5504-407f-b5c1-b152534bcb5e",
      "name": "Merge1"
    },
    {
      "parameters": {
        "inputDataFieldName": "={{ $json.binaryProperty }}",
        "name": "={{ $binary[$json.binaryProperty].fileName }}",
        "driveId": {
          "__rl": true,
          "mode": "list",
          "value": "My Drive"
        },
        "folderId": {
          "__rl": true,
          "value": "1ufqBzk2QQ6MYnMU2cSzG3mqoab-JCP_Z",
          "mode": "list",
          "cachedResultName": "Create Surat Keterangan Tidak Mampu",
          "cachedResultUrl": "https://drive.google.com/drive/folders/1ufqBzk2QQ6MYnMU2cSzG3mqoab-JCP_Z"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        -440,
        900
      ],
      "id": "0557f51b-9205-4f18-90b6-5e2629fefaab",
      "name": "Upload file2",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "jyiiyKxh6DOyPVt5",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Run Once for All Items\nconst out = [];\nfor (const item of items) {\n  const bin = item.binary || {};\n  const keys = Object.keys(bin);\n  if (keys.length === 0) { out.push(item); continue; }\n  for (const k of keys) {\n    out.push({\n      json: { binaryProperty: k },\n      binary: { [k]: bin[k] },\n    });\n  }\n}\nreturn out;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -660,
        900
      ],
      "id": "dcf5e0a1-7a71-4e8b-9807-bc2a8b0efaa7",
      "name": "Code2"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "1ae8a1a1-9f9d-4792-8505-9c84e1d3654b",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -880,
        820
      ],
      "id": "fcebb38c-229d-4d64-be97-011ec41c67cf",
      "name": "Uploud File",
      "webhookId": "1ae8a1a1-9f9d-4792-8505-9c84e1d3654b"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "410be478-05a9-4622-8e8a-9049667cc717",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -880,
        1160
      ],
      "id": "b0824533-c9b8-45f4-85b7-a2536b8c1ed1",
      "name": "Update Data",
      "webhookId": "410be478-05a9-4622-8e8a-9049667cc717"
    },
    {
      "parameters": {
        "jsCode": "/**\n * Generate Payload Surat ‚Äî gabung data form + banyak file Drive\n * Mode   : Run Once for All Items\n * Input  : (A) 1 item Webhook (JSON: object atau array atau string)\n *          (B) 0..N item file Drive (tiap item = 1 file)\n * Output : 1 item { json: payload }\n */\n\n// ---------- Utils ----------\nconst has = (o, k) => Object.prototype.hasOwnProperty.call(o ?? {}, k);\nconst clean  = (s) => (s ?? '').toString().normalize('NFKC').trim();\nconst lower  = (s) => clean(s).toLowerCase();\nconst ensure = (x, f='-') => { const v = clean(x); return v ? v : f; };\nconst valKey = (o, k) => (has(o, k) ? (o[k] === '' ? null : o[k]) : null);\nconst baseName = (name) => lower((name || '').replace(/\\.[^./\\\\]+$/, ''));\n\nlet bodyData = null;\n\n// ---------- Ambil sumber data webhook secara fleksibel ----------\nfor (const it of items) {\n  const s = it.json || {};\n  if (!s) continue;\n\n  // s.body bisa objek/array/string\n  if (s.body !== undefined) {\n    const b = s.body;\n    if (Array.isArray(b)) {\n      if (b.length > 0 && typeof b[0] === 'object') { bodyData = b[0]; break; }\n      if (b.length > 0 && typeof b[0] === 'string') {\n        try { bodyData = JSON.parse(b[0]); break; } catch {}\n      }\n    } else if (typeof b === 'string') {\n      try { bodyData = JSON.parse(b); break; } catch {}\n    } else if (typeof b === 'object' && b) {\n      bodyData = b; break;\n    }\n  }\n\n  // string JSON dari FormData\n  if (s?.body?.data) {\n    try { bodyData = JSON.parse(s.body.data); break; } catch {}\n  }\n\n  // fallback s.data\n  if (s?.data) {\n    if (typeof s.data === 'string') { try { bodyData = JSON.parse(s.data); break; } catch {} }\n    else if (typeof s.data === 'object') { bodyData = s.data; break; }\n  }\n}\n\nif (typeof bodyData !== 'object' || bodyData === null) bodyData = {};\n\n// ---------- Normalisasi mandatory_data vs body langsung ----------\nconst md = (bodyData && (bodyData.mandatory_data !== undefined))\n  ? (Array.isArray(bodyData.mandatory_data)\n      ? (bodyData.mandatory_data[0] ?? {})\n      : (bodyData.mandatory_data ?? {}))\n  : bodyData;\n\n// ---------- Intent & deteksi file drive ----------\nconst intent = (md?.action || bodyData?.action || '').toString().toLowerCase();\nconst isUpdateOnly = intent === 'update_only';\n\n// deteksi ada file Drive pada `items` (bukan dari webhook)\nconst hasDriveFiles = items.some(it => {\n  const s = it.json || {};\n  return !!(s.id || s.webViewLink || s.webContentLink || s.originalFilename || s.name || s.mimeType);\n});\n\n// ---------- files_info hanya dipakai saat upload (bukan update-only) DAN ada file drive ----------\nconst filesInfo = (!isUpdateOnly && hasDriveFiles)\n  ? (Array.isArray(md.files_info)\n      ? md.files_info\n      : (Array.isArray(bodyData.files_info) ? bodyData.files_info : []))\n  : [];\n\n// ---------- Kolektor dokumen ----------\nconst map = new Map(); // key unik\nconst uniq = (base) => {\n  let k = base || 'lampiran';\n  if (!map.has(k)) return k;\n  let i = 2;\n  while (map.has(`${k}_${i}`)) i++;\n  return `${k}_${i}`;\n};\nconst put = (key, obj) => map.set(key, Object.assign(map.get(key) || {}, obj));\nconst add = (label, obj={}) => {\n  const key = uniq(lower(label || 'lampiran').replace(/\\s+/g,'_').replace(/[^a-z0-9_\\-]/g,''));\n  put(key, {\n    label: key, file_id:null, download_url:null, view_url:null,\n    name:null, mimeType:null, size:null, iconLink:null, thumbnailLink:null, createdTime:null,\n    ...obj,\n  });\n};\n\n// 1) dokumen dari payload (jika ada)\nif (Array.isArray(md.dokumen)) {\n  for (const d of md.dokumen) {\n    add(d?.label ?? d?.name ?? 'lampiran', {\n      file_id: d?.file_id ?? null,\n      download_url: d?.download_url ?? null,\n      view_url: d?.view_url ?? null,\n      name: d?.name ?? null,\n      mimeType: d?.mimeType ?? null,\n      size: Number.isFinite(+d?.size) ? +d.size : null,\n      iconLink: d?.iconLink ?? null,\n      thumbnailLink: d?.thumbnailLink ?? null,\n      createdTime: d?.createdTime ?? null,\n    });\n  }\n}\n\n// Helper untuk pencocokan Drive\nconst findBestSlot = (driveName, driveSize) => {\n  const dBase = baseName(driveName);\n  // a) cocok nama yang sudah ada\n  for (const [k, v] of map.entries()) {\n    if ((v.name && baseName(v.name) === dBase) || (v.label && baseName(v.label) === dBase)) return k;\n  }\n  // b) fallback by size (¬±2 KB)\n  if (Number.isFinite(driveSize)) {\n    for (const [k, v] of map.entries()) {\n      if (Number.isFinite(+v.size)) {\n        const diff = Math.abs(+v.size - driveSize);\n        if (diff <= 2048) return k;\n      }\n    }\n  }\n  return null;\n};\n\n// 2) masukkan files_info (HANYA upload, bukan update-only)\n//    dan hanya jika belum ada entri dengan nama dasar yang sama\nif (filesInfo.length) {\n  for (const f of filesInfo) {\n    const bn = baseName(f?.name || 'lampiran');\n    let already = false;\n    for (const v of map.values()) {\n      if (baseName(v.name||v.label) === bn) { already = true; break; }\n    }\n    if (!already) {\n      const key = uniq(bn || 'lampiran');\n      put(key, {\n        label: key,\n        name: f?.name ?? null,\n        mimeType: f?.type ?? null,\n        size: Number.isFinite(+f?.size) ? +f.size : null,\n      });\n    }\n  }\n}\n\n// 3) gabungkan SEMUA item file Drive (tiap item = 1 file)\nfor (const it of items) {\n  const s = it.json || {};\n  const isDrive = !!(s.id || s.webViewLink || s.webContentLink || s.name || s.originalFilename || s.mimeType);\n  if (!isDrive) continue;\n\n  const dName = s.name || s.originalFilename || 'lampiran';\n  const dSize = Number.isFinite(+s.size) ? +s.size : (s.quotaBytesUsed ? +s.quotaBytesUsed : null);\n\n  let slot = findBestSlot(dName, dSize);\n  if (!slot) {\n    const key = uniq(baseName(dName) || 'lampiran');\n    add(key, { name: dName });\n    slot = key;\n  }\n\n  put(slot, {\n    file_id: s.id ?? null,\n    download_url: s.webContentLink ?? null,\n    view_url: s.webViewLink ?? null,\n    name: s.name ?? s.originalFilename ?? dName,\n    mimeType: s.mimeType ?? null,\n    size: dSize ?? null,\n    iconLink: s.iconLink ?? null,\n    thumbnailLink: s.thumbnailLink ?? null,\n    createdTime: s.createdTime ?? null,\n  });\n}\n\nconst dokumen = Array.from(map.values());\n\n// ---------- Bidang teks (domisili) ----------\nconst kelurahan = ensure(md?.pemohon?.kelurahan);\nconst kecamatan = ensure(md?.pemohon?.kecamatan);\nconst kotaKab   = ensure(md?.pemohon?.kota_kab ?? md?.pemohon?.kabupaten);\nconst provinsi  = ensure(md?.pemohon?.provinsi);\nconst domisili  = md?.pemohon?.domisili ? clean(md.pemohon.domisili) : `${kelurahan}, ${kecamatan}, ${kotaKab}, ${provinsi}`;\n\n// ---------- Payload akhir ----------\nconst payload = {\n  jenis_surat   : valKey(md, 'jenis_surat'),\n  nomor_surat   : valKey(md, 'nomor_surat'),\n  tanggal_surat : valKey(md, 'tanggal_surat'),\n\n  pemohon: {\n    nama             : md?.pemohon?.nama ?? null,\n    nik              : md?.pemohon?.nik ?? null,\n    ttl              : md?.pemohon?.ttl ?? null,\n    agama            : md?.pemohon?.agama ?? null,\n    jenis_kelamin    : md?.pemohon?.jenis_kelamin ?? null,\n    status_perkawinan: md?.pemohon?.status_perkawinan ?? null,\n    pekerjaan        : md?.pemohon?.pekerjaan ?? null,\n    alamat           : md?.pemohon?.alamat ?? null,\n    kelurahan, kecamatan, kota_kab: kotaKab, provinsi, domisili,\n  },\n\n  dokumen,\n\n  penandatangan: {\n    nama   : md?.penandatangan?.nama ?? null,\n    nip    : md?.penandatangan?.nip ?? null,\n    jabatan: md?.penandatangan?.jabatan ?? null,\n  },\n\n  operator                 : md?.operator ?? null,\n  ref                      : md?.ref ?? null,\n  WAHA_Trigger_session     : md?.WAHA_Trigger_session ?? null,\n  WAHA_Trigger_payload_from: md?.WAHA_Trigger_payload_from ?? null,\n  LogoURL                  : md?.LogoURL ?? null,\n\n  URL_CREATE     : md?.URL_CREATE ?? null,\n  URL_UPDATE     : md?.URL_UPDATE ?? null,\n  URL_DELETE     : md?.URL_DELETE ?? null,\n  URL_UPLOAD     : md?.URL_UPLOAD ?? null,\n  URL_DELETE_FILE: md?.URL_DELETE_FILE ?? null,\n\n  id_user      : md?.id_user ?? bodyData?.id_user ?? null,\n  url_web_link : md?.url_web_link ?? bodyData?.url_web_link ?? null,\n  action       : intent || null,\n  timestamp    : md?.timestamp ?? bodyData?.timestamp ?? null,\n};\n\n// Catatan penting: untuk mencegah tersimpan, JANGAN masukkan files_info ke payload.\n// (Jika ingin debugging saja, bisa tambahkan saat intent upload saja. Default: tidak disimpan.)\n\nreturn [{ json: payload }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -660,
        1160
      ],
      "id": "ca28d6f1-9b91-4f79-858a-a44b5f0415d0",
      "name": "Code3"
    },
    {
      "parameters": {
        "operation": "toJson",
        "options": {
          "fileName": "={{ DateTime.now().setZone('Asia/Tokyo').setLocale('id').toFormat('dd_MM_yyyy_HH_mm_ss') + '_' + ($json.pemohon.nama).trim().replace(/\\s+/g,'-').toUpperCase() + '_' + ($json.pemohon.nik) }}\n"
        }
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        -440,
        1160
      ],
      "id": "4e18ba5d-95a1-49e6-a026-09977623f676",
      "name": "Convert to File3"
    },
    {
      "parameters": {
        "operation": "update",
        "fileId": {
          "__rl": true,
          "value": "={{ $('Code3').item.json.id_user }}",
          "mode": "id"
        },
        "changeFileContent": true,
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        -220,
        1160
      ],
      "id": "358653d1-b01b-492e-adcc-5ce526828664",
      "name": "Update file2",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "jyiiyKxh6DOyPVt5",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "html": "<!doctype html>\n<html lang=\"id\">\n<head>\n  <meta charset=\"utf-8\" />\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\n  <title>Kawe Nia ‚Ä¢ Layanan SKTM</title>\n  <style>\n    :root{\n      --bg:#0b1020; --panel:#0f172a; --ink:#e5e7eb; --muted:#9ca3af;\n      --accent:#22c55e; --accent-2:#38bdf8; --line:#1f2937;\n      --danger:#ef4444; --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.35);\n      --space:clamp(14px,2.4vw,22px);\n      --modal-radius:10px;\n      --modal-bg:#111827;\n      --modal-border:rgba(148,163,184,.45);\n      --overlay:rgba(0,0,0,.72);\n    }\n    *{box-sizing:border-box} html,body{height:100%}\n\n    /* ===== FULL BACKGROUND ===== */\n    body{\n      margin:0; color:var(--ink);\n      font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial,\"Apple Color Emoji\",\"Segoe UI Emoji\";\n      background:#0a0e1a;\n      min-height:100svh;\n    }\n    .bg{\n      position:fixed; inset:0; z-index:-1; pointer-events:none;\n      background:\n        radial-gradient(1400px 800px at 20% -10%, #16223f 0%, transparent 60%),\n        radial-gradient(1200px 700px at 90% -20%, rgba(56,189,248,.15) 0%, transparent 60%),\n        linear-gradient(145deg,#0a0e1a,#0f1933 55%,#0a0e1a);\n      background-attachment:fixed,fixed,fixed;\n    }\n\n    body,body *{min-width:0; overflow-wrap:anywhere; word-break:break-word; white-space:normal}\n    .wrap{max-width:1100px;margin:40px auto;padding:0 20px}\n\n    .topbar{display:flex;align-items:center;gap:16px;margin-bottom:18px}\n    .brand{display:flex;align-items:center;gap:12px;min-width:0}\n    /* ==== Logo responsif & konsisten (tanpa wrapper tambahan) ==== */\n    .brand img.logo{\n      width: 120px; /* atau angka yang Anda mau */\n      aspect-ratio: 1 / 1;\n      object-fit: contain;\n      background:#0f172a;\n      border-radius:12px;\n      display:block;\n      /* Garis stroke di dalam */\n      box-shadow:\n        inset 0 0 0 1px rgba(148,163,184,.35), /* border tipis */\n        0 0 6px rgba(0,0,0,.35);               /* glow shadow merata */\n    }\n\n    .brand .title{font-weight:700;font-size:clamp(16px,2.4vw,20px)}\n    .brand .sub{font-size:12px;color:var(--muted)}\n    .pill{margin-left:auto;display:flex;gap:8px;align-items:center;font-size:12px;color:#cbd5e1;\n      background:linear-gradient(180deg,rgba(56,189,248,.2),rgba(34,197,94,.15));\n      border:1px solid rgba(148,163,184,.3);padding:6px 10px;border-radius:999px;flex-shrink:0;}\n\n    .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.02));\n      border:1px solid rgba(148,163,184,.2); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden}\n    .card-header{display:flex;flex-wrap:wrap;gap:14px;align-items:center;justify-content:center;\n      padding:clamp(14px,2.2vw,20px) var(--space);\n      background:radial-gradient(800px 300px at 10% -20%, rgba(56,189,248,.15), transparent 60%),\n                 radial-gradient(600px 300px at 90% -30%, rgba(34,197,94,.18), transparent 55%);\n      border-bottom:1px solid rgba(148,163,184,.2)}\n    .hgroup{display:flex;flex-direction:column;gap:8px;min-width:0;margin-bottom:4px;width:100%;text-align:center}\n    .h1{font-size:clamp(18px,2.8vw,26px);font-weight:800;letter-spacing:.3px;margin-bottom:2px}\n    .h2{font-size:13px;color:var(--muted);margin-top:2px}\n    .badges{display:flex;gap:8px;flex-wrap:wrap;min-width:0;margin-top:6px}\n    .badge{font-size:12px;padding:6px 10px;border-radius:999px;background:#0b1224;border:1px solid rgba(148,163,184,.26)}\n    .badge.info{border-color:rgba(56,189,248,.45);background:rgba(56,189,248,.12);color:#cffafe}\n\n    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:0;min-height:360px}\n    @media (max-width:960px){.grid{grid-template-columns:1fr}.side{background:transparent}.panel{border-right:none}}\n\n    .panel{padding:var(--space);border-right:1px solid rgba(148,163,184,.16)} .panel:last-child{border-right:none}\n    .stitle{font-size:13px;letter-spacing:.4px;text-transform:uppercase;color:#a5b4fc;font-weight:700;margin-bottom:10px}\n\n    /* ===== BAR AKSI EDIT ===== */\n    .editbar{display:flex;gap:10px;align-items:center;margin-bottom:12px}\n    .edit-actions{display:none;gap:10px}\n    .edit-mode .edit-actions{display:flex}\n\n    /* ===== Data Pemohon ===== */\n    .ident{\n      display:grid; grid-template-columns:160px 10px 1fr; gap:6px 10px; align-items:start; font-size:14px;\n      background:rgba(15,23,42,.55); border:1px solid rgba(148,163,184,.15); border-radius:14px; padding:10px 12px;\n    }\n    @media (max-width:560px){ .ident{grid-template-columns:110px 8px 1fr} }\n    .lab{color:#cbd5e1} .sep{color:#475569} .val{color:#e5e7eb;font-weight:600;line-height:1.45}\n    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,\"Liberation Mono\",\"Courier New\",monospace}\n\n    .note{margin-top:12px;font-size:12.5px;color:#a5b4fc;background:rgba(99,102,241,.1);\n      border:1px dashed rgba(99,102,241,.35);border-radius:12px;padding:10px 12px}\n\n    .side{display:flex;flex-direction:column;gap:14px;padding:var(--space);\n      background:linear-gradient(180deg,rgba(2,6,23,.35),rgba(2,6,23,.15))}\n    .callout{border:1px solid rgba(56,189,248,.35);background:rgba(56,189,248,.1);border-radius:14px;padding:12px 14px;font-size:13px;color:#e0f2fe}\n    .actions{display:flex;flex-wrap:wrap;gap:10px}\n\n    /* ===== Buttons ===== */\n    .btn{appearance:none;border:none;cursor:pointer;font-weight:700;letter-spacing:.3px;\n      background:#0b1224;color:var(--ink);padding:10px 14px;border-radius:12px; border:1px solid rgba(148,163,184,.3);\n      display:inline-flex; align-items:center; gap:8px; justify-content:center;}\n    a.btn, a.btn:link, a.btn:visited { text-decoration:none; color:inherit; }\n    a.btn:hover, a.btn:focus { text-decoration:none; }\n    .btn.primary,.btn.success{ background:linear-gradient(180deg,rgba(34,197,94,.95),rgba(16,185,129,.95)); border-color:rgba(16,185,129,.95); color:#052e1a !important; }\n    .btn.secondary{ background:linear-gradient(180deg,rgba(56,189,248,.9),rgba(59,130,246,.9)); border-color:rgba(96,165,250,.95); color:#06293a !important; }\n    .btn.ghost{background:transparent}\n    .btn.danger{ background:linear-gradient(180deg,rgba(239,68,68,.95),rgba(220,38,38,.95)); border-color:rgba(220,38,38,.95); color:#fef2f2 !important; }\n    .btn:active{transform:translateY(1px)}\n    .btn:disabled, .btn.disabled{\n      opacity: 0.4 !important;\n      cursor: not-allowed !important;\n      pointer-events: none !important;\n      background: #1f2937 !important;\n      border-color: #374151 !important;\n      color: #6b7280 !important;\n      transform: none !important;\n    }\n    .btn:disabled:hover, .btn.disabled:hover{\n      background: #1f2937 !important;\n      border-color: #374151 !important;\n      color: #6b7280 !important;\n    }\n\n    .edit-mode .val{display:none}.edit-mode .edit-field{display:block}\n    .edit-field{display:none;width:100%;background:rgba(15,23,42,.8);border:1px solid rgba(56,189,248,.4);border-radius:8px;padding:8px 10px;color:#e5e7eb;font-size:14px;font-weight:600}\n    .edit-field:focus{outline:none;border-color:rgba(56,189,248,.8);box-shadow:0 0 0 2px rgba(56,189,248,.2)}\n\n    .file-upload-container{background:rgba(15,23,42,.55);border:1px solid rgba(148,163,184,.15);border-radius:14px;padding:14px}\n    .upload-progress{width:100%;height:4px;background:rgba(148,163,184,.2);border-radius:2px;overflow:hidden;margin:8px 0}\n    .upload-progress-bar{height:100%;background:linear-gradient(90deg,#22c55e,#16a34a);width:0%;transition:width .3s ease}\n\n    .uploaded-files-container{background:rgba(15,23,42,.55);border:1px solid rgba(148,163,184,.15);border-radius:14px;padding:14px;min-height:60px}\n    .no-files-message{color:#9ca3af;font-size:13px;text-align:center;font-style:italic}\n\n    .uploaded-file-item{display:flex;flex-direction:column;gap:8px;padding:10px 12px;background:rgba(34,197,94,.06);\n      border:1px solid rgba(34,197,94,.25);border-radius:12px;margin-bottom:8px}\n    .file-name{color:#d1fae5;font-weight:700;line-height:1.35}\n    .file-meta{color:#a5b4fc;font-size:12px}\n    .file-id{font-size:12px;color:#94a3b8}\n    .file-actions{display:flex;flex-wrap:wrap;gap:8px;margin-top:4px}\n    .file-actions .btn{padding:6px 10px;border-radius:10px}\n\n    .card-footer{display:flex;gap:14px;justify-content:space-between;align-items:center;\n      padding:12px var(--space);border-top:1px solid rgba(148,163,184,.2);color:var(--muted);font-size:12px}\n\n    /* ===== MODAL ===== */\n    .modal-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:1000;background:var(--overlay)}\n    .modal{width:min(480px,92vw);border-radius:var(--modal-radius);background:var(--modal-bg);\n      border:1px solid var(--modal-border);box-shadow:0 18px 50px rgba(0,0,0,.55);padding:18px 18px}\n    .modal-header{display:flex;gap:10px;align-items:center;margin-bottom:8px}\n    .modal-icon{font-size:28px}\n    .modal-title{font-weight:800;font-size:18px;letter-spacing:.3px}\n    .modal-message{color:#cbd5e1;line-height:1.7;margin:8px 0 16px;font-size:14px}\n    .modal-actions{display:flex;gap:10px;justify-content:flex-end}\n    .modal .btn{border-radius:10px;padding:10px 14px}\n    .modal--info{box-shadow:inset 4px 0 0 0 #38bdf8, 0 18px 50px rgba(0,0,0,.55)}\n    .modal--success{box-shadow:inset 4px 0 0 0 #22c55e, 0 18px 50px rgba(0,0,0,.55)}\n    .modal--confirm{box-shadow:inset 4px 0 0 0 #f59e0b, 0 18px 50px rgba(0,0,0,.55)}\n    .modal--danger{box-shadow:inset 4px 0 0 0 #ef4444, 0 18px 50px rgba(0,0,0,.55)}\n\n    /* ===== LOADING ===== */\n    .loading-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:900;background:rgba(2,6,23,.75)}\n    .loading-box{display:flex;flex-direction:column;align-items:center;gap:14px;padding:22px;border-radius:12px;border:1px solid rgba(148,163,184,.35);background:#0f172a}\n    .spinner{width:52px;height:52px;border-radius:50%;border:4px solid rgba(148,163,184,.35);border-top-color:#22c55e;animation:spin 1s linear infinite}\n    @keyframes spin{to{transform:rotate(360deg)}}\n    .loading-text{font-size:14px;color:#e5e7eb}\n\n    @media print{.side{display:none} body{background:#fff} .card{border:none;box-shadow:none} .pill,.modal-overlay,.loading-overlay{display:none!important}}\n  </style>\n</head>\n<body>\n  <div class=\"bg\" aria-hidden=\"true\"></div>\n\n  <div class=\"wrap\">\n    <div class=\"topbar\">\n      <div class=\"brand\">\n        <img class=\"logo\" id=\"LogoURL\" src=\"\" alt=\"Lambang Kabupaten\">\n        <div>\n          <div class=\"title\">Kawe Nia ‚Ä¢ Pelayanan Masyarakat</div>\n        </div>\n      </div>\n      <div class=\"pill\">üü¢ Layanan aktif ‚Ä¢ 24/7</div>\n    </div>\n\n    <section class=\"card\" role=\"region\" aria-label=\"Layanan SKTM\">\n      <header class=\"card-header\">\n        <div class=\"hgroup\" style=\"align-items: center; text-align: center;\">\n          <div style=\"text-align: center; margin-bottom: 20px; width: 100%;\">\n            <div style=\"font-weight: bold; font-size: 16px; margin-bottom: 2px;\">PEMERINTAH KABUPATEN MIMIKA</div>\n            <div style=\"font-weight: bold; font-size: 16px; margin-bottom: 2px;\">DISTRIK WANIA</div>\n            <div style=\"font-size: 12px; margin-bottom: 1px;\">Jln. CENDRAWASIH SP IV TIMIKA ‚Äì PAPUA TENGAH 99910</div>\n            <div style=\"font-size: 12px; margin-bottom: 15px;\">Akun E-Distrik Wania.distrikwania.13@gmail.com</div>\n          </div>\n          <div class=\"h1\" style=\"text-align: center; width: 100%;\">SURAT KETERANGAN TIDAK MAMPU</div>\n          <div class=\"h2\" style=\"text-align: center; width: 100%;\">Nomor : <span class=\"mono\">400.2.1 / 307 / 2025</span></div>\n        </div>\n      </header>\n\n      <div class=\"grid\">\n        <div class=\"panel\">\n          <div class=\"stitle\">Data Pemohon</div>\n\n          <!-- BAR EDIT -->\n          <div class=\"editbar\">\n            <button class=\"btn ghost\" onclick=\"toggleEditMode()\" id=\"editBtn\">‚úèÔ∏è Masuk Mode Edit</button>\n            <div class=\"edit-actions\">\n              <button class=\"btn success\" onclick=\"saveChanges()\">üíæ Simpan Perubahan</button>\n              <button class=\"btn danger\" onclick=\"cancelEdit()\">‚úñÔ∏è Batal</button>\n            </div>\n          </div>\n\n          <div class=\"ident\" aria-label=\"Identitas Pemohon\">\n            <div class=\"lab\">Nama</div><div class=\"sep\">:</div><div class=\"val\" id=\"nama\"></div>\n            <input type=\"text\" class=\"edit-field\" id=\"editNama\" value=\"\">\n\n            <div class=\"lab\">NIK</div><div class=\"sep\">:</div><div class=\"val mono\" id=\"nik\"></div>\n            <input type=\"text\" class=\"edit-field\" id=\"editNIK\" value=\"\">\n\n            <div class=\"lab\">Tempat/Tgl Lahir</div><div class=\"sep\">:</div><div class=\"val\" id=\"ttl\"></div>\n            <input type=\"text\" class=\"edit-field\" id=\"editTTL\" value=\"\">\n\n            <div class=\"lab\">Agama</div><div class=\"sep\">:</div><div class=\"val\" id=\"agama\"></div>\n            <input type=\"text\" class=\"edit-field\" id=\"editAgama\" value=\"\">\n\n            <div class=\"lab\">Jenis Kelamin</div><div class=\"sep\">:</div><div class=\"val\" id=\"jenis_kelamin\"></div>\n            <select class=\"edit-field\" id=\"editJenisKelamin\">\n              <option value=\"Laki-Laki\" selected>Laki-laki</option>\n              <option value=\"Perempuan\">Perempuan</option>\n            </select>\n\n            <div class=\"lab\">Status Perkawinan</div><div class=\"sep\">:</div><div class=\"val\" id=\"status_perkawinan\"></div>\n            <select class=\"edit-field\" id=\"editStatusPerkawinan\">\n              <option value=\"BELUM KAWIN\">Belum Kawin</option>\n              <option value=\"KAWIN\">Kawin</option>\n              <option value=\"CERAI HIDUP\">Cerai Hidup</option>\n              <option value=\"CERAI MATI\">Cerai Mati</option>\n            </select>\n\n            <div class=\"lab\">Pekerjaan</div><div class=\"sep\">:</div><div class=\"val\" id=\"pekerjaan\"></div>\n            <input type=\"text\" class=\"edit-field\" id=\"editPekerjaan\" value=\"\">\n\n            <div class=\"lab\">Alamat</div><div class=\"sep\">:</div><div class=\"val\" id=\"alamat\"></div>\n            <textarea class=\"edit-field\" id=\"editAlamat\" rows=\"2\"></textarea>\n\n            <div class=\"lab\">Kelurahan/Kampung</div><div class=\"sep\">:</div><div class=\"val\" id=\"kelurahan\"></div>\n            <select class=\"edit-field\" id=\"editKelurahan\">\n              <option value=\"\">-- Pilih Kelurahan/Kampung --</option>\n              <option value=\"Inauga\">Inauga</option>\n              <option value=\"Kamoro Jaya\">Kamoro Jaya</option>\n              <option value=\"Wonosari Jaya\">Wonosari Jaya</option>\n              <option value=\"Kadun Jaya\">Kadun Jaya</option>\n              <option value=\"Mandiri Jaya\">Mandiri Jaya</option>\n              <option value=\"Mawokau Jaya\">Mawokau Jaya</option>\n              <option value=\"Nawaripi\">Nawaripi</option>\n            </select>\n\n            <div class=\"lab\">Kecamatan</div><div class=\"sep\">:</div><div class=\"val\" id=\"kecamatan\"></div>\n            <input type=\"text\" class=\"edit-field\" id=\"editKecamatan\" value=\"WANIA\">\n\n            <div class=\"lab\">Kota/Kabupaten</div><div class=\"sep\">:</div><div class=\"val\" id=\"kota_kab\"></div>\n            <input type=\"text\" class=\"edit-field\" id=\"editKotaKab\" value=\"MIMIKA\">\n\n            <div class=\"lab\">Provinsi</div><div class=\"sep\">:</div><div class=\"val\" id=\"provinsi\"></div>\n            <input type=\"text\" class=\"edit-field\" id=\"editProvinsi\" value=\"PAPUA TENGAH\">\n          </div>\n\n          <div class=\"stitle\" style=\"margin-top:10px\">Lampiran Wajib</div>\n          <div class=\"callout\" style=\"border-color:rgba(239,68,68,.45);background:rgba(239,68,68,.08);color:#fee2e2\">\n            üìé <strong>WAJIB LAMPIRKAN :</strong> Kartu KTP, Kartu Keluarga, Surat Keterangan Sakit dari Rumah Sakit, dan Surat Keterangan dari RT Setempat harus dilampirkan sebelum mengirim surat.\n          </div>\n\n          <div class=\"stitle\" style=\"margin-top:10px\">Upload File</div>\n          <div class=\"file-upload-container\" ondragover=\"handleDragOver(event)\" ondragleave=\"handleDragLeave(event)\" ondrop=\"handleDrop(event)\">\n            <input type=\"file\" id=\"fileInput\" accept=\"*\" multiple style=\"display:none\" onchange=\"handleFileSelect(event)\">\n            <button class=\"btn ghost\" onclick=\"document.getElementById('fileInput').click()\" style=\"width:100%;margin-bottom:8px\">üìÅ Pilih File</button>\n            <div style=\"font-size:11px;color:#9ca3af;text-align:center;margin-bottom:8px\">(PDF, JPG, PNG, DOC, XLS, PPT, ZIP, RAR, dll)</div>\n            <div id=\"fileInfo\" style=\"display:none\"></div>\n            <div id=\"uploadProgress\" class=\"upload-progress\" style=\"display:none\"><div id=\"uploadProgressBar\" class=\"upload-progress-bar\"></div></div>\n            <button class=\"btn primary\" id=\"uploadBtn\" onclick=\"uploadFiles()\" style=\"width:100%;display:none\">üì§ Kirim File</button>\n          </div>\n\n          <div class=\"stitle\" style=\"margin-top:16px\">File Terupload</div>\n          <div class=\"uploaded-files-container\">\n            <div id=\"uploadedFilesList\"><div class=\"no-files-message\">Belum ada file yang diupload</div></div>\n          </div>\n\n          <div class=\"note\">‚ÑπÔ∏è <b>Catatan:</b> Periksa kembali kebenaran data sebelum membuat surat.</div>\n\n          <div class=\"stitle\" style=\"margin-top:16px\">Keterangan</div>\n          <div class=\"file-upload-container\" style=\"margin-bottom:16px;line-height:1.6;font-size:14px\">\n            <div style=\"margin-bottom:8px\">1. Tersebut namanya di atas adalah benar-benar penduduk <strong id=\"keterangan_kelurahan\"></strong>.</div>\n            <div style=\"margin-bottom:8px\">2. Tersebut namanya di atas adalah benar-berstatus ekonomi lemah yang tidak mampu menebus atau membayar biaya pengobatan <strong>BPJS / KIS</strong>.</div>\n            <div style=\"margin-bottom:8px\">3. Mohon surat keterangan ini digunakan sebagaimana mestinya.</div>\n            <div style=\"margin-top:12px;font-style:italic\">Demikian surat keterangan tidak mampu ini kami buat untuk dapat digunakan sebagaimana mestinya.</div>\n          </div>\n        </div>\n\n        <aside class=\"side\">\n          <div class=\"stitle\">Tindakan</div>\n          <div class=\"actions\">\n            <button class=\"btn primary\" id=\"createSendBtn\" onclick=\"confirmCreateAndSend()\">üì® Buat Surat & Kirim Data</button>\n            <button class=\"btn danger\" onclick=\"confirmDeleteAll()\">üóëÔ∏è Hapus Surat & Hapus Data</button>\n          </div>\n\n          <div class=\"stitle\" style=\"margin-top:10px\">Ringkasan</div>\n          <div class=\"callout\">\n            <div><b>üë§ Operator:</b> KaweNia</div>\n            <div><b>üìÖ Tanggal:</b> <span id=\"date\"></span></div>\n            <div><b>üîó Referensi:</b> KaweNia-SKTM</div>\n            <div><b>üß≠ From:</b> <span id=\"WAHA_Trigger_payload_from\"></span></div>\n          </div>\n        </aside>\n      </div>\n\n      <footer class=\"card-footer\">\n        <div>¬© <span id=\"tahun\"></span> Pemerintah Distrik Wania ‚Ä¢ Kawe Nia</div>\n      </footer>\n    </section>\n  </div>\n\n  <!-- LOADING -->\n  <div class=\"loading-overlay\" id=\"loadingOverlay\" aria-live=\"polite\" aria-busy=\"true\">\n    <div class=\"loading-box\">\n      <div class=\"spinner\" aria-hidden=\"true\"></div>\n      <div class=\"loading-text\" id=\"loadingText\">Memuat data‚Ä¶ Mohon menunggu.</div>\n    </div>\n  </div>\n\n  <!-- MODAL -->\n  <div class=\"modal-overlay\" id=\"modalOverlay\" role=\"dialog\" aria-modal=\"true\" aria-hidden=\"true\">\n    <div class=\"modal modal--info\" id=\"modalBox\" role=\"document\">\n      <div class=\"modal-header\">\n        <div class=\"modal-icon\" id=\"modalIcon\">‚ÑπÔ∏è</div>\n        <div class=\"modal-title\" id=\"modalTitle\">Informasi</div>\n      </div>\n      <div class=\"modal-message\" id=\"modalMessage\">Pesan‚Ä¶</div>\n      <div class=\"modal-actions\" id=\"modalActions\"></div>\n    </div>\n  </div>\n\n<script>\n/* ================= 1) DYNAMIC WEBHOOK ================= */\nconst ENDPOINT_MAP = {\n  x1: 'webhook',\n  x2: 'urlpost', \n  x3: 'webhook_url',\n  x4: 'WEBHOOK'\n};\n\nfunction getWebhookUrl(){\n  if (!lastObj || typeof lastObj !== 'object') return null;\n  for (const [key, field] of Object.entries(ENDPOINT_MAP)) {\n    if (lastObj[field]) return lastObj[field];\n  }\n  return null;\n}\nconst UPDATE_STRATEGY = 'OVERWRITE_BIN';\nconst POLL_MS = 500;\n\n/* ================= 2) CONFIG & DATA SOURCE ================= */\nconst META_CONFIG = {\n  x7k: \"{{ $json.id }}\",\n  p9m: \"https://distrikwania.com/data/\",\n  w2n: \"id\",\n  z5f: /\\{\\{\\s*\\$json\\.id\\s*\\}\\}/,\n  h8r: ['id', 'ref', 'key', 'token'],\n  q3t: function(s) { return (s||\"\").toString().trim(); },\n  // Decoy variables to confuse\n  userId: 'user',\n  sessionId: 'session', \n  authToken: 'token',\n  apiKey: 'key'\n};\n\n// Obfuscated function names\nconst fn = {\n  extract: 'extractDataRef',\n  resolve: 'resolveParameter',\n  validate: 'validateInput'\n};\n\nfunction extractDataRef(){\n  const raw = META_CONFIG.x7k;\n  if(META_CONFIG.z5f.test(raw)){\n    const urlObj = new URL(location.href);\n    for(const param of META_CONFIG.h8r){\n      const val = urlObj.searchParams.get(param);\n      if(val) return META_CONFIG.q3t(val);\n    }\n    const segments = urlObj.pathname.split('/').filter(Boolean);\n    if(segments.length) return segments[segments.length-1];\n    return \"\";\n  }\n  return META_CONFIG.q3t(raw);\n}\n\nconst DATA_REF = extractDataRef();\nconst API_ENDPOINT = DATA_REF ? (META_CONFIG.p9m + encodeURIComponent(DATA_REF)) : \"\";\n\n/* ================= 3) UTIL ================= */\nconst $=id=>document.getElementById(id);\nconst toStr=(x,fb='-')=>{const v=(x??'').toString().trim();return v.length?v:fb;}\nconst isJSONResponse=res=>(res.headers.get('content-type')||'').toLowerCase().includes('application/json');\nasync function hashText(txt){const buf=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(txt));return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');}\nfunction pickObj(root){if(!root)return{}; if(Array.isArray(root?.data)&&root.data[0])return root.data[0]; if(Array.isArray(root)&&root[0])return root[0]; return root;}\nfunction humanSize(bytes){if(!bytes&&bytes!==0)return null; const u=['B','KB','MB','GB']; let i=0, n=Number(bytes); while(n>=1024&&i<u.length-1){n/=1024;i++} return (Math.round(n*10)/10)+' '+u[i];}\n\n/* ================= 4) STATE ================= */\nlet lastJSON=null,lastObj={},lastHash=null;\nlet editMode=false,pollHandle=null,pendingFiles=[];\nlet firstLoadDone=false;\n\n/* ================= 5) VIEW MAP ================= */\nconst VIEW={logo:$(\"LogoURL\"),date:$(\"date\"),from:$(\"WAHA_Trigger_payload_from\"),tahun:$(\"tahun\"),\n  nama:$(\"nama\"),nik:$(\"nik\"),ttl:$(\"ttl\"),agama:$(\"agama\"),jenis_kelamin:$(\"jenis_kelamin\"),status_perkawinan:$(\"status_perkawinan\"),\n  pekerjaan:$(\"pekerjaan\"),alamat:$(\"alamat\"),kelurahan:$(\"kelurahan\"),kecamatan:$(\"kecamatan\"),kota_kab:$(\"kota_kab\"),provinsi:$(\"provinsi\"),\n  ket_kel:$(\"keterangan_kelurahan\"),filesList:$(\"uploadedFilesList\")};\nconst EDIT={nama:$(\"editNama\"),nik:$(\"editNIK\"),ttl:$(\"editTTL\"),agama:$(\"editAgama\"),jk:$(\"editJenisKelamin\"),\n  status:$(\"editStatusPerkawinan\"),pekerjaan:$(\"editPekerjaan\"),alamat:$(\"editAlamat\"),\n  kelurahan:$(\"editKelurahan\"),kecamatan:$(\"editKecamatan\"),kota_kab:$(\"editKotaKab\"),provinsi:$(\"editProvinsi\")};\nconst elFileInput=$(\"fileInput\"), elFileInfo=$(\"fileInfo\"), elUploadBtn=$(\"uploadBtn\");\nconst elProg=$(\"uploadProgress\"), elProgBar=$(\"uploadProgressBar\");\nconst loadingOverlay=$(\"loadingOverlay\"), loadingText=$(\"loadingText\");\n\n/* ================= 6) RENDER ================= */\nfunction renderStatic(){ if(VIEW.tahun) VIEW.tahun.textContent=String(new Date().getFullYear()); }\n\n// Helper function to format text with proper capitalization (only first letter capitalized)\nfunction formatProperCase(text) {\n  if (!text) return '';\n  return text.toLowerCase().replace(/\\b\\w/g, letter => letter.toUpperCase());\n}\n\n// Helper functions to validate field values against select options\nfunction validateGenderValue(value) {\n  const validGenders = ['Laki-Laki', 'Perempuan'];\n  if (!value) return '';\n  \n  // Case-sensitive match first\n  if (validGenders.includes(value)) {\n    return value;\n  }\n  \n  // Case-insensitive match\n  const match = validGenders.find(g => g.toLowerCase() === value.toLowerCase());\n  if (match) {\n    return match;\n  }\n  \n  return '';\n}\n\nfunction validateMarriageStatusValue(value) {\n  const validStatuses = ['BELUM KAWIN', 'KAWIN', 'CERAI HIDUP', 'CERAI MATI'];\n  if (!value) return '';\n  \n  // Case-sensitive match first\n  if (validStatuses.includes(value)) {\n    return formatProperCase(value); // Format to proper case for display\n  }\n  \n  // Case-insensitive match\n  const match = validStatuses.find(s => s.toLowerCase() === value.toLowerCase());\n  if (match) {\n    return formatProperCase(match); // Format to proper case for display\n  }\n  \n  return '';\n}\n\nfunction validateKelurahanValue(value) {\n  const validKelurahan = ['Inauga', 'Kamoro Jaya', 'Wonosari Jaya', 'Kadun Jaya', 'Mandiri Jaya', 'Mawokau Jaya', 'Nawaripi'];\n  if (!value) return '';\n  \n  // Case-sensitive match first\n  if (validKelurahan.includes(value)) {\n    return value;\n  }\n  \n  // Case-insensitive match\n  const match = validKelurahan.find(k => k.toLowerCase() === value.toLowerCase());\n  if (match) {\n    return match;\n  }\n  \n  return '';\n}\n\nfunction normalizeDocs(docs){\n  const arr=Array.isArray(docs)?docs.filter(Boolean):[];\n  const seen=new Set(); const out=[];\n  for(const d of arr){\n    const fid=d?.file_id||d?.id||d?.fileId||null;\n    const hasUrl=!!(d?.view_url||d?.download_url);\n    if(!fid && !hasUrl) continue;\n    const key=fid?`fid:${fid}`:`name:${(d?.name||'').toLowerCase()}|size:${d?.size||0}`;\n    if(seen.has(key)) continue; seen.add(key);\n    out.push({\n      label:d?.label??d?.name??'-',\n      name:d?.name??d?.label??'-',\n      file_id:fid,\n      view_url:d?.view_url??null,\n      download_url:d?.download_url??null,\n      size: d?.size ?? null,\n      mimeType: d?.mimeType ?? d?.mime ?? null\n    });\n  }\n  return out;\n}\n\nfunction renderFiles(obj){\n  const wrap=VIEW.filesList; if(!wrap) return;\n  const docs=normalizeDocs(obj?.dokumen);\n  wrap.innerHTML='';\n  updateCreateSendButton(docs.length > 0);\n  if(!docs.length){\n    const div=document.createElement('div'); div.className='no-files-message'; div.textContent='Belum ada file yang diupload'; wrap.appendChild(div); return;\n  }\n  docs.forEach(d=>{\n    const row=document.createElement('div'); row.className='uploaded-file-item';\n    const nameEl=document.createElement('div'); nameEl.className='file-name'; nameEl.textContent=toStr(d.name,'(tanpa nama)'); row.appendChild(nameEl);\n    const metaParts=[]; if(d.size!=null) metaParts.push('Ukuran: '+humanSize(d.size)); if(d.mimeType) metaParts.push(d.mimeType);\n    const metaEl=document.createElement('div'); metaEl.className='file-meta'; metaEl.textContent=metaParts.join(' ‚Ä¢ ')||'‚Äî'; row.appendChild(metaEl);\n    const act=document.createElement('div'); act.className='file-actions';\n    if(d.view_url){ const a=document.createElement('a'); a.href=d.view_url; a.target='_blank'; a.rel='noopener'; a.textContent='üëÅÔ∏è Lihat'; a.className='btn success'; act.appendChild(a); }\n    if(d.file_id){ \n      const b=document.createElement('button'); \n      b.className='btn danger'; \n      b.textContent='üóëÔ∏è Hapus'; \n      \n      // Check if system is disabled due to letter being sent\n      if(window.systemDisabled) {\n        b.disabled = true;\n        b.classList.add('disabled');\n        b.onclick = function(e) {\n          e.preventDefault();\n          showModal({\n            icon: 'üîí',\n            title: 'Hapus Dokumen Tidak Tersedia',\n            message: 'Surat telah terkirim. Dokumen tidak dapat dihapus.',\n            variant: 'info',\n            buttons: [{label: 'Tutup', variant: 'secondary', value: true}]\n          });\n        };\n      } else {\n        b.onclick=()=>confirmDeleteDocs([d]);\n      }\n      \n      act.appendChild(b); \n    }\n    row.appendChild(act);\n    wrap.appendChild(row);\n  });\n}\n\nfunction renderView(obj){\n  if(VIEW.date) VIEW.date.textContent=toStr(obj.date,new Date().toLocaleDateString('id-ID'));\n  if(VIEW.from) VIEW.from.textContent=toStr(obj.WAHA_Trigger_payload_from,'‚Äî');\n  if(VIEW.logo){ const logo=obj.LogoURL||obj.logo_url||''; if(logo) VIEW.logo.src=logo; }\n  \n  // Check status and disable buttons if letter has been sent\n  checkStatusAndDisableButtons(obj);\n\n  const p=obj.pemohon||{};\n  VIEW.nama&&(VIEW.nama.textContent=formatProperCase(toStr(p.nama)));\n  VIEW.nik&&(VIEW.nik.textContent=toStr(p.nik));\n  VIEW.ttl&&(VIEW.ttl.textContent=formatProperCase(toStr(p.ttl)));\n  VIEW.agama&&(VIEW.agama.textContent=formatProperCase(toStr(p.agama)));\n  \n  // Filter and validate Jenis Kelamin - only display if valid\n  if(VIEW.jenis_kelamin) {\n    const validGender = validateGenderValue(p.jenis_kelamin);\n    VIEW.jenis_kelamin.textContent = toStr(validGender);\n  }\n  \n  // Filter and validate Status Perkawinan - only display if valid\n  if(VIEW.status_perkawinan) {\n    const validStatus = validateMarriageStatusValue(p.status_perkawinan);\n    VIEW.status_perkawinan.textContent = toStr(validStatus);\n  }\n  VIEW.pekerjaan&&(VIEW.pekerjaan.textContent=formatProperCase(toStr(p.pekerjaan)));\n  VIEW.alamat&&(VIEW.alamat.textContent=formatProperCase(toStr(p.alamat)));\n  \n  // Filter and validate Kelurahan/Kampung - only display if valid\n  if(VIEW.kelurahan) {\n    const kelurahanValue = p['kelurahan/kampung'] || p.kelurahan;\n    const validKelurahan = validateKelurahanValue(kelurahanValue);\n    VIEW.kelurahan.textContent = toStr(validKelurahan);\n  }\n  \n  VIEW.kecamatan&&(VIEW.kecamatan.textContent=formatProperCase(toStr(p.kecamatan)));\n  VIEW.kota_kab&&(VIEW.kota_kab.textContent=formatProperCase(toStr(p.kota_kab)));\n  VIEW.provinsi&&(VIEW.provinsi.textContent=formatProperCase(toStr(p.provinsi)));\n  \n  // Filter and validate Kelurahan for keterangan section too\n  if(VIEW.ket_kel) {\n    const kelurahanValue = p['kelurahan/kampung'] || p.kelurahan;\n    const validKelurahan = validateKelurahanValue(kelurahanValue);\n    VIEW.ket_kel.textContent = toStr(validKelurahan);\n  }\n\n  EDIT.nama&&(EDIT.nama.value=p.nama??''); EDIT.nik&&(EDIT.nik.value=p.nik??''); EDIT.ttl&&(EDIT.ttl.value=p.ttl??'');\n  EDIT.agama&&(EDIT.agama.value=p.agama??''); EDIT.jk&&(EDIT.jk.value=p.jenis_kelamin??'LAKI-LAKI');\n  // Fix status perkawinan field - ensure proper value selection\n  if(EDIT.status) {\n    const statusValue = p.status_perkawinan ?? 'BELUM KAWIN';\n    \n    // Clear any previous selection first\n    EDIT.status.selectedIndex = -1;\n    \n    // Find and explicitly select the matching option (case-sensitive search)\n    let option = EDIT.status.querySelector(`option[value=\"${statusValue}\"]`);\n    \n    // If no exact match, try case-insensitive search\n    if (!option && statusValue) {\n      const options = EDIT.status.querySelectorAll('option');\n      option = Array.from(options).find(opt => \n        opt.value && opt.value.toLowerCase() === statusValue.toLowerCase()\n      );\n    }\n    \n    if (option) {\n      option.selected = true;\n      EDIT.status.value = option.value;\n    } else {\n      // No match found - fallback to first option for marriage status\n      if (EDIT.status.options.length > 0) {\n        EDIT.status.selectedIndex = 0;\n        EDIT.status.value = EDIT.status.options[0].value;\n      }\n    }\n  }\n  EDIT.pekerjaan&&(EDIT.pekerjaan.value=p.pekerjaan??'');\n  EDIT.alamat&&(EDIT.alamat.value=p.alamat??''); \n  \n  // Fix kelurahan/kampung field - ensure proper value selection\n  if(EDIT.kelurahan) {\n    const kelurahanValue = p['kelurahan/kampung'] ?? p.kelurahan ?? '';\n    \n    // Clear any previous selection first\n    EDIT.kelurahan.selectedIndex = -1;\n    \n    // Find and explicitly select the matching option (case-sensitive search)\n    let option = EDIT.kelurahan.querySelector(`option[value=\"${kelurahanValue}\"]`);\n    \n    // If no exact match, try case-insensitive search\n    if (!option && kelurahanValue) {\n      const options = EDIT.kelurahan.querySelectorAll('option');\n      option = Array.from(options).find(opt => \n        opt.value && opt.value.toLowerCase() === kelurahanValue.toLowerCase()\n      );\n    }\n    \n    if (option) {\n      option.selected = true;\n      EDIT.kelurahan.value = option.value;\n    } else {\n      // No match found - keep empty selection and don't display JSON data\n      EDIT.kelurahan.selectedIndex = 0; // Select the empty option\n      EDIT.kelurahan.value = '';\n    }\n  }\n  \n  EDIT.kecamatan&&(EDIT.kecamatan.value=p.kecamatan??''); EDIT.kota_kab&&(EDIT.kota_kab.value=p.kota_kab??'');\n  EDIT.provinsi&&(EDIT.provinsi.value=p.provinsi??'');\n\n  renderFiles(obj);\n}\n\n/* ================= 7) POLLING ================= */\nfunction startPolling(){stopPolling();pollHandle=setInterval(()=>{if(!editMode)loadOnce(false);},POLL_MS)}\nfunction stopPolling(){if(pollHandle){clearInterval(pollHandle);pollHandle=null}}\n\n/* ================= 8) LOADING ================= */\nfunction showLoading(show,text){ if(text) loadingText.textContent=text; loadingOverlay.style.display=show?'flex':'none'; }\n\n/* ================= 9) MODAL ================= */\nconst modalOverlay=$(\"modalOverlay\");\nconst modalBox=$(\"modalBox\");\nconst modalIcon=$(\"modalIcon\");\nconst modalTitle=$(\"modalTitle\");\nconst modalMessage=$(\"modalMessage\");\nconst modalActions=$(\"modalActions\");\n\nfunction showModal({icon='‚ÑπÔ∏è',title='Informasi',message='',buttons=[{label:'Tutup',variant:'secondary',value:true}],variant='info',closable=true}={}){\n  return new Promise(resolve=>{\n    modalIcon.textContent=icon; modalTitle.textContent=title; modalMessage.innerHTML=message; modalActions.innerHTML='';\n    modalBox.className='modal modal--'+variant;\n    buttons.forEach(btn=>{ const el=document.createElement('button'); el.className='btn '+(btn.primary?'primary':btn.danger?'danger':btn.variant||'secondary'); el.textContent=btn.label||'OK'; el.onclick=()=>{hide(); resolve(btn.value);} ; modalActions.appendChild(el); });\n    function onEsc(e){ if(e.key==='Escape' && closable){ hide(); resolve(null);} }\n    function hide(){ modalOverlay.style.display='none'; document.removeEventListener('keydown',onEsc); }\n    modalOverlay.style.display='flex'; document.addEventListener('keydown',onEsc);\n  });\n}\nfunction infoModal(title,message,icon='‚ÑπÔ∏è'){ return showModal({icon,title,message,variant:'info',buttons:[{label:'Tutup',variant:'secondary',value:true}]}); }\nfunction successModal(title,message){ return showModal({icon:'‚úÖ',title,message,variant:'success',buttons:[{label:'Tutup',variant:'secondary',value:true}]}); }\nfunction confirmModal(title,message,{okLabel='Lanjutkan',cancelLabel='Batal',icon='‚ùì',danger=false}={}){ return showModal({ icon,title,message,variant:'confirm', buttons:[ {label:cancelLabel,variant:'secondary',value:false}, {label:okLabel,primary:!danger,danger:danger,value:true} ] }); }\n\n/* ================= 10) EDIT ================= */\nfunction toggleEditMode(){ \n  // Check if system is disabled due to letter being sent\n  if (window.systemDisabled) {\n    showModal({\n      icon: 'üîí',\n      title: 'Mode Edit Tidak Tersedia',\n      message: 'Surat telah terkirim. Mode edit telah dinonaktifkan.',\n      variant: 'info',\n      buttons: [{label: 'Tutup', variant: 'secondary', value: true}]\n    });\n    return;\n  }\n  \n  editMode=!editMode; \n  document.body.classList.toggle('edit-mode',editMode); \n  const btn=$(\"editBtn\"); \n  if(btn) btn.textContent=editMode?'üîí Tutup Mode Edit':'‚úèÔ∏è Masuk Mode Edit'; \n  if(editMode) stopPolling(); \n  else {loadOnce(false);startPolling();} \n}\nfunction cancelEdit(){renderView(lastObj||{}); if(editMode) toggleEditMode();}\n\n/* === Konsolidasi struktur payload === */\nfunction baseHref(){ return (new URL(location.href)).href; }\nfunction buildBasePayload(action){\n  const dataCloned = JSON.parse(JSON.stringify(lastObj||{}));\n  if(UPDATE_STRATEGY==='OVERWRITE_BIN') dataCloned.dokumen = normalizeDocs(lastObj?.dokumen);\n  return {\n    action,\n    id_user: DATA_REF,\n    id_surat: baseHref(),\n    data: { ...dataCloned, id_user: DATA_REF, id_surat: baseHref() }\n  };\n}\nasync function sendJSON(action, extras={}){\n  const targetUrl = getWebhookUrl();\n  if(!targetUrl){\n    throw new Error('Service endpoint not configured. Please verify configuration settings.');\n  }\n  const payload = { ...buildBasePayload(action), ...extras };\n  const resp = await fetch(targetUrl,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });\n  const text = await resp.text();\n  if(!resp.ok) throw new Error('HTTP '+resp.status+' ‚Äî '+text.slice(0,200));\n  return text;\n}\n\nasync function saveChanges(){\n  try{\n    if(!lastObj||typeof lastObj!=='object') lastObj={}; if(!lastObj.pemohon) lastObj.pemohon={};\n    const p=lastObj.pemohon;\n    p.nama=EDIT.nama?.value??p.nama; p.nik=EDIT.nik?.value??p.nik; p.ttl=EDIT.ttl?.value??p.ttl; p.agama=EDIT.agama?.value??p.agama;\n    p.jenis_kelamin=EDIT.jk?.value??p.jenis_kelamin; p.status_perkawinan=EDIT.status?.value??p.status_perkawinan;\n    p.pekerjaan=EDIT.pekerjaan?.value??p.pekerjaan; p.alamat=EDIT.alamat?.value??p.alamat;\n    p['kelurahan/kampung']=EDIT.kelurahan?.value??p['kelurahan/kampung']??p.kelurahan; p.kecamatan=EDIT.kecamatan?.value??p.kecamatan;\n    p.kota_kab=EDIT.kota_kab?.value??p.kota_kab; p.provinsi=EDIT.provinsi?.value??p.provinsi;\n\n    showLoading(true,'Menyimpan perubahan data ke server‚Ä¶');\n    await sendJSON('UPDATE_ONLY', { strategy: UPDATE_STRATEGY });\n    renderView(lastObj); if(editMode) toggleEditMode();\n    await successModal('Perubahan Disimpan','Perubahan data telah berhasil disimpan di server.');\n  }catch(e){\n    await showModal({icon:'‚ö†Ô∏è',title:'Gagal Menyimpan',message:'Terjadi kendala saat menyimpan perubahan.<br><span class=\"mono\">'+(e.message||e)+'</span>',variant:'danger',buttons:[{label:'Tutup',variant:'secondary',value:true}]});\n  }finally{ showLoading(false); }\n}\n\n/* ================= 11) LOAD JSON ================= */\nasync function loadOnce(showLoader=true){\n  try{\n    if(!API_ENDPOINT){ return; }\n    if(showLoader && !firstLoadDone) showLoading(true,'Memuat data‚Ä¶ Mohon menunggu.');\n    const res=await fetch(API_ENDPOINT+'?t='+Date.now(),{cache:'no-store'});\n    const text=await res.text();\n    if(!res.ok) throw new Error('HTTP '+res.status+' ‚Äî '+text.slice(0,200));\n    let data; try{data=JSON.parse(text);}catch(err){ if(!isJSONResponse(res)) throw new Error('Respon bukan JSON'); throw err; }\n    const h=await hashText(JSON.stringify(data));\n    if(h!==lastHash){lastHash=h; lastJSON=data; lastObj=pickObj(data)||{}; renderView(lastObj);} \n    if(!firstLoadDone){firstLoadDone=true; showLoading(false);} \n  }catch(e){\n    if(!firstLoadDone){\n      showLoading(false);\n      await showModal({icon:'‚ö†Ô∏è',title:'Gagal Memuat Data',message:'Sistem tidak dapat memuat data awal.<br><span class=\"mono\">'+(e.message||e)+'</span>',variant:'danger',buttons:[{label:'Tutup',variant:'secondary',value:true}]});\n    }\n  }\n}\nfunction startRealtime(){renderStatic();loadOnce(true);startPolling();}\n\n/* ================= 12) CREATE / DELETE ================= */\nasync function confirmCreateAndSend(){\n  const docs = normalizeDocs(lastObj?.dokumen);\n  if(!docs || docs.length === 0){\n    await showModal({ icon:'‚ö†Ô∏è', title:'Belum Ada File yang Dilampirkan', message:'Silakan upload minimal satu file pendukung sebelum membuat surat.', variant:'danger', buttons:[{label:'Tutup',variant:'secondary',value:true}] });\n    return;\n  }\n  const ok = await confirmModal('Konfirmasi Pembuatan Surat','Dengan menekan <b>Setujui & Proses</b>, sistem akan membuat dokumen berdasarkan data saat ini dan mengirimkannya.',{okLabel:'Setujui & Proses',cancelLabel:'Tinjau Kembali',icon:'üì®'});\n  if(!ok) return;\n  await generateAndSendLetter();\n}\nasync function generateAndSendLetter(){\n  try{\n    if(editMode) await saveChanges();\n    showLoading(true,'Memproses pembuatan surat dan pengiriman data‚Ä¶');\n    await sendJSON('CREATE_AND_SEND');\n    await successModal('Surat Berhasil Dibuat','Data dan surat telah dikirim untuk verifikasi.');\n  }catch(e){\n    await showModal({icon:'‚ö†Ô∏è',title:'Gagal Membuat Surat',message:'Terjadi kendala saat membuat atau mengirim surat.<br><span class=\"mono\">'+(e.message||e)+'</span>',variant:'danger',buttons:[{label:'Tutup',variant:'secondary',value:true}]});\n  }finally{ showLoading(false); }\n}\n\nasync function confirmDeleteAll(){\n  const ok = await showModal({ icon:'üóëÔ∏è',title:'Konfirmasi Penghapusan', message:'Tindakan ini akan <b>menghapus seluruh data dan surat</b> terkait referensi ini. Lanjutkan?', variant:'confirm', buttons:[ {label:'Batal',variant:'secondary',value:false}, {label:'Ya, Hapus Semua',danger:true,value:true} ] });\n  if(!ok) return; await deleteLetterAndData();\n}\nasync function deleteLetterAndData(){\n  try{\n    showLoading(true,'Menghapus surat dan seluruh data terkait‚Ä¶');\n    await sendJSON('DELETE_ALL');\n    await successModal('Penghapusan Berhasil','Surat dan seluruh data terkait telah dihapus dari sistem.');\n    location.reload();\n  }catch(e){\n    await showModal({ icon:'‚ö†Ô∏è', title:'Gagal Menghapus', message:'Terjadi kendala saat menghapus surat atau data.<br><span class=\"mono\">'+(e.message||e)+'</span>', variant:'danger', buttons:[{label:'Tutup',variant:'secondary',value:true}] }).then(()=>location.reload());\n  }finally{ showLoading(false); }\n}\n\n/* ================= 13) UPLOAD ================= */\nfunction handleFileSelect(ev){pendingFiles=Array.from(ev.target.files||[]);refreshPendingFilesUI();}\nfunction handleDragOver(ev){ev.preventDefault();ev.stopPropagation();ev.currentTarget.style.borderColor='rgba(56,189,248,.6)';ev.currentTarget.style.background='rgba(56,189,248,.06)';}\nfunction handleDragLeave(ev){ev.preventDefault();ev.stopPropagation();ev.currentTarget.style.borderColor='';ev.currentTarget.style.background='';}\nfunction handleDrop(ev){ev.preventDefault();ev.stopPropagation();ev.currentTarget.style.borderColor='';ev.currentTarget.style.background='';pendingFiles=Array.from(ev.dataTransfer.files||[]);refreshPendingFilesUI();}\nfunction refreshPendingFilesUI(){ if(!elFileInfo||!elUploadBtn) return; if(!pendingFiles.length){elFileInfo.style.display='none';elUploadBtn.style.display='none';return;} elFileInfo.style.display=''; elUploadBtn.style.display=''; elFileInfo.innerHTML = '<div style=\"font-weight:600;margin-bottom:6px\">File akan diunggah:</div>' + pendingFiles.map(f => `<div style=\"font-size:12px; margin-bottom:8px\">‚Ä¢ ${f.name}</div>`).join(''); }\nasync function uploadFiles(){\n  try{\n    if(!pendingFiles.length) return infoModal('Tidak Ada File','Silakan pilih minimal satu file untuk diunggah.');\n    if(!lastObj && !lastJSON) return infoModal('Data Utama Belum Ada','Muat ulang halaman, lalu coba kembali.');\n    if(editMode) await saveChanges();\n\n    const form=new FormData();\n    form.append('action','UPLOAD_FILES');\n    form.append('id_user', DATA_REF);\n    form.append('id_surat', baseHref());\n    form.append('data', JSON.stringify({ ...((lastObj)||{}), id_user: DATA_REF, id_surat: baseHref() }));\n    pendingFiles.forEach(f=>form.append('files[]',f,f.name));\n\n    if(elProg) elProg.style.display=''; if(elProgBar) elProgBar.style.width='8%';\n    const targetUrl = getWebhookUrl();\n    if(!targetUrl){\n      throw new Error('Service endpoint not configured. Please verify configuration settings.');\n    }\n    showLoading(true,'Mengunggah berkas‚Ä¶');\n    const resp=await fetch(targetUrl,{method:'POST',body:form}); const text=await resp.text();\n    if(!resp.ok) throw new Error('HTTP '+resp.status+' ‚Äî '+text.slice(0,200));\n    if(elProgBar) elProgBar.style.width='100%';\n    await successModal('Unggah Berhasil','Berkas berhasil diunggah dan ditautkan ke data pemohon.');\n\n    pendingFiles=[]; if(elFileInput) elFileInput.value=''; refreshPendingFilesUI(); await loadOnce(false);\n  }catch(e){\n    await showModal({icon:'‚ö†Ô∏è',title:'Unggah Gagal',message:'Terjadi kendala saat mengunggah berkas.<br><span class=\"mono\">'+(e.message||e)+'</span>',variant:'danger',buttons:[{label:'Tutup',variant:'secondary',value:true}]});\n  }finally{ setTimeout(()=>{if(elProg) elProg.style.display='none';},600); if(elProgBar) elProgBar.style.width='0%'; showLoading(false); }\n}\n\n/* ================= 14) HAPUS DOKUMEN ================= */\nasync function confirmDeleteDocs(docs=[]){\n  if(!docs.length) return;\n  const listHtml=docs.map(d=>{ const sizeTxt = d.size!=null ? humanSize(d.size) : '‚Äî'; return `üìÑ <b>${toStr(d.name,'(tanpa nama)')}</b><br>Ukuran: ${sizeTxt}${d.mimeType?(' ‚Ä¢ '+d.mimeType):''}<br>ID: <span class=\"mono\">${toStr(d.file_id,'‚Äî')}</span>`; }).join('<hr style=\"border:0;border-top:1px solid rgba(148,163,184,.25);margin:8px 0\">');\n  const ok = await showModal({ icon:'üóÇÔ∏è', title:'Konfirmasi Penghapusan Dokumen', message:`Dokumen berikut akan dihapus dari sistem:<br><br>${listHtml}<br><br>Tindakan ini tidak dapat dibatalkan. Lanjutkan?`, variant:'confirm', buttons:[ {label:'Batal',variant:'secondary',value:false}, {label:'Hapus Dokumen',danger:true,value:true} ] });\n  if(!ok) return; await deleteDocumentsByFileIds(docs.map(d=>d.file_id).filter(Boolean));\n}\nasync function deleteDocumentsByFileIds(fileIds=[]){\n  if(!fileIds.length) return;\n  try{\n    showLoading(true,'Menghapus dokumen terpilih‚Ä¶');\n    await sendJSON('DELETE_DOCS', { delete_file_ids: fileIds });\n    await loadOnce(false);\n    await successModal('Dokumen Dihapus','Dokumen terpilih telah berhasil dihapus dari sistem.');\n  }catch(e){\n    await showModal({icon:'‚ö†Ô∏è',title:'Gagal Menghapus Dokumen',message:'Terjadi kendala saat menghapus dokumen.<br><span class=\"mono\">'+(e.message||e)+'</span>',variant:'danger',buttons:[{label:'Tutup',variant:'secondary',value:true}]});\n  }finally{ showLoading(false); }\n}\n\n/* ================= 15) FILE VALIDATION ================= */\nfunction updateCreateSendButton(hasFiles = false){ const btn=$(\"createSendBtn\"); if(!btn) return; btn.style.opacity = hasFiles ? '1' : '0.5'; btn.style.cursor = hasFiles ? 'pointer' : 'not-allowed'; btn.disabled = !hasFiles; }\n\n/* ================= 16) STATUS CHECK & BUTTON DISABLE ================= */\nfunction checkStatusAndDisableButtons(obj) {\n  const status = obj?.status || '';\n  const isLetterSent = status.toLowerCase().includes('terkirim');\n  \n  if (isLetterSent) {\n    disableAllButtons();\n    showStatusMessage('Surat telah terkirim');\n  } else {\n    enableAllButtons();\n  }\n}\n\nfunction disableAllButtons() {\n  \n  // Disable specific buttons by ID\n  const specificButtons = [\n    'createSendBtn',    // Tombol kirim surat dan data\n    'editBtn',          // Tombol edit\n    'uploadBtn'         // Tombol upload\n  ];\n  \n  specificButtons.forEach(buttonId => {\n    const button = document.getElementById(buttonId);\n    if (button) {\n      button.disabled = true;\n      button.classList.add('disabled');\n    }\n  });\n  \n  // Disable all buttons with specific onclick functions\n  const functionalButtons = document.querySelectorAll('button[onclick], .btn[onclick]');\n  functionalButtons.forEach(button => {\n    button.disabled = true;\n    button.classList.add('disabled');\n    // Remove click handlers\n    const originalOnclick = button.onclick;\n    button.onclick = function(e) {\n      e.preventDefault();\n      e.stopPropagation();\n      showModal({\n        icon: 'üîí',\n        title: 'Aksi Tidak Tersedia',\n        message: 'Surat telah terkirim. Semua tombol telah dinonaktifkan.',\n        variant: 'info',\n        buttons: [{label: 'Tutup', variant: 'secondary', value: true}]\n      });\n      return false;\n    };\n    button.setAttribute('data-original-onclick', originalOnclick ? originalOnclick.toString() : '');\n  });\n  \n  // Disable all delete document buttons (dynamically created)\n  const deleteDocButtons = document.querySelectorAll('.file-actions .btn.danger');\n  deleteDocButtons.forEach(button => {\n    button.disabled = true;\n    button.classList.add('disabled');\n    button.onclick = function(e) {\n      e.preventDefault();\n      showModal({\n        icon: 'üîí',\n        title: 'Hapus Dokumen Tidak Tersedia',\n        message: 'Surat telah terkirim. Dokumen tidak dapat dihapus.',\n        variant: 'info',\n        buttons: [{label: 'Tutup', variant: 'secondary', value: true}]\n      });\n    };\n  });\n  \n  // Disable file input\n  const fileInput = document.getElementById('fileInput');\n  if (fileInput) {\n    fileInput.disabled = true;\n  }\n  \n  // Disable file upload container drag and drop\n  const uploadContainer = document.querySelector('.file-upload-container');\n  if (uploadContainer) {\n    uploadContainer.style.pointerEvents = 'none';\n    uploadContainer.style.opacity = '0.5';\n    uploadContainer.ondragover = null;\n    uploadContainer.ondragleave = null;\n    uploadContainer.ondrop = null;\n  }\n  \n  // Disable edit mode if active and prevent future edit mode activation\n  if (editMode) {\n    document.body.classList.remove('edit-mode');\n    editMode = false;\n  }\n  \n  // Mark system as disabled to prevent edit mode activation\n  window.systemDisabled = true;\n}\n\nfunction enableAllButtons() {\n  \n  // Enable specific buttons by ID\n  const specificButtons = [\n    'createSendBtn',    // Tombol kirim surat dan data\n    'editBtn',          // Tombol edit\n    'uploadBtn'         // Tombol upload\n  ];\n  \n  specificButtons.forEach(buttonId => {\n    const button = document.getElementById(buttonId);\n    if (button) {\n      button.disabled = false;\n      button.classList.remove('disabled');\n    }\n  });\n  \n  // Enable all buttons and restore original onclick functions\n  const functionalButtons = document.querySelectorAll('button[onclick], .btn[onclick]');\n  functionalButtons.forEach(button => {\n    button.disabled = false;\n    button.classList.remove('disabled');\n    \n    // Restore original onclick if it was saved\n    const originalOnclick = button.getAttribute('data-original-onclick');\n    if (originalOnclick && originalOnclick !== '') {\n      try {\n        button.onclick = new Function(originalOnclick);\n      } catch (e) {\n        // Could not restore original onclick\n      }\n    }\n    button.removeAttribute('data-original-onclick');\n  });\n  \n  // Enable file input\n  const fileInput = document.getElementById('fileInput');\n  if (fileInput) {\n    fileInput.disabled = false;\n  }\n  \n  // Enable file upload container drag and drop\n  const uploadContainer = document.querySelector('.file-upload-container');\n  if (uploadContainer) {\n    uploadContainer.style.pointerEvents = '';\n    uploadContainer.style.opacity = '';\n    uploadContainer.ondragover = handleDragOver;\n    uploadContainer.ondragleave = handleDragLeave;\n    uploadContainer.ondrop = handleDrop;\n  }\n  \n  // Mark system as enabled\n  window.systemDisabled = false;\n}\n\nfunction showStatusMessage(message) {\n  // Create or update status message\n  let statusDiv = document.getElementById('statusMessage');\n  if (!statusDiv) {\n    statusDiv = document.createElement('div');\n    statusDiv.id = 'statusMessage';\n    statusDiv.style.cssText = `\n      background: rgba(34,197,94,.1);\n      border: 1px solid rgba(34,197,94,.35);\n      border-radius: 12px;\n      padding: 12px 14px;\n      margin: 14px 0;\n      font-size: 14px;\n      color: #d1fae5;\n      text-align: center;\n      font-weight: 700;\n      animation: slideIn 0.5s ease-out;\n    `;\n    \n    // Insert after the brand section\n    const topbar = document.querySelector('.topbar');\n    if (topbar && topbar.nextSibling) {\n      topbar.parentNode.insertBefore(statusDiv, topbar.nextSibling);\n    }\n  }\n  \n  statusDiv.innerHTML = `üü¢ ${message}`;\n  statusDiv.style.display = 'block';\n  \n  // Add slide-in animation\n  const style = document.createElement('style');\n  style.textContent = `\n    @keyframes slideIn {\n      from { opacity: 0; transform: translateY(-10px); }\n      to { opacity: 1; transform: translateY(0); }\n    }\n  `;\n  if (!document.querySelector('style[data-status-animation]')) {\n    style.setAttribute('data-status-animation', 'true');\n    document.head.appendChild(style);\n  }\n}\n\n/* ================= 17) START ================= */\nwindow.toggleEditMode=toggleEditMode; window.saveChanges=saveChanges; window.cancelEdit=cancelEdit;\nwindow.uploadFiles=uploadFiles; window.confirmCreateAndSend=confirmCreateAndSend; window.confirmDeleteAll=confirmDeleteAll;\nwindow.handleFileSelect=handleFileSelect; window.handleDragOver=handleDragOver; window.handleDragLeave=handleDragLeave; window.handleDrop=handleDrop;\nwindow.checkStatusAndDisableButtons=checkStatusAndDisableButtons;\n\ndocument.addEventListener('DOMContentLoaded',startRealtime);\n</script>\n\n</body>\n</html>\n"
      },
      "type": "n8n-nodes-base.html",
      "typeVersion": 1.2,
      "position": [
        440,
        160
      ],
      "id": "db996d2e-f693-4101-abcc-cfb33d267267",
      "name": "HTML1"
    },
    {
      "parameters": {
        "jsCode": "/**\n * Generate Payload Surat ‚Äî gabung data form + banyak file Drive\n * Mode   : Run Once for All Items\n * Input  : 1 item Webhook (body.action, body.id_user, body.delete_file_ids, body.data[...])\n * Output : 1 item { json: payload }\n */\n\n/* ===================== Utils ===================== */\nconst clean = (s) => (s ?? '').toString().normalize('NFKC').trim();\nconst lower = (s) => clean(s).toLowerCase();\nconst ensure = (x, f='-') => { const v = clean(x); return v ? v : f; };\n\nconst toNull = (x) => {\n  if (x === undefined || x === null) return null;\n  const v = (typeof x === 'string') ? x.trim() : x;\n  if (v === '' || v === 'undefined' || v === 'null') return null;\n  return v;\n};\n\nconst baseName = (name) => lower((name || '').replace(/\\.[^./\\\\]+$/, ''));\n\nconst safeParseJSON = (maybeJSON) => {\n  try {\n    if (typeof maybeJSON === 'string') return JSON.parse(maybeJSON);\n    if (typeof maybeJSON === 'object' && maybeJSON !== null) return maybeJSON;\n  } catch {}\n  return {};\n};\n\nconst tryParse = (x) => {\n  if (typeof x === 'string') {\n    let s = x;\n    if (/%[0-9A-Fa-f]{2}/.test(x) && (x.includes('%7B') || x.includes('%5B'))) {\n      try { s = decodeURIComponent(x); } catch {}\n    }\n    let obj = safeParseJSON(s);\n    if (typeof obj === 'string') obj = safeParseJSON(obj); // double-stringified\n    return obj;\n  }\n  return safeParseJSON(x);\n};\n\nconst uniqArray = (arr) => Array.from(new Set((arr || []).filter(Boolean)));\nconst firstDefined = (...args) => args.find(v => v !== undefined && v !== null);\n\n/* ===================== Ambil wrapper (body) ===================== */\nconst firstItem = items[0]?.json ?? {};\nconst root = (firstItem && typeof firstItem.body === 'object' && firstItem.body !== null)\n  ? firstItem.body\n  : firstItem;\n\n// Wrapper fields\nconst wrapperAction     = root.action ?? null;\nconst wrapperIdUser     = root.id_user ?? null;\nconst wrapperDeleteIds  = Array.isArray(root.delete_file_ids) ? root.delete_file_ids : [];\nlet   rawData           = root.data ?? null;\n\n/* ===================== Parse data (object/array/string) ===================== */\nlet bodyData = tryParse(rawData);\nif (typeof bodyData !== 'object' || bodyData === null) bodyData = {};\n\nlet bodyArray = null;\nif (Array.isArray(bodyData)) {\n  bodyArray = bodyData;\n  bodyData = bodyData[0] || {};\n}\n\n/* ===================== Action & Delete IDs ===================== */\nconst actionRaw = firstDefined(wrapperAction, bodyData?.action);\nconst action    = toNull(actionRaw) || null;\n\nconst deleteIds = uniqArray(\n  wrapperDeleteIds.concat(Array.isArray(bodyData?.delete_file_ids) ? bodyData.delete_file_ids : [])\n);\nconst deletedSet = new Set(deleteIds);\n\n/* ===================== Kebijakan struktur baru vs lama ===================== */\nlet mdCandidate = bodyData;\nif (bodyData && typeof bodyData.mandatory_data === 'object' && bodyData.mandatory_data !== null) {\n  mdCandidate = bodyData.mandatory_data;\n}\nif (Array.isArray(mdCandidate)) mdCandidate = mdCandidate[0] || {};\nconst md = (typeof mdCandidate === 'object' && mdCandidate !== null) ? mdCandidate : {};\n\n// files_info untuk audit/unggah (tidak dipakai saat DELETE_DOCS untuk mengisi dokumen)\nlet filesInfo = [];\nif (Array.isArray(bodyData.files_info)) filesInfo = bodyData.files_info;\nelse if (Array.isArray(md.files_info)) filesInfo = md.files_info;\nelse if (bodyArray && Array.isArray(bodyArray[0]?.files_info)) filesInfo = bodyArray[0].files_info;\n\n/* ===================== Kolektor dokumen ===================== */\nconst map = new Map();\n\nconst uniqKey = (base) => {\n  let k = base || 'lampiran';\n  if (!map.has(k)) return k;\n  let i = 2;\n  while (map.has(`${k}_${i}`)) i++;\n  return `${k}_${i}`;\n};\nconst put = (key, obj) => map.set(key, Object.assign(map.get(key) || {}, obj));\nconst normKey = (label) => lower(label || 'lampiran').replace(/\\s+/g,'_').replace(/[^a-z0-9_\\-]/g,'');\n\nconst add = (label, obj={}) => {\n  const key = uniqKey(normKey(label || 'lampiran'));\n  put(key, {\n    label: key, file_id:null, download_url:null, view_url:null,\n    name:null, mimeType:null, size:null, iconLink:null, thumbnailLink:null, createdTime:null,\n    ...obj,\n  });\n};\n\n// 1) md.dokumen (DI-FILTER terhadap delete_file_ids)\nif (Array.isArray(md.dokumen)) {\n  for (const d of md.dokumen) {\n    const fid = toNull(d?.file_id);\n    if (fid && deletedSet.has(fid)) continue; // buang yang akan dihapus\n    add(d?.label ?? d?.name ?? 'lampiran', {\n      file_id     : fid,\n      download_url: toNull(d?.download_url),\n      view_url    : toNull(d?.view_url),\n      name        : toNull(d?.name),\n      mimeType    : toNull(d?.mimeType),\n      size        : (Number.isFinite(+d?.size) ? +d.size : null),\n    });\n  }\n}\n\n// 2) files_info ‚Üí HANYA jika BUKAN DELETE_DOCS (hindari muncul lagi saat timpa)\nif (action !== 'DELETE_DOCS') {\n  for (const f of (Array.isArray(filesInfo) ? filesInfo : [])) {\n    const key = uniqKey(baseName(f?.name || 'lampiran'));\n    put(key, {\n      label   : key,\n      name    : toNull(f?.name) ?? null,\n      mimeType: toNull(f?.type) ?? null,\n      size    : (Number.isFinite(+f?.size) ? +f.size : null),\n    });\n  }\n}\n\nconst dokumen = Array.from(map.values());\n\n/* ===================== Normalisasi bidang teks ===================== */\nconst pemohonRaw = md?.pemohon ?? {};\nconst kelurahan  = ensure(toNull(pemohonRaw.kelurahan));\nconst kecamatan  = ensure(toNull(pemohonRaw.kecamatan));\nconst kotaKab    = ensure(toNull(pemohonRaw.kota_kab ?? pemohonRaw.kabupaten));\nconst provinsi   = ensure(toNull(pemohonRaw.provinsi));\n\nlet domisili = toNull(pemohonRaw.domisili);\nif (!domisili) domisili = `${kelurahan}, ${kecamatan}, ${kotaKab}, ${provinsi}`;\n\n/* ===================== Metadata umum (tanpa campur || dan ??) ===================== */\nconst idUserRaw = firstDefined(wrapperIdUser,\n                               (bodyArray && bodyArray[0]) ? bodyArray[0].id_user : undefined,\n                               bodyData?.id_user);\nconst id_user = toNull(idUserRaw);\n\nconst urlWebRaw = firstDefined((bodyArray && bodyArray[0]) ? bodyArray[0].url_web_link : undefined,\n                               bodyData?.url_web_link);\nconst url_web_link = toNull(urlWebRaw);\n\nconst actionInRaw = firstDefined(action,\n                                 (bodyArray && bodyArray[0]) ? bodyArray[0].action : undefined,\n                                 bodyData?.action);\nconst actionIn = toNull(actionInRaw);\n\nconst tsRaw = firstDefined((bodyArray && bodyArray[0]) ? bodyArray[0].timestamp : undefined,\n                           bodyData?.timestamp);\nconst timestamp = toNull(tsRaw);\n\n/* ===================== Payload akhir ===================== */\nconst payload = {\n  jenis_surat   : toNull(md?.jenis_surat),\n  nomor_surat   : toNull(md?.nomor_surat),\n  tanggal_surat : toNull(md?.tanggal_surat),\n\n  pemohon: {\n    nama             : toNull(pemohonRaw?.nama),\n    nik              : toNull(pemohonRaw?.nik),\n    ttl              : toNull(pemohonRaw?.ttl),\n    agama            : toNull(pemohonRaw?.agama),\n    jenis_kelamin    : toNull(pemohonRaw?.jenis_kelamin),\n    status_perkawinan: toNull(pemohonRaw?.status_perkawinan),\n    pekerjaan        : toNull(pemohonRaw?.pekerjaan),\n    alamat           : toNull(pemohonRaw?.alamat),\n    kelurahan, kecamatan,\n    kota_kab         : kotaKab,\n    provinsi,\n    domisili,\n  },\n\n  dokumen, // sudah difilter\n\n  penandatangan: {\n    nama   : toNull(md?.penandatangan?.nama),\n    nip    : toNull(md?.penandatangan?.nip),\n    jabatan: toNull(md?.penandatangan?.jabatan),\n  },\n\n  operator                 : toNull(md?.operator),\n  ref                      : toNull(md?.ref),\n  WAHA_Trigger_session     : toNull(md?.WAHA_Trigger_session),\n  WAHA_Trigger_payload_from: toNull(md?.WAHA_Trigger_payload_from),\n  LogoURL                  : toNull(md?.LogoURL),\n\n  URL_CREATE     : toNull(md?.URL_CREATE),\n  URL_UPDATE     : toNull(md?.URL_UPDATE),\n  URL_DELETE     : toNull(md?.URL_DELETE),\n  URL_UPLOAD     : toNull(md?.URL_UPLOAD),\n  URL_DELETE_FILE: toNull(md?.URL_DELETE_FILE),\n\n  // Metadata\n  id_user,\n  url_web_link,\n  action    : actionIn,\n  timestamp,\n\n  // Audit\n  files_info: Array.isArray(filesInfo) ? filesInfo : [],\n\n  // daftar id file untuk dihapus fisik\n  delete_file_ids: deleteIds,\n};\n\n// console.log({ id_user, actionIn, deleteIds, dokumen_len: dokumen.length });\nreturn [{ json: payload }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -660,
        1420
      ],
      "id": "23ba8db9-8ffe-4b8b-b491-1955b74b6407",
      "name": "Code5"
    },
    {
      "parameters": {
        "operation": "toJson",
        "options": {
          "fileName": "={{ DateTime.now().setZone('Asia/Tokyo').setLocale('id').toFormat('dd_MM_yyyy_HH_mm_ss') + '_' + ($json.pemohon.nama).trim().replace(/\\s+/g,'-').toUpperCase() + '_' + ($json.pemohon.nik) }}\n"
        }
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        -440,
        1420
      ],
      "id": "e16deb67-f7e9-4a88-b070-78cb8fd492c7",
      "name": "Convert to File5"
    },
    {
      "parameters": {
        "operation": "update",
        "fileId": {
          "__rl": true,
          "value": "={{ $('Code5').item.json.id_user }}",
          "mode": "id"
        },
        "changeFileContent": true,
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        -220,
        1420
      ],
      "id": "d83288ef-011c-41a0-b955-0486474c0385",
      "name": "Update file4",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "jyiiyKxh6DOyPVt5",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "method": "DELETE",
        "url": "=https://www.googleapis.com/drive/v3/files/{{ $('Delete file').item.json.body.delete_file_ids[0] }}?supportsAllDrives=true",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "googleOAuth2Api",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        220,
        1420
      ],
      "id": "3549c92b-9f7d-4133-9ef5-995d1d0c460e",
      "name": "Delete File",
      "credentials": {
        "googleOAuth2Api": {
          "id": "L31Mzf4p7TJyr4bB",
          "name": "Google account"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "737cd7f5-bfa1-4b9c-b55a-21aa718bfc3d",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -880,
        3320
      ],
      "id": "0592378a-2658-4698-9d8a-6e4983f97d68",
      "name": "Kirim data",
      "webhookId": "737cd7f5-bfa1-4b9c-b55a-21aa718bfc3d"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "6f618e27-f826-40e5-b7bd-00023db65711",
              "leftValue": "={{ $('Code5').item.json.delete_file_ids[0] }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        0,
        1420
      ],
      "id": "f81386e7-0904-40c5-a071-91698f5389f2",
      "name": "If"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "e1863045-3bfd-497d-b8a3-fc2c7c23eaa7",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -880,
        1420
      ],
      "id": "adba6025-0e13-43e4-b62a-c8986c688497",
      "name": "Delete file",
      "webhookId": "e1863045-3bfd-497d-b8a3-fc2c7c23eaa7"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "d240d7b5-7395-4a13-9b1c-ebd4d6fe4589",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -880,
        2860
      ],
      "id": "32f53b52-742b-471d-959d-4627bb194ba0",
      "name": "Hapus Surat",
      "webhookId": "d240d7b5-7395-4a13-9b1c-ebd4d6fe4589"
    },
    {
      "parameters": {
        "jsCode": "// Input: item tunggal dari Webhook\nconst body = $json.body || {};\nconst data = body.data || {};\n\n// ==== helper: ambil segmen terakhir dari URL / path / string biasa ====\nfunction tailId(v){\n  if (typeof v !== 'string') return '';\n  const s = v.trim();\n  if (!s) return '';\n  try {\n    const u = new URL(s);                      // jika URL valid\n    const parts = u.pathname.split('/').filter(Boolean);\n    return parts.length ? parts[parts.length - 1] : s;\n  } catch {\n    // jika bukan URL valid, fallback: split '/' biasa\n    const parts = s.split('/').filter(Boolean);\n    return parts.length ? parts[parts.length - 1] : s;\n  }\n}\n\n// 1) id_user\nconst idUser = (data.id_user || body.id_user || '').trim();\n\n// 2) id_surat ‚Üí ambil ID belakang link\nconst idSuratRaw = data.id_surat || body.id_surat || '';\nconst idSurat    = tailId(idSuratRaw);\n\n// 3) file_id dari dokumen\nconst fromDocs = Array.isArray(data.dokumen)\n  ? data.dokumen.map(d => d?.file_id)\n  : [];\n\n// 4) delete_file_ids (jika ada)\nconst explicit = Array.isArray(data.delete_file_ids)\n  ? data.delete_file_ids\n  : [];\n\n// 5) gabungkan semua sumber + bersihkan\nconst allIds = []\n  .concat(idUser, idSurat, explicit, fromDocs)\n  .filter(x => typeof x === 'string' && x.trim().length > 0);\n\n// 6) unik\nconst uniq = [...new Set(allIds.map(x => x.trim()))];\n\n// 7) keluarkan sebagai array items n8n\nreturn uniq.map(id => ({ json: { fileId: id } }));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -660,
        2860
      ],
      "id": "bdc007f6-f622-4899-8355-2f52da372198",
      "name": "Code4"
    },
    {
      "parameters": {
        "method": "DELETE",
        "url": "=https://www.googleapis.com/drive/v3/files/{{ $json.fileId }}\n?supportsAllDrives=true",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "googleOAuth2Api",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -440,
        2860
      ],
      "id": "6f3d5925-2739-4f65-bd9a-421cd3dd0d66",
      "name": "Hapus Semua",
      "credentials": {
        "googleOAuth2Api": {
          "id": "L31Mzf4p7TJyr4bB",
          "name": "Google account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://n8n-qz8tp6856ibc.bgxy.sumopod.my.id/webhook/5af2b097-ff31-46e8-86d8-1dcb4800c60b",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "name_file",
              "value": "={{ (Date.now().toString(36) + Math.random().toString(36).slice(2,6)).toUpperCase() }}\n"
            },
            {
              "name": "session_waha",
              "value": "KaweNia"
            },
            {
              "name": "id_waha",
              "value": "=6285230047347@c.us"
            },
            {
              "name": "Nama",
              "value": "={{ $('Merge2').item.json.data[0].pemohon.nama }}"
            },
            {
              "name": "NIK",
              "value": "={{ $('Merge2').item.json.data[0].pemohon.nik }}"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "=text/html; charset=utf-8",
        "body": "={{ $json.html }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1540,
        3320
      ],
      "id": "45ac577e-fc6f-417a-8c54-6fca5b4a8e93",
      "name": "HTTP Request1"
    },
    {
      "parameters": {
        "jsCode": "/**\n * Generate Payload Surat ‚Äî TANPA menyertakan isi dokumen\n * + Tambah id_surat (ekstrak segmen terakhir bila berupa URL)\n * Mode   : Run Once for All Items\n * Input  : 1 item Webhook (seluruh field ada di body)\n * Output : 1 item { json: payload } ‚Äî tanpa property \"dokumen\"\n */\n\n/* ===================== Utils ===================== */\nconst clean = (s) => (s ?? '').toString().normalize('NFKC').trim();\nconst lower = (s) => clean(s).toLowerCase();\nconst ensure = (x, f='-') => { const v = clean(x); return v ? v : f; };\n\nconst toNull = (x) => {\n  if (x === undefined || x === null) return null;\n  const v = (typeof x === 'string') ? x.trim() : x;\n  if (v === '' || v === 'undefined' || v === 'null') return null;\n  return v;\n};\n\nconst safeParseJSON = (maybeJSON) => {\n  try {\n    if (typeof maybeJSON === 'string') return JSON.parse(maybeJSON);\n    if (typeof maybeJSON === 'object' && maybeJSON !== null) return maybeJSON;\n  } catch {}\n  return {};\n};\n\nconst tryParse = (x) => {\n  if (typeof x === 'string') {\n    let s = x;\n    if (/%[0-9A-Fa-f]{2}/.test(x) && (x.includes('%7B') || x.includes('%5B'))) {\n      try { s = decodeURIComponent(x); } catch {}\n    }\n    let obj = safeParseJSON(s);\n    if (typeof obj === 'string') obj = safeParseJSON(obj); // double-stringified\n    return obj;\n  }\n  return safeParseJSON(x);\n};\n\nconst uniqArray = (arr) => Array.from(new Set((arr || []).filter(Boolean)));\nconst firstDefined = (...args) => args.find(v => v !== undefined && v !== null);\nconst hasKeys = (o) => o && typeof o === 'object' && Object.keys(o).length > 0;\n\n/* Ambil segmen terakhir dari URL/path/string biasa */\nconst tailId = (v) => {\n  const s = toNull(v);\n  if (!s) return null;\n  try {\n    const u = new URL(s);\n    const parts = u.pathname.split('/').filter(Boolean);\n    return parts.length ? parts[parts.length - 1] : s;\n  } catch {\n    const parts = s.split('/').filter(Boolean);\n    return parts.length ? parts[parts.length - 1] : s;\n  }\n};\n\n/* ===================== Ambil wrapper (body) ===================== */\nconst firstItem = items[0]?.json ?? {};\nconst root      = (firstItem && typeof firstItem.body === 'object' && firstItem.body !== null)\n  ? firstItem.body\n  : firstItem;\n\n/* ===================== Compat: struktur lama (data/mandatory_data) vs baru (langsung di body) ===================== */\nconst rawData   = root.data ?? null;                 // bisa null\nlet   bodyData  = tryParse(rawData);\nif (!hasKeys(bodyData)) bodyData = {};               // objek kosong jika tak ada\n\n// Kandidat ‚Äúmaster data‚Äù (md): prioritas data.mandatory_data ‚Üí data ‚Üí body (root)\nlet md = null;\nif (hasKeys(bodyData?.mandatory_data)) md = bodyData.mandatory_data;\nelse if (hasKeys(bodyData))            md = bodyData;\nelse                                    md = root;  // fallback\n\n/* ===================== Action, Delete IDs, files_info ===================== */\nconst wrapperAction = root.action ?? null;\nconst wrapperIdUser = root.id_user ?? null;\n\nconst deleteIds = uniqArray([\n  ...(Array.isArray(root.delete_file_ids) ? root.delete_file_ids : []),\n  ...(Array.isArray(bodyData.delete_file_ids) ? bodyData.delete_file_ids : []),\n]);\n\nlet filesInfo = [];\nif (Array.isArray(bodyData.files_info)) filesInfo = bodyData.files_info;\nelse if (Array.isArray(md.files_info))  filesInfo = md.files_info;\nelse if (Array.isArray(root.files_info)) filesInfo = root.files_info;\n\n/* ===================== Normalisasi bidang teks ===================== */\nconst pemohonRaw = hasKeys(md?.pemohon) ? md.pemohon\n                 : hasKeys(root?.pemohon) ? root.pemohon\n                 : {};\nconst kelurahan  = ensure(toNull(pemohonRaw.kelurahan));\nconst kecamatan  = ensure(toNull(pemohonRaw.kecamatan));\nconst kotaKab    = ensure(toNull(pemohonRaw.kota_kab ?? pemohonRaw.kabupaten));\nconst provinsi   = ensure(toNull(pemohonRaw.provinsi));\n\nlet domisili = toNull(pemohonRaw.domisili);\nif (!domisili) domisili = `${kelurahan}, ${kecamatan}, ${kotaKab}, ${provinsi}`;\n\n/* ===================== Metadata umum ===================== */\nconst id_user      = toNull(firstDefined(wrapperIdUser, bodyData?.id_user, md?.id_user, root?.id_user));\nconst url_web_link = toNull(firstDefined(bodyData?.url_web_link, md?.url_web_link, root?.url_web_link));\nconst timestamp    = toNull(firstDefined(bodyData?.timestamp, md?.timestamp, root?.timestamp));\nconst actionIn     = toNull(firstDefined(wrapperAction, bodyData?.action, md?.action));\n\n/* ====== NEW: id_surat_raw & id_surat (tail) ====== */\nconst id_surat_raw = toNull(firstDefined(root?.id_surat, md?.id_surat, url_web_link));\nconst id_surat     = tailId(id_surat_raw);\n\n/* ===================== Payload akhir (TANPA dokumen) ===================== */\nconst payload = {\n  // Header surat\n  jenis_surat  : toNull(firstDefined(md?.jenis_surat,  root?.jenis_surat)),\n  nomor_surat  : toNull(firstDefined(md?.nomor_surat,  root?.nomor_surat)),\n  tanggal_surat: toNull(firstDefined(md?.tanggal_surat,root?.tanggal_surat)),\n\n  // Pemohon\n  pemohon: {\n    nama             : toNull(pemohonRaw?.nama),\n    nik              : toNull(pemohonRaw?.nik),\n    ttl              : toNull(pemohonRaw?.ttl),\n    agama            : toNull(pemohonRaw?.agama),\n    jenis_kelamin    : toNull(pemohonRaw?.jenis_kelamin),\n    status_perkawinan: toNull(pemohonRaw?.status_perkawinan),\n    pekerjaan        : toNull(pemohonRaw?.pekerjaan),\n    alamat           : toNull(pemohonRaw?.alamat),\n    kelurahan, kecamatan,\n    kota_kab         : kotaKab,\n    provinsi,\n    domisili,\n  },\n\n  // Penandatangan\n  penandatangan: {\n    nama   : toNull(firstDefined(md?.penandatangan?.nama,   root?.penandatangan?.nama)),\n    nip    : toNull(firstDefined(md?.penandatangan?.nip,    root?.penandatangan?.nip)),\n    jabatan: toNull(firstDefined(md?.penandatangan?.jabatan,root?.penandatangan?.jabatan)),\n  },\n\n  // Lain-lain\n  operator                 : toNull(firstDefined(md?.operator,  root?.operator)),\n  ref                      : toNull(firstDefined(md?.ref,       root?.ref)),\n  WAHA_Trigger_session     : toNull(firstDefined(md?.WAHA_Trigger_session,      root?.WAHA_Trigger_session)),\n  WAHA_Trigger_payload_from: toNull(firstDefined(md?.WAHA_Trigger_payload_from,  root?.WAHA_Trigger_payload_from)),\n  LogoURL                  : toNull(firstDefined(md?.LogoURL,   root?.LogoURL)),\n\n  // Endpoints\n  URL_CREATE     : toNull(firstDefined(md?.URL_CREATE,     root?.URL_CREATE)),\n  URL_UPDATE     : toNull(firstDefined(md?.URL_UPDATE,     root?.URL_UPDATE)),\n  URL_DELETE     : toNull(firstDefined(md?.URL_DELETE,     root?.URL_DELETE)),\n  URL_UPLOAD     : toNull(firstDefined(md?.URL_UPLOAD,     root?.URL_UPLOAD)),\n  URL_DELETE_FILE: toNull(firstDefined(md?.URL_DELETE_FILE,root?.URL_DELETE_FILE)),\n\n  // Metadata\n  id_user,\n  id_surat_raw,   // jejak asli (bisa URL atau ID)\n  id_surat,       // hasil ekstraksi (segmen terakhir)\n  url_web_link,\n  action    : actionIn,\n  timestamp,\n\n  // Audit (opsional disertakan)\n  files_info: Array.isArray(filesInfo) ? filesInfo : [],\n\n  // daftar id file untuk dihapus fisik (tanpa mengirim detail dokumen)\n  delete_file_ids: deleteIds,\n};\n\n// Tidak ada property \"dokumen\" di payload\nreturn [{ json: payload }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        0,
        3120
      ],
      "id": "d4de84b5-3fd6-4909-8b7f-ee9c103f725f",
      "name": "Code6"
    },
    {
      "parameters": {
        "operation": "toJson",
        "options": {
          "fileName": "={{ \n  DateTime.now()\n    .setZone('Asia/Tokyo')\n    .setLocale('id')\n    .toFormat('dd_MM_yyyy_HH_mm_ss')\n    + '_' \n    + ($json.pemohon.nama || '')\n        .trim()\n        .replace(/\\s+/g, '-')\n        .toUpperCase() \n    + '_' \n    + ($json.pemohon.nik || '') \n}}\n"
        }
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        660,
        3320
      ],
      "id": "e1f572f5-1ec9-4a2f-9d95-66bdd9c0ced5",
      "name": "Convert to File2"
    },
    {
      "parameters": {
        "driveId": {
          "__rl": true,
          "mode": "list",
          "value": "My Drive"
        },
        "folderId": {
          "__rl": true,
          "value": "1ufqBzk2QQ6MYnMU2cSzG3mqoab-JCP_Z",
          "mode": "list",
          "cachedResultName": "Create Surat Keterangan Tidak Mampu",
          "cachedResultUrl": "https://drive.google.com/drive/folders/1ufqBzk2QQ6MYnMU2cSzG3mqoab-JCP_Z"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        880,
        3420
      ],
      "id": "e958ba62-d329-4223-90ff-d27350e0bcd4",
      "name": "Upload file3",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "jyiiyKxh6DOyPVt5",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "operation": "fromJson",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        880,
        3220
      ],
      "id": "c216a56c-9a66-472e-86ff-6af9ddb1b937",
      "name": "Extract from File2"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        1100,
        3320
      ],
      "id": "bfd8ab80-17ec-423a-b9da-2f7f5a12213a",
      "name": "Merge2"
    },
    {
      "parameters": {
        "html": "<!doctype html>\n<html lang=\"id\">\n<head>\n  <meta charset=\"utf-8\" />\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\n  <title>Kawe Nia ‚Ä¢ Layanan SKTM</title>\n  <style>\n    :root{\n      --bg:#0b1020; --panel:#0f172a; --ink:#e5e7eb; --muted:#9ca3af;\n      --accent:#22c55e; --accent-2:#38bdf8; --line:#1f2937;\n      --danger:#ef4444; --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.35);\n      --space:clamp(14px,2.4vw,22px);\n      --modal-radius:10px;\n      --modal-bg:#111827;\n      --modal-border:rgba(148,163,184,.45);\n      --overlay:rgba(0,0,0,.72);\n    }\n    *{box-sizing:border-box} html,body{height:100%}\n    body{\n      margin:0; color:var(--ink);\n      font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial,\"Apple Color Emoji\",\"Segoe UI Emoji\";\n      background:#0a0e1a; min-height:100svh;\n    }\n    .bg{position:fixed; inset:0; z-index:-1; pointer-events:none;\n      background:\n        radial-gradient(1400px 800px at 20% -10%, #16223f 0%, transparent 60%),\n        radial-gradient(1200px 700px at 90% -20%, rgba(56,189,248,.15) 0%, transparent 60%),\n        linear-gradient(145deg,#0a0e1a,#0f1933 55%,#0a0e1a);\n      background-attachment:fixed,fixed,fixed;}\n    body,body *{min-width:0; overflow-wrap:anywhere; word-break:break-word; white-space:normal}\n    .wrap{max-width:1100px;margin:40px auto;padding:0 20px}\n    .topbar{display:flex;align-items:center;gap:16px;margin-bottom:18px}\n    .brand{display:flex;align-items:center;gap:12px;min-width:0}\n    .brand img.logo{\n      width:120px; aspect-ratio:1/1; object-fit:contain; background:#0f172a; border-radius:12px; display:block;\n      box-shadow: inset 0 0 0 1px rgba(148,163,184,.35), 0 0 6px rgba(0,0,0,.35);\n    }\n    .brand .title{font-weight:700;font-size:clamp(16px,2.4vw,20px)}\n    .brand .sub{font-size:12px;color:var(--muted)}\n    .pill{margin-left:auto;display:flex;gap:8px;align-items:center;font-size:12px;color:#cbd5e1;\n      background:linear-gradient(180deg,rgba(56,189,248,.2),rgba(34,197,94,.15));\n      border:1px solid rgba(148,163,184,.3);padding:6px 10px;border-radius:999px;flex-shrink:0;}\n    .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.02));\n      border:1px solid rgba(148,163,184,.2); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden}\n    .card-header{display:flex;flex-wrap:wrap;gap:14px;align-items:center;justify-content:space-between;\n      padding:clamp(14px,2.2vw,20px) var(--space);\n      background:radial-gradient(800px 300px at 10% -20%, rgba(56,189,248,.15), transparent 60%),\n                 radial-gradient(600px 300px at 90% -30%, rgba(34,197,94,.18), transparent 55%);\n      border-bottom:1px solid rgba(148,163,184,.2)}\n    .hgroup{display:flex;flex-direction:column;gap:8px;min-width:0;margin-bottom:4px}\n    .h1{font-size:clamp(18px,2.8vw,26px);font-weight:800;letter-spacing:.3px;margin-bottom:2px}\n    .h2{font-size:13px;color:var(--muted);margin-top:2px}\n    .badges{display:flex;gap:8px;flex-wrap:wrap;min-width:0;margin-top:6px}\n    .badge{font-size:12px;padding:6px 10px;border-radius:999px;background:#0b1224;border:1px solid rgba(148,163,184,.26)}\n    .badge.info{border-color:rgba(56,189,248,.45);background:rgba(56,189,248,.12);color:#cffafe}\n    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:0;min-height:360px}\n    @media (max-width:960px){.grid{grid-template-columns:1fr}.side{background:transparent}.panel{border-right:none}}\n    .panel{padding:var(--space);border-right:1px solid rgba(148,163,184,.16)} .panel:last-child{border-right:none}\n    .stitle{font-size:13px;letter-spacing:.4px;text-transform:uppercase;color:#a5b4fc;font-weight:700;margin-bottom:10px}\n    .ident{display:grid; grid-template-columns:160px 10px 1fr; gap:6px 10px; align-items:start; font-size:14px;\n      background:rgba(15,23,42,.55); border:1px solid rgba(148,163,184,.15); border-radius:14px; padding:10px 12px}\n    @media (max-width:560px){ .ident{grid-template-columns:110px 8px 1fr} }\n    .lab{color:#cbd5e1} .sep{color:#475569} .val{color:#e5e7eb;font-weight:600;line-height:1.45}\n    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,\"Liberation Mono\",\"Courier New\",monospace}\n    .side{display:flex;flex-direction:column;gap:14px;padding:var(--space);\n      background:linear-gradient(180deg,rgba(2,6,23,.35),rgba(2,6,23,.15))}\n    .callout{border:1px solid rgba(56,189,248,.35);background:rgba(56,189,248,.1);border-radius:14px;padding:12px 14px;font-size:13px;color:#e0f2fe}\n    .actions{display:flex;flex-wrap:wrap;gap:10px}\n    .btn{appearance:none;border:none;cursor:pointer;font-weight:700;letter-spacing:.3px;\n      background:#0b1224;color:var(--ink);padding:10px 14px;border-radius:12px;border:1px solid rgba(148,163,184,.3);\n      display:inline-flex; align-items:center; gap:8px; justify-content:center;}\n    a.btn, a.btn:link, a.btn:visited { text-decoration:none; color:inherit; }\n    a.btn:hover, a.btn:focus { text-decoration:none; }\n    .btn.primary,.btn.success{background:linear-gradient(180deg,rgba(34,197,94,.95),rgba(16,185,129,.95));border-color:rgba(16,185,129,.95);color:#052e1a!important}\n    .btn.secondary{background:linear-gradient(180deg,rgba(56,189,248,.9),rgba(59,130,246,.9));border-color:rgba(96,165,250,.95);color:#06293a!important}\n    .btn.ghost{background:transparent}\n    .btn.danger{background:linear-gradient(180deg,rgba(239,68,68,.95),rgba(220,38,38,.95));border-color:rgba(220,38,38,.95);color:#fef2f2!important}\n    .btn:active{transform:translateY(1px)}\n    .uploaded-files-container{background:rgba(15,23,42,.55);border:1px solid rgba(148,163,184,.15);border-radius:14px;padding:14px;min-height:60px}\n    .no-files-message{color:#9ca3af;font-size:13px;text-align:center;font-style:italic}\n    .uploaded-file-item{display:flex;flex-direction:column;gap:8px;padding:10px 12px;background:rgba(34,197,94,.06);\n      border:1px solid rgba(34,197,94,.25);border-radius:12px;margin-bottom:8px}\n    .file-name{color:#d1fae5;font-weight:700;line-height:1.35}\n    .file-meta{color:#a5b4fc;font-size:12px}\n    .file-actions{display:flex;flex-wrap:wrap;gap:8px;margin-top:4px}\n    .file-actions .btn{padding:6px 10px;border-radius:10px}\n    .note-box{background:rgba(15,23,42,.55);border:1px solid rgba(148,163,184,.15);border-radius:14px;padding:12px 14px}\n    .note-input{width:100%;min-height:110px;resize:vertical;color:#e5e7eb;font-size:14px;line-height:1.6;\n      background:#0e162b;border:1px solid rgba(56,189,248,.35);border-radius:12px;padding:12px 14px;box-shadow:inset 0 0 0 1px rgba(56,189,248,.15)}\n    .note-input::placeholder{color:#94a3b8}\n    .card-footer{display:flex;gap:14px;justify-content:space-between;align-items:center;\n      padding:12px var(--space);border-top:1px solid rgba(148,163,184,.2);color:var(--muted);font-size:12px}\n    .modal-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:1000;background:var(--overlay)}\n    .modal{width:min(480px,92vw);border-radius:var(--modal-radius);background:var(--modal-bg);\n      border:1px solid var(--modal-border);box-shadow:0 18px 50px rgba(0,0,0,.55);padding:18px 18px}\n    .modal-header{display:flex;gap:10px;align-items:center;margin-bottom:8px}\n    .modal-icon{font-size:28px}\n    .modal-title{font-weight:800;font-size:18px;letter-spacing:.3px}\n    .modal-message{color:#cbd5e1;line-height:1.7;margin:8px 0 16px;font-size:14px}\n    .modal-actions{display:flex;gap:10px;justify-content:flex-end}\n    .modal .btn{border-radius:10px;padding:10px 14px}\n    .modal--info{box-shadow:inset 4px 0 0 0 #38bdf8, 0 18px 50px rgba(0,0,0,.55)}\n    .modal--success{box-shadow:inset 4px 0 0 0 #22c55e, 0 18px 50px rgba(0,0,0,.55)}\n    .modal--confirm{box-shadow:inset 4px 0 0 0 #f59e0b, 0 18px 50px rgba(0,0,0,.55)}\n    .modal--danger{box-shadow:inset 4px 0 0 0 #ef4444, 0 18px 50px rgba(0,0,0,.55)}\n    .loading-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:900;background:rgba(2,6,23,.75)}\n    .loading-box{display:flex;flex-direction:column;align-items:center;gap:14px;padding:22px;border-radius:12px;border:1px solid rgba(148,163,184,.35);background:#0f172a}\n    .spinner{width:52px;height:52px;border-radius:50%;border:4px solid rgba(148,163,184,.35);border-top-color:#22c55e;animation:spin 1s linear infinite}\n    @keyframes spin{to{transform:rotate(360deg)}}\n    .loading-text{font-size:14px;color:#e5e7eb}\n    @media print{.side{display:none} body{background:#fff} .card{border:none;box-shadow:none} .pill,.modal-overlay,.loading-overlay{display:none!important}}\n  </style>\n</head>\n<body>\n  <div class=\"bg\" aria-hidden=\"true\"></div>\n\n  <div class=\"wrap\">\n    <div class=\"topbar\">\n      <div class=\"brand\">\n        <img class=\"logo\" id=\"LogoURL\" src=\"\" alt=\"Lambang Kabupaten\">\n        <div>\n          <div class=\"title\">Kawe Nia ‚Ä¢ Pelayanan Masyarakat</div>\n          <div class=\"sub\">Distrik Wania, Kabupaten Mimika</div>\n        </div>\n      </div>\n      <div class=\"pill\">üü¢ Layanan aktif ‚Ä¢ 24/7</div>\n    </div>\n\n    <section class=\"card\" role=\"region\" aria-label=\"Layanan SKTM\">\n      <header class=\"card-header\">\n        <div class=\"hgroup\">\n          <div class=\"h1\" id=\"jenis_surat\"></div>\n          <div class=\"h2\">Nomor: <span class=\"mono\" id=\"nomor_surat\"></span></div>\n        </div>\n        <div class=\"badges\"><span class=\"badge info\">Status: Menunggu Tanda Tangan</span></div>\n      </header>\n\n      <div class=\"grid\">\n        <div class=\"panel\">\n          <div class=\"stitle\">Data Pemohon</div>\n          <div class=\"ident\" aria-label=\"Identitas Pemohon\">\n            <div class=\"lab\">Nama</div><div class=\"sep\">:</div><div class=\"val\" id=\"nama\"></div>\n            <div class=\"lab\">NIK</div><div class=\"sep\">:</div><div class=\"val mono\" id=\"nik\"></div>\n            <div class=\"lab\">Tempat/Tgl Lahir</div><div class=\"sep\">:</div><div class=\"val\" id=\"ttl\"></div>\n            <div class=\"lab\">Agama</div><div class=\"sep\">:</div><div class=\"val\" id=\"agama\"></div>\n            <div class=\"lab\">Jenis Kelamin</div><div class=\"sep\">:</div><div class=\"val\" id=\"jenis_kelamin\"></div>\n            <div class=\"lab\">Status Perkawinan</div><div class=\"sep\">:</div><div class=\"val\" id=\"status_perkawinan\"></div>\n            <div class=\"lab\">Pekerjaan</div><div class=\"sep\">:</div><div class=\"val\" id=\"pekerjaan\"></div>\n            <div class=\"lab\">Alamat</div><div class=\"sep\">:</div><div class=\"val\" id=\"alamat\"></div>\n            <div class=\"lab\">Kelurahan</div><div class=\"sep\">:</div><div class=\"val\" id=\"kelurahan\"></div>\n            <div class=\"lab\">Kecamatan</div><div class=\"sep\">:</div><div class=\"val\" id=\"kecamatan\"></div>\n            <div class=\"lab\">Kota/Kabupaten</div><div class=\"sep\">:</div><div class=\"val\" id=\"kota_kab\"></div>\n            <div class=\"lab\">Provinsi</div><div class=\"sep\">:</div><div class=\"val\" id=\"provinsi\"></div>\n          </div>\n\n          <div class=\"stitle\" style=\"margin-top:16px\">File Terupload</div>\n          <div class=\"uploaded-files-container\">\n            <div id=\"uploadedFilesList\"><div class=\"no-files-message\">Belum ada file yang diupload</div></div>\n          </div>\n\n          <div class=\"stitle\" style=\"margin-top:16px\">Keterangan</div>\n          <div class=\"uploaded-files-container\" style=\"margin-bottom:16px;line-height:1.6;font-size:14px\">\n            <div style=\"margin-bottom:8px\">1. Tersebut namanya di atas adalah benar-benar penduduk <strong id=\"keterangan_kelurahan\"></strong>.</div>\n            <div style=\"margin-bottom:8px\">2. Tersebut namanya di atas adalah benar-berstatus ekonomi lemah yang tidak mampu menebus atau membayar biaya pengobatan <strong>BPJS / KIS</strong>.</div>\n            <div style=\"margin-bottom:8px\">3. Mohon surat keterangan ini digunakan sebagaimana mestinya.</div>\n            <div style=\"margin-top:12px;font-style:italic\">Demikian surat keterangan tidak mampu ini kami buat untuk dapat digunakan sebagaimana mestinya.</div>\n          </div>\n\n          <div class=\"stitle\" style=\"margin-top:16px\">Catatan Kepala Distrik</div>\n          <div class=\"note-box\" style=\"margin-bottom:16px\">\n            <textarea id=\"noteText\" class=\"note-input\" placeholder=\"Tulis catatan atau instruksi untuk pemohon (wajib saat Minta Perbaikan / Tolak)‚Ä¶\"></textarea>\n            <div style=\"display:flex;justify-content:flex-end;margin-top:10px\">\n              <button class=\"btn secondary\" onclick=\"sendNote()\">üì® Kirim Pesan</button>\n            </div>\n          </div>\n        </div>\n\n        <aside class=\"side\">\n          <div class=\"stitle\">Tindakan</div>\n          <div class=\"actions\">\n            <button class=\"btn primary\" onclick=\"confirmCreateAndSend()\">‚úÖ Setujui & TTD</button>\n            <button class=\"btn danger\" onclick=\"confirmDeleteAll()\">‚õî Tolak & Hapus</button>\n          </div>\n\n          <div class=\"stitle\" style=\"margin-top:10px\">Ringkasan</div>\n          <div class=\"callout\">\n            <div><b>üë§ Operator:</b> <span id=\"operator\"></span></div>\n            <div><b>üìÖ Tanggal:</b> <span id=\"tanggal_surat\"></span></div>\n            <div><b>üîó Referensi:</b> <span id=\"ref\"></span></div>\n            <div><b>üß≠ From:</b> <span id=\"WAHA_Trigger_payload_from\"></span></div>\n          </div>\n        </aside>\n      </div>\n\n      <footer class=\"card-footer\">\n        <div>¬© <span id=\"tahun\"></span> Pemerintah Distrik Wania ‚Ä¢ Kawe Nia</div>\n      </footer>\n    </section>\n  </div>\n\n  <div class=\"loading-overlay\" id=\"loadingOverlay\" aria-live=\"polite\" aria-busy=\"true\">\n    <div class=\"loading-box\">\n      <div class=\"spinner\" aria-hidden=\"true\"></div>\n      <div class=\"loading-text\" id=\"loadingText\">Memuat data‚Ä¶ Mohon menunggu.</div>\n    </div>\n  </div>\n\n  <div class=\"modal-overlay\" id=\"modalOverlay\" role=\"dialog\" aria-modal=\"true\">\n    <div class=\"modal modal--info\" id=\"modalBox\" role=\"document\">\n      <div class=\"modal-header\">\n        <div class=\"modal-icon\" id=\"modalIcon\">‚ÑπÔ∏è</div>\n        <div class=\"modal-title\" id=\"modalTitle\">Informasi</div>\n      </div>\n      <div class=\"modal-message\" id=\"modalMessage\">Pesan‚Ä¶</div>\n      <div class=\"modal-actions\" id=\"modalActions\"></div>\n    </div>\n  </div>\n\n<script>\n/* ===== Webhook Endpoints ===== */\nconst WEBHOOK_CREATE='https://n8n-qz8tp6856ibc.bgxy.sumopod.my.id/webhook/1e87058d-af1d-4cf2-918e-93e7682dda01';\nconst WEBHOOK_UPDATE='https://n8n-qz8tp6856ibc.bgxy.sumopod.my.id/webhook/e1863045-3bfd-497d-b8a3-fc2c7c23eaa7';\nconst WEBHOOK_UPLOAD='https://n8n-qz8tp6856ibc.bgxy.sumopod.my.id/webhook/1ae8a1a1-9f9d-4792-8505-9c84e1d3654b';\nconst WEBHOOK_DELETE='https://n8n-qz8tp6856ibc.bgxy.sumopod.my.id/webhook/d240d7b5-7395-4a13-9b1c-ebd4d6fe4589';\n/* === Permintaan khusus: const PESAN untuk kirim pesan === */\nconst PESAN='https://n8n-qz8tp6856ibc.bgxy.sumopod.my.id/webhook/646a0ac9-0b1c-4283-ae20-fe42f0ad4384';\n\nconst UPDATE_STRATEGY='OVERWRITE_BIN';\nconst POLL_MS=500;\n\n/* ===== ID & JSON Source ===== */\nconst ID_USER_RAW=\"{{ $json.id }}\";\nfunction resolveIdUser(){\n  if(/\\{\\{\\s*\\$json\\.id\\s*\\}\\}/.test(ID_USER_RAW)){\n    const u=new URL(location.href);\n    const q=u.searchParams.get('id'); if(q) return q.trim();\n    const segs=u.pathname.split('/').filter(Boolean); if(segs.length) return segs[segs.length-1];\n    return \"\";\n  }\n  return (ID_USER_RAW||\"\").trim();\n}\nconst ID_USER=resolveIdUser();\nconst JSON_URL=ID_USER?(\"https://distrikwania.com/data/\"+encodeURIComponent(ID_USER)):\"\";\n\n/* ===== Utils ===== */\nconst $=id=>document.getElementById(id);\nconst toStr=(x,fb='-')=>{const v=(x??'').toString().trim();return v.length?v:fb;}\nconst isJSONResponse=res=>(res.headers.get('content-type')||'').toLowerCase().includes('application/json');\nasync function hashText(txt){const buf=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(txt));return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');}\nfunction pickObj(root){if(!root)return{}; if(Array.isArray(root?.data)&&root.data[0])return root.data[0]; if(Array.isArray(root)&&root[0])return root[0]; return root;}\nfunction humanSize(bytes){if(!bytes&&bytes!==0)return null; const u=['B','KB','MB','GB']; let i=0, n=Number(bytes); while(n>=1024&&i<u.length-1){n/=1024;i++} return (Math.round(n*10)/10)+' '+u[i];}\n\n/* ===== State ===== */\nlet lastJSON=null,lastObj={},lastHash=null;\nlet pollHandle=null, firstLoadDone=false;\n\n/* ===== View Map ===== */\nconst VIEW={\n  logo:$('LogoURL'),jenis_surat:$('jenis_surat'),nomor_surat:$('nomor_surat'),\n  operator:$('operator'),tanggal_surat:$('tanggal_surat'),ref:$('ref'),from:$('WAHA_Trigger_payload_from'),tahun:$('tahun'),\n  nama:$('nama'),nik:$('nik'),ttl:$('ttl'),agama:$('agama'),jenis_kelamin:$('jenis_kelamin'),status_perkawinan:$('status_perkawinan'),\n  pekerjaan:$('pekerjaan'),alamat:$('alamat'),kelurahan:$('kelurahan'),kecamatan:$('kecamatan'),kota_kab:$('kota_kab'),provinsi:$('provinsi'),\n  ket_kel:$('keterangan_kelurahan'),filesList:$('uploadedFilesList')\n};\n\n/* ===== Render ===== */\nfunction renderStatic(){ if(VIEW.tahun) VIEW.tahun.textContent=String(new Date().getFullYear()); }\nfunction normalizeDocs(docs){\n  const arr=Array.isArray(docs)?docs.filter(Boolean):[];\n  const seen=new Set(); const out=[];\n  for(const d of arr){\n    const fid=d?.file_id||d?.id||d?.fileId||null;\n    const hasUrl=!!(d?.view_url||d?.download_url);\n    if(!fid && !hasUrl) continue;\n    const key=fid?`fid:${fid}`:`name:${(d?.name||'').toLowerCase()}|size:${d?.size||0}`;\n    if(seen.has(key)) continue; seen.add(key);\n    out.push({\n      label:d?.label??d?.name??'-',\n      name:d?.name??d?.label??'-',\n      file_id:fid,\n      view_url:d?.view_url??null,\n      download_url:d?.download_url??(d?.view_url??null),\n      size:d?.size??null,\n      mimeType:d?.mimeType??d?.mime??null\n    });\n  }\n  return out;\n}\nfunction renderFiles(obj){\n  const wrap=VIEW.filesList; if(!wrap) return;\n  const docs=normalizeDocs(obj?.dokumen);\n  wrap.innerHTML='';\n  if(!docs.length){\n    const div=document.createElement('div'); div.className='no-files-message'; div.textContent='Belum ada file yang diupload'; wrap.appendChild(div); return;\n  }\n  docs.forEach(d=>{\n    const row=document.createElement('div'); row.className='uploaded-file-item';\n    const nameEl=document.createElement('div'); nameEl.className='file-name'; nameEl.textContent=toStr(d.name,'(tanpa nama)'); row.appendChild(nameEl);\n    const metaParts=[]; if(d.size!=null) metaParts.push('Ukuran: '+humanSize(d.size)); if(d.mimeType) metaParts.push(d.mimeType);\n    const metaEl=document.createElement('div'); metaEl.className='file-meta'; metaEl.textContent=metaParts.join(' ‚Ä¢ ')||'‚Äî'; row.appendChild(metaEl);\n    const act=document.createElement('div'); act.className='file-actions';\n    if(d.view_url){ const a=document.createElement('a'); a.href=d.view_url; a.target='_blank'; a.rel='noopener'; a.textContent='üëÅÔ∏è Lihat'; a.className='btn success'; act.appendChild(a); }\n    if(d.download_url){ const dl=document.createElement('a'); dl.href=d.download_url; dl.setAttribute('download',''); dl.textContent='üì• Unduh'; dl.className='btn secondary'; act.appendChild(dl); }\n    row.appendChild(act);\n    wrap.appendChild(row);\n  });\n}\nfunction renderView(obj){\n  if(VIEW.jenis_surat) VIEW.jenis_surat.textContent=toStr(obj.jenis_surat,'Surat Keterangan Tidak Mampu (SKTM)');\n  if(VIEW.nomor_surat) VIEW.nomor_surat.textContent=toStr(obj.nomor_surat,'‚Äî');\n  if(VIEW.operator) VIEW.operator.textContent=toStr(obj.operator,'‚Äî');\n  if(VIEW.tanggal_surat) VIEW.tanggal_surat.textContent=toStr(obj.tanggal_surat,new Date().toLocaleDateString('id-ID'));\n  if(VIEW.ref) VIEW.ref.textContent=toStr(obj.ref,ID_USER||'‚Äî');\n  if(VIEW.from) VIEW.from.textContent=toStr(obj.WAHA_Trigger_payload_from,'‚Äî');\n  if(VIEW.logo){ const logo=obj.LogoURL||obj.logo_url||''; if(logo) VIEW.logo.src=logo; }\n  const p=obj.pemohon||{};\n  VIEW.nama&&(VIEW.nama.textContent=toStr(p.nama)); VIEW.nik&&(VIEW.nik.textContent=toStr(p.nik));\n  VIEW.ttl&&(VIEW.ttl.textContent=toStr(p.ttl)); VIEW.agama&&(VIEW.agama.textContent=toStr(p.agama));\n  VIEW.jenis_kelamin&&(VIEW.jenis_kelamin.textContent=toStr(p.jenis_kelamin));\n  VIEW.status_perkawinan&&(VIEW.status_perkawinan.textContent=toStr(p.status_perkawinan));\n  VIEW.pekerjaan&&(VIEW.pekerjaan.textContent=toStr(p.pekerjaan));\n  VIEW.alamat&&(VIEW.alamat.textContent=toStr(p.alamat));\n  VIEW.kelurahan&&(VIEW.kelurahan.textContent=toStr(p.kelurahan));\n  VIEW.kecamatan&&(VIEW.kecamatan.textContent=toStr(p.kecamatan));\n  VIEW.kota_kab&&(VIEW.kota_kab.textContent=toStr(p.kota_kab));\n  VIEW.provinsi&&(VIEW.provinsi.textContent=toStr(p.provinsi));\n  VIEW.ket_kel&&(VIEW.ket_kel.textContent=toStr(p.kelurahan));\n  renderFiles(obj);\n}\n\n/* ===== Polling ===== */\nfunction startPolling(){ stopPolling(); pollHandle=setInterval(()=>{ loadOnce(false); }, POLL_MS); }\nfunction stopPolling(){ if(pollHandle){ clearInterval(pollHandle); pollHandle=null; } }\n\n/* ===== Loading ===== */\nconst loadingOverlay=$('loadingOverlay'), loadingText=$('loadingText');\nfunction showLoading(show,text){ if(text) loadingText.textContent=text; loadingOverlay.style.display=show?'flex':'none'; }\n\n/* ===== Modal ===== */\nconst modalOverlay=$('modalOverlay'), modalBox=$('modalBox');\nconst modalIcon=$('modalIcon'), modalTitle=$('modalTitle'), modalMessage=$('modalMessage'), modalActions=$('modalActions');\nfunction showModal({icon='‚ÑπÔ∏è',title='Informasi',message='',buttons=[{label:'Tutup',variant:'secondary',value:true}],variant='info',closable=true}={}){\n  return new Promise(resolve=>{\n    modalIcon.textContent=icon; modalTitle.textContent=title; modalMessage.innerHTML=message; modalActions.innerHTML='';\n    modalBox.className='modal modal--'+variant;\n    buttons.forEach(btn=>{\n      const el=document.createElement('button');\n      el.className='btn '+(btn.primary?'primary':btn.danger?'danger':btn.variant||'secondary');\n      el.textContent=btn.label||'OK';\n      el.onclick=()=>{ hide(); resolve(btn.value); };\n      modalActions.appendChild(el);\n    });\n    function onEsc(e){ if(e.key==='Escape' && closable){ hide(); resolve(null);} }\n    function hide(){ modalOverlay.style.display='none'; document.removeEventListener('keydown',onEsc); }\n    modalOverlay.style.display='flex'; document.addEventListener('keydown',onEsc);\n  });\n}\nfunction infoModal(title,message){ return showModal({icon:'‚ÑπÔ∏è',title,message,variant:'info',buttons:[{label:'Tutup',variant:'secondary',value:true}]}); }\nfunction successModal(title,message){ return showModal({icon:'‚úÖ',title,message,variant:'success',buttons:[{label:'Tutup',variant:'secondary',value:true}]}); }\nfunction confirmModal(title,message,{okLabel='Lanjutkan',cancelLabel='Batal',icon='‚ùì',danger=false}={}){\n  return showModal({icon,title,message,variant:'confirm',buttons:[{label:cancelLabel,variant:'secondary',value:false},{label:okLabel,primary:!danger,danger, value:true}]});\n}\n\n/* ===== Load JSON ===== */\nasync function loadOnce(showLoader=true){\n  try{\n    if(!JSON_URL){ console.warn('ID_USER kosong.'); return; }\n    if(showLoader && !firstLoadDone) showLoading(true,'Memuat data‚Ä¶ Mohon menunggu.');\n    const res=await fetch(JSON_URL+'?t='+Date.now(),{cache:'no-store'});\n    const text=await res.text();\n    if(!res.ok) throw new Error('HTTP '+res.status+' ‚Äî '+text.slice(0,200));\n    let data; try{data=JSON.parse(text);}catch(err){ if(!isJSONResponse(res)) throw new Error('Respon bukan JSON'); throw err; }\n    const h=await hashText(JSON.stringify(data));\n    if(h!==lastHash){lastHash=h; lastJSON=data; lastObj=pickObj(data)||{}; renderView(lastObj);}\n    if(!firstLoadDone){firstLoadDone=true; showLoading(false);}\n  }catch(e){\n    console.error('Load error:',e.message);\n    if(!firstLoadDone){\n      showLoading(false);\n      await showModal({icon:'‚ö†Ô∏è',title:'Gagal Memuat Data',message:'Sistem tidak dapat memuat data awal.<br><span class=\"mono\">'+(e.message||e)+'</span><br>Periksa koneksi dan sumber data, lalu muat ulang halaman.',variant:'danger',buttons:[{label:'Tutup',variant:'secondary',value:true}]});\n    }\n  }\n}\nfunction startRealtime(){renderStatic();loadOnce(true);startPolling();}\n\n/* ===== Create / Delete Surat ===== */\nasync function confirmCreateAndSend(){\n  const ok = await confirmModal(\n    'Konfirmasi Tanda Tangan',\n    'Apakah Anda yakin ingin <b>MENYETUJUI dan MENANDATANGANI</b> surat ini?<br><br>Pastikan seluruh data pemohon telah diverifikasi dan benar sebelum melanjutkan.',\n    { okLabel:'Ya, Setujui & TTD', cancelLabel:'Batal', icon:'üñäÔ∏è' }\n  );\n  if(!ok) return; \n  await generateAndSendLetter();\n}\nasync function generateAndSendLetter(){\n  try{\n    showLoading(true,'Memproses pembuatan surat dan pengiriman untuk tanda tangan‚Ä¶');\n    const resp=await fetch(WEBHOOK_CREATE,{\n      method:'POST',\n      headers:{'Content-Type':'application/json'},\n      body:JSON.stringify({...lastObj,id_user:ID_USER,id_surat:(new URL(location.href)).href})\n    });\n    const text=await resp.text(); \n    if(!resp.ok){throw new Error('HTTP '+resp.status+' ‚Äî '+text.slice(0,200));}\n    await successModal('Berhasil Diproses','Surat berhasil dibuat dan diteruskan untuk penandatanganan Kepala Distrik.');\n  }catch(e){\n    await showModal({\n      icon:'‚ö†Ô∏è',\n      title:'Gagal Memproses Surat',\n      message:'Terjadi kendala saat membuat/ mengirim surat untuk tanda tangan.<br><span class=\"mono\">'+(e.message||e)+'</span>',\n      variant:'danger',\n      buttons:[{label:'Tutup',variant:'secondary',value:true}]\n    });\n  }finally{ showLoading(false); }\n}\n\nasync function confirmDeleteAll(){\n  const ok = await showModal({\n    icon:'‚õî',\n    title:'Konfirmasi Penolakan Surat',\n    message:'Apakah Anda yakin ingin <b>MENOLAK dan MENGHAPUS</b> surat ini beserta seluruh data terkait?<br><br><b>Catatan:</b> Tindakan ini bersifat permanen dan tidak dapat dibatalkan.',\n    variant:'confirm',\n    buttons:[\n      {label:'Batal', variant:'secondary', value:false},\n      {label:'Ya, Tolak & Hapus', danger:true, value:true}\n    ]\n  });\n  if(!ok) return; \n  await deleteLetterAndData();\n}\nasync function deleteLetterAndData(){\n  try{\n    showLoading(true,'Menghapus surat dan seluruh data terkait‚Ä¶');\n    const resp=await fetch(WEBHOOK_DELETE,{\n      method:'POST',\n      headers:{'Content-Type':'application/json'},\n      body:JSON.stringify({\n        action:'DELETE_ALL',\n        id_user:ID_USER,\n        id_surat:(new URL(location.href)).href,\n        data:{...lastObj,id_user:ID_USER,id_surat:(new URL(location.href)).href}\n      })\n    });\n    const text=await resp.text(); \n    if(!resp.ok){throw new Error('HTTP '+resp.status+' ‚Äî '+text.slice(0,200));}\n    await successModal('Penghapusan Berhasil','Surat dan seluruh data terkait telah dihapus dari sistem.');\n    location.reload();\n  }catch(e){\n    await showModal({\n      icon:'‚ö†Ô∏è',\n      title:'Gagal Menghapus',\n      message:'Terjadi kendala saat menghapus surat atau data.<br><span class=\"mono\">'+(e.message||e)+'</span>',\n      variant:'danger',\n      buttons:[{label:'Tutup',variant:'secondary',value:true}]\n    }).then(()=>location.reload());\n  }finally{ showLoading(false); }\n}\n\n/* ===== Kirim Catatan / Pesan ===== */\nasync function sendNote(){\n  try{\n    const textNote=( $('noteText').value || '' ).trim();\n    if(!textNote) return infoModal('Catatan Kosong','Silakan tulis catatan terlebih dahulu.');\n\n    const ok = await confirmModal(\n      'Kirim Pesan kepada Pemohon',\n      'Pesan berikut akan dikirim:<br><br><i>\"'+textNote.replace(/</g,'&lt;').replace(/>/g,'&gt;')+'\"</i>',\n      { okLabel:'Kirim Sekarang', cancelLabel:'Batal', icon:'‚úâÔ∏è' }\n    );\n    if(!ok) return;\n\n    showLoading(true,'Mengirim pesan‚Ä¶');\n\n    const payload={\n      id_user: ID_USER,\n      id_surat: (new URL(location.href)).href,\n      message: textNote,\n      json: lastObj || {},\n      data: lastObj || {},\n      meta: { ref: lastObj?.ref || ID_USER, operator: lastObj?.operator || null, at: new Date().toISOString() }\n    };\n\n    const resp=await fetch(PESAN,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});\n    const bodyText=await resp.text();\n    if(!resp.ok){ throw new Error('HTTP '+resp.status+' ‚Äî '+bodyText.slice(0,200)); }\n\n    $('noteText').value='';\n    await successModal('Pesan Terkirim','Catatan/instruksi berhasil dikirim ke sistem.');\n  }catch(e){\n    await showModal({\n      icon:'‚ö†Ô∏è',\n      title:'Gagal Mengirim Pesan',\n      message:'Tidak dapat mengirim pesan.<br><span class=\"mono\">'+(e.message||e)+'</span>',\n      variant:'danger',\n      buttons:[{label:'Tutup',variant:'secondary',value:true}]\n    });\n  }finally{ showLoading(false); }\n}\n\n/* ===== Start ===== */\nwindow.confirmCreateAndSend=confirmCreateAndSend;\nwindow.confirmDeleteAll=confirmDeleteAll;\nwindow.sendNote=sendNote;\ndocument.addEventListener('DOMContentLoaded',startRealtime);\n</script>\n</body>\n</html>\n"
      },
      "type": "n8n-nodes-base.html",
      "typeVersion": 1.2,
      "position": [
        1320,
        3320
      ],
      "id": "c1ee0e91-527e-4e4d-9b65-649168e01e92",
      "name": "HTML"
    },
    {
      "parameters": {
        "name": "={{ $json.query.name_file }}",
        "driveId": {
          "__rl": true,
          "mode": "list",
          "value": "My Drive"
        },
        "folderId": {
          "__rl": true,
          "value": "1ufqBzk2QQ6MYnMU2cSzG3mqoab-JCP_Z",
          "mode": "list",
          "cachedResultName": "Create Surat Keterangan Tidak Mampu",
          "cachedResultUrl": "https://drive.google.com/drive/folders/1ufqBzk2QQ6MYnMU2cSzG3mqoab-JCP_Z"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        -660,
        3780
      ],
      "id": "cd15335e-e05d-43b2-92da-2ccd57410c3b",
      "name": "Upload file4",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "jyiiyKxh6DOyPVt5",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "resource": "Chatting",
        "operation": "Send Text",
        "session": "={{ $('Webhook').item.json.query.session_waha }}",
        "chatId": "=6281396650844@c.us",
        "text": "=Surat Masuk Atas Nama {{ $('Webhook').item.json.query.Nama }}\nNomor KTP {{ $('Webhook').item.json.query.NIK }}\n\nLink Surat\nhttps://distrikwania.com/data/{{ $json.id }}",
        "requestOptions": {}
      },
      "type": "@devlikeapro/n8n-nodes-waha.WAHA",
      "typeVersion": 202502,
      "position": [
        -440,
        3780
      ],
      "id": "14930f5c-889e-43af-b9e5-865032e24a58",
      "name": "Send a text message1",
      "credentials": {
        "wahaApi": {
          "id": "uivlaHVGkUY1vyJT",
          "name": "WAHA account"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "5af2b097-ff31-46e8-86d8-1dcb4800c60b",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -880,
        3780
      ],
      "id": "5bb7a88a-ff1c-4f3a-ace6-b19bc20465ac",
      "name": "Webhook",
      "webhookId": "5af2b097-ff31-46e8-86d8-1dcb4800c60b"
    },
    {
      "parameters": {
        "jsCode": "// Input: item tunggal dari Webhook\nconst body = Array.isArray($json.body) ? $json.body[0] : $json.body || {};\nconst data = body.data || {};\n\n// ==== Ambil semua file_id dari dokumen ====\nconst dokumen = Array.isArray(body.dokumen) \n  ? body.dokumen\n  : Array.isArray(data.dokumen) \n    ? data.dokumen \n    : [];\n\nconst ids = dokumen\n  .map(d => (d?.file_id || '').trim())\n  .filter(x => x.length > 0);\n\n// ==== Unik (hapus duplikat) ====\nconst uniq = [...new Set(ids)];\n\n// Output array items untuk n8n\nreturn uniq.map(id => ({ json: { fileId: id } }));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -660,
        3520
      ],
      "id": "83f5fb58-f631-4433-a2d6-a7ce4eebb3f2",
      "name": "Code7"
    },
    {
      "parameters": {
        "operation": "download",
        "fileId": {
          "__rl": true,
          "value": "={{ $json.fileId }}",
          "mode": "id"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        -440,
        3520
      ],
      "id": "8b7be1c0-e001-4a95-9105-c6fcc130b0d3",
      "name": "Download file",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "jyiiyKxh6DOyPVt5",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "inputDataFieldName": "={{ $json.binaryProperty }}",
        "name": "={{ $binary[$json.binaryProperty].fileName }}",
        "driveId": {
          "__rl": true,
          "mode": "list",
          "value": "My Drive"
        },
        "folderId": {
          "__rl": true,
          "value": "1ufqBzk2QQ6MYnMU2cSzG3mqoab-JCP_Z",
          "mode": "list",
          "cachedResultName": "Create Surat Keterangan Tidak Mampu",
          "cachedResultUrl": "https://drive.google.com/drive/folders/1ufqBzk2QQ6MYnMU2cSzG3mqoab-JCP_Z"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        0,
        3520
      ],
      "id": "d8139f75-a11c-4c2c-82b4-621229db0c0a",
      "name": "Upload file5",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "jyiiyKxh6DOyPVt5",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Run Once for All Items\nconst out = [];\nfor (const item of items) {\n  const bin = item.binary || {};\n  const keys = Object.keys(bin);\n  if (keys.length === 0) { out.push(item); continue; }\n  for (const k of keys) {\n    out.push({\n      json: { binaryProperty: k },\n      binary: { [k]: bin[k] },\n    });\n  }\n}\nreturn out;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -220,
        3520
      ],
      "id": "b97f4c49-7a6c-494c-85c6-794b7a6b5797",
      "name": "Code8"
    },
    {
      "parameters": {
        "jsCode": "/**\n * Generate Payload Surat ‚Äî gabung data form + banyak file Drive (ANTI NULL + SEMUA ID)\n * Mode   : Run Once for All Items\n * Input  : Kumpulan item: (A) hasil Upload (>=1 item), (B) 1 item berisi body.data (string JSON atau object/array)\n * Output : 1 item { json: payload }\n */\n\n/* ===================== Utils ===================== */\nconst has     = (o, k) => Object.prototype.hasOwnProperty.call(o ?? {}, k);\nconst clean   = (s) => (s ?? '').toString().normalize('NFKC').trim();\nconst lower   = (s) => clean(s).toLowerCase();\nconst ensure  = (x, f='') => { const v = clean(x); return v ? v : f; };\n\n/** Normalisasi ‚Üí string kosong jika kosong/undefined/null/\"undefined\"/\"null\" */\nconst toStr = (x) => {\n  if (x === undefined || x === null) return '';\n  const v = (typeof x === 'string') ? x.trim() : x;\n  if (v === '' || v === 'undefined' || v === 'null') return '';\n  return (typeof v === 'string') ? v : JSON.stringify(v);\n};\n\nconst baseName = (name) => lower((name || '').replace(/\\.[^./\\\\]+$/, ''));\n\n// Aman parse JSON (+decodeURIComponent jika terlihat urlencoded)\nconst safeParseJSON = (maybeJSON) => {\n  try {\n    if (typeof maybeJSON === 'string') return JSON.parse(maybeJSON);\n    if (typeof maybeJSON === 'object' && maybeJSON !== null) return maybeJSON;\n  } catch {}\n  return {};\n};\n\nconst tryParse = (x) => {\n  if (typeof x === 'string') {\n    let s = x;\n    if (/%[0-9A-Fa-f]{2}/.test(x) && (x.includes('%7B') || x.includes('%5B'))) {\n      try { s = decodeURIComponent(x); } catch(e) {}\n    }\n    let obj = safeParseJSON(s);\n    if (typeof obj === 'string') obj = safeParseJSON(obj);\n    return obj;\n  }\n  return safeParseJSON(x);\n};\n\n/** Ekstrak id_surat dari URL https://distrikwania.com/data/<ID> */\nconst extractSuratId = (raw) => {\n  const s = toStr(raw);\n  if (!s) return '';\n  // coba pola khusus /data/<ID>\n  const m = s.match(/\\/data\\/([^/?#]+)/i);\n  if (m && m[1]) return m[1].trim();\n  // fallback: ambil segmen terakhir yg non-kosong\n  const segs = s.split('/').filter(Boolean);\n  return (segs.length ? segs[segs.length-1] : '').trim();\n};\n\n/* ===================== Ambil body.data dari salah satu item ===================== */\nlet rawData = null;\nfor (const it of items) {\n  const s = it.json || {};\n  // pola umum dari Webhook ‚Üí body.data\n  if (s && s.body && s.body.data !== undefined) { rawData = s.body.data; break; }\n  if (s && s.data !== undefined)               { rawData = s.data;      break; }\n}\n\nlet bodyData = tryParse(rawData);\nlet bodyArray = null;\n\n// === Fallback baru: cari langsung di items top-level ===\nif (!rawData || typeof bodyData !== 'object' || bodyData === null || Array.isArray(bodyData)) {\n  // Kumpulkan kandidat item yang terlihat seperti ‚Äúkepala surat‚Äù\n  const heads = [];\n  for (const it of items) {\n    const j = it?.json || {};\n    const looksLikeHead =\n      (typeof j === 'object') &&\n      (j !== null) &&\n      (\n        has(j,'jenis_surat') || has(j,'pemohon') || has(j,'id_user') ||\n        has(j,'id_surat') || has(j,'id_surat_raw')\n      );\n    if (looksLikeHead) heads.push(j);\n  }\n\n  if (heads.length === 1) {\n    bodyData = heads[0];\n  } else if (heads.length > 1) {\n    // jika banyak, pilih yang paling lengkap (punya paling banyak kunci penting)\n    const score = (o) => ['jenis_surat','pemohon','id_user','id_surat','id_surat_raw','URL_CREATE','URL_UPDATE'].reduce((n,k)=>n+(has(o,k)?1:0),0);\n    heads.sort((a,b)=>score(b)-score(a));\n    // gabungkan kepala pertama dengan sisanya (non-destructive)\n    const merged = Object.assign({}, heads[0]);\n    for (let i=1;i<heads.length;i++){\n      for (const [k,v] of Object.entries(heads[i])) {\n        if (merged[k] === undefined || merged[k] === null || merged[k] === '' ) merged[k] = v;\n      }\n    }\n    bodyData = merged;\n  } else {\n    // tidak ada kandidat ‚Üí tetap pakai parse hasil awal\n    if (typeof bodyData !== 'object' || bodyData === null) bodyData = {};\n  }\n}\n\n// Jika bodyData berupa array ‚Üí ambil elemen pertamanya sebagai head\nif (Array.isArray(bodyData)) { bodyArray = bodyData; bodyData = bodyData[0] || {}; }\n\n\n/* ===================== Skema baru vs lama ===================== */\nlet mdCandidate = bodyData;\nif (bodyData && typeof bodyData.mandatory_data === 'object' && bodyData.mandatory_data !== null) {\n  mdCandidate = bodyData.mandatory_data;\n}\nif (Array.isArray(mdCandidate)) mdCandidate = mdCandidate[0] || {};\nconst md = (typeof mdCandidate === 'object' && mdCandidate !== null) ? mdCandidate : {};\n\n/* ===================== files_info & delete_file_ids ===================== */\nlet filesInfo = [];\nif (Array.isArray(bodyData.files_info)) filesInfo = bodyData.files_info;\nelse if (Array.isArray(md.files_info)) filesInfo = md.files_info;\nelse if (bodyArray && Array.isArray(bodyArray[0]?.files_info)) filesInfo = bodyArray[0].files_info;\n\nlet deleteFileIds = [];\nif (Array.isArray(bodyData.delete_file_ids)) deleteFileIds = bodyData.delete_file_ids;\nelse if (Array.isArray(md.delete_file_ids)) deleteFileIds = md.delete_file_ids;\nelse if (bodyArray && Array.isArray(bodyArray[0]?.delete_file_ids)) deleteFileIds = bodyArray[0].delete_file_ids;\n\n/* ===================== Kolektor dokumen (dipadankan dg file Drive) ===================== */\nconst map = new Map();\nconst uniq = (base) => { let k = base || 'lampiran'; if (!map.has(k)) return k; let i=2; while(map.has(`${k}_${i}`)) i++; return `${k}_${i}`; };\nconst put  = (key, obj) => map.set(key, Object.assign(map.get(key) || {}, obj));\nconst normKey = (label) => lower(label || 'lampiran').replace(/\\s+/g,'_').replace(/[^a-z0-9_\\-]/g,'');\nconst add = (label, obj={}) => {\n  const key = uniq(normKey(label || 'lampiran'));\n  put(key, {\n    label: key,\n    file_id: '', download_url:'', view_url:'',\n    name:'', mimeType:'', size:'', iconLink:'', thumbnailLink:'', createdTime:'',\n    // ID penting per dokumen:\n    parents: [], permissionIds: [], headRevisionId:'',\n    owners_permissionIds: [], lastModifyingUser_permissionId:'', permissions_ids: [],\n    ...obj,\n  });\n};\n\n// 1) md.dokumen (opsional)\nif (Array.isArray(md.dokumen)) {\n  for (const d of md.dokumen) {\n    add(d?.label ?? d?.name ?? 'lampiran', {\n      file_id     : toStr(d?.file_id),\n      download_url: toStr(d?.download_url),\n      view_url    : toStr(d?.view_url),\n      name        : toStr(d?.name),\n      mimeType    : toStr(d?.mimeType),\n      size        : toStr(d?.size),\n    });\n  }\n}\n\n// 2) seed dari files_info\nfor (const f of (Array.isArray(filesInfo) ? filesInfo : [])) {\n  const key = uniq(baseName(f?.name || 'lampiran'));\n  put(key, {\n    label: key,\n    name : toStr(f?.name),\n    mimeType: toStr(f?.type),\n    size: toStr(f?.size),\n  });\n}\n\n// Helper padanan Drive\nconst findBestSlot = (driveName, driveSizeStr) => {\n  const dBase = baseName(driveName || 'lampiran');\n  // a) cocok nama\n  for (const [k, v] of map.entries()) {\n    if (v.name && baseName(v.name) === dBase) return k;\n  }\n  // b) cocok label\n  for (const [k, v] of map.entries()) {\n    if (v.label && baseName(v.label) === dBase) return k;\n  }\n  // c) cocok size (string ‚Üí number)\n  const driveSize = Number(driveSizeStr);\n  if (Number.isFinite(driveSize)) {\n    for (const [k, v] of map.entries()) {\n      const vs = Number(v.size);\n      if (Number.isFinite(vs)) {\n        const diff = Math.abs(vs - driveSize);\n        if (diff <= 2048) return k;\n      }\n    }\n  }\n  return null;\n};\n\n/* ===================== Kumpulkan SEMUA ID dari semua item Drive ===================== */\nconst ids_all_unique = new Set();\nconst ids_detail = {\n  id_user: '',\n  id_surat_raw: '',\n  id_surat: '',\n  delete_file_ids: [],\n  drive_files: [],  // array objek: {id, parents[], permissionIds[], headRevisionId, owners_permissionIds[], lastModifyingUser_permissionId, permissions_ids[]}\n};\n\n// isi dasar dari bodyData/md\nconst id_user_val      = toStr(bodyData.id_user ?? md.id_user ?? (bodyArray ? bodyArray[0]?.id_user : ''));\nconst id_surat_raw_val = toStr(bodyData.id_surat_raw ?? md.id_surat_raw ?? (bodyArray ? bodyArray[0]?.id_surat_raw : ''));\nlet   id_surat_val     = toStr(bodyData.id_surat ?? md.id_surat ?? (bodyArray ? bodyArray[0]?.id_surat : ''));\n\n// auto-extract id_surat bila masih kosong namun ada URL\nif (!id_surat_val && id_surat_raw_val) id_surat_val = extractSuratId(id_surat_raw_val);\n\n// taruh ke detail + set\nids_detail.id_user      = id_user_val;\nids_detail.id_surat_raw = id_surat_raw_val;\nids_detail.id_surat     = id_surat_val;\nids_detail.delete_file_ids = Array.from(new Set((deleteFileIds||[]).map(toStr).filter(Boolean)));\n\n[id_user_val, id_surat_raw_val, id_surat_val, ...ids_detail.delete_file_ids].forEach(x => x && ids_all_unique.add(x));\n\n/* ===================== Loop semua item: mapping ke dokumen + kumpulkan ID ===================== */\nfor (const it of items) {\n  const s = it.json || {};\n  const isDrive = !!(s.id || s.webViewLink || s.webContentLink || s.name || s.originalFilename || s.mimeType);\n  if (!isDrive) continue;\n\n  const dName = s.name || s.originalFilename || 'lampiran';\n  const dSize = s.size ?? s.quotaBytesUsed ?? '';\n\n  // --- kumpulkan ID drive ---\n  const fileId = toStr(s.id);\n  const parents = Array.isArray(s.parents) ? s.parents.map(toStr).filter(Boolean) : [];\n  const permissionIds = Array.isArray(s.permissionIds) ? s.permissionIds.map(toStr).filter(Boolean) : [];\n  const headRevisionId = toStr(s.headRevisionId);\n  const owners_permissionIds = Array.isArray(s.owners)\n    ? s.owners.map(o => toStr(o?.permissionId)).filter(Boolean)\n    : [];\n  const lastModifyingUser_permissionId = toStr(s.lastModifyingUser?.permissionId);\n  const permissions_ids = Array.isArray(s.permissions)\n    ? s.permissions.map(p => toStr(p?.id)).filter(Boolean)\n    : [];\n\n  // masukkan ke detail\n  ids_detail.drive_files.push({\n    id: fileId,\n    parents,\n    permissionIds,\n    headRevisionId,\n    owners_permissionIds,\n    lastModifyingUser_permissionId,\n    permissions_ids,\n  });\n\n  // add ke set unik\n  [fileId, headRevisionId, lastModifyingUser_permissionId, ...parents, ...permissionIds, ...owners_permissionIds, ...permissions_ids]\n    .forEach(x => x && ids_all_unique.add(x));\n\n  // --- padankan ke entri dokumen ---\n  let slot = findBestSlot(dName, dSize);\n  if (!slot) {\n    const key = uniq(baseName(dName) || 'lampiran');\n    add(key, { name: dName });\n    slot = key;\n  }\n\n  put(slot, {\n    file_id      : fileId,\n    download_url : toStr(s.webContentLink),\n    view_url     : toStr(s.webViewLink),\n    name         : toStr(s.name ?? s.originalFilename ?? dName),\n    mimeType     : toStr(s.mimeType),\n    size         : toStr(dSize),\n    iconLink     : toStr(s.iconLink),\n    thumbnailLink: toStr(s.thumbnailLink),\n    createdTime  : toStr(s.createdTime),\n\n    // sertakan ID penting per dokumen\n    parents,\n    permissionIds,\n    headRevisionId,\n    owners_permissionIds,\n    lastModifyingUser_permissionId,\n    permissions_ids,\n  });\n}\n\nconst dokumen = Array.from(map.values());\n\n/* ===================== Normalisasi bidang teks pemohon ===================== */\nconst pemohonRaw = md?.pemohon ?? {};\nconst kelurahan  = ensure(toStr(pemohonRaw.kelurahan), '');\nconst kecamatan  = ensure(toStr(pemohonRaw.kecamatan), '');\nconst kotaKab    = ensure(toStr(pemohonRaw.kota_kab ?? pemohonRaw.kabupaten), '');\nconst provinsi   = ensure(toStr(pemohonRaw.provinsi), '');\nlet domisili     = toStr(pemohonRaw.domisili);\nif (!domisili) domisili = [kelurahan, kecamatan, kotaKab, provinsi].filter(Boolean).join(', ');\n\n/* ===================== Payload akhir (ANTI NULL) ===================== */\nconst payload = {\n  // header surat\n  jenis_surat   : toStr(md?.jenis_surat),\n  nomor_surat   : toStr(md?.nomor_surat),\n  tanggal_surat : toStr(md?.tanggal_surat),\n\n  // pemohon\n  pemohon: {\n    nama             : toStr(pemohonRaw?.nama),\n    nik              : toStr(pemohonRaw?.nik),\n    ttl              : toStr(pemohonRaw?.ttl),\n    agama            : toStr(pemohonRaw?.agama),\n    jenis_kelamin    : toStr(pemohonRaw?.jenis_kelamin),\n    status_perkawinan: toStr(pemohonRaw?.status_perkawinan),\n    pekerjaan        : toStr(pemohonRaw?.pekerjaan),\n    alamat           : toStr(pemohonRaw?.alamat),\n    kelurahan, kecamatan,\n    kota_kab         : kotaKab,\n    provinsi,\n    domisili,\n  },\n\n  // lampiran (sudah mengandung ID-ID penting tiap file)\n  dokumen,\n\n  // penandatangan\n  penandatangan: {\n    nama   : toStr(md?.penandatangan?.nama),\n    nip    : toStr(md?.penandatangan?.nip),\n    jabatan: toStr(md?.penandatangan?.jabatan),\n  },\n\n  // metadata lain\n  operator                 : toStr(md?.operator),\n  ref                      : toStr(md?.ref),\n  WAHA_Trigger_session     : toStr(md?.WAHA_Trigger_session),\n  WAHA_Trigger_payload_from: toStr(md?.WAHA_Trigger_payload_from),\n  LogoURL                  : toStr(md?.LogoURL),\n\n  URL_CREATE     : toStr(md?.URL_CREATE),\n  URL_UPDATE     : toStr(md?.URL_UPDATE),\n  URL_DELETE     : toStr(md?.URL_DELETE),\n  URL_UPLOAD     : toStr(md?.URL_UPLOAD),\n  URL_DELETE_FILE: toStr(md?.URL_DELETE_FILE),\n\n  // body meta (anti null)\n  id_user      : id_user_val,\n  id_surat_raw : id_surat_raw_val,\n  id_surat     : id_surat_val,\n  url_web_link : toStr((bodyArray ? bodyArray[0]?.url_web_link : bodyData?.url_web_link) ?? bodyData?.url_web_link),\n  action       : toStr((bodyArray ? bodyArray[0]?.action       : bodyData?.action)       ?? bodyData?.action),\n  timestamp    : toStr((bodyArray ? bodyArray[0]?.timestamp    : bodyData?.timestamp)    ?? bodyData?.timestamp),\n\n  // audit mentah (tetap ada walau kosong)\n  files_info       : Array.isArray(filesInfo) ? filesInfo : [],\n  delete_file_ids  : ids_detail.delete_file_ids,\n\n  // sekat ID (semua ID yang ditemukan)\n  ids: {\n    all_unique: Array.from(ids_all_unique),\n    detail   : ids_detail,\n  },\n};\n\n// console.log('PAYLOAD:', payload);\nreturn [{ json: payload }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        440,
        3320
      ],
      "id": "10642755-b429-4f14-8670-48938a1de84c",
      "name": "Code9"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        220,
        3320
      ],
      "id": "2d2b7622-2c99-4937-afe2-4e36b052af4e",
      "name": "Merge3"
    },
    {
      "parameters": {
        "content": "## Create Web Warga\n",
        "height": 380,
        "width": 1660
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1000,
        80
      ],
      "typeVersion": 1,
      "id": "68b081b0-9c40-485c-a933-36fe26a4fcb1",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "## Send Link HTML User",
        "height": 240,
        "width": 780
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1000,
        480
      ],
      "typeVersion": 1,
      "id": "392383d0-a377-4cea-a241-70bc474cf4c5",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "content": "## Button Uploud File HTML User",
        "height": 320,
        "width": 1660
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1000,
        740
      ],
      "typeVersion": 1,
      "id": "059183be-6461-43b6-bbb6-2cd0c548e371",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "content": "## Button Update Data HTML User",
        "height": 240,
        "width": 1000
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1000,
        1080
      ],
      "typeVersion": 1,
      "id": "fbbe050c-dcad-4d10-8df2-223cb41dfdbe",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "content": "## Button Delete File HTML User",
        "height": 240,
        "width": 1440
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1000,
        1340
      ],
      "typeVersion": 1,
      "id": "0bc9d9ca-3ca1-419b-8b7b-523be7e8419b",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "content": "## Button Delete Data & Delete Surat HTML User",
        "height": 240,
        "width": 780
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1000,
        2780
      ],
      "typeVersion": 1,
      "id": "4f243d37-d8d8-4cbd-982d-7da791d7405b",
      "name": "Sticky Note5"
    },
    {
      "parameters": {
        "content": "## Send Data & Create Surat & Generate HTML Admin\n",
        "height": 440,
        "width": 2760
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1000,
        3240
      ],
      "typeVersion": 1,
      "id": "bb0bfe5b-513e-40ad-be1e-d088cf8affbb",
      "name": "Sticky Note6"
    },
    {
      "parameters": {
        "content": "## Send Link HTML Admin",
        "height": 240,
        "width": 780
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1000,
        3700
      ],
      "typeVersion": 1,
      "id": "5b70b175-41d2-473e-b634-cd8a902d01b3",
      "name": "Sticky Note7"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "646a0ac9-0b1c-4283-ae20-fe42f0ad4384",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -880,
        4300
      ],
      "id": "e69b7ba3-4ff3-4cc1-a693-fe6d8e773b77",
      "name": "Webhook1",
      "webhookId": "646a0ac9-0b1c-4283-ae20-fe42f0ad4384"
    },
    {
      "parameters": {
        "resource": "Chatting",
        "operation": "Send Text",
        "session": "={{ $json.body.data.WAHA_Trigger_session }}",
        "chatId": "={{ $json.body.data.WAHA_Trigger_payload_from }}",
        "text": "=Pesan Dari Kepala Distrik\n\n{{ $json.body.message }}",
        "requestOptions": {}
      },
      "type": "@devlikeapro/n8n-nodes-waha.WAHA",
      "typeVersion": 202502,
      "position": [
        -660,
        4300
      ],
      "id": "75c3bbb1-7d7f-42cd-b9b7-fd058d0df51a",
      "name": "Send a text message2",
      "credentials": {
        "wahaApi": {
          "id": "uivlaHVGkUY1vyJT",
          "name": "WAHA account"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "1e87058d-af1d-4cf2-918e-93e7682dda01",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -880,
        4660
      ],
      "id": "2d83a664-9d56-4bf1-b2b7-b7d5dda3f479",
      "name": "Webhook2",
      "webhookId": "1e87058d-af1d-4cf2-918e-93e7682dda01"
    },
    {
      "parameters": {
        "operation": "update",
        "documentURL": "={{ $json.id }}",
        "actionsUi": {
          "actionFields": [
            {
              "action": "replaceAll",
              "text": "{NAMA}",
              "replaceText": "={{ $('Webhook2').item.json.body.pemohon.nama }}"
            },
            {
              "action": "replaceAll",
              "text": "{NIK}",
              "replaceText": "={{ $('Webhook2').item.json.body.pemohon.nik }}"
            },
            {
              "action": "replaceAll",
              "text": "{TTL}",
              "replaceText": "={{ $('Webhook2').item.json.body.pemohon.ttl }}"
            },
            {
              "action": "replaceAll",
              "text": "{AGAMA}",
              "replaceText": "={{ $('Webhook2').item.json.body.pemohon.agama }}"
            },
            {
              "action": "replaceAll",
              "text": "{JENISKELAMIN}",
              "replaceText": "={{ $('Webhook2').item.json.body.pemohon.jenis_kelamin }}"
            },
            {
              "action": "replaceAll",
              "text": "{STATUSPERNIKAHAN}",
              "replaceText": "={{ $('Webhook2').item.json.body.pemohon.status_perkawinan }}"
            },
            {
              "action": "replaceAll",
              "text": "{PEKERJAAN}",
              "replaceText": "={{ $('Webhook2').item.json.body.pemohon.pekerjaan }}"
            },
            {
              "action": "replaceAll",
              "text": "{ALAMAT}",
              "replaceText": "={{ $('Webhook2').item.json.body.pemohon.alamat }}"
            },
            {
              "action": "replaceAll",
              "text": "{KELURAHAN}",
              "replaceText": "={{ $('Webhook2').item.json.body.pemohon.kelurahan }}"
            },
            {
              "action": "replaceAll",
              "text": "{TANGGALSURAT}",
              "replaceText": "={{ $('Webhook2').item.json.body.tanggal_surat }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.googleDocs",
      "typeVersion": 2,
      "position": [
        -440,
        4660
      ],
      "id": "56ac30f0-8c21-4fd3-b33b-067a5cb89f36",
      "name": "Write Surat Usaha",
      "credentials": {
        "googleDocsOAuth2Api": {
          "id": "skUGYZC8DG94zWQo",
          "name": "Google Docs account"
        }
      }
    },
    {
      "parameters": {
        "operation": "download",
        "fileId": {
          "__rl": true,
          "value": "={{ $json.documentId }}",
          "mode": "id"
        },
        "options": {
          "binaryPropertyName": "data",
          "googleFileConversion": {
            "conversion": {
              "docsToFormat": "application/pdf"
            }
          }
        }
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        -220,
        4660
      ],
      "id": "3e148cee-90ab-49b8-9091-49641f824b77",
      "name": "Saved Surat Usaha",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "jyiiyKxh6DOyPVt5",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "name": "={{ $('Create Surat Usaha').item.json.name }}",
        "driveId": {
          "__rl": true,
          "mode": "list",
          "value": "My Drive"
        },
        "folderId": {
          "__rl": true,
          "value": "1CbRPo1yFRv1LRtacbGzriGgcHeVXvUNX",
          "mode": "list",
          "cachedResultName": "Saved Surat Usaha",
          "cachedResultUrl": "https://drive.google.com/drive/folders/1CbRPo1yFRv1LRtacbGzriGgcHeVXvUNX"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        -880,
        5280
      ],
      "id": "bb8e7aa3-5587-4106-b5d2-ee8563b4e8f5",
      "name": "Get Link Surat Usaha",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "jyiiyKxh6DOyPVt5",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "sendTo": "=agunghenditemorubun@gmail.com, mimikawania@gmail.com, kkchanmartin@gmail.com",
        "subject": "={{ $('Create Surat Usaha').item.json.name }}",
        "emailType": "text",
        "message": "={{ $('Create Surat Usaha').item.json.name }}\n{{ new Date($json.createdTime).toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' }) }}\n\n\n{{ $json.webViewLink }}\n",
        "options": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        -660,
        5280
      ],
      "id": "8c3a4223-2c26-4be9-9e75-34561541f416",
      "name": "Send Link Surat  Gmail",
      "webhookId": "db7dc3bb-6195-4c7c-879b-51bd85f9cc7c",
      "credentials": {
        "gmailOAuth2": {
          "id": "htg9LVNV2zQKpqQf",
          "name": "Gmail account Mimika"
        }
      }
    },
    {
      "parameters": {
        "resource": "Chatting",
        "operation": "Send Text",
        "session": "={{ $('Data Input').item.json.WAHA_Trigger_session }}",
        "chatId": "=6281396650844@c.us",
        "text": "={{ $('Create Surat Usaha').item.json.name }}\n\n\n{{ $('Get Link Surat Usaha').item.json.webViewLink }}",
        "requestOptions": {}
      },
      "type": "@devlikeapro/n8n-nodes-waha.WAHA",
      "typeVersion": 202502,
      "position": [
        -440,
        5280
      ],
      "id": "95ea92cc-1b5c-4f17-8246-bf259903b2bb",
      "name": "Send Link Surat Wa",
      "credentials": {
        "wahaApi": {
          "id": "uivlaHVGkUY1vyJT",
          "name": "WAHA account"
        }
      }
    },
    {
      "parameters": {
        "operation": "binaryToPropery",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        0,
        4660
      ],
      "id": "cf7fb6ef-d15a-4fa7-881f-362bf8685d20",
      "name": "Extract from File"
    },
    {
      "parameters": {
        "resource": "Chatting",
        "operation": "Send File",
        "session": "={{ $('Webhook2').item.json.body.WAHA_Trigger_session }}",
        "chatId": "={{ $('Webhook2').item.json.body.WAHA_Trigger_payload_from }}",
        "file": "={\n  \"mimetype\": \"application/pdf\",\n  \"filename\": \"Surat Keterangan Tidak Mampu {{ $('Webhook2').item.json.body.pemohon.nama }}.pdf\",\n  \"data\": \"{{ $json.data }}\"\n}\n",
        "caption": "=Surat Keterangan Tidak Mampu \nAtas Nama {{ $('Webhook2').item.json.body.pemohon.nama }}\nNIK {{ $('Webhook2').item.json.body.pemohon.nik }}\nTelah Berhasil Di Buat",
        "requestOptions": {}
      },
      "type": "@devlikeapro/n8n-nodes-waha.WAHA",
      "typeVersion": 202502,
      "position": [
        220,
        4560
      ],
      "id": "55da257b-8845-496b-bb8e-ca1035145fa8",
      "name": "Send a file",
      "credentials": {
        "wahaApi": {
          "id": "uivlaHVGkUY1vyJT",
          "name": "WAHA account"
        }
      }
    },
    {
      "parameters": {
        "resource": "Chatting",
        "operation": "Send File",
        "session": "={{ $('Webhook2').item.json.body.WAHA_Trigger_session }}",
        "chatId": "=6281396650844@c.us",
        "file": "={\n  \"mimetype\": \"application/pdf\",\n  \"filename\": \"Surat Keterangan Tidak Mampu {{ $('Webhook2').item.json.body.pemohon.nama }}.pdf\",\n  \"data\": \"{{ $json.data }}\"\n}\n",
        "caption": "=Surat Keterangan Tidak Mampu \nAtas Nama {{ $('Webhook2').item.json.body.pemohon.nama }}\nNIK {{ $('Webhook2').item.json.body.pemohon.nik }}\nTelah di buat dan di kirim kepada {{ $('Webhook2').item.json.body.WAHA_Trigger_payload_from.replace('@c.us', '') }}\n",
        "requestOptions": {}
      },
      "type": "@devlikeapro/n8n-nodes-waha.WAHA",
      "typeVersion": 202502,
      "position": [
        220,
        4760
      ],
      "id": "b785fca5-eb0a-41a9-a5fc-7097acad2955",
      "name": "Send a file1",
      "credentials": {
        "wahaApi": {
          "id": "uivlaHVGkUY1vyJT",
          "name": "WAHA account"
        }
      }
    },
    {
      "parameters": {
        "resource": "Chatting",
        "operation": "Send Text",
        "session": "={{ $('Webhook').item.json.query.session_waha }}",
        "chatId": "=6285652240263@c.us",
        "text": "=Surat Masuk Atas Nama {{ $('Webhook').item.json.query.Nama }}\nNomor KTP {{ $('Webhook').item.json.query.NIK }}\n\nLink Surat\nhttps://distrikwania.com/data/{{ $json.id }}",
        "requestOptions": {}
      },
      "type": "@devlikeapro/n8n-nodes-waha.WAHA",
      "typeVersion": 202502,
      "position": [
        -880,
        4040
      ],
      "id": "4660ae80-a30c-498f-b44b-3d7472cd59c1",
      "name": "Send a text message3",
      "credentials": {
        "wahaApi": {
          "id": "uivlaHVGkUY1vyJT",
          "name": "WAHA account"
        }
      }
    },
    {
      "parameters": {
        "resource": "Chatting",
        "operation": "Send File",
        "session": "={{ $('Webhook2').item.json.body.WAHA_Trigger_session }}",
        "chatId": "=6285652240263@c.us",
        "file": "={\n  \"mimetype\": \"application/pdf\",\n  \"filename\": \"Surat Keterangan Tidak Mampu {{ $('Webhook2').item.json.body.pemohon.nama }}.pdf\",\n  \"data\": \"{{ $json.data }}\"\n}\n",
        "caption": "=Surat Keterangan Tidak Mampu \nAtas Nama {{ $('Webhook2').item.json.body.pemohon.nama }}\nNIK {{ $('Webhook2').item.json.body.pemohon.nik }}\nTelah di buat dan di kirim kepada {{ $('Webhook2').item.json.body.WAHA_Trigger_payload_from.replace('@c.us', '') }}\n",
        "requestOptions": {}
      },
      "type": "@devlikeapro/n8n-nodes-waha.WAHA",
      "typeVersion": 202502,
      "position": [
        -880,
        5020
      ],
      "id": "61612dc0-6973-4c76-ad4a-1df1f6511464",
      "name": "Send a file2",
      "credentials": {
        "wahaApi": {
          "id": "uivlaHVGkUY1vyJT",
          "name": "WAHA account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "0ebbf789-ae3b-4ee1-a549-f71a35821b95",
              "leftValue": "={{ $json.body.dokumen }}",
              "rightValue": "",
              "operator": {
                "type": "array",
                "operation": "empty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        0,
        3320
      ],
      "id": "54b64750-7ad3-4dc5-a4f6-bceabf90f968",
      "name": "If1"
    },
    {
      "parameters": {
        "operation": "copy",
        "fileId": {
          "__rl": true,
          "value": "1oAfXARAJXHPRK2K6ALm2_LKoZgopK5-xNh7p55Zs5yM",
          "mode": "list",
          "cachedResultName": "Create Surat Keterangan Tidak Mampu",
          "cachedResultUrl": "https://docs.google.com/document/d/1oAfXARAJXHPRK2K6ALm2_LKoZgopK5-xNh7p55Zs5yM/edit?usp=drivesdk"
        },
        "name": "=SKTM-{{$json.body.pemohon.nama}}",
        "options": {
          "copyRequiresWriterPermission": false
        }
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        -660,
        4660
      ],
      "id": "94cf7b4d-edee-4849-903f-2bef44f93993",
      "name": "Copy file",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "jyiiyKxh6DOyPVt5",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "resource": "Chatting",
        "operation": "Send Text",
        "text": "Data ",
        "requestOptions": {}
      },
      "type": "@devlikeapro/n8n-nodes-waha.WAHA",
      "typeVersion": 202502,
      "position": [
        660,
        820
      ],
      "id": "3410fabc-69c3-43ae-b23e-2dafa1aa5b10",
      "name": "Send a text message4",
      "credentials": {
        "wahaApi": {
          "id": "uivlaHVGkUY1vyJT",
          "name": "WAHA account"
        }
      }
    },
    {
      "parameters": {
        "resource": "Chatting",
        "operation": "Send Text",
        "session": "={{ $('Switch').item.json.WAHA_Trigger_session }}",
        "chatId": "={{ $('Switch').item.json.WAHA_Trigger_payload_from }}",
        "text": "‚úÖ Data berhasil diubah!",
        "requestOptions": {}
      },
      "type": "@devlikeapro/n8n-nodes-waha.WAHA",
      "typeVersion": 202502,
      "position": [
        220,
        1680
      ],
      "id": "72534f29-3ada-4694-a84b-d8f9239129d9",
      "name": "Send a text message5",
      "credentials": {
        "wahaApi": {
          "id": "uivlaHVGkUY1vyJT",
          "name": "WAHA account"
        }
      }
    },
    {
      "parameters": {
        "driveId": {
          "__rl": true,
          "mode": "list",
          "value": "My Drive"
        },
        "folderId": {
          "__rl": true,
          "value": "={{ $('Create Folder Warga').item.json.id }}",
          "mode": "id"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        0,
        260
      ],
      "id": "572db00a-a6b6-42dc-9a93-414a8e85d6b3",
      "name": "Create Json Data Warga",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "jyiiyKxh6DOyPVt5",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "name": "={{ $json.query.name_file }}",
        "driveId": {
          "__rl": true,
          "mode": "list",
          "value": "My Drive"
        },
        "folderId": {
          "__rl": true,
          "value": "1z6iQjNCmp39IHqZ23EWWIsbA5g__Ahr-",
          "mode": "list",
          "cachedResultName": "Data Web Warga",
          "cachedResultUrl": "https://drive.google.com/drive/folders/1z6iQjNCmp39IHqZ23EWWIsbA5g__Ahr-"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        -660,
        560
      ],
      "id": "717dfe73-277d-4811-8be5-71d5717ea243",
      "name": "Create Web Warga",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "jyiiyKxh6DOyPVt5",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "resource": "folder",
        "name": "={{ DateTime.now().setZone('Asia/Tokyo').setLocale('id').toFormat('dd_MM_yyyy_HH_mm_ss') + '_' + ($('Data Input').item.json.Nama).trim().replace(/\\s+/g,'-').toUpperCase() + '_' + ($('Data Input').item.json.NIK) }}",
        "driveId": {
          "__rl": true,
          "mode": "list",
          "value": "My Drive"
        },
        "folderId": {
          "__rl": true,
          "value": "1po03k8LByOZlSZ7lOkFLWGijOWk5HZ5n",
          "mode": "list",
          "cachedResultName": "Data Warga Format json",
          "cachedResultUrl": "https://drive.google.com/drive/folders/1po03k8LByOZlSZ7lOkFLWGijOWk5HZ5n"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        -440,
        300
      ],
      "id": "35cad591-a3e7-4fb1-8f87-0e2cd3460bd4",
      "name": "Create Folder Warga",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "jyiiyKxh6DOyPVt5",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        220,
        160
      ],
      "id": "0795c243-1646-4133-b949-399027f50147",
      "name": "Merge"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -220,
        260
      ],
      "id": "beb5b6ed-6069-4c54-b2a8-903760ceede0",
      "name": "Merge4"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "5f3c9805-585e-4dd8-a9de-b83aa21cd301",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -880,
        2100
      ],
      "id": "6d21e63f-43da-4f40-8e83-9a7c2dd28d94",
      "name": "Webhook3",
      "webhookId": "5f3c9805-585e-4dd8-a9de-b83aa21cd301"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "UPDATE_ONLY",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "a6c9a0b4-c489-49ab-bf3f-fe62400d91b9"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "UPDATE_ONLY"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "cc0d5e24-157a-4d73-8523-296db2e66a18",
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "UPLOAD_FILES",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "UPLOAD_FILES"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "900496c4-5ae9-47e6-bc8e-1e15edcdb718",
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "DELETE_DOCS",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "DELETE_DOCS"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "b18a55bc-31a8-42f4-b9eb-63c4a724604c",
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "DELETE_ALL",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "DELETE_ALL"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "ef332668-f3d6-4460-936b-effd9ada2929",
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "CREATE_AND_SEND",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "CREATE_AND_SEND"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -440,
        2080
      ],
      "id": "f4f7be21-c0cb-4228-9b83-a4121fcafc46",
      "name": "Switch"
    },
    {
      "parameters": {
        "operation": "toJson",
        "options": {
          "fileName": "={{ DateTime.now().setZone('Asia/Tokyo').setLocale('id').toFormat('dd_MM_yyyy_HH_mm_ss') + '_' + ($json.pemohon.nama).trim().replace(/\\s+/g,'-').toUpperCase() + '_' + ($json.pemohon.nik) }}\n"
        }
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        -220,
        1680
      ],
      "id": "5d9ad8d8-fae4-4775-aa55-7416de330d30",
      "name": "Convert to File6"
    },
    {
      "parameters": {
        "operation": "update",
        "fileId": {
          "__rl": true,
          "value": "={{ $('Switch').item.json.id_user }}",
          "mode": "id"
        },
        "changeFileContent": true,
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        0,
        1680
      ],
      "id": "8a14e1ca-372e-4138-93f4-8833a0cd642d",
      "name": "Update file5",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "jyiiyKxh6DOyPVt5",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "/**\n * n8n Code Node ‚Äî Parse & Normalize Payload Surat + Binary Split (No Icon/Thumbnail/Binary_Prop)\n * Mode   : Run Once for All Items\n * Input  : items (array dari webhook, bisa ada binary)\n * Output : [{ json, binary }]\n */\n\nconst out = [];\n\nfor (const item of items) {\n  const body = item.json?.body ?? {};\n  let s = body.data ?? item.json;\n\n  // --- dukung multipart: body.data bisa string JSON ---\n  if (typeof s === 'string') {\n    try { s = JSON.parse(s); }\n    catch { s = {}; }\n  }\n\n  // ---------------- Utils ----------------\n  const has = (o, k) => Object.prototype.hasOwnProperty.call(o ?? {}, k);\n  const val = (o, k) => {\n    if (!o || typeof o !== 'object') return null;\n    if (!has(o, k)) return null;\n    const v = o[k];\n    if (v === undefined || v === '') return null;\n    return v;\n  };\n  const ensureStr = (x, fb='-') => {\n    const v = (x ?? '').toString().trim();\n    return v.length ? v : fb;\n  };\n  const toTitleCase = (str) => {\n    if (!str) return str;\n    return str.toLowerCase().replace(/\\b\\w/g, (c) => c.toUpperCase());\n  };\n  const lower = (s) => (s ?? '').toString().trim().toLowerCase();\n\n  const guessMimeFromName = (name='') => {\n    const n = (name || '').toLowerCase();\n    if (n.endsWith('.jpg') || n.endsWith('.jpeg')) return 'image/jpeg';\n    if (n.endsWith('.png'))  return 'image/png';\n    if (n.endsWith('.pdf'))  return 'application/pdf';\n    if (n.endsWith('.docx')) return 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';\n    if (n.endsWith('.doc'))  return 'application/msword';\n    if (n.endsWith('.xlsx')) return 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';\n    if (n.endsWith('.xls'))  return 'application/vnd.ms-excel';\n    return null;\n  };\n\n  // ---------------- Binary map ----------------\n  const bin = item.binary || {};\n  const binKeys = Object.keys(bin);\n\n  const binaryIndex = {};\n  for (const k of binKeys) {\n    const b = bin[k] || {};\n    const key = lower(k);\n    binaryIndex[key] = { prop: k, ...b };\n    if (b.fileName) {\n      binaryIndex[lower(b.fileName)] = { prop: k, ...b };\n    }\n  }\n\n  // ---------------- Tangkap delete_file_ids (INI YANG HILANG) ----------------\n  const deleteIds = Array.isArray(body.delete_file_ids)\n    ? body.delete_file_ids.filter(x => typeof x === 'string' && x.trim().length > 0)\n    : [];\n\n  // ---------------- Dokumen ----------------\n  let dokumen = [];\n  if (Array.isArray(s.dokumen)) {\n    dokumen = s.dokumen.map((d = {}) => {\n      const base = {\n        name         : d?.name ?? null,\n        type         : d?.type ?? d?.mimeType ?? null,\n        file_id      : d?.file_id ?? null,\n        size         : d?.size ?? null,\n        view_url     : d?.view_url ?? null,\n        download_url : d?.download_url ?? null,\n      };\n\n      // Enrichment dari binary\n      let bMatch = null;\n      if (d?.binary_prop && binaryIndex[lower(d.binary_prop)]) {\n        bMatch = binaryIndex[lower(d.binary_prop)];\n      } else if (base.name && binaryIndex[lower(base.name)]) {\n        bMatch = binaryIndex[lower(base.name)];\n      }\n\n      if (bMatch) {\n        base.type = base.type ?? bMatch.mimeType ?? null;\n        base.size = base.size ?? (bMatch.fileSize ?? null);\n        base.name = base.name ?? bMatch.fileName ?? null;\n      }\n\n      if (!base.type && base.name) {\n        const g = guessMimeFromName(base.name);\n        if (g) base.type = g;\n      }\n\n      return base;\n    });\n  } else if (binKeys.length) {\n    dokumen = binKeys.map((k) => {\n      const b = bin[k] || {};\n      return {\n        name        : b.fileName ?? k,\n        type        : b.mimeType ?? guessMimeFromName(b.fileName ?? '') ?? null,\n        file_id     : null,\n        size        : b.fileSize ?? null,\n        view_url    : null,\n        download_url: null,\n      };\n    });\n  }\n\n  // --- Opsional: bila action = DELETE_DOCS, kosongkan dokumen agar semantik jelas\n  const topAction = body.action ?? val(s, 'action');\n  if (String(topAction).toUpperCase() === 'DELETE_DOCS') {\n    // (pilihan) tetap boleh kirim dokumen, tapi biasanya tidak diperlukan saat delete\n    // dokumen = [];\n  }\n\n  // ---------------- Alamat/domisili ----------------\n  const pem = s.pemohon ?? {};\n  const kelVal   = ensureStr(val(pem, 'kelurahan/kampung') ?? val(pem, 'Kelurahan'));\n  const kecVal   = ensureStr(val(pem, 'kecamatan') ?? val(pem, 'Kecamatan'));\n  const kotaKab  = ensureStr(val(pem, 'kota_kab') ?? val(pem, 'Kabupaten') ?? val(pem, 'Kota'));\n  const provinsi = ensureStr(val(pem, 'provinsi') ?? val(pem, 'Provinsi') ?? 'Papua Tengah');\n\n  // ---------------- Payload akhir ----------------\n  const payload = {\n    action  : topAction,\n    strategy: body.strategy ?? val(s, 'strategy') ?? null,\n    id_user : body.id_user ?? val(s, 'id_user'),\n    id_surat: body.id_surat ?? val(s, 'id_surat'),\n    date    : val(s, 'date'),\n\n    // <‚Äî TAMBAHKAN FIELD INI\n    delete_file_ids: deleteIds,\n\n    pemohon: {\n      nama               : toTitleCase(val(pem, 'nama')),\n      nik                : val(pem, 'nik'),\n      ttl                : toTitleCase(val(pem, 'ttl')),\n      agama              : toTitleCase(val(pem, 'agama')),\n      jenis_kelamin      : toTitleCase(val(pem, 'jenis_kelamin')),\n      status_perkawinan  : toTitleCase(val(pem, 'status_perkawinan')),\n      pekerjaan          : toTitleCase(val(pem, 'pekerjaan')),\n      alamat             : toTitleCase(val(pem, 'alamat')),\n      \"kelurahan/kampung\": toTitleCase(kelVal),\n      kecamatan          : toTitleCase(kecVal),\n      kota_kab           : toTitleCase(kotaKab),\n      provinsi           : toTitleCase(provinsi),\n    },\n\n    dokumen,\n\n    WAHA_Trigger_session     : val(s, 'WAHA_Trigger_session'),\n    WAHA_Trigger_payload_from: val(s, 'WAHA_Trigger_payload_from'),\n    LogoURL                  : val(s, 'LogoURL'),\n    webhook                  : val(s, 'webhook'),\n  };\n\n  // ---------------- Binary Split ----------------\n  if (binKeys.length === 0) {\n    out.push({ json: payload });\n  } else {\n    for (const k of binKeys) {\n      out.push({\n        json: { ...payload, binaryProperty: k },\n        binary: { [k]: bin[k] },\n      });\n    }\n  }\n}\n\nreturn out;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -660,
        2100
      ],
      "id": "8d5cd7ae-af6b-4852-bc43-fd5a6c3f431d",
      "name": "Code10"
    },
    {
      "parameters": {
        "inputDataFieldName": "={{ $json.binaryProperty }}",
        "name": "={{ $binary[$json.binaryProperty].fileName }}",
        "driveId": {
          "__rl": true,
          "mode": "list",
          "value": "My Drive"
        },
        "folderId": {
          "__rl": true,
          "value": "={{ $json.id }}",
          "mode": "id"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        -220,
        2000
      ],
      "id": "b032b472-b2e5-4ca0-ad93-b6b36f7ff57d",
      "name": "Upload file",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "jyiiyKxh6DOyPVt5",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        0,
        1940
      ],
      "id": "83f4ec5f-87cc-4257-96a4-c6b8534e8e41",
      "name": "Merge6"
    },
    {
      "parameters": {
        "jsCode": "/**\n * n8n Code Node ‚Äî Aggregate Uploaded Items -> Single Clean Payload (MERGE old+new docs)\n * Mode: Run Once for All Items\n */\n\nconst toTitleCase = (str) => {\n  if (!str) return str;\n  return str.toString()\n    .toLowerCase()\n    .replace(/\\b\\w/g, c => c.toUpperCase());\n};\n\nconst ensureStr = (x, fb='-') => {\n  const v = (x ?? '').toString().trim();\n  return v.length ? v : fb;\n};\n\nconst firstWith = (xs, pred) => xs.find(pred) ?? {};\nconst J = items.map(it => it.json || {});\nconst base = firstWith(J, j => j && (j.pemohon || j.action || Array.isArray(j?.dokumen))) || (J[0] || {});\n\n/* ---------------- Normalizer untuk objek dokumen ---------------- */\nconst normDoc = (d = {}) => {\n  const name        = d.name ?? d.filename ?? null;\n  const file_id     = d.file_id ?? d.id ?? null;\n  const mimetype    = d.type ?? d.mimeType ?? d.mimetype ?? d.fileExtension ?? null;\n  const view_url    = d.view_url ?? d.webViewLink ?? d.viewUrl ?? null;\n  const download_url= d.download_url ?? d.webContentLink ?? d.downloadUrl ?? null;\n  const size        = d.size != null ? Number(d.size) :\n                      (typeof d.quotaBytesUsed !== 'undefined' ? Number(d.quotaBytesUsed) : null);\n\n  // susun objek tanpa icon & binary_prop\n  const obj = {\n    name,\n    type: mimetype,\n    file_id,\n    size: Number.isFinite(size) ? size : null,\n    view_url,\n    download_url,\n    thumbnail: d.thumbnail ?? d.thumbnailLink ?? null\n  };\n\n  // filter agar property dengan null dibuang\n  return Object.fromEntries(\n    Object.entries(obj).filter(([_, v]) => v !== null && v !== undefined)\n  );\n};\n\n/* ---------------- Kumpulkan dokumen lama (jika ada) ---------------- */\nconst oldDocs = [];\nfor (const j of J) {\n  if (j && Array.isArray(j.dokumen)) {\n    for (const d of j.dokumen) {\n      oldDocs.push(normDoc(d));\n    }\n  }\n}\n\n/* ---------------- Kumpulkan dokumen baru dari setiap item upload ---------------- */\nconst newDocs = [];\nfor (const j of J) {\n  const looksLikeFile =\n    j && (j.id || j.file_id) && (j.name || j.filename || j.originalFilename || j.fullFileExtension);\n\n  if (!looksLikeFile) continue;\n\n  const d = {\n    name: j.name ?? j.filename ?? j.originalFilename ?? null,\n    type: j.mimeType ?? j.mimetype ?? j.fileExtension ?? j.fullFileExtension ?? null,\n    file_id: j.id ?? j.file_id ?? null,\n    size: j.size ?? j.quotaBytesUsed ?? null,\n    view_url: j.webViewLink ?? null,\n    download_url: j.webContentLink ?? null,\n    thumbnail: j.thumbnailLink ?? null\n  };\n\n  newDocs.push(normDoc(d));\n}\n\n/* ---------------- Merge + de-duplicate ---------------- */\nconst keyOf = (d) => {\n  if (d.file_id) return `id:${d.file_id}`;\n  if (d.download_url) return `dl:${d.download_url}`;\n  if (d.view_url) return `vw:${d.view_url}`;\n  return `ns:${d.name || '-'}#${d.size || '-'}`;\n};\n\nconst seen = new Set();\nconst dokumen = [];\n\nfor (const d of oldDocs) {\n  const k = keyOf(d);\n  if (seen.has(k)) continue;\n  seen.add(k);\n  dokumen.push(d);\n}\nfor (const d of newDocs) {\n  const k = keyOf(d);\n  if (seen.has(k)) continue;\n  seen.add(k);\n  dokumen.push(d);\n}\n\n/* ---------------- Normalisasi alamat/domisili ---------------- */\nconst kel = ensureStr(base?.pemohon?.['kelurahan/kampung'] ?? base?.pemohon?.Kelurahan);\nconst kec = ensureStr(base?.pemohon?.kecamatan ?? base?.pemohon?.Kecamatan);\nconst kab = ensureStr(base?.pemohon?.kota_kab ?? base?.pemohon?.Kabupaten ?? base?.pemohon?.Kota);\nconst prov= ensureStr(base?.pemohon?.provinsi ?? base?.pemohon?.Provinsi ?? 'Papua Tengah');\n\n/* ---------------- Payload akhir ---------------- */\nconst payload = {\n  action   : base.action ?? J[0]?.action ?? 'UPLOAD_FILES',\n  strategy : base.strategy ?? J[0]?.strategy ?? 'OVERWRITE_BIN',\n  id_user  : base.id_user ?? J[0]?.id_user ?? null,\n  id_surat : base.id_surat ?? J[0]?.id_surat ?? null,\n  date     : base.date ?? null,\n\n  pemohon: {\n    nama              : toTitleCase(base?.pemohon?.nama ?? base?.Nama),\n    nik               : base?.pemohon?.nik ?? base?.NIK ?? null,\n    ttl               : toTitleCase(base?.pemohon?.ttl ?? base?.TTL),\n    agama             : toTitleCase(base?.pemohon?.agama ?? base?.Agama),\n    jenis_kelamin     : toTitleCase(base?.pemohon?.jenis_kelamin ?? base?.JenisKelamin),\n    status_perkawinan : toTitleCase(base?.pemohon?.status_perkawinan ?? base?.StatusPerkawinan),\n    pekerjaan         : toTitleCase(base?.pemohon?.pekerjaan ?? base?.Pekerjaan),\n    alamat            : toTitleCase(base?.pemohon?.alamat ?? base?.Alamat),\n\n    \"kelurahan/kampung\": toTitleCase(kel),\n    kecamatan          : toTitleCase(kec),\n    kota_kab           : toTitleCase(kab),\n    provinsi           : toTitleCase(prov),\n  },\n\n  dokumen,\n\n  WAHA_Trigger_session      : base.WAHA_Trigger_session ?? null,\n  WAHA_Trigger_payload_from : base.WAHA_Trigger_payload_from ?? null,\n  LogoURL                   : base.LogoURL ?? null,\n  webhook                   : base.webhook ?? base.URL_POST ?? null,\n};\n\nreturn [{ json: payload }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        220,
        1940
      ],
      "id": "b2314c07-0281-4936-b439-9769597d0b70",
      "name": "Code12"
    },
    {
      "parameters": {
        "operation": "toJson",
        "options": {
          "fileName": "={{ DateTime.now().setZone('Asia/Tokyo').setLocale('id').toFormat('dd_MM_yyyy_HH_mm_ss') + '_' + ($json.pemohon.nama).trim().replace(/\\s+/g,'-').toUpperCase() + '_' + ($json.pemohon.nik) }}\n"
        }
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        440,
        1940
      ],
      "id": "2ee84597-0936-455d-a781-d002cc950539",
      "name": "Convert to File4"
    },
    {
      "parameters": {
        "operation": "update",
        "fileId": {
          "__rl": true,
          "value": "={{ $('Code12').item.json.id_user }}",
          "mode": "id"
        },
        "changeFileContent": true,
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        660,
        1940
      ],
      "id": "e111346e-1391-4dc7-a318-9acef5098524",
      "name": "Update file1",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "jyiiyKxh6DOyPVt5",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "resource": "Chatting",
        "operation": "Send Text",
        "session": "={{ $('Code12').item.json.WAHA_Trigger_session }}",
        "chatId": "={{ $('Code12').item.json.WAHA_Trigger_payload_from }}",
        "text": "‚úÖ File berhasil terupload!",
        "requestOptions": {}
      },
      "type": "@devlikeapro/n8n-nodes-waha.WAHA",
      "typeVersion": 202502,
      "position": [
        880,
        1940
      ],
      "id": "e4493264-01a4-473c-ab28-a03d3a8dbd41",
      "name": "Send a text message6",
      "credentials": {
        "wahaApi": {
          "id": "uivlaHVGkUY1vyJT",
          "name": "WAHA account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Ambil data dari input\nconst input = items[0].json;  \n\n// Ambil langsung field delete_file_ids\nconst output = {\n  delete_file_ids: input.delete_file_ids || []\n};\n\n// Kembalikan hasil\nreturn [{ json: output }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -220,
        2400
      ],
      "id": "9d179c8a-8bd2-41d7-b496-4933c7488ac7",
      "name": "Code11"
    },
    {
      "parameters": {
        "method": "DELETE",
        "url": "=https://www.googleapis.com/drive/v3/files/{{ $('Code11').item.json.delete_file_ids }}?supportsAllDrives=true",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "googleOAuth2Api",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        0,
        2400
      ],
      "id": "957ac85a-418b-48db-9dd7-1a2bf52cc140",
      "name": "Delete File1",
      "credentials": {
        "googleOAuth2Api": {
          "id": "L31Mzf4p7TJyr4bB",
          "name": "Google account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "/**\n * n8n Code Node ‚Äî Ambil Semua ID dari Payload\n * Mode   : Run Once for Single Item\n * Input  : { json }\n * Output : Array of items { json: { fileId } }\n */\n\n// ==== Helper: Ambil segmen terakhir dari URL / path ====\nfunction tailId(v) {\n  if (typeof v !== 'string') return '';\n  const s = v.trim();\n  if (!s) return '';\n\n  try {\n    // Jika URL valid\n    const u = new URL(s);\n    const parts = u.pathname.split('/').filter(Boolean);\n    return parts.length ? parts[parts.length - 1] : s;\n  } catch {\n    // Jika bukan URL valid ‚Üí fallback split biasa\n    const parts = s.split('/').filter(Boolean);\n    return parts.length ? parts[parts.length - 1] : s;\n  }\n}\n\n// Ambil body & data\nconst body = $json.body || {};\nconst data = body.data || $json || {};\n\n// 1) id_user\nconst idUser = (data.id_user || body.id_user || '').trim();\n\n// 2) id_surat ‚Üí ambil ID terakhir dari link\nconst idSuratRaw = data.id_surat || body.id_surat || '';\nconst idSurat = tailId(idSuratRaw);\n\n// 3) file_id dari dokumen\nconst fromDocs = Array.isArray(data.dokumen)\n  ? data.dokumen.map(d => d?.file_id).filter(Boolean)\n  : [];\n\n// 4) delete_file_ids (jika ada)\nconst explicit = Array.isArray(data.delete_file_ids)\n  ? data.delete_file_ids.filter(Boolean)\n  : [];\n\n// 5) Gabungkan semua sumber\nconst allIds = []\n  .concat(idUser, idSurat, explicit, fromDocs)\n  .filter(x => typeof x === 'string' && x.trim().length > 0);\n\n// 6) Buat unik\nconst uniq = [...new Set(allIds.map(x => x.trim()))];\n\n// 7) Return array items untuk n8n\nreturn uniq.map(id => ({ json: { fileId: id } }));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -220,
        2600
      ],
      "id": "4b113350-376b-48a7-a901-3195460fe0ae",
      "name": "Code13",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "method": "DELETE",
        "url": "=https://www.googleapis.com/drive/v3/files/{{ $json.fileId }}\n?supportsAllDrives=true",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "googleOAuth2Api",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        0,
        2600
      ],
      "id": "fe5c06c3-e4af-49aa-95ca-c4c2bf94550a",
      "name": "Hapus Semua1",
      "credentials": {
        "googleOAuth2Api": {
          "id": "L31Mzf4p7TJyr4bB",
          "name": "Google account"
        }
      }
    },
    {
      "parameters": {
        "resource": "Chatting",
        "operation": "Send Text",
        "session": "={{ $('Switch').item.json.WAHA_Trigger_session }}",
        "chatId": "={{ $('Switch').item.json.WAHA_Trigger_payload_from }}",
        "reply_to": "=",
        "text": "‚úÖ Surat dan Data berhasil dihapus!",
        "requestOptions": {}
      },
      "type": "@devlikeapro/n8n-nodes-waha.WAHA",
      "typeVersion": 202502,
      "position": [
        220,
        2600
      ],
      "id": "2a1c59bb-5dd4-4d26-9cf2-0c8b0c225fb5",
      "name": "Send a text message7",
      "executeOnce": true,
      "credentials": {
        "wahaApi": {
          "id": "uivlaHVGkUY1vyJT",
          "name": "WAHA account"
        }
      }
    },
    {
      "parameters": {
        "resource": "Chatting",
        "operation": "Send Text",
        "session": "={{ $('Switch').item.json.WAHA_Trigger_session }}",
        "chatId": "={{ $('Switch').item.json.WAHA_Trigger_payload_from }}",
        "text": "‚úÖ File berhasil dihapus!",
        "requestOptions": {}
      },
      "type": "@devlikeapro/n8n-nodes-waha.WAHA",
      "typeVersion": 202502,
      "position": [
        220,
        2400
      ],
      "id": "2824fe24-7006-4920-bffa-0196d748c25d",
      "name": "Send a text message9",
      "credentials": {
        "wahaApi": {
          "id": "uivlaHVGkUY1vyJT",
          "name": "WAHA account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Ambil data dari input\nconst input = items[0].json;  // kalau di n8n\n// const input = JSON.parse(JSON.stringify(yourJson)); // kalau manual\n\n// Ambil daftar file_id yang mau dihapus\nconst toDelete = new Set(input.delete_file_ids || []);\n\n// Filter dokumen agar tidak menyertakan file_id yang ada di delete_file_ids\nconst newDocs = (input.dokumen || []).filter(doc => !toDelete.has(doc.file_id));\n\n// Buat output baru TANPA delete_file_ids\nconst { delete_file_ids, ...rest } = input;\nconst output = {\n  ...rest,\n  dokumen: newDocs\n};\n\n// Kembalikan hasil\nreturn [{ json: output }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -220,
        2200
      ],
      "id": "0190b237-e1d1-4aaa-9670-9d2b712b5c0f",
      "name": "Code14"
    },
    {
      "parameters": {
        "operation": "toJson",
        "options": {
          "fileName": "={{ DateTime.now().setZone('Asia/Tokyo').setLocale('id').toFormat('dd_MM_yyyy_HH_mm_ss') + '_' + ($json.pemohon.nama).trim().replace(/\\s+/g,'-').toUpperCase() + '_' + ($json.pemohon.nik) }}\n"
        }
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        0,
        2200
      ],
      "id": "18399557-fdbb-4232-a05e-441e2a04e570",
      "name": "Convert to File8"
    },
    {
      "parameters": {
        "operation": "update",
        "fileId": {
          "__rl": true,
          "value": "={{ $('Switch').item.json.id_user }}",
          "mode": "id"
        },
        "changeFileContent": true,
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        220,
        2200
      ],
      "id": "36be0934-7bae-4915-ab40-9bcc925fbf41",
      "name": "Update file7",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "jyiiyKxh6DOyPVt5",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://n8n-qz8tp6856ibc.bgxy.sumopod.my.id/webhook/737cd7f5-bfa1-4b9c-b55a-21aa718bfc3d",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$input.all().map(i => i.json)}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -100,
        2920
      ],
      "id": "d0e8b474-ff05-494b-9bc8-6d577f0910f5",
      "name": "HTTP Request2"
    },
    {
      "parameters": {
        "resource": "Chatting",
        "operation": "Send Text",
        "session": "={{ $('Switch').item.json.WAHA_Trigger_session }}",
        "chatId": "={{ $('Switch').item.json.WAHA_Trigger_payload_from }}",
        "text": "‚úÖ Surat dan Data berhasil Terkirim!",
        "requestOptions": {}
      },
      "type": "@devlikeapro/n8n-nodes-waha.WAHA",
      "typeVersion": 202502,
      "position": [
        160,
        2920
      ],
      "id": "ad55a5f6-cdfb-48ca-bc91-dc2dc863bc7c",
      "name": "Send a text message8",
      "credentials": {
        "wahaApi": {
          "id": "uivlaHVGkUY1vyJT",
          "name": "WAHA account"
        }
      }
    },
    {
      "parameters": {
        "resource": "Chatting",
        "operation": "Send Text",
        "session": "={{ $('Switch').item.json.WAHA_Trigger_session }}",
        "chatId": "={{ $('Switch').item.json.WAHA_Trigger_payload_from }}",
        "text": "‚úÖ Mohon tunggu notifikasi selanjutnya dari saya!",
        "requestOptions": {}
      },
      "type": "@devlikeapro/n8n-nodes-waha.WAHA",
      "typeVersion": 202502,
      "position": [
        420,
        2920
      ],
      "id": "e3ab2917-84d3-4047-b667-222e686da536",
      "name": "Send a text message10",
      "credentials": {
        "wahaApi": {
          "id": "uivlaHVGkUY1vyJT",
          "name": "WAHA account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Ambil data dari input\nconst input = items[0].json;  // kalau di n8n\n// const input = JSON.parse(JSON.stringify(yourJson)); // kalau manual\n\n// Ambil daftar file_id yang mau dihapus\nconst toDelete = new Set(input.delete_file_ids || []);\n\n// Filter dokumen agar tidak menyertakan file_id yang ada di delete_file_ids\nconst newDocs = (input.dokumen || []).filter(doc => !toDelete.has(doc.file_id));\n\n// Buat output baru TANPA delete_file_ids\nconst { delete_file_ids, ...rest } = input;\nconst output = {\n  ...rest,\n  dokumen: newDocs,\n  status: \"terkirim\"\n};\n\n// Kembalikan hasil\nreturn [{ json: output }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -60,
        2780
      ],
      "id": "85c8a2c5-e697-4f3d-92e0-50df1ce4f769",
      "name": "Code15"
    },
    {
      "parameters": {
        "operation": "toJson",
        "options": {
          "fileName": "={{ DateTime.now().setZone('Asia/Tokyo').setLocale('id').toFormat('dd_MM_yyyy_HH_mm_ss') + '_' + ($json.pemohon.nama).trim().replace(/\\s+/g,'-').toUpperCase() + '_' + ($json.pemohon.nik) }}\n"
        }
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        160,
        2780
      ],
      "id": "1e076910-02be-4089-bbbd-f0b96f168ddb",
      "name": "Convert to File9"
    },
    {
      "parameters": {
        "operation": "update",
        "fileId": {
          "__rl": true,
          "value": "={{ $('Switch').item.json.id_user }}",
          "mode": "id"
        },
        "changeFileContent": true,
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        380,
        2780
      ],
      "id": "f2b907bb-867d-48fb-aa6b-cf833cabd0e3",
      "name": "Update file8",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "jyiiyKxh6DOyPVt5",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "/**\n * n8n Code Node ‚Äî Parse & Normalize Payload Surat + Binary Split (No Icon/Thumbnail/Binary_Prop)\n * Mode   : Run Once for All Items\n * Input  : items (array dari webhook, bisa ada binary)\n * Output : [{ json, binary }]\n */\n\nconst out = [];\n\nfor (const item of items) {\n  /* -------------------- Ambil body & normalisasi s -------------------- */\n  const rawBody = item.json?.body ?? item.json ?? {};\n  let s = null;\n\n  // Jika body sudah array (kasus Anda): ambil elemen pertama\n  if (Array.isArray(rawBody)) {\n    s = rawBody[0] ?? {};\n  } else if (typeof rawBody === 'string') {\n    // Jika body string JSON\n    try { s = JSON.parse(rawBody); } catch { s = {}; }\n  } else if (rawBody && typeof rawBody === 'object') {\n    // Bisa jadi struktur { data: ... } atau langsung payload\n    s = rawBody.data ?? rawBody;\n    if (typeof s === 'string') {\n      try { s = JSON.parse(s); } catch { s = {}; }\n    }\n  } else {\n    s = {};\n  }\n\n  /* -------------------- Utils -------------------- */\n  const has = (o, k) => Object.prototype.hasOwnProperty.call(o ?? {}, k);\n  const val = (o, k) => {\n    if (!o || typeof o !== 'object') return null;\n    if (!has(o, k)) return null;\n    const v = o[k];\n    if (v === undefined || v === '') return null;\n    return v;\n  };\n  const ensureStr = (x, fb = '-') => {\n    const v = (x ?? '').toString().trim();\n    return v.length ? v : fb;\n  };\n  const toTitleCase = (str) => {\n    if (!str) return str;\n    return str.toString().toLowerCase().replace(/\\b\\w/g, c => c.toUpperCase());\n  };\n  const lower = (x) => (x ?? '').toString().trim().toLowerCase();\n  const guessMimeFromName = (name = '') => {\n    const n = (name || '').toLowerCase();\n    if (n.endsWith('.jpg') || n.endsWith('.jpeg')) return 'image/jpeg';\n    if (n.endsWith('.png'))  return 'image/png';\n    if (n.endsWith('.pdf'))  return 'application/pdf';\n    if (n.endsWith('.docx')) return 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';\n    if (n.endsWith('.doc'))  return 'application/msword';\n    if (n.endsWith('.xlsx')) return 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';\n    if (n.endsWith('.xls'))  return 'application/vnd.ms-excel';\n    return null;\n  };\n\n  /* -------------------- Binary map (untuk multipart) -------------------- */\n  const bin = item.binary || {};\n  const binKeys = Object.keys(bin);\n\n  const binaryIndex = {};\n  for (const k of binKeys) {\n    const b = bin[k] || {};\n    const key = lower(k);\n    binaryIndex[key] = { prop: k, ...b };\n    if (b.fileName) {\n      binaryIndex[lower(b.fileName)] = { prop: k, ...b };\n    }\n  }\n\n  /* -------------------- Ambil nilai penting dari payload s -------------------- */\n  const topAction = (val(s, 'action') || '').toString().toUpperCase() || null;\n\n  // delete_file_ids (array of string)\n  const delRaw = val(s, 'delete_file_ids');\n  const deleteIds = Array.isArray(delRaw)\n    ? delRaw.filter(x => typeof x === 'string' && x.trim().length > 0)\n    : [];\n\n  /* -------------------- Dokumen -------------------- */\n  let dokumen = [];\n  if (Array.isArray(s.dokumen)) {\n    dokumen = s.dokumen.map((d = {}) => {\n      const base = {\n        name         : d?.name ?? null,\n        type         : d?.type ?? d?.mimeType ?? null,\n        file_id      : d?.file_id ?? null,\n        size         : d?.size ?? null,\n        view_url     : d?.view_url ?? null,\n        download_url : d?.download_url ?? null,\n      };\n\n      // Enrichment dari binary (cocokkan via nama/binary_prop jika ada)\n      let bMatch = null;\n      if (d?.binary_prop && binaryIndex[lower(d.binary_prop)]) {\n        bMatch = binaryIndex[lower(d.binary_prop)];\n      } else if (base.name && binaryIndex[lower(base.name)]) {\n        bMatch = binaryIndex[lower(base.name)];\n      }\n\n      if (bMatch) {\n        base.type = base.type ?? bMatch.mimeType ?? null;\n        base.size = base.size ?? (bMatch.fileSize ?? null);\n        base.name = base.name ?? bMatch.fileName ?? null;\n      }\n\n      if (!base.type && base.name) {\n        const g = guessMimeFromName(base.name);\n        if (g) base.type = g;\n      }\n\n      return base;\n    });\n  } else if (binKeys.length) {\n    // Jika tidak ada dokumen dalam JSON tapi ada binary multipart\n    dokumen = binKeys.map((k) => {\n      const b = bin[k] || {};\n      return {\n        name        : b.fileName ?? k,\n        type        : b.mimeType ?? guessMimeFromName(b.fileName ?? '') ?? null,\n        file_id     : null,\n        size        : b.fileSize ?? null,\n        view_url    : null,\n        download_url: null,\n      };\n    });\n  }\n\n  // Catatan: bila action = DELETE_DOCS, biasanya tidak perlu isi dokumen (opsional)\n  // if (topAction === 'DELETE_DOCS') dokumen = [];\n\n  /* -------------------- Pemohon & alamat -------------------- */\n  const pem = s.pemohon ?? {};\n  const kelVal   = ensureStr(val(pem, 'kelurahan/kampung') ?? val(pem, 'Kelurahan'));\n  const kecVal   = ensureStr(val(pem, 'kecamatan') ?? val(pem, 'Kecamatan'));\n  const kotaKab  = ensureStr(val(pem, 'kota_kab') ?? val(pem, 'Kabupaten') ?? val(pem, 'Kota'));\n  const provinsi = ensureStr(val(pem, 'provinsi') ?? val(pem, 'Provinsi') ?? 'Papua Tengah');\n\n  /* -------------------- Payload akhir -------------------- */\n  const payload = {\n    action   : topAction,\n    strategy : val(s, 'strategy') ?? null,\n    id_user  : val(s, 'id_user'),\n    id_surat : val(s, 'id_surat'),\n    date     : val(s, 'date'),\n\n    delete_file_ids: deleteIds,\n\n    pemohon: {\n      nama               : toTitleCase(val(pem, 'nama')),\n      nik                : val(pem, 'nik'),\n      ttl                : toTitleCase(val(pem, 'ttl')),\n      agama              : toTitleCase(val(pem, 'agama')),\n      jenis_kelamin      : toTitleCase(val(pem, 'jenis_kelamin')),\n      status_perkawinan  : toTitleCase(val(pem, 'status_perkawinan')),\n      pekerjaan          : toTitleCase(val(pem, 'pekerjaan')),\n      alamat             : toTitleCase(val(pem, 'alamat')),\n      \"kelurahan/kampung\": toTitleCase(kelVal),\n      kecamatan          : toTitleCase(kecVal),\n      kota_kab           : toTitleCase(kotaKab),\n      provinsi           : toTitleCase(provinsi),\n    },\n\n    dokumen,\n\n    WAHA_Trigger_session     : val(s, 'WAHA_Trigger_session'),\n    WAHA_Trigger_payload_from: val(s, 'WAHA_Trigger_payload_from'),\n    LogoURL                  : val(s, 'LogoURL'),\n    webhook                  : val(s, 'webhook'),\n  };\n\n  /* -------------------- Binary Split -------------------- */\n  const binKeysNow = Object.keys(item.binary || {});\n  if (binKeysNow.length === 0) {\n    out.push({ json: payload });\n  } else {\n    for (const k of binKeysNow) {\n      out.push({\n        json  : { ...payload, binaryProperty: k },\n        binary: { [k]: item.binary[k] },\n      });\n    }\n  }\n}\n\nreturn out;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -580,
        3360
      ],
      "id": "d8a95594-6dea-4c5d-905e-a7e05e3aff1a",
      "name": "Code16"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pemohon[\"kelurahan/kampung\"] }}",
                    "rightValue": "Inauga",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "9d02af7b-4ad2-4636-b779-c24ad20574ff"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Inauga"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "218927f5-f51f-471f-be4a-010701020f4f",
                    "leftValue": "={{ $json.pemohon[\"kelurahan/kampung\"] }}",
                    "rightValue": "Kamoro Jaya",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Kamoro Jaya"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "434f5383-4146-481b-ac6a-21e3af3a816a",
                    "leftValue": "={{ $json.pemohon[\"kelurahan/kampung\"] }}",
                    "rightValue": "Wonosari Jaya",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Wonosari Jaya"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "85b276dd-7c0a-4a6b-adb0-2778e24fe319",
                    "leftValue": "={{ $json.pemohon[\"kelurahan/kampung\"] }}",
                    "rightValue": "Kadun Jaya",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Kadun Jaya"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "1ef4e71e-4e0b-4555-b29d-552a3a595364",
                    "leftValue": "={{ $json.pemohon[\"kelurahan/kampung\"] }}",
                    "rightValue": "Mandiri Jaya",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Mandiri Jaya"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "ac69d6ab-7383-4492-bbdc-ae9ab541346c",
                    "leftValue": "={{ $json.pemohon[\"kelurahan/kampung\"] }}",
                    "rightValue": "Mawokau Jaya",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Mawokau Jaya"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "ff40f43b-2fe7-4567-8ec8-cdeca15f5807",
                    "leftValue": "={{ $json.pemohon[\"kelurahan/kampung\"] }}",
                    "rightValue": "Nawaripi",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Nawaripi"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -320,
        3240
      ],
      "id": "1548f910-a915-4b06-8e11-5c156f4359bb",
      "name": "Switch1"
    }
  ],
  "connections": {
    "Data Input": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate HTML": {
      "main": [
        [
          {
            "node": "Create Web Warga",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "Convert to File",
            "type": "main",
            "index": 0
          },
          {
            "node": "Create Folder Warga",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert to File": {
      "main": [
        [
          {
            "node": "Extract from File1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code1": {
      "main": [
        [
          {
            "node": "Convert to File1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert to File1": {
      "main": [
        [
          {
            "node": "Update file",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update file": {
      "main": [
        [
          {
            "node": "Send a text message4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File1": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge1": {
      "main": [
        [
          {
            "node": "Code1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upload file2": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Code2": {
      "main": [
        [
          {
            "node": "Upload file2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Uploud File": {
      "main": [
        [
          {
            "node": "Code2",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code3": {
      "main": [
        [
          {
            "node": "Convert to File3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert to File3": {
      "main": [
        [
          {
            "node": "Update file2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Data": {
      "main": [
        [
          {
            "node": "Code3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTML1": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code5": {
      "main": [
        [
          {
            "node": "Convert to File5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert to File5": {
      "main": [
        [
          {
            "node": "Update file4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update file4": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Delete File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete file": {
      "main": [
        [
          {
            "node": "Code5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Hapus Surat": {
      "main": [
        [
          {
            "node": "Code4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code4": {
      "main": [
        [
          {
            "node": "Hapus Semua",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code6": {
      "main": [
        [
          {
            "node": "Merge3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert to File2": {
      "main": [
        [
          {
            "node": "Upload file3",
            "type": "main",
            "index": 0
          },
          {
            "node": "Extract from File2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upload file3": {
      "main": [
        [
          {
            "node": "Merge2",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Extract from File2": {
      "main": [
        [
          {
            "node": "Merge2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge2": {
      "main": [
        [
          {
            "node": "HTML",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTML": {
      "main": [
        [
          {
            "node": "HTTP Request1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Kirim data": {
      "main": [
        [
          {
            "node": "Code16",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upload file4": {
      "main": [
        [
          {
            "node": "Send a text message1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "Upload file4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code7": {
      "main": [
        [
          {
            "node": "Download file",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code8": {
      "main": [
        [
          {
            "node": "Upload file5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download file": {
      "main": [
        [
          {
            "node": "Code8",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upload file5": {
      "main": [
        [
          {
            "node": "Merge3",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge3": {
      "main": [
        [
          {
            "node": "Code9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code9": {
      "main": [
        [
          {
            "node": "Convert to File2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook1": {
      "main": [
        [
          {
            "node": "Send a text message2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Write Surat Usaha": {
      "main": [
        [
          {
            "node": "Saved Surat Usaha",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Saved Surat Usaha": {
      "main": [
        [
          {
            "node": "Extract from File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Link Surat Usaha": {
      "main": [
        [
          {
            "node": "Send Link Surat  Gmail",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Link Surat  Gmail": {
      "main": [
        [
          {
            "node": "Send Link Surat Wa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File": {
      "main": [
        [
          {
            "node": "Send a file",
            "type": "main",
            "index": 0
          },
          {
            "node": "Send a file1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook2": {
      "main": [
        [
          {
            "node": "Copy file",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "Merge3",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Copy file": {
      "main": [
        [
          {
            "node": "Write Surat Usaha",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Json Data Warga": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Create Web Warga": {
      "main": [
        [
          {
            "node": "Send a text message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Folder Warga": {
      "main": [
        [
          {
            "node": "Merge4",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "HTML1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge4": {
      "main": [
        [
          {
            "node": "Create Json Data Warga",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook3": {
      "main": [
        [
          {
            "node": "Code10",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Convert to File6",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge6",
            "type": "main",
            "index": 0
          },
          {
            "node": "Upload file",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code14",
            "type": "main",
            "index": 0
          },
          {
            "node": "Code11",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code13",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HTTP Request2",
            "type": "main",
            "index": 0
          },
          {
            "node": "Code15",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert to File6": {
      "main": [
        [
          {
            "node": "Update file5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update file5": {
      "main": [
        [
          {
            "node": "Send a text message5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code10": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upload file": {
      "main": [
        [
          {
            "node": "Merge6",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge6": {
      "main": [
        [
          {
            "node": "Code12",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code12": {
      "main": [
        [
          {
            "node": "Convert to File4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert to File4": {
      "main": [
        [
          {
            "node": "Update file1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update file1": {
      "main": [
        [
          {
            "node": "Send a text message6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code11": {
      "main": [
        [
          {
            "node": "Delete File1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete File1": {
      "main": [
        [
          {
            "node": "Send a text message9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code13": {
      "main": [
        [
          {
            "node": "Hapus Semua1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Hapus Semua1": {
      "main": [
        [
          {
            "node": "Send a text message7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert to File8": {
      "main": [
        [
          {
            "node": "Update file7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code14": {
      "main": [
        [
          {
            "node": "Convert to File8",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request2": {
      "main": [
        [
          {
            "node": "Send a text message8",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send a text message8": {
      "main": [
        [
          {
            "node": "Send a text message10",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code15": {
      "main": [
        [
          {
            "node": "Convert to File9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert to File9": {
      "main": [
        [
          {
            "node": "Update file8",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code16": {
      "main": [
        [
          {
            "node": "Switch1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": null,
  "pinData": {
    "Webhook2": [
      {
        "json": {
          "headers": {
            "host": "n8n-qz8tp6856ibc.bgxy.sumopod.my.id",
            "user-agent": "Mozilla/5.0 (Linux; Android 10; K) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Mobile Safari/537.36",
            "content-length": "2072",
            "accept": "*/*",
            "accept-encoding": "gzip, br",
            "accept-language": "id-ID,id;q=0.9,en-US;q=0.8,en;q=0.7",
            "cdn-loop": "cloudflare; loops=1",
            "cf-connecting-ip": "114.10.135.185",
            "cf-ipcountry": "ID",
            "cf-ray": "978356520c4c5cd7-SIN",
            "cf-visitor": "{\"scheme\":\"https\"}",
            "content-type": "application/json",
            "origin": "https://distrikwania.com",
            "priority": "u=1, i",
            "referer": "https://distrikwania.com/",
            "sec-ch-ua": "\"Not;A=Brand\";v=\"99\", \"Google Chrome\";v=\"139\", \"Chromium\";v=\"139\"",
            "sec-ch-ua-mobile": "?1",
            "sec-ch-ua-platform": "\"Android\"",
            "sec-fetch-dest": "empty",
            "sec-fetch-mode": "cors",
            "sec-fetch-site": "cross-site",
            "x-forwarded-for": "114.10.135.185, 162.158.189.164",
            "x-forwarded-host": "n8n-qz8tp6856ibc.bgxy.sumopod.my.id",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "f3675854bda2",
            "x-real-ip": "162.158.189.164"
          },
          "params": {},
          "query": {},
          "body": {
            "jenis_surat": "Surat Keterangan Tidak Mampu (SKTM)",
            "nomor_surat": "400.2.1 / 767 / 2025",
            "tanggal_surat": "01 September 2025",
            "pemohon": {
              "nama": "Agung Hendi Temorubun",
              "nik": "9109010807030004",
              "ttl": "Timika 22 Juli",
              "agama": "Katholik",
              "jenis_kelamin": "Laki-Laki",
              "status_perkawinan": "Belum Kawin",
              "pekerjaan": "Mahasiswa",
              "alamat": "Jln. Cendrawasih Sp2",
              "kelurahan": "Pasar Sentral",
              "kecamatan": "Wania",
              "kota_kab": "Mimika",
              "provinsi": "Papua Tengah",
              "domisili": "Pasar Sentral, Wania, Mimika, Papua Tengah"
            },
            "dokumen": [],
            "penandatangan": {
              "nama": "Merlyn Temorubun",
              "nip": "085230047347",
              "jabatan": "Kepala Distrik"
            },
            "operator": "Kawe Nia",
            "ref": "-",
            "WAHA_Trigger_session": "KaweNia",
            "WAHA_Trigger_payload_from": "6285652240263@c.us",
            "LogoURL": "https://upload.wikimedia.org/wikipedia/commons/thumb/1/10/Lambang_Kabupaten_Mimika.jpg/500px-Lambang_Kabupaten_Mimika.jpg",
            "URL_CREATE": "https://n8n-qz8tp6856ibc.bgxy.sumopod.my.id/webhook-test/1ae8a1a1-9f9d-4792-8505-9c84e1d3654b",
            "URL_UPDATE": "https://n8n-qz8tp6856ibc.bgxy.sumopod.my.id/webhook-test/1ae8a1a1-9f9d-4792-8505-9c84e1d3654b",
            "URL_DELETE": "https://n8n-qz8tp6856ibc.bgxy.sumopod.my.id/webhook-test/1ae8a1a1-9f9d-4792-8505-9c84e1d3654b",
            "URL_UPLOAD": "https://n8n-qz8tp6856ibc.bgxy.sumopod.my.id/webhook/1ae8a1a1-9f9d-4792-8505-9c84e1d3654b",
            "URL_DELETE_FILE": "https://n8n-qz8tp6856ibc.bgxy.sumopod.my.id/webhook-test/1ae8a1a1-9f9d-4792-8505-9c84e1d3654b",
            "id_user": "1hvwLX73QFQ30_c_VNgFcHSHy4mTRuMea",
            "id_surat_raw": "https://distrikwania.com/data/1gfO4gon2OcI9uQEVJAY3fg-PUXmYUGHb",
            "id_surat": "https://distrikwania.com/data/17fKN3QxS6OUkqMvq72jmY1RqLpRfQ0eU",
            "url_web_link": "",
            "action": "",
            "timestamp": "",
            "files_info": [],
            "delete_file_ids": [],
            "ids": {
              "all_unique": [
                "1pqd0sEj2sEFZWA5RkKMMLqtH4nC-XO2w",
                "https://distrikwania.com/data/1gfO4gon2OcI9uQEVJAY3fg-PUXmYUGHb",
                "1gfO4gon2OcI9uQEVJAY3fg-PUXmYUGHb"
              ],
              "detail": {
                "id_user": "1pqd0sEj2sEFZWA5RkKMMLqtH4nC-XO2w",
                "id_surat_raw": "https://distrikwania.com/data/1gfO4gon2OcI9uQEVJAY3fg-PUXmYUGHb",
                "id_surat": "1gfO4gon2OcI9uQEVJAY3fg-PUXmYUGHb",
                "delete_file_ids": [],
                "drive_files": []
              }
            }
          },
          "webhookUrl": "https://n8n-qz8tp6856ibc.bgxy.sumopod.my.id/webhook/1e87058d-af1d-4cf2-918e-93e7682dda01",
          "executionMode": "production"
        }
      }
    ],
    "Delete file": [
      {
        "json": {
          "headers": {
            "host": "n8n-qz8tp6856ibc.bgxy.sumopod.my.id",
            "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/140.0.0.0 Safari/537.36",
            "content-length": "1455",
            "accept": "*/*",
            "accept-encoding": "gzip, br",
            "accept-language": "id,en-US;q=0.9,en;q=0.8",
            "cdn-loop": "cloudflare; loops=1",
            "cf-connecting-ip": "114.10.135.57",
            "cf-ipcountry": "ID",
            "cf-ray": "979a0bc49b454048-SIN",
            "cf-visitor": "{\"scheme\":\"https\"}",
            "content-type": "application/json",
            "origin": "https://distrikwania.com",
            "priority": "u=1, i",
            "referer": "https://distrikwania.com/",
            "sec-ch-ua": "\"Chromium\";v=\"140\", \"Not=A?Brand\";v=\"24\", \"Google Chrome\";v=\"140\"",
            "sec-ch-ua-mobile": "?0",
            "sec-ch-ua-platform": "\"Windows\"",
            "sec-fetch-dest": "empty",
            "sec-fetch-mode": "cors",
            "sec-fetch-site": "cross-site",
            "x-forwarded-for": "114.10.135.57, 162.158.107.80",
            "x-forwarded-host": "n8n-qz8tp6856ibc.bgxy.sumopod.my.id",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "f3675854bda2",
            "x-real-ip": "162.158.107.80"
          },
          "params": {},
          "query": {},
          "body": {
            "action": "UPDATE_ONLY",
            "strategy": "OVERWRITE_BIN",
            "id_user": "1wq2RRJqfrGq-wssB7shlxq8EG2OZnelW",
            "data": {
              "jenis_surat": "Surat Keterangan Tidak Mampu (SKTM)",
              "nomor_surat": "400.2.1 / 767 / 2025",
              "tanggal_surat": "26 Agustus 2025",
              "pemohon": {
                "nama": "MUSDAHLIFA",
                "nik": "91709011408790006",
                "ttl": "SERUI, 14-08-1979",
                "agama": "ISLAM",
                "jenis_kelamin": "LAKI-LAKI",
                "status_perkawinan": "KAWIN",
                "pekerjaan": "PEGAWAI NEGERI SIPIL (PNS)",
                "alamat": "JL. SERAYU NO.305, RT 009/RW 004",
                "kelurahan": "KAMORO JAYA",
                "kecamatan": "WANIA",
                "kota_kab": "MIMIKA",
                "provinsi": "PAPUA TENGAH"
              },
              "dokumen": [],
              "penandatangan": {
                "nama": "Merlyn Temorubun",
                "nip": "085230047347",
                "jabatan": "Kepala Distrik"
              },
              "operator": "Kawe Nia",
              "ref": "-",
              "WAHA_Trigger_session": "KaweNia",
              "WAHA_Trigger_payload_from": "6285230047347@c.us",
              "LogoURL": "https://upload.wikimedia.org/wikipedia/commons/thumb/1/10/Lambang_Kabupaten_Mimika.jpg/500px-Lambang_Kabupaten_Mimika.jpg",
              "URL_CREATE": "https://n8n-qz8tp6856ibc.bgxy.sumopod.my.id/webhook-test/1ae8a1a1-9f9d-4792-8505-9c84e1d3654b",
              "URL_UPDATE": "https://n8n-qz8tp6856ibc.bgxy.sumopod.my.id/webhook/410be478-05a9-4622-8e8a-9049667cc717",
              "URL_DELETE": "https://n8n-qz8tp6856ibc.bgxy.sumopod.my.id/webhook-test/1ae8a1a1-9f9d-4792-8505-9c84e1d3654b",
              "URL_UPLOAD": "https://n8n-qz8tp6856ibc.bgxy.sumopod.my.id/webhook/1ae8a1a1-9f9d-4792-8505-9c84e1d3654b",
              "URL_DELETE_FILE": "https://n8n-qz8tp6856ibc.bgxy.sumopod.my.id/webhook-test/1ae8a1a1-9f9d-4792-8505-9c84e1d3654b"
            }
          },
          "webhookUrl": "https://n8n-qz8tp6856ibc.bgxy.sumopod.my.id/webhook/e1863045-3bfd-497d-b8a3-fc2c7c23eaa7",
          "executionMode": "production"
        }
      }
    ],
    "Data Input": [
      {
        "json": {
          "date": "07 September 2025",
          "Nama": "AGUNG HENDI TEMOURUBUN",
          "NIK": "9170101007030004",
          "TTL": "TIMIKA 08-07-2003",
          "Agama": "KATOLIK",
          "JenisKelamin": "LAK1-LAK1",
          "StatusPerkawinan": "BELUM nikah",
          "Pekerjaan": "BELUM/TIDAK BEKERJA",
          "Alamat": "JL. BUDI UTOMO",
          "Kelurahan/Kampung": "PASAR SENTRAL",
          "Kecamatan": "Wania",
          "Kabupaten": "Mimika",
          "Provinsi": "Papua Tengah",
          "WAHA_Trigger_session": "KaweNia",
          "WAHA_Trigger_payload_from": "6285230047347@c.us",
          "LogoURL": "https://upload.wikimedia.org/wikipedia/commons/thumb/1/10/Lambang_Kabupaten_Mimika.jpg/500px-Lambang_Kabupaten_Mimika.jpg",
          "URL_POST": "https://n8n-qz8tp6856ibc.bgxy.sumopod.my.id/webhook-test/5f3c9805-585e-4dd8-a9de-b83aa21cd301"
        }
      }
    ],
    "Kirim data": [
      {
        "json": {
          "headers": {
            "host": "n8n-qz8tp6856ibc.bgxy.sumopod.my.id",
            "user-agent": "axios/1.8.3",
            "content-length": "1794",
            "accept": "application/json,text/html,application/xhtml+xml,application/xml,text/*;q=0.9, image/*;q=0.8, */*;q=0.7",
            "accept-encoding": "gzip, br",
            "cdn-loop": "cloudflare; loops=1",
            "cf-connecting-ip": "8.215.39.173",
            "cf-ipcountry": "ID",
            "cf-ray": "97bbb836af6dcdd1-SIN",
            "cf-visitor": "{\"scheme\":\"https\"}",
            "content-type": "application/json",
            "x-forwarded-for": "8.215.39.173, 172.71.124.164",
            "x-forwarded-host": "n8n-qz8tp6856ibc.bgxy.sumopod.my.id",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "f3675854bda2",
            "x-real-ip": "172.71.124.164"
          },
          "params": {},
          "query": {},
          "body": [
            {
              "action": "CREATE_AND_SEND",
              "strategy": "OVERWRITE_BIN",
              "id_user": "1BaHZfTkhuzCcugmkdKC1BzQV52GOMrUP",
              "id_surat": "https://distrikwania.com/data/1W4p8UkwzxEbjLuSqGyZd9MWVGfuwyZwk",
              "date": "07 September 2025",
              "delete_file_ids": [],
              "pemohon": {
                "nama": "Agung Hendi Temourubun",
                "nik": "9170101007030004",
                "ttl": "Timika 08-07-2003",
                "agama": "Katolik",
                "jenis_kelamin": "Laki-Laki",
                "status_perkawinan": "Belum Kawin",
                "pekerjaan": "Belum/Tidak Bekerja",
                "alamat": "Jl. Budi Utomo",
                "kelurahan/kampung": "Nawaripi",
                "kecamatan": "Wania",
                "kota_kab": "Mimika",
                "provinsi": "Papua Tengah"
              },
              "dokumen": [
                {
                  "name": "KTP - Copy (2).jpg",
                  "type": "image/jpeg",
                  "file_id": "1dD5oDrmwGajYOxsFN-12bgutv4JBvwPd",
                  "size": 235176,
                  "view_url": "https://drive.google.com/file/d/1dD5oDrmwGajYOxsFN-12bgutv4JBvwPd/view?usp=drivesdk",
                  "download_url": "https://drive.google.com/uc?id=1dD5oDrmwGajYOxsFN-12bgutv4JBvwPd&export=download"
                },
                {
                  "name": "KTP - Copy.jpg",
                  "type": "image/jpeg",
                  "file_id": "1jBhvXgDk2AqE6imZWjgJS_NPAKZ2X9UV",
                  "size": 235176,
                  "view_url": "https://drive.google.com/file/d/1jBhvXgDk2AqE6imZWjgJS_NPAKZ2X9UV/view?usp=drivesdk",
                  "download_url": "https://drive.google.com/uc?id=1jBhvXgDk2AqE6imZWjgJS_NPAKZ2X9UV&export=download"
                },
                {
                  "name": "KTP.jpg",
                  "type": "image/jpeg",
                  "file_id": "19CEHphDpxzToOEF-fotQQYwEUl4rXecD",
                  "size": 235176,
                  "view_url": "https://drive.google.com/file/d/19CEHphDpxzToOEF-fotQQYwEUl4rXecD/view?usp=drivesdk",
                  "download_url": "https://drive.google.com/uc?id=19CEHphDpxzToOEF-fotQQYwEUl4rXecD&export=download"
                }
              ],
              "WAHA_Trigger_session": "KaweNia",
              "WAHA_Trigger_payload_from": "6285230047347@c.us",
              "LogoURL": "https://upload.wikimedia.org/wikipedia/commons/thumb/1/10/Lambang_Kabupaten_Mimika.jpg/500px-Lambang_Kabupaten_Mimika.jpg",
              "webhook": "https://n8n-qz8tp6856ibc.bgxy.sumopod.my.id/webhook-test/5f3c9805-585e-4dd8-a9de-b83aa21cd301"
            }
          ],
          "webhookUrl": "https://n8n-qz8tp6856ibc.bgxy.sumopod.my.id/webhook/737cd7f5-bfa1-4b9c-b55a-21aa718bfc3d",
          "executionMode": "production"
        }
      }
    ]
  },
  "versionId": "b471db21-554d-4912-a638-4478907f95a8",
  "activeVersionId": "b471db21-554d-4912-a638-4478907f95a8",
  "triggerCount": 10,
  "shared": [
    {
      "updatedAt": "2025-09-07T11:49:31.400Z",
      "createdAt": "2025-09-07T11:49:31.400Z",
      "role": "workflow:owner",
      "workflowId": "Aa0mObAGLoNfAUki",
      "projectId": "MsnmAoT3kpqQYaku"
    }
  ],
  "activeVersion": {
    "updatedAt": "2025-11-27T06:24:38.693Z",
    "createdAt": "2025-11-27T06:24:38.693Z",
    "versionId": "b471db21-554d-4912-a638-4478907f95a8",
    "workflowId": "Aa0mObAGLoNfAUki",
    "nodes": [
      {
        "parameters": {
          "inputSource": "jsonExample",
          "jsonExample": "{\n  \"date\": null,\n  \n  \"Nama\": null,\n  \"NIK\": null,\n  \"TTL\": null,\n  \"Agama\": null,\n  \"JenisKelamin\": null,\n  \"StatusPerkawinan\": null,\n  \"Pekerjaan\": null,\n  \"Alamat\": null,\n\n  \"Kelurahan/Kampung\": null,\n  \"Kecamatan\": null,\n  \"Kabupaten\": null,\n  \"Provinsi\": null,\n\n  \"WAHA_Trigger_session\": null,\n  \"WAHA_Trigger_payload_from\": null,\n\n  \"LogoURL\": null,\n  \"URL_POST\": null\n}"
        },
        "type": "n8n-nodes-base.executeWorkflowTrigger",
        "typeVersion": 1.1,
        "position": [
          -880,
          160
        ],
        "id": "66a3e4f2-0f5e-479a-99ef-b31646cc0239",
        "name": "Data Input"
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://n8n-qz8tp6856ibc.bgxy.sumopod.my.id/webhook/e81bec01-4835-4966-b0b2-2a11835fed44",
          "sendQuery": true,
          "queryParameters": {
            "parameters": [
              {
                "name": "name_file",
                "value": "={{ (Date.now().toString(36) + Math.random().toString(36).slice(2,6)).toUpperCase() }}\n"
              },
              {
                "name": "session_waha",
                "value": "KaweNia"
              },
              {
                "name": "id_waha",
                "value": "={{ $('Data Input').item.json.WAHA_Trigger_payload_from }}"
              },
              {
                "name": "Nama",
                "value": "={{ $('Data Input').item.json.Nama }}"
              },
              {
                "name": "NIK",
                "value": "={{ $('Data Input').item.json.NIK }}"
              }
            ]
          },
          "sendBody": true,
          "contentType": "raw",
          "rawContentType": "=text/html; charset=utf-8",
          "body": "={{ $json.html }}",
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          660,
          160
        ],
        "id": "9fd9d339-dbf0-4ffd-984b-1f7bcf07638b",
        "name": "HTTP Request"
      },
      {
        "parameters": {
          "resource": "Chatting",
          "operation": "Send Text",
          "session": "={{ $('Generate HTML').item.json.query.session_waha }}",
          "chatId": "={{ $('Generate HTML').item.json.query.id_waha }}",
          "text": "=Permohonan Surat Atas Nama {{ $('Generate HTML').item.json.query.Nama }}\nNomor KTP {{ $('Generate HTML').item.json.query.NIK }}\n\nLink Surat\nhttps://distrikwania.com/data/{{ $json.id }}",
          "requestOptions": {}
        },
        "type": "@devlikeapro/n8n-nodes-waha.WAHA",
        "typeVersion": 202502,
        "position": [
          -440,
          560
        ],
        "id": "c9a83860-3883-4252-87f6-c988e2f993f1",
        "name": "Send a text message",
        "credentials": {
          "wahaApi": {
            "id": "uivlaHVGkUY1vyJT",
            "name": "WAHA account"
          }
        }
      },
      {
        "parameters": {
          "httpMethod": "POST",
          "path": "e81bec01-4835-4966-b0b2-2a11835fed44",
          "options": {}
        },
        "type": "n8n-nodes-base.webhook",
        "typeVersion": 2,
        "position": [
          -880,
          560
        ],
        "id": "d2ace661-6c09-4039-8632-ae79da9af9cf",
        "name": "Generate HTML",
        "webhookId": "e81bec01-4835-4966-b0b2-2a11835fed44"
      },
      {
        "parameters": {
          "jsCode": "/**\n * n8n Code Node ‚Äî Generate Payload Surat (Run Once for Each Item)\n * Input  : $json (object tunggal atau array of object)\n * Output : [{ json: payload }]\n */\n\nconst s = Array.isArray($json) ? ($json[0] ?? {}) : ($json ?? {});\n\n// ---------------- Utils dasar ----------------\nconst has = (o, k) => Object.prototype.hasOwnProperty.call(o ?? {}, k);\nconst val = (k) => {\n  if (!has(s, k)) return null;\n  const v = s[k];\n  if (v === undefined || v === '') return null;\n  return v;\n};\nconst ensureStr = (x, fallback = '-') => {\n  const v = (x ?? '').toString().trim();\n  return v.length ? v : fallback;\n};\n\n// Ubah jadi Title Case\nconst toTitleCase = (str) => {\n  if (!str) return str;\n  return str\n    .toLowerCase()\n    .replace(/\\b\\w/g, (c) => c.toUpperCase());\n};\n\n// Ubah hanya huruf pertama string\nconst capitalizeFirst = (str) => {\n  if (!str) return str;\n  return str.charAt(0).toUpperCase() + str.slice(1);\n};\n\n// ---------------- Kolektor dokumen ----------------\nconst clean = (str) => (str ?? '').toString().normalize('NFKC').trim();\nconst normLabel = (x) =>\n  clean(x).toLowerCase().replace(/\\s+/g, '_').replace(/[^a-z0-9_\\-]/g, '') || 'dokumen';\n\nconst map = new Map();\nif (Array.isArray(s.documents)) {\n  for (const d of s.documents) {\n    const label = normLabel(d?.label);\n    map.set(label, {\n      label,\n      file_id: d?.file_id ?? null,\n      download_url: d?.download_url ?? null,\n      view_url: d?.view_url ?? null,\n    });\n  }\n}\nfor (const [k, v] of Object.entries(s)) {\n  const m = k.match(/^doc[_\\.]?([a-z0-9_\\-]+)[_\\.](file_id|download_url|view_url)$/i);\n  if (!m) continue;\n  const label = normLabel(m[1]);\n  if (!map.has(label)) {\n    map.set(label, { label, file_id: null, download_url: null, view_url: null });\n  }\n  map.get(label)[m[2]] = (v === '' ? null : v);\n}\nconst dokumen = Array.from(map.values());\n\n// ---------------- Alamat/domisili ----------------\nconst kelVal   = ensureStr(val('Kelurahan/Kampung') ?? val('Kelurahan'));\nconst kecVal   = ensureStr(val('Kecamatan'));\nconst kotaKab  = ensureStr(val('Kabupaten') ?? val('Kota'));\nconst provinsi = ensureStr(val('Provinsi') ?? 'Papua Tengah');\n\n// ---------------- Ambil URL_POST dari input ----------------\nconst urlPostIn = val('URL_POST') ?? val('urlpost');\n\n// ---------------- Payload akhir ----------------\nconst payload = {\n  date: val('date') ?? null,\n\n  pemohon: {\n    nama             : toTitleCase(val('Nama')),\n    nik              : val('NIK'),\n    ttl              : toTitleCase(val('TTL')),\n    agama            : toTitleCase(val('Agama')),\n    jenis_kelamin    : toTitleCase(val('JenisKelamin')),\n    status_perkawinan: toTitleCase(val('StatusPerkawinan')),\n    pekerjaan        : toTitleCase(val('Pekerjaan')),\n    alamat           : toTitleCase(val('Alamat')),\n\n    \"kelurahan/kampung\": toTitleCase(kelVal),\n    kecamatan          : toTitleCase(kecVal),\n    kota_kab           : toTitleCase(kotaKab),\n    provinsi           : toTitleCase(provinsi),\n  },\n\n  dokumen,\n\n  WAHA_Trigger_session     : val('WAHA_Trigger_session'),\n  WAHA_Trigger_payload_from: val('WAHA_Trigger_payload_from'),\n  LogoURL                  : val('LogoURL')\n};\n\nif (urlPostIn !== null) {\n  payload.webhook  = urlPostIn; \n}\n\nreturn [{ json: payload }];\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -660,
          160
        ],
        "id": "4a367f1d-892c-4321-9cae-851d6923d02b",
        "name": "Code"
      },
      {
        "parameters": {
          "operation": "toJson",
          "options": {
            "fileName": "={{ DateTime.now().setZone('Asia/Tokyo').setLocale('id').toFormat('dd_MM_yyyy_HH_mm_ss') + '_' + ($('Data Input').item.json.Nama).trim().replace(/\\s+/g,'-').toUpperCase() + '_' + ($('Data Input').item.json.NIK) }}\n"
          }
        },
        "type": "n8n-nodes-base.convertToFile",
        "typeVersion": 1.1,
        "position": [
          -440,
          60
        ],
        "id": "842bf36d-4904-486f-aad8-59eae9c9f676",
        "name": "Convert to File"
      },
      {
        "parameters": {
          "jsCode": "/**\n * Generate Payload Surat ‚Äî gabung data form + banyak file Drive\n * Mode   : Run Once for All Items\n * Input  : Kumpulan item: (A) hasil Upload (>=1 item), (B) 1 item berisi body.data (string JSON)\n * Output : 1 item { json: payload }\n */\n\n/* ===================== Utils ===================== */\nconst has     = (o, k) => Object.prototype.hasOwnProperty.call(o ?? {}, k);\nconst clean   = (s) => (s ?? '').toString().normalize('NFKC').trim();\nconst lower   = (s) => clean(s).toLowerCase();\nconst ensure  = (x, f='-') => { const v = clean(x); return v ? v : f; };\n\n/** \n * Normalisasi: jadikan null bila really null/undefined/\"undefined\"/\"null\".\n * (CATATAN: string kosong \"\" juga jadi null. \n * Jika Anda ingin \"\" tetap kosong, pakai varian toNullKeepEmpty di bawah.)\n */\nconst toNull = (x) => {\n  if (x === undefined || x === null) return null;\n  const v = (typeof x === 'string') ? x.trim() : x;\n  if (v === '' || v === 'undefined' || v === 'null') return null;\n  return v;\n};\n\n// // Varian opsional jika ingin \"\" dipertahankan:\n// const toNull = (x) => {\n//   if (x === undefined || x === null) return null;\n//   if (typeof x === 'string') {\n//     const v = x.trim();\n//     if (v === 'undefined' || v === 'null') return null;\n//     return v; // \"\" dipertahankan\n//   }\n//   return x;\n// };\n\nconst baseName = (name) => lower((name || '').replace(/\\.[^./\\\\]+$/, ''));\n\n// Aman parse JSON string (+ decodeURIComponent jika terindikasi urlencoded)\nconst safeParseJSON = (maybeJSON) => {\n  try {\n    if (typeof maybeJSON === 'string') return JSON.parse(maybeJSON);\n    if (typeof maybeJSON === 'object' && maybeJSON !== null) return maybeJSON;\n  } catch {}\n  return {};\n};\n\nconst tryParse = (x) => {\n  if (typeof x === 'string') {\n    let s = x;\n    // jika terlihat urlencoded (mengandung %7B / %5B), coba decodeURIComponent\n    if (/%[0-9A-Fa-f]{2}/.test(x) && (x.includes('%7B') || x.includes('%5B'))) {\n      try { s = decodeURIComponent(x); } catch(e) {}\n    }\n    // parse\n    let obj = safeParseJSON(s);\n    // antisipasi double-stringified\n    if (typeof obj === 'string') obj = safeParseJSON(obj);\n    return obj;\n  }\n  return safeParseJSON(x);\n};\n\n/* ===================== Ambil body.data dari salah satu item ===================== */\nlet rawData = null;\nfor (const it of items) {\n  const s = it.json || {};\n  // umum: Webhook Node ‚Üí it.json.body.data\n  if (s && s.body && s.body.data !== undefined) {\n    rawData = s.body.data;\n    break;\n  }\n  // fallback (kalau Anda kirim sebagai \"data\" langsung)\n  if (s && s.data !== undefined) {\n    rawData = s.data;\n    break;\n  }\n}\n\nlet bodyData = tryParse(rawData);\nif (typeof bodyData !== 'object' || bodyData === null) bodyData = {};\n\n// Jika bodyData berupa array ‚Üí ambil elemen pertamanya sebagai \"head\" objek\nlet bodyArray = null;\nif (Array.isArray(bodyData)) {\n  bodyArray = bodyData;\n  bodyData = bodyData[0] || {};\n}\n\n/* ===================== Kebijakan struktur baru vs lama ===================== */\n// Struktur BARU: field berada di top-level: jenis_surat, pemohon, dokumen, files_info, dll.\n// Struktur LAMA: field utama berada di bodyData.mandatory_data\nlet mdCandidate = bodyData;\nif (bodyData && typeof bodyData.mandatory_data === 'object' && bodyData.mandatory_data !== null) {\n  mdCandidate = bodyData.mandatory_data;\n}\n// Jika mdCandidate masih array (kasus langka), ambil [0]\nif (Array.isArray(mdCandidate)) mdCandidate = mdCandidate[0] || {};\nconst md = (typeof mdCandidate === 'object' && mdCandidate !== null) ? mdCandidate : {};\n\n// Pastikan files_info berupa array ‚Äî cek di beberapa lokasi yang mungkin\nlet filesInfo = [];\nif (Array.isArray(bodyData.files_info)) {\n  filesInfo = bodyData.files_info;\n} else if (Array.isArray(md.files_info)) {\n  filesInfo = md.files_info;\n} else if (bodyArray && Array.isArray(bodyArray[0]?.files_info)) {\n  filesInfo = bodyArray[0].files_info;\n}\n\n/* ===================== Kolektor dokumen ===================== */\nconst map = new Map(); // key unik\n\nconst uniq = (base) => {\n  let k = base || 'lampiran';\n  if (!map.has(k)) return k;\n  let i = 2;\n  while (map.has(`${k}_${i}`)) i++;\n  return `${k}_${i}`;\n};\n\nconst put = (key, obj) => map.set(key, Object.assign(map.get(key) || {}, obj));\n\nconst normKey = (label) => lower(label || 'lampiran')\n  .replace(/\\s+/g,'_')\n  .replace(/[^a-z0-9_\\-]/g,'');\n\nconst add = (label, obj={}) => {\n  const key = uniq(normKey(label || 'lampiran'));\n  put(key, {\n    label: key, file_id:null, download_url:null, view_url:null,\n    name:null, mimeType:null, size:null, iconLink:null, thumbnailLink:null, createdTime:null,\n    ...obj,\n  });\n};\n\n// 1) md.dokumen dari form/editor (bisa kosong)\nif (Array.isArray(md.dokumen)) {\n  for (const d of md.dokumen) {\n    add(d?.label ?? d?.name ?? 'lampiran', {\n      file_id     : toNull(d?.file_id),\n      download_url: toNull(d?.download_url),\n      view_url    : toNull(d?.view_url),\n      name        : toNull(d?.name),\n      mimeType    : toNull(d?.mimeType),\n      size        : (Number.isFinite(+d?.size) ? +d.size : null),\n    });\n  }\n}\n\n// 2) files_info (pre-upload; sumber nama/ukuran sebelum Drive respond)\nfor (const f of (Array.isArray(filesInfo) ? filesInfo : [])) {\n  const key = uniq(baseName(f?.name || 'lampiran'));\n  put(key, {\n    label   : key,\n    name    : toNull(f?.name) ?? null,\n    mimeType: toNull(f?.type) ?? null,\n    size    : (Number.isFinite(+f?.size) ? +f.size : null),\n  });\n}\n\n// Helper: cari entry dokumen yang paling cocok untuk file Drive\nconst findBestSlot = (driveName, driveSize) => {\n  const dBase = baseName(driveName || 'lampiran');\n  let candidateKey = null;\n\n  // a) cocok nama dasar dari files_info / md.dokumen\n  for (const [k, v] of map.entries()) {\n    if (v.name && baseName(v.name) === dBase) { candidateKey = k; break; }\n  }\n  if (candidateKey) return candidateKey;\n\n  // b) cocok label (jika label==nama)\n  for (const [k, v] of map.entries()) {\n    if (v.label && baseName(v.label) === dBase) { candidateKey = k; break; }\n  }\n  if (candidateKey) return candidateKey;\n\n  // c) fallback by size (toleransi ¬±2 KB)\n  if (Number.isFinite(driveSize)) {\n    for (const [k, v] of map.entries()) {\n      if (Number.isFinite(+v.size)) {\n        const diff = Math.abs(+v.size - driveSize);\n        if (diff <= 2048) { candidateKey = k; break; }\n      }\n    }\n  }\n  return candidateKey;\n};\n\n// 3) SEMUA hasil Upload (tiap item = 1 file Drive)\nfor (const it of items) {\n  const s = it.json || {};\n  // deteksi metadata Google Drive/Upload\n  const isDrive = !!(s.id || s.webViewLink || s.webContentLink || s.name || s.originalFilename || s.mimeType);\n  if (!isDrive) continue;\n\n  const dName = s.name || s.originalFilename || 'lampiran';\n  const dSize = Number.isFinite(+s.size) ? +s.size\n              : (s.quotaBytesUsed ? +s.quotaBytesUsed : null);\n\n  let slot = findBestSlot(dName, dSize);\n  if (!slot) {\n    // tidak ketemu pasangan ‚Üí buat entri baru\n    const key = uniq(baseName(dName) || 'lampiran');\n    add(key, { name: dName });\n    slot = key;\n  }\n\n  put(slot, {\n    file_id      : s.id ?? null,\n    download_url : s.webContentLink ?? null,\n    view_url     : s.webViewLink ?? null,\n    name         : s.name ?? s.originalFilename ?? dName,\n    mimeType     : s.mimeType ?? null,\n    size         : dSize ?? null,\n    iconLink     : s.iconLink ?? null,\n    thumbnailLink: s.thumbnailLink ?? null,\n    createdTime  : s.createdTime ?? null,\n  });\n}\n\nconst dokumen = Array.from(map.values());\n\n/* ===================== Normalisasi bidang teks ===================== */\nconst pemohonRaw = md?.pemohon ?? {};\nconst kelurahan  = ensure(toNull(pemohonRaw.kelurahan));\nconst kecamatan  = ensure(toNull(pemohonRaw.kecamatan));\nconst kotaKab    = ensure(toNull(pemohonRaw.kota_kab ?? pemohonRaw.kabupaten));\nconst provinsi   = ensure(toNull(pemohonRaw.provinsi));\n\n// Jika domisili kosong ‚Üí susun dari komponen\nlet domisili = toNull(pemohonRaw.domisili);\nif (!domisili) domisili = `${kelurahan}, ${kecamatan}, ${kotaKab}, ${provinsi}`;\n\n/* ===================== Payload akhir ===================== */\nconst payload = {\n  jenis_surat   : toNull(md?.jenis_surat),\n  nomor_surat   : toNull(md?.nomor_surat),\n  tanggal_surat : toNull(md?.tanggal_surat),\n\n  pemohon: {\n    nama             : toNull(pemohonRaw?.nama),\n    nik              : toNull(pemohonRaw?.nik),\n    ttl              : toNull(pemohonRaw?.ttl),\n    agama            : toNull(pemohonRaw?.agama),\n    jenis_kelamin    : toNull(pemohonRaw?.jenis_kelamin),\n    status_perkawinan: toNull(pemohonRaw?.status_perkawinan),\n    pekerjaan        : toNull(pemohonRaw?.pekerjaan),\n    alamat           : toNull(pemohonRaw?.alamat),\n    kelurahan, kecamatan,\n    kota_kab         : kotaKab,\n    provinsi,\n    domisili,\n  },\n\n  dokumen,\n\n  penandatangan: {\n    nama   : toNull(md?.penandatangan?.nama),\n    nip    : toNull(md?.penandatangan?.nip),\n    jabatan: toNull(md?.penandatangan?.jabatan),\n  },\n\n  operator                 : toNull(md?.operator),\n  ref                      : toNull(md?.ref),\n  WAHA_Trigger_session     : toNull(md?.WAHA_Trigger_session),\n  WAHA_Trigger_payload_from: toNull(md?.WAHA_Trigger_payload_from),\n  LogoURL                  : toNull(md?.LogoURL),\n\n  URL_CREATE     : toNull(md?.URL_CREATE),\n  URL_UPDATE     : toNull(md?.URL_UPDATE),\n  URL_DELETE     : toNull(md?.URL_DELETE),\n  URL_UPLOAD     : toNull(md?.URL_UPLOAD),\n  URL_DELETE_FILE: toNull(md?.URL_DELETE_FILE),\n\n  // Field metadata dari bodyData (string \"undefined\" ‚Üí null)\n  id_user      : toNull((bodyArray ? bodyArray[0]?.id_user : bodyData?.id_user) ?? bodyData?.id_user),\n  url_web_link : toNull((bodyArray ? bodyArray[0]?.url_web_link : bodyData?.url_web_link) ?? bodyData?.url_web_link),\n  action       : toNull((bodyArray ? bodyArray[0]?.action : bodyData?.action) ?? bodyData?.action),\n  timestamp    : toNull((bodyArray ? bodyArray[0]?.timestamp : bodyData?.timestamp) ?? bodyData?.timestamp),\n\n  // Simpan kembali files_info mentah untuk audit (dari data yang Anda kirim)\n  files_info   : filesInfo,\n};\n\n// Opsional log untuk debug di Executions ‚Üí Console\n// console.log('bodyData keys:', Object.keys(bodyData||{}));\n// console.log('filesInfo len :', Array.isArray(filesInfo)?filesInfo.length:'not array');\n// console.log('dokumen len   :', dokumen.length);\n\nreturn [{ json: payload }];\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          0,
          820
        ],
        "id": "a6bc9ad4-7833-4706-9cef-6214461cdbc8",
        "name": "Code1"
      },
      {
        "parameters": {
          "operation": "toJson",
          "options": {
            "fileName": "={{ DateTime.now().setZone('Asia/Tokyo').setLocale('id').toFormat('dd_MM_yyyy_HH_mm_ss') + '_' + ($json.pemohon.nama).trim().replace(/\\s+/g,'-').toUpperCase() + '_' + ($json.pemohon.nik) }}\n"
          }
        },
        "type": "n8n-nodes-base.convertToFile",
        "typeVersion": 1.1,
        "position": [
          220,
          820
        ],
        "id": "c904227e-048e-4b9b-ab7f-0d36768db9be",
        "name": "Convert to File1"
      },
      {
        "parameters": {
          "operation": "update",
          "fileId": {
            "__rl": true,
            "value": "={{ $('Code1').item.json.id_user }}",
            "mode": "id"
          },
          "changeFileContent": true,
          "options": {}
        },
        "type": "n8n-nodes-base.googleDrive",
        "typeVersion": 3,
        "position": [
          440,
          820
        ],
        "id": "0e22be27-dc5f-44a1-95c1-ec1dc9e766fc",
        "name": "Update file",
        "credentials": {
          "googleDriveOAuth2Api": {
            "id": "jyiiyKxh6DOyPVt5",
            "name": "Google Drive account"
          }
        }
      },
      {
        "parameters": {
          "operation": "fromJson",
          "options": {}
        },
        "type": "n8n-nodes-base.extractFromFile",
        "typeVersion": 1,
        "position": [
          0,
          0
        ],
        "id": "438e0015-b5cd-4ea1-a9ac-2d6530c2df52",
        "name": "Extract from File1"
      },
      {
        "parameters": {
          "mode": "combine",
          "combineBy": "combineAll",
          "options": {}
        },
        "type": "n8n-nodes-base.merge",
        "typeVersion": 3.2,
        "position": [
          -220,
          820
        ],
        "id": "3327edb4-5504-407f-b5c1-b152534bcb5e",
        "name": "Merge1"
      },
      {
        "parameters": {
          "inputDataFieldName": "={{ $json.binaryProperty }}",
          "name": "={{ $binary[$json.binaryProperty].fileName }}",
          "driveId": {
            "__rl": true,
            "mode": "list",
            "value": "My Drive"
          },
          "folderId": {
            "__rl": true,
            "value": "1ufqBzk2QQ6MYnMU2cSzG3mqoab-JCP_Z",
            "mode": "list",
            "cachedResultName": "Create Surat Keterangan Tidak Mampu",
            "cachedResultUrl": "https://drive.google.com/drive/folders/1ufqBzk2QQ6MYnMU2cSzG3mqoab-JCP_Z"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleDrive",
        "typeVersion": 3,
        "position": [
          -440,
          900
        ],
        "id": "0557f51b-9205-4f18-90b6-5e2629fefaab",
        "name": "Upload file2",
        "credentials": {
          "googleDriveOAuth2Api": {
            "id": "jyiiyKxh6DOyPVt5",
            "name": "Google Drive account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// Run Once for All Items\nconst out = [];\nfor (const item of items) {\n  const bin = item.binary || {};\n  const keys = Object.keys(bin);\n  if (keys.length === 0) { out.push(item); continue; }\n  for (const k of keys) {\n    out.push({\n      json: { binaryProperty: k },\n      binary: { [k]: bin[k] },\n    });\n  }\n}\nreturn out;\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -660,
          900
        ],
        "id": "dcf5e0a1-7a71-4e8b-9807-bc2a8b0efaa7",
        "name": "Code2"
      },
      {
        "parameters": {
          "httpMethod": "POST",
          "path": "1ae8a1a1-9f9d-4792-8505-9c84e1d3654b",
          "options": {}
        },
        "type": "n8n-nodes-base.webhook",
        "typeVersion": 2,
        "position": [
          -880,
          820
        ],
        "id": "fcebb38c-229d-4d64-be97-011ec41c67cf",
        "name": "Uploud File",
        "webhookId": "1ae8a1a1-9f9d-4792-8505-9c84e1d3654b"
      },
      {
        "parameters": {
          "httpMethod": "POST",
          "path": "410be478-05a9-4622-8e8a-9049667cc717",
          "options": {}
        },
        "type": "n8n-nodes-base.webhook",
        "typeVersion": 2,
        "position": [
          -880,
          1160
        ],
        "id": "b0824533-c9b8-45f4-85b7-a2536b8c1ed1",
        "name": "Update Data",
        "webhookId": "410be478-05a9-4622-8e8a-9049667cc717"
      },
      {
        "parameters": {
          "jsCode": "/**\n * Generate Payload Surat ‚Äî gabung data form + banyak file Drive\n * Mode   : Run Once for All Items\n * Input  : (A) 1 item Webhook (JSON: object atau array atau string)\n *          (B) 0..N item file Drive (tiap item = 1 file)\n * Output : 1 item { json: payload }\n */\n\n// ---------- Utils ----------\nconst has = (o, k) => Object.prototype.hasOwnProperty.call(o ?? {}, k);\nconst clean  = (s) => (s ?? '').toString().normalize('NFKC').trim();\nconst lower  = (s) => clean(s).toLowerCase();\nconst ensure = (x, f='-') => { const v = clean(x); return v ? v : f; };\nconst valKey = (o, k) => (has(o, k) ? (o[k] === '' ? null : o[k]) : null);\nconst baseName = (name) => lower((name || '').replace(/\\.[^./\\\\]+$/, ''));\n\nlet bodyData = null;\n\n// ---------- Ambil sumber data webhook secara fleksibel ----------\nfor (const it of items) {\n  const s = it.json || {};\n  if (!s) continue;\n\n  // s.body bisa objek/array/string\n  if (s.body !== undefined) {\n    const b = s.body;\n    if (Array.isArray(b)) {\n      if (b.length > 0 && typeof b[0] === 'object') { bodyData = b[0]; break; }\n      if (b.length > 0 && typeof b[0] === 'string') {\n        try { bodyData = JSON.parse(b[0]); break; } catch {}\n      }\n    } else if (typeof b === 'string') {\n      try { bodyData = JSON.parse(b); break; } catch {}\n    } else if (typeof b === 'object' && b) {\n      bodyData = b; break;\n    }\n  }\n\n  // string JSON dari FormData\n  if (s?.body?.data) {\n    try { bodyData = JSON.parse(s.body.data); break; } catch {}\n  }\n\n  // fallback s.data\n  if (s?.data) {\n    if (typeof s.data === 'string') { try { bodyData = JSON.parse(s.data); break; } catch {} }\n    else if (typeof s.data === 'object') { bodyData = s.data; break; }\n  }\n}\n\nif (typeof bodyData !== 'object' || bodyData === null) bodyData = {};\n\n// ---------- Normalisasi mandatory_data vs body langsung ----------\nconst md = (bodyData && (bodyData.mandatory_data !== undefined))\n  ? (Array.isArray(bodyData.mandatory_data)\n      ? (bodyData.mandatory_data[0] ?? {})\n      : (bodyData.mandatory_data ?? {}))\n  : bodyData;\n\n// ---------- Intent & deteksi file drive ----------\nconst intent = (md?.action || bodyData?.action || '').toString().toLowerCase();\nconst isUpdateOnly = intent === 'update_only';\n\n// deteksi ada file Drive pada `items` (bukan dari webhook)\nconst hasDriveFiles = items.some(it => {\n  const s = it.json || {};\n  return !!(s.id || s.webViewLink || s.webContentLink || s.originalFilename || s.name || s.mimeType);\n});\n\n// ---------- files_info hanya dipakai saat upload (bukan update-only) DAN ada file drive ----------\nconst filesInfo = (!isUpdateOnly && hasDriveFiles)\n  ? (Array.isArray(md.files_info)\n      ? md.files_info\n      : (Array.isArray(bodyData.files_info) ? bodyData.files_info : []))\n  : [];\n\n// ---------- Kolektor dokumen ----------\nconst map = new Map(); // key unik\nconst uniq = (base) => {\n  let k = base || 'lampiran';\n  if (!map.has(k)) return k;\n  let i = 2;\n  while (map.has(`${k}_${i}`)) i++;\n  return `${k}_${i}`;\n};\nconst put = (key, obj) => map.set(key, Object.assign(map.get(key) || {}, obj));\nconst add = (label, obj={}) => {\n  const key = uniq(lower(label || 'lampiran').replace(/\\s+/g,'_').replace(/[^a-z0-9_\\-]/g,''));\n  put(key, {\n    label: key, file_id:null, download_url:null, view_url:null,\n    name:null, mimeType:null, size:null, iconLink:null, thumbnailLink:null, createdTime:null,\n    ...obj,\n  });\n};\n\n// 1) dokumen dari payload (jika ada)\nif (Array.isArray(md.dokumen)) {\n  for (const d of md.dokumen) {\n    add(d?.label ?? d?.name ?? 'lampiran', {\n      file_id: d?.file_id ?? null,\n      download_url: d?.download_url ?? null,\n      view_url: d?.view_url ?? null,\n      name: d?.name ?? null,\n      mimeType: d?.mimeType ?? null,\n      size: Number.isFinite(+d?.size) ? +d.size : null,\n      iconLink: d?.iconLink ?? null,\n      thumbnailLink: d?.thumbnailLink ?? null,\n      createdTime: d?.createdTime ?? null,\n    });\n  }\n}\n\n// Helper untuk pencocokan Drive\nconst findBestSlot = (driveName, driveSize) => {\n  const dBase = baseName(driveName);\n  // a) cocok nama yang sudah ada\n  for (const [k, v] of map.entries()) {\n    if ((v.name && baseName(v.name) === dBase) || (v.label && baseName(v.label) === dBase)) return k;\n  }\n  // b) fallback by size (¬±2 KB)\n  if (Number.isFinite(driveSize)) {\n    for (const [k, v] of map.entries()) {\n      if (Number.isFinite(+v.size)) {\n        const diff = Math.abs(+v.size - driveSize);\n        if (diff <= 2048) return k;\n      }\n    }\n  }\n  return null;\n};\n\n// 2) masukkan files_info (HANYA upload, bukan update-only)\n//    dan hanya jika belum ada entri dengan nama dasar yang sama\nif (filesInfo.length) {\n  for (const f of filesInfo) {\n    const bn = baseName(f?.name || 'lampiran');\n    let already = false;\n    for (const v of map.values()) {\n      if (baseName(v.name||v.label) === bn) { already = true; break; }\n    }\n    if (!already) {\n      const key = uniq(bn || 'lampiran');\n      put(key, {\n        label: key,\n        name: f?.name ?? null,\n        mimeType: f?.type ?? null,\n        size: Number.isFinite(+f?.size) ? +f.size : null,\n      });\n    }\n  }\n}\n\n// 3) gabungkan SEMUA item file Drive (tiap item = 1 file)\nfor (const it of items) {\n  const s = it.json || {};\n  const isDrive = !!(s.id || s.webViewLink || s.webContentLink || s.name || s.originalFilename || s.mimeType);\n  if (!isDrive) continue;\n\n  const dName = s.name || s.originalFilename || 'lampiran';\n  const dSize = Number.isFinite(+s.size) ? +s.size : (s.quotaBytesUsed ? +s.quotaBytesUsed : null);\n\n  let slot = findBestSlot(dName, dSize);\n  if (!slot) {\n    const key = uniq(baseName(dName) || 'lampiran');\n    add(key, { name: dName });\n    slot = key;\n  }\n\n  put(slot, {\n    file_id: s.id ?? null,\n    download_url: s.webContentLink ?? null,\n    view_url: s.webViewLink ?? null,\n    name: s.name ?? s.originalFilename ?? dName,\n    mimeType: s.mimeType ?? null,\n    size: dSize ?? null,\n    iconLink: s.iconLink ?? null,\n    thumbnailLink: s.thumbnailLink ?? null,\n    createdTime: s.createdTime ?? null,\n  });\n}\n\nconst dokumen = Array.from(map.values());\n\n// ---------- Bidang teks (domisili) ----------\nconst kelurahan = ensure(md?.pemohon?.kelurahan);\nconst kecamatan = ensure(md?.pemohon?.kecamatan);\nconst kotaKab   = ensure(md?.pemohon?.kota_kab ?? md?.pemohon?.kabupaten);\nconst provinsi  = ensure(md?.pemohon?.provinsi);\nconst domisili  = md?.pemohon?.domisili ? clean(md.pemohon.domisili) : `${kelurahan}, ${kecamatan}, ${kotaKab}, ${provinsi}`;\n\n// ---------- Payload akhir ----------\nconst payload = {\n  jenis_surat   : valKey(md, 'jenis_surat'),\n  nomor_surat   : valKey(md, 'nomor_surat'),\n  tanggal_surat : valKey(md, 'tanggal_surat'),\n\n  pemohon: {\n    nama             : md?.pemohon?.nama ?? null,\n    nik              : md?.pemohon?.nik ?? null,\n    ttl              : md?.pemohon?.ttl ?? null,\n    agama            : md?.pemohon?.agama ?? null,\n    jenis_kelamin    : md?.pemohon?.jenis_kelamin ?? null,\n    status_perkawinan: md?.pemohon?.status_perkawinan ?? null,\n    pekerjaan        : md?.pemohon?.pekerjaan ?? null,\n    alamat           : md?.pemohon?.alamat ?? null,\n    kelurahan, kecamatan, kota_kab: kotaKab, provinsi, domisili,\n  },\n\n  dokumen,\n\n  penandatangan: {\n    nama   : md?.penandatangan?.nama ?? null,\n    nip    : md?.penandatangan?.nip ?? null,\n    jabatan: md?.penandatangan?.jabatan ?? null,\n  },\n\n  operator                 : md?.operator ?? null,\n  ref                      : md?.ref ?? null,\n  WAHA_Trigger_session     : md?.WAHA_Trigger_session ?? null,\n  WAHA_Trigger_payload_from: md?.WAHA_Trigger_payload_from ?? null,\n  LogoURL                  : md?.LogoURL ?? null,\n\n  URL_CREATE     : md?.URL_CREATE ?? null,\n  URL_UPDATE     : md?.URL_UPDATE ?? null,\n  URL_DELETE     : md?.URL_DELETE ?? null,\n  URL_UPLOAD     : md?.URL_UPLOAD ?? null,\n  URL_DELETE_FILE: md?.URL_DELETE_FILE ?? null,\n\n  id_user      : md?.id_user ?? bodyData?.id_user ?? null,\n  url_web_link : md?.url_web_link ?? bodyData?.url_web_link ?? null,\n  action       : intent || null,\n  timestamp    : md?.timestamp ?? bodyData?.timestamp ?? null,\n};\n\n// Catatan penting: untuk mencegah tersimpan, JANGAN masukkan files_info ke payload.\n// (Jika ingin debugging saja, bisa tambahkan saat intent upload saja. Default: tidak disimpan.)\n\nreturn [{ json: payload }];\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -660,
          1160
        ],
        "id": "ca28d6f1-9b91-4f79-858a-a44b5f0415d0",
        "name": "Code3"
      },
      {
        "parameters": {
          "operation": "toJson",
          "options": {
            "fileName": "={{ DateTime.now().setZone('Asia/Tokyo').setLocale('id').toFormat('dd_MM_yyyy_HH_mm_ss') + '_' + ($json.pemohon.nama).trim().replace(/\\s+/g,'-').toUpperCase() + '_' + ($json.pemohon.nik) }}\n"
          }
        },
        "type": "n8n-nodes-base.convertToFile",
        "typeVersion": 1.1,
        "position": [
          -440,
          1160
        ],
        "id": "4e18ba5d-95a1-49e6-a026-09977623f676",
        "name": "Convert to File3"
      },
      {
        "parameters": {
          "operation": "update",
          "fileId": {
            "__rl": true,
            "value": "={{ $('Code3').item.json.id_user }}",
            "mode": "id"
          },
          "changeFileContent": true,
          "options": {}
        },
        "type": "n8n-nodes-base.googleDrive",
        "typeVersion": 3,
        "position": [
          -220,
          1160
        ],
        "id": "358653d1-b01b-492e-adcc-5ce526828664",
        "name": "Update file2",
        "credentials": {
          "googleDriveOAuth2Api": {
            "id": "jyiiyKxh6DOyPVt5",
            "name": "Google Drive account"
          }
        }
      },
      {
        "parameters": {
          "html": "<!doctype html>\n<html lang=\"id\">\n<head>\n  <meta charset=\"utf-8\" />\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\n  <title>Kawe Nia ‚Ä¢ Layanan SKTM</title>\n  <style>\n    :root{\n      --bg:#0b1020; --panel:#0f172a; --ink:#e5e7eb; --muted:#9ca3af;\n      --accent:#22c55e; --accent-2:#38bdf8; --line:#1f2937;\n      --danger:#ef4444; --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.35);\n      --space:clamp(14px,2.4vw,22px);\n      --modal-radius:10px;\n      --modal-bg:#111827;\n      --modal-border:rgba(148,163,184,.45);\n      --overlay:rgba(0,0,0,.72);\n    }\n    *{box-sizing:border-box} html,body{height:100%}\n\n    /* ===== FULL BACKGROUND ===== */\n    body{\n      margin:0; color:var(--ink);\n      font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial,\"Apple Color Emoji\",\"Segoe UI Emoji\";\n      background:#0a0e1a;\n      min-height:100svh;\n    }\n    .bg{\n      position:fixed; inset:0; z-index:-1; pointer-events:none;\n      background:\n        radial-gradient(1400px 800px at 20% -10%, #16223f 0%, transparent 60%),\n        radial-gradient(1200px 700px at 90% -20%, rgba(56,189,248,.15) 0%, transparent 60%),\n        linear-gradient(145deg,#0a0e1a,#0f1933 55%,#0a0e1a);\n      background-attachment:fixed,fixed,fixed;\n    }\n\n    body,body *{min-width:0; overflow-wrap:anywhere; word-break:break-word; white-space:normal}\n    .wrap{max-width:1100px;margin:40px auto;padding:0 20px}\n\n    .topbar{display:flex;align-items:center;gap:16px;margin-bottom:18px}\n    .brand{display:flex;align-items:center;gap:12px;min-width:0}\n    /* ==== Logo responsif & konsisten (tanpa wrapper tambahan) ==== */\n    .brand img.logo{\n      width: 120px; /* atau angka yang Anda mau */\n      aspect-ratio: 1 / 1;\n      object-fit: contain;\n      background:#0f172a;\n      border-radius:12px;\n      display:block;\n      /* Garis stroke di dalam */\n      box-shadow:\n        inset 0 0 0 1px rgba(148,163,184,.35), /* border tipis */\n        0 0 6px rgba(0,0,0,.35);               /* glow shadow merata */\n    }\n\n    .brand .title{font-weight:700;font-size:clamp(16px,2.4vw,20px)}\n    .brand .sub{font-size:12px;color:var(--muted)}\n    .pill{margin-left:auto;display:flex;gap:8px;align-items:center;font-size:12px;color:#cbd5e1;\n      background:linear-gradient(180deg,rgba(56,189,248,.2),rgba(34,197,94,.15));\n      border:1px solid rgba(148,163,184,.3);padding:6px 10px;border-radius:999px;flex-shrink:0;}\n\n    .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.02));\n      border:1px solid rgba(148,163,184,.2); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden}\n    .card-header{display:flex;flex-wrap:wrap;gap:14px;align-items:center;justify-content:center;\n      padding:clamp(14px,2.2vw,20px) var(--space);\n      background:radial-gradient(800px 300px at 10% -20%, rgba(56,189,248,.15), transparent 60%),\n                 radial-gradient(600px 300px at 90% -30%, rgba(34,197,94,.18), transparent 55%);\n      border-bottom:1px solid rgba(148,163,184,.2)}\n    .hgroup{display:flex;flex-direction:column;gap:8px;min-width:0;margin-bottom:4px;width:100%;text-align:center}\n    .h1{font-size:clamp(18px,2.8vw,26px);font-weight:800;letter-spacing:.3px;margin-bottom:2px}\n    .h2{font-size:13px;color:var(--muted);margin-top:2px}\n    .badges{display:flex;gap:8px;flex-wrap:wrap;min-width:0;margin-top:6px}\n    .badge{font-size:12px;padding:6px 10px;border-radius:999px;background:#0b1224;border:1px solid rgba(148,163,184,.26)}\n    .badge.info{border-color:rgba(56,189,248,.45);background:rgba(56,189,248,.12);color:#cffafe}\n\n    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:0;min-height:360px}\n    @media (max-width:960px){.grid{grid-template-columns:1fr}.side{background:transparent}.panel{border-right:none}}\n\n    .panel{padding:var(--space);border-right:1px solid rgba(148,163,184,.16)} .panel:last-child{border-right:none}\n    .stitle{font-size:13px;letter-spacing:.4px;text-transform:uppercase;color:#a5b4fc;font-weight:700;margin-bottom:10px}\n\n    /* ===== BAR AKSI EDIT ===== */\n    .editbar{display:flex;gap:10px;align-items:center;margin-bottom:12px}\n    .edit-actions{display:none;gap:10px}\n    .edit-mode .edit-actions{display:flex}\n\n    /* ===== Data Pemohon ===== */\n    .ident{\n      display:grid; grid-template-columns:160px 10px 1fr; gap:6px 10px; align-items:start; font-size:14px;\n      background:rgba(15,23,42,.55); border:1px solid rgba(148,163,184,.15); border-radius:14px; padding:10px 12px;\n    }\n    @media (max-width:560px){ .ident{grid-template-columns:110px 8px 1fr} }\n    .lab{color:#cbd5e1} .sep{color:#475569} .val{color:#e5e7eb;font-weight:600;line-height:1.45}\n    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,\"Liberation Mono\",\"Courier New\",monospace}\n\n    .note{margin-top:12px;font-size:12.5px;color:#a5b4fc;background:rgba(99,102,241,.1);\n      border:1px dashed rgba(99,102,241,.35);border-radius:12px;padding:10px 12px}\n\n    .side{display:flex;flex-direction:column;gap:14px;padding:var(--space);\n      background:linear-gradient(180deg,rgba(2,6,23,.35),rgba(2,6,23,.15))}\n    .callout{border:1px solid rgba(56,189,248,.35);background:rgba(56,189,248,.1);border-radius:14px;padding:12px 14px;font-size:13px;color:#e0f2fe}\n    .actions{display:flex;flex-wrap:wrap;gap:10px}\n\n    /* ===== Buttons ===== */\n    .btn{appearance:none;border:none;cursor:pointer;font-weight:700;letter-spacing:.3px;\n      background:#0b1224;color:var(--ink);padding:10px 14px;border-radius:12px; border:1px solid rgba(148,163,184,.3);\n      display:inline-flex; align-items:center; gap:8px; justify-content:center;}\n    a.btn, a.btn:link, a.btn:visited { text-decoration:none; color:inherit; }\n    a.btn:hover, a.btn:focus { text-decoration:none; }\n    .btn.primary,.btn.success{ background:linear-gradient(180deg,rgba(34,197,94,.95),rgba(16,185,129,.95)); border-color:rgba(16,185,129,.95); color:#052e1a !important; }\n    .btn.secondary{ background:linear-gradient(180deg,rgba(56,189,248,.9),rgba(59,130,246,.9)); border-color:rgba(96,165,250,.95); color:#06293a !important; }\n    .btn.ghost{background:transparent}\n    .btn.danger{ background:linear-gradient(180deg,rgba(239,68,68,.95),rgba(220,38,38,.95)); border-color:rgba(220,38,38,.95); color:#fef2f2 !important; }\n    .btn:active{transform:translateY(1px)}\n    .btn:disabled, .btn.disabled{\n      opacity: 0.4 !important;\n      cursor: not-allowed !important;\n      pointer-events: none !important;\n      background: #1f2937 !important;\n      border-color: #374151 !important;\n      color: #6b7280 !important;\n      transform: none !important;\n    }\n    .btn:disabled:hover, .btn.disabled:hover{\n      background: #1f2937 !important;\n      border-color: #374151 !important;\n      color: #6b7280 !important;\n    }\n\n    .edit-mode .val{display:none}.edit-mode .edit-field{display:block}\n    .edit-field{display:none;width:100%;background:rgba(15,23,42,.8);border:1px solid rgba(56,189,248,.4);border-radius:8px;padding:8px 10px;color:#e5e7eb;font-size:14px;font-weight:600}\n    .edit-field:focus{outline:none;border-color:rgba(56,189,248,.8);box-shadow:0 0 0 2px rgba(56,189,248,.2)}\n\n    .file-upload-container{background:rgba(15,23,42,.55);border:1px solid rgba(148,163,184,.15);border-radius:14px;padding:14px}\n    .upload-progress{width:100%;height:4px;background:rgba(148,163,184,.2);border-radius:2px;overflow:hidden;margin:8px 0}\n    .upload-progress-bar{height:100%;background:linear-gradient(90deg,#22c55e,#16a34a);width:0%;transition:width .3s ease}\n\n    .uploaded-files-container{background:rgba(15,23,42,.55);border:1px solid rgba(148,163,184,.15);border-radius:14px;padding:14px;min-height:60px}\n    .no-files-message{color:#9ca3af;font-size:13px;text-align:center;font-style:italic}\n\n    .uploaded-file-item{display:flex;flex-direction:column;gap:8px;padding:10px 12px;background:rgba(34,197,94,.06);\n      border:1px solid rgba(34,197,94,.25);border-radius:12px;margin-bottom:8px}\n    .file-name{color:#d1fae5;font-weight:700;line-height:1.35}\n    .file-meta{color:#a5b4fc;font-size:12px}\n    .file-id{font-size:12px;color:#94a3b8}\n    .file-actions{display:flex;flex-wrap:wrap;gap:8px;margin-top:4px}\n    .file-actions .btn{padding:6px 10px;border-radius:10px}\n\n    .card-footer{display:flex;gap:14px;justify-content:space-between;align-items:center;\n      padding:12px var(--space);border-top:1px solid rgba(148,163,184,.2);color:var(--muted);font-size:12px}\n\n    /* ===== MODAL ===== */\n    .modal-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:1000;background:var(--overlay)}\n    .modal{width:min(480px,92vw);border-radius:var(--modal-radius);background:var(--modal-bg);\n      border:1px solid var(--modal-border);box-shadow:0 18px 50px rgba(0,0,0,.55);padding:18px 18px}\n    .modal-header{display:flex;gap:10px;align-items:center;margin-bottom:8px}\n    .modal-icon{font-size:28px}\n    .modal-title{font-weight:800;font-size:18px;letter-spacing:.3px}\n    .modal-message{color:#cbd5e1;line-height:1.7;margin:8px 0 16px;font-size:14px}\n    .modal-actions{display:flex;gap:10px;justify-content:flex-end}\n    .modal .btn{border-radius:10px;padding:10px 14px}\n    .modal--info{box-shadow:inset 4px 0 0 0 #38bdf8, 0 18px 50px rgba(0,0,0,.55)}\n    .modal--success{box-shadow:inset 4px 0 0 0 #22c55e, 0 18px 50px rgba(0,0,0,.55)}\n    .modal--confirm{box-shadow:inset 4px 0 0 0 #f59e0b, 0 18px 50px rgba(0,0,0,.55)}\n    .modal--danger{box-shadow:inset 4px 0 0 0 #ef4444, 0 18px 50px rgba(0,0,0,.55)}\n\n    /* ===== LOADING ===== */\n    .loading-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:900;background:rgba(2,6,23,.75)}\n    .loading-box{display:flex;flex-direction:column;align-items:center;gap:14px;padding:22px;border-radius:12px;border:1px solid rgba(148,163,184,.35);background:#0f172a}\n    .spinner{width:52px;height:52px;border-radius:50%;border:4px solid rgba(148,163,184,.35);border-top-color:#22c55e;animation:spin 1s linear infinite}\n    @keyframes spin{to{transform:rotate(360deg)}}\n    .loading-text{font-size:14px;color:#e5e7eb}\n\n    @media print{.side{display:none} body{background:#fff} .card{border:none;box-shadow:none} .pill,.modal-overlay,.loading-overlay{display:none!important}}\n  </style>\n</head>\n<body>\n  <div class=\"bg\" aria-hidden=\"true\"></div>\n\n  <div class=\"wrap\">\n    <div class=\"topbar\">\n      <div class=\"brand\">\n        <img class=\"logo\" id=\"LogoURL\" src=\"\" alt=\"Lambang Kabupaten\">\n        <div>\n          <div class=\"title\">Kawe Nia ‚Ä¢ Pelayanan Masyarakat</div>\n        </div>\n      </div>\n      <div class=\"pill\">üü¢ Layanan aktif ‚Ä¢ 24/7</div>\n    </div>\n\n    <section class=\"card\" role=\"region\" aria-label=\"Layanan SKTM\">\n      <header class=\"card-header\">\n        <div class=\"hgroup\" style=\"align-items: center; text-align: center;\">\n          <div style=\"text-align: center; margin-bottom: 20px; width: 100%;\">\n            <div style=\"font-weight: bold; font-size: 16px; margin-bottom: 2px;\">PEMERINTAH KABUPATEN MIMIKA</div>\n            <div style=\"font-weight: bold; font-size: 16px; margin-bottom: 2px;\">DISTRIK WANIA</div>\n            <div style=\"font-size: 12px; margin-bottom: 1px;\">Jln. CENDRAWASIH SP IV TIMIKA ‚Äì PAPUA TENGAH 99910</div>\n            <div style=\"font-size: 12px; margin-bottom: 15px;\">Akun E-Distrik Wania.distrikwania.13@gmail.com</div>\n          </div>\n          <div class=\"h1\" style=\"text-align: center; width: 100%;\">SURAT KETERANGAN TIDAK MAMPU</div>\n          <div class=\"h2\" style=\"text-align: center; width: 100%;\">Nomor : <span class=\"mono\">400.2.1 / 307 / 2025</span></div>\n        </div>\n      </header>\n\n      <div class=\"grid\">\n        <div class=\"panel\">\n          <div class=\"stitle\">Data Pemohon</div>\n\n          <!-- BAR EDIT -->\n          <div class=\"editbar\">\n            <button class=\"btn ghost\" onclick=\"toggleEditMode()\" id=\"editBtn\">‚úèÔ∏è Masuk Mode Edit</button>\n            <div class=\"edit-actions\">\n              <button class=\"btn success\" onclick=\"saveChanges()\">üíæ Simpan Perubahan</button>\n              <button class=\"btn danger\" onclick=\"cancelEdit()\">‚úñÔ∏è Batal</button>\n            </div>\n          </div>\n\n          <div class=\"ident\" aria-label=\"Identitas Pemohon\">\n            <div class=\"lab\">Nama</div><div class=\"sep\">:</div><div class=\"val\" id=\"nama\"></div>\n            <input type=\"text\" class=\"edit-field\" id=\"editNama\" value=\"\">\n\n            <div class=\"lab\">NIK</div><div class=\"sep\">:</div><div class=\"val mono\" id=\"nik\"></div>\n            <input type=\"text\" class=\"edit-field\" id=\"editNIK\" value=\"\">\n\n            <div class=\"lab\">Tempat/Tgl Lahir</div><div class=\"sep\">:</div><div class=\"val\" id=\"ttl\"></div>\n            <input type=\"text\" class=\"edit-field\" id=\"editTTL\" value=\"\">\n\n            <div class=\"lab\">Agama</div><div class=\"sep\">:</div><div class=\"val\" id=\"agama\"></div>\n            <input type=\"text\" class=\"edit-field\" id=\"editAgama\" value=\"\">\n\n            <div class=\"lab\">Jenis Kelamin</div><div class=\"sep\">:</div><div class=\"val\" id=\"jenis_kelamin\"></div>\n            <select class=\"edit-field\" id=\"editJenisKelamin\">\n              <option value=\"Laki-Laki\" selected>Laki-laki</option>\n              <option value=\"Perempuan\">Perempuan</option>\n            </select>\n\n            <div class=\"lab\">Status Perkawinan</div><div class=\"sep\">:</div><div class=\"val\" id=\"status_perkawinan\"></div>\n            <select class=\"edit-field\" id=\"editStatusPerkawinan\">\n              <option value=\"BELUM KAWIN\">Belum Kawin</option>\n              <option value=\"KAWIN\">Kawin</option>\n              <option value=\"CERAI HIDUP\">Cerai Hidup</option>\n              <option value=\"CERAI MATI\">Cerai Mati</option>\n            </select>\n\n            <div class=\"lab\">Pekerjaan</div><div class=\"sep\">:</div><div class=\"val\" id=\"pekerjaan\"></div>\n            <input type=\"text\" class=\"edit-field\" id=\"editPekerjaan\" value=\"\">\n\n            <div class=\"lab\">Alamat</div><div class=\"sep\">:</div><div class=\"val\" id=\"alamat\"></div>\n            <textarea class=\"edit-field\" id=\"editAlamat\" rows=\"2\"></textarea>\n\n            <div class=\"lab\">Kelurahan/Kampung</div><div class=\"sep\">:</div><div class=\"val\" id=\"kelurahan\"></div>\n            <select class=\"edit-field\" id=\"editKelurahan\">\n              <option value=\"\">-- Pilih Kelurahan/Kampung --</option>\n              <option value=\"Inauga\">Inauga</option>\n              <option value=\"Kamoro Jaya\">Kamoro Jaya</option>\n              <option value=\"Wonosari Jaya\">Wonosari Jaya</option>\n              <option value=\"Kadun Jaya\">Kadun Jaya</option>\n              <option value=\"Mandiri Jaya\">Mandiri Jaya</option>\n              <option value=\"Mawokau Jaya\">Mawokau Jaya</option>\n              <option value=\"Nawaripi\">Nawaripi</option>\n            </select>\n\n            <div class=\"lab\">Kecamatan</div><div class=\"sep\">:</div><div class=\"val\" id=\"kecamatan\"></div>\n            <input type=\"text\" class=\"edit-field\" id=\"editKecamatan\" value=\"WANIA\">\n\n            <div class=\"lab\">Kota/Kabupaten</div><div class=\"sep\">:</div><div class=\"val\" id=\"kota_kab\"></div>\n            <input type=\"text\" class=\"edit-field\" id=\"editKotaKab\" value=\"MIMIKA\">\n\n            <div class=\"lab\">Provinsi</div><div class=\"sep\">:</div><div class=\"val\" id=\"provinsi\"></div>\n            <input type=\"text\" class=\"edit-field\" id=\"editProvinsi\" value=\"PAPUA TENGAH\">\n          </div>\n\n          <div class=\"stitle\" style=\"margin-top:10px\">Lampiran Wajib</div>\n          <div class=\"callout\" style=\"border-color:rgba(239,68,68,.45);background:rgba(239,68,68,.08);color:#fee2e2\">\n            üìé <strong>WAJIB LAMPIRKAN :</strong> Kartu KTP, Kartu Keluarga, Surat Keterangan Sakit dari Rumah Sakit, dan Surat Keterangan dari RT Setempat harus dilampirkan sebelum mengirim surat.\n          </div>\n\n          <div class=\"stitle\" style=\"margin-top:10px\">Upload File</div>\n          <div class=\"file-upload-container\" ondragover=\"handleDragOver(event)\" ondragleave=\"handleDragLeave(event)\" ondrop=\"handleDrop(event)\">\n            <input type=\"file\" id=\"fileInput\" accept=\"*\" multiple style=\"display:none\" onchange=\"handleFileSelect(event)\">\n            <button class=\"btn ghost\" onclick=\"document.getElementById('fileInput').click()\" style=\"width:100%;margin-bottom:8px\">üìÅ Pilih File</button>\n            <div style=\"font-size:11px;color:#9ca3af;text-align:center;margin-bottom:8px\">(PDF, JPG, PNG, DOC, XLS, PPT, ZIP, RAR, dll)</div>\n            <div id=\"fileInfo\" style=\"display:none\"></div>\n            <div id=\"uploadProgress\" class=\"upload-progress\" style=\"display:none\"><div id=\"uploadProgressBar\" class=\"upload-progress-bar\"></div></div>\n            <button class=\"btn primary\" id=\"uploadBtn\" onclick=\"uploadFiles()\" style=\"width:100%;display:none\">üì§ Kirim File</button>\n          </div>\n\n          <div class=\"stitle\" style=\"margin-top:16px\">File Terupload</div>\n          <div class=\"uploaded-files-container\">\n            <div id=\"uploadedFilesList\"><div class=\"no-files-message\">Belum ada file yang diupload</div></div>\n          </div>\n\n          <div class=\"note\">‚ÑπÔ∏è <b>Catatan:</b> Periksa kembali kebenaran data sebelum membuat surat.</div>\n\n          <div class=\"stitle\" style=\"margin-top:16px\">Keterangan</div>\n          <div class=\"file-upload-container\" style=\"margin-bottom:16px;line-height:1.6;font-size:14px\">\n            <div style=\"margin-bottom:8px\">1. Tersebut namanya di atas adalah benar-benar penduduk <strong id=\"keterangan_kelurahan\"></strong>.</div>\n            <div style=\"margin-bottom:8px\">2. Tersebut namanya di atas adalah benar-berstatus ekonomi lemah yang tidak mampu menebus atau membayar biaya pengobatan <strong>BPJS / KIS</strong>.</div>\n            <div style=\"margin-bottom:8px\">3. Mohon surat keterangan ini digunakan sebagaimana mestinya.</div>\n            <div style=\"margin-top:12px;font-style:italic\">Demikian surat keterangan tidak mampu ini kami buat untuk dapat digunakan sebagaimana mestinya.</div>\n          </div>\n        </div>\n\n        <aside class=\"side\">\n          <div class=\"stitle\">Tindakan</div>\n          <div class=\"actions\">\n            <button class=\"btn primary\" id=\"createSendBtn\" onclick=\"confirmCreateAndSend()\">üì® Buat Surat & Kirim Data</button>\n            <button class=\"btn danger\" onclick=\"confirmDeleteAll()\">üóëÔ∏è Hapus Surat & Hapus Data</button>\n          </div>\n\n          <div class=\"stitle\" style=\"margin-top:10px\">Ringkasan</div>\n          <div class=\"callout\">\n            <div><b>üë§ Operator:</b> KaweNia</div>\n            <div><b>üìÖ Tanggal:</b> <span id=\"date\"></span></div>\n            <div><b>üîó Referensi:</b> KaweNia-SKTM</div>\n            <div><b>üß≠ From:</b> <span id=\"WAHA_Trigger_payload_from\"></span></div>\n          </div>\n        </aside>\n      </div>\n\n      <footer class=\"card-footer\">\n        <div>¬© <span id=\"tahun\"></span> Pemerintah Distrik Wania ‚Ä¢ Kawe Nia</div>\n      </footer>\n    </section>\n  </div>\n\n  <!-- LOADING -->\n  <div class=\"loading-overlay\" id=\"loadingOverlay\" aria-live=\"polite\" aria-busy=\"true\">\n    <div class=\"loading-box\">\n      <div class=\"spinner\" aria-hidden=\"true\"></div>\n      <div class=\"loading-text\" id=\"loadingText\">Memuat data‚Ä¶ Mohon menunggu.</div>\n    </div>\n  </div>\n\n  <!-- MODAL -->\n  <div class=\"modal-overlay\" id=\"modalOverlay\" role=\"dialog\" aria-modal=\"true\" aria-hidden=\"true\">\n    <div class=\"modal modal--info\" id=\"modalBox\" role=\"document\">\n      <div class=\"modal-header\">\n        <div class=\"modal-icon\" id=\"modalIcon\">‚ÑπÔ∏è</div>\n        <div class=\"modal-title\" id=\"modalTitle\">Informasi</div>\n      </div>\n      <div class=\"modal-message\" id=\"modalMessage\">Pesan‚Ä¶</div>\n      <div class=\"modal-actions\" id=\"modalActions\"></div>\n    </div>\n  </div>\n\n<script>\n/* ================= 1) DYNAMIC WEBHOOK ================= */\nconst ENDPOINT_MAP = {\n  x1: 'webhook',\n  x2: 'urlpost', \n  x3: 'webhook_url',\n  x4: 'WEBHOOK'\n};\n\nfunction getWebhookUrl(){\n  if (!lastObj || typeof lastObj !== 'object') return null;\n  for (const [key, field] of Object.entries(ENDPOINT_MAP)) {\n    if (lastObj[field]) return lastObj[field];\n  }\n  return null;\n}\nconst UPDATE_STRATEGY = 'OVERWRITE_BIN';\nconst POLL_MS = 500;\n\n/* ================= 2) CONFIG & DATA SOURCE ================= */\nconst META_CONFIG = {\n  x7k: \"{{ $json.id }}\",\n  p9m: \"https://distrikwania.com/data/\",\n  w2n: \"id\",\n  z5f: /\\{\\{\\s*\\$json\\.id\\s*\\}\\}/,\n  h8r: ['id', 'ref', 'key', 'token'],\n  q3t: function(s) { return (s||\"\").toString().trim(); },\n  // Decoy variables to confuse\n  userId: 'user',\n  sessionId: 'session', \n  authToken: 'token',\n  apiKey: 'key'\n};\n\n// Obfuscated function names\nconst fn = {\n  extract: 'extractDataRef',\n  resolve: 'resolveParameter',\n  validate: 'validateInput'\n};\n\nfunction extractDataRef(){\n  const raw = META_CONFIG.x7k;\n  if(META_CONFIG.z5f.test(raw)){\n    const urlObj = new URL(location.href);\n    for(const param of META_CONFIG.h8r){\n      const val = urlObj.searchParams.get(param);\n      if(val) return META_CONFIG.q3t(val);\n    }\n    const segments = urlObj.pathname.split('/').filter(Boolean);\n    if(segments.length) return segments[segments.length-1];\n    return \"\";\n  }\n  return META_CONFIG.q3t(raw);\n}\n\nconst DATA_REF = extractDataRef();\nconst API_ENDPOINT = DATA_REF ? (META_CONFIG.p9m + encodeURIComponent(DATA_REF)) : \"\";\n\n/* ================= 3) UTIL ================= */\nconst $=id=>document.getElementById(id);\nconst toStr=(x,fb='-')=>{const v=(x??'').toString().trim();return v.length?v:fb;}\nconst isJSONResponse=res=>(res.headers.get('content-type')||'').toLowerCase().includes('application/json');\nasync function hashText(txt){const buf=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(txt));return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');}\nfunction pickObj(root){if(!root)return{}; if(Array.isArray(root?.data)&&root.data[0])return root.data[0]; if(Array.isArray(root)&&root[0])return root[0]; return root;}\nfunction humanSize(bytes){if(!bytes&&bytes!==0)return null; const u=['B','KB','MB','GB']; let i=0, n=Number(bytes); while(n>=1024&&i<u.length-1){n/=1024;i++} return (Math.round(n*10)/10)+' '+u[i];}\n\n/* ================= 4) STATE ================= */\nlet lastJSON=null,lastObj={},lastHash=null;\nlet editMode=false,pollHandle=null,pendingFiles=[];\nlet firstLoadDone=false;\n\n/* ================= 5) VIEW MAP ================= */\nconst VIEW={logo:$(\"LogoURL\"),date:$(\"date\"),from:$(\"WAHA_Trigger_payload_from\"),tahun:$(\"tahun\"),\n  nama:$(\"nama\"),nik:$(\"nik\"),ttl:$(\"ttl\"),agama:$(\"agama\"),jenis_kelamin:$(\"jenis_kelamin\"),status_perkawinan:$(\"status_perkawinan\"),\n  pekerjaan:$(\"pekerjaan\"),alamat:$(\"alamat\"),kelurahan:$(\"kelurahan\"),kecamatan:$(\"kecamatan\"),kota_kab:$(\"kota_kab\"),provinsi:$(\"provinsi\"),\n  ket_kel:$(\"keterangan_kelurahan\"),filesList:$(\"uploadedFilesList\")};\nconst EDIT={nama:$(\"editNama\"),nik:$(\"editNIK\"),ttl:$(\"editTTL\"),agama:$(\"editAgama\"),jk:$(\"editJenisKelamin\"),\n  status:$(\"editStatusPerkawinan\"),pekerjaan:$(\"editPekerjaan\"),alamat:$(\"editAlamat\"),\n  kelurahan:$(\"editKelurahan\"),kecamatan:$(\"editKecamatan\"),kota_kab:$(\"editKotaKab\"),provinsi:$(\"editProvinsi\")};\nconst elFileInput=$(\"fileInput\"), elFileInfo=$(\"fileInfo\"), elUploadBtn=$(\"uploadBtn\");\nconst elProg=$(\"uploadProgress\"), elProgBar=$(\"uploadProgressBar\");\nconst loadingOverlay=$(\"loadingOverlay\"), loadingText=$(\"loadingText\");\n\n/* ================= 6) RENDER ================= */\nfunction renderStatic(){ if(VIEW.tahun) VIEW.tahun.textContent=String(new Date().getFullYear()); }\n\n// Helper function to format text with proper capitalization (only first letter capitalized)\nfunction formatProperCase(text) {\n  if (!text) return '';\n  return text.toLowerCase().replace(/\\b\\w/g, letter => letter.toUpperCase());\n}\n\n// Helper functions to validate field values against select options\nfunction validateGenderValue(value) {\n  const validGenders = ['Laki-Laki', 'Perempuan'];\n  if (!value) return '';\n  \n  // Case-sensitive match first\n  if (validGenders.includes(value)) {\n    return value;\n  }\n  \n  // Case-insensitive match\n  const match = validGenders.find(g => g.toLowerCase() === value.toLowerCase());\n  if (match) {\n    return match;\n  }\n  \n  return '';\n}\n\nfunction validateMarriageStatusValue(value) {\n  const validStatuses = ['BELUM KAWIN', 'KAWIN', 'CERAI HIDUP', 'CERAI MATI'];\n  if (!value) return '';\n  \n  // Case-sensitive match first\n  if (validStatuses.includes(value)) {\n    return formatProperCase(value); // Format to proper case for display\n  }\n  \n  // Case-insensitive match\n  const match = validStatuses.find(s => s.toLowerCase() === value.toLowerCase());\n  if (match) {\n    return formatProperCase(match); // Format to proper case for display\n  }\n  \n  return '';\n}\n\nfunction validateKelurahanValue(value) {\n  const validKelurahan = ['Inauga', 'Kamoro Jaya', 'Wonosari Jaya', 'Kadun Jaya', 'Mandiri Jaya', 'Mawokau Jaya', 'Nawaripi'];\n  if (!value) return '';\n  \n  // Case-sensitive match first\n  if (validKelurahan.includes(value)) {\n    return value;\n  }\n  \n  // Case-insensitive match\n  const match = validKelurahan.find(k => k.toLowerCase() === value.toLowerCase());\n  if (match) {\n    return match;\n  }\n  \n  return '';\n}\n\nfunction normalizeDocs(docs){\n  const arr=Array.isArray(docs)?docs.filter(Boolean):[];\n  const seen=new Set(); const out=[];\n  for(const d of arr){\n    const fid=d?.file_id||d?.id||d?.fileId||null;\n    const hasUrl=!!(d?.view_url||d?.download_url);\n    if(!fid && !hasUrl) continue;\n    const key=fid?`fid:${fid}`:`name:${(d?.name||'').toLowerCase()}|size:${d?.size||0}`;\n    if(seen.has(key)) continue; seen.add(key);\n    out.push({\n      label:d?.label??d?.name??'-',\n      name:d?.name??d?.label??'-',\n      file_id:fid,\n      view_url:d?.view_url??null,\n      download_url:d?.download_url??null,\n      size: d?.size ?? null,\n      mimeType: d?.mimeType ?? d?.mime ?? null\n    });\n  }\n  return out;\n}\n\nfunction renderFiles(obj){\n  const wrap=VIEW.filesList; if(!wrap) return;\n  const docs=normalizeDocs(obj?.dokumen);\n  wrap.innerHTML='';\n  updateCreateSendButton(docs.length > 0);\n  if(!docs.length){\n    const div=document.createElement('div'); div.className='no-files-message'; div.textContent='Belum ada file yang diupload'; wrap.appendChild(div); return;\n  }\n  docs.forEach(d=>{\n    const row=document.createElement('div'); row.className='uploaded-file-item';\n    const nameEl=document.createElement('div'); nameEl.className='file-name'; nameEl.textContent=toStr(d.name,'(tanpa nama)'); row.appendChild(nameEl);\n    const metaParts=[]; if(d.size!=null) metaParts.push('Ukuran: '+humanSize(d.size)); if(d.mimeType) metaParts.push(d.mimeType);\n    const metaEl=document.createElement('div'); metaEl.className='file-meta'; metaEl.textContent=metaParts.join(' ‚Ä¢ ')||'‚Äî'; row.appendChild(metaEl);\n    const act=document.createElement('div'); act.className='file-actions';\n    if(d.view_url){ const a=document.createElement('a'); a.href=d.view_url; a.target='_blank'; a.rel='noopener'; a.textContent='üëÅÔ∏è Lihat'; a.className='btn success'; act.appendChild(a); }\n    if(d.file_id){ \n      const b=document.createElement('button'); \n      b.className='btn danger'; \n      b.textContent='üóëÔ∏è Hapus'; \n      \n      // Check if system is disabled due to letter being sent\n      if(window.systemDisabled) {\n        b.disabled = true;\n        b.classList.add('disabled');\n        b.onclick = function(e) {\n          e.preventDefault();\n          showModal({\n            icon: 'üîí',\n            title: 'Hapus Dokumen Tidak Tersedia',\n            message: 'Surat telah terkirim. Dokumen tidak dapat dihapus.',\n            variant: 'info',\n            buttons: [{label: 'Tutup', variant: 'secondary', value: true}]\n          });\n        };\n      } else {\n        b.onclick=()=>confirmDeleteDocs([d]);\n      }\n      \n      act.appendChild(b); \n    }\n    row.appendChild(act);\n    wrap.appendChild(row);\n  });\n}\n\nfunction renderView(obj){\n  if(VIEW.date) VIEW.date.textContent=toStr(obj.date,new Date().toLocaleDateString('id-ID'));\n  if(VIEW.from) VIEW.from.textContent=toStr(obj.WAHA_Trigger_payload_from,'‚Äî');\n  if(VIEW.logo){ const logo=obj.LogoURL||obj.logo_url||''; if(logo) VIEW.logo.src=logo; }\n  \n  // Check status and disable buttons if letter has been sent\n  checkStatusAndDisableButtons(obj);\n\n  const p=obj.pemohon||{};\n  VIEW.nama&&(VIEW.nama.textContent=formatProperCase(toStr(p.nama)));\n  VIEW.nik&&(VIEW.nik.textContent=toStr(p.nik));\n  VIEW.ttl&&(VIEW.ttl.textContent=formatProperCase(toStr(p.ttl)));\n  VIEW.agama&&(VIEW.agama.textContent=formatProperCase(toStr(p.agama)));\n  \n  // Filter and validate Jenis Kelamin - only display if valid\n  if(VIEW.jenis_kelamin) {\n    const validGender = validateGenderValue(p.jenis_kelamin);\n    VIEW.jenis_kelamin.textContent = toStr(validGender);\n  }\n  \n  // Filter and validate Status Perkawinan - only display if valid\n  if(VIEW.status_perkawinan) {\n    const validStatus = validateMarriageStatusValue(p.status_perkawinan);\n    VIEW.status_perkawinan.textContent = toStr(validStatus);\n  }\n  VIEW.pekerjaan&&(VIEW.pekerjaan.textContent=formatProperCase(toStr(p.pekerjaan)));\n  VIEW.alamat&&(VIEW.alamat.textContent=formatProperCase(toStr(p.alamat)));\n  \n  // Filter and validate Kelurahan/Kampung - only display if valid\n  if(VIEW.kelurahan) {\n    const kelurahanValue = p['kelurahan/kampung'] || p.kelurahan;\n    const validKelurahan = validateKelurahanValue(kelurahanValue);\n    VIEW.kelurahan.textContent = toStr(validKelurahan);\n  }\n  \n  VIEW.kecamatan&&(VIEW.kecamatan.textContent=formatProperCase(toStr(p.kecamatan)));\n  VIEW.kota_kab&&(VIEW.kota_kab.textContent=formatProperCase(toStr(p.kota_kab)));\n  VIEW.provinsi&&(VIEW.provinsi.textContent=formatProperCase(toStr(p.provinsi)));\n  \n  // Filter and validate Kelurahan for keterangan section too\n  if(VIEW.ket_kel) {\n    const kelurahanValue = p['kelurahan/kampung'] || p.kelurahan;\n    const validKelurahan = validateKelurahanValue(kelurahanValue);\n    VIEW.ket_kel.textContent = toStr(validKelurahan);\n  }\n\n  EDIT.nama&&(EDIT.nama.value=p.nama??''); EDIT.nik&&(EDIT.nik.value=p.nik??''); EDIT.ttl&&(EDIT.ttl.value=p.ttl??'');\n  EDIT.agama&&(EDIT.agama.value=p.agama??''); EDIT.jk&&(EDIT.jk.value=p.jenis_kelamin??'LAKI-LAKI');\n  // Fix status perkawinan field - ensure proper value selection\n  if(EDIT.status) {\n    const statusValue = p.status_perkawinan ?? 'BELUM KAWIN';\n    \n    // Clear any previous selection first\n    EDIT.status.selectedIndex = -1;\n    \n    // Find and explicitly select the matching option (case-sensitive search)\n    let option = EDIT.status.querySelector(`option[value=\"${statusValue}\"]`);\n    \n    // If no exact match, try case-insensitive search\n    if (!option && statusValue) {\n      const options = EDIT.status.querySelectorAll('option');\n      option = Array.from(options).find(opt => \n        opt.value && opt.value.toLowerCase() === statusValue.toLowerCase()\n      );\n    }\n    \n    if (option) {\n      option.selected = true;\n      EDIT.status.value = option.value;\n    } else {\n      // No match found - fallback to first option for marriage status\n      if (EDIT.status.options.length > 0) {\n        EDIT.status.selectedIndex = 0;\n        EDIT.status.value = EDIT.status.options[0].value;\n      }\n    }\n  }\n  EDIT.pekerjaan&&(EDIT.pekerjaan.value=p.pekerjaan??'');\n  EDIT.alamat&&(EDIT.alamat.value=p.alamat??''); \n  \n  // Fix kelurahan/kampung field - ensure proper value selection\n  if(EDIT.kelurahan) {\n    const kelurahanValue = p['kelurahan/kampung'] ?? p.kelurahan ?? '';\n    \n    // Clear any previous selection first\n    EDIT.kelurahan.selectedIndex = -1;\n    \n    // Find and explicitly select the matching option (case-sensitive search)\n    let option = EDIT.kelurahan.querySelector(`option[value=\"${kelurahanValue}\"]`);\n    \n    // If no exact match, try case-insensitive search\n    if (!option && kelurahanValue) {\n      const options = EDIT.kelurahan.querySelectorAll('option');\n      option = Array.from(options).find(opt => \n        opt.value && opt.value.toLowerCase() === kelurahanValue.toLowerCase()\n      );\n    }\n    \n    if (option) {\n      option.selected = true;\n      EDIT.kelurahan.value = option.value;\n    } else {\n      // No match found - keep empty selection and don't display JSON data\n      EDIT.kelurahan.selectedIndex = 0; // Select the empty option\n      EDIT.kelurahan.value = '';\n    }\n  }\n  \n  EDIT.kecamatan&&(EDIT.kecamatan.value=p.kecamatan??''); EDIT.kota_kab&&(EDIT.kota_kab.value=p.kota_kab??'');\n  EDIT.provinsi&&(EDIT.provinsi.value=p.provinsi??'');\n\n  renderFiles(obj);\n}\n\n/* ================= 7) POLLING ================= */\nfunction startPolling(){stopPolling();pollHandle=setInterval(()=>{if(!editMode)loadOnce(false);},POLL_MS)}\nfunction stopPolling(){if(pollHandle){clearInterval(pollHandle);pollHandle=null}}\n\n/* ================= 8) LOADING ================= */\nfunction showLoading(show,text){ if(text) loadingText.textContent=text; loadingOverlay.style.display=show?'flex':'none'; }\n\n/* ================= 9) MODAL ================= */\nconst modalOverlay=$(\"modalOverlay\");\nconst modalBox=$(\"modalBox\");\nconst modalIcon=$(\"modalIcon\");\nconst modalTitle=$(\"modalTitle\");\nconst modalMessage=$(\"modalMessage\");\nconst modalActions=$(\"modalActions\");\n\nfunction showModal({icon='‚ÑπÔ∏è',title='Informasi',message='',buttons=[{label:'Tutup',variant:'secondary',value:true}],variant='info',closable=true}={}){\n  return new Promise(resolve=>{\n    modalIcon.textContent=icon; modalTitle.textContent=title; modalMessage.innerHTML=message; modalActions.innerHTML='';\n    modalBox.className='modal modal--'+variant;\n    buttons.forEach(btn=>{ const el=document.createElement('button'); el.className='btn '+(btn.primary?'primary':btn.danger?'danger':btn.variant||'secondary'); el.textContent=btn.label||'OK'; el.onclick=()=>{hide(); resolve(btn.value);} ; modalActions.appendChild(el); });\n    function onEsc(e){ if(e.key==='Escape' && closable){ hide(); resolve(null);} }\n    function hide(){ modalOverlay.style.display='none'; document.removeEventListener('keydown',onEsc); }\n    modalOverlay.style.display='flex'; document.addEventListener('keydown',onEsc);\n  });\n}\nfunction infoModal(title,message,icon='‚ÑπÔ∏è'){ return showModal({icon,title,message,variant:'info',buttons:[{label:'Tutup',variant:'secondary',value:true}]}); }\nfunction successModal(title,message){ return showModal({icon:'‚úÖ',title,message,variant:'success',buttons:[{label:'Tutup',variant:'secondary',value:true}]}); }\nfunction confirmModal(title,message,{okLabel='Lanjutkan',cancelLabel='Batal',icon='‚ùì',danger=false}={}){ return showModal({ icon,title,message,variant:'confirm', buttons:[ {label:cancelLabel,variant:'secondary',value:false}, {label:okLabel,primary:!danger,danger:danger,value:true} ] }); }\n\n/* ================= 10) EDIT ================= */\nfunction toggleEditMode(){ \n  // Check if system is disabled due to letter being sent\n  if (window.systemDisabled) {\n    showModal({\n      icon: 'üîí',\n      title: 'Mode Edit Tidak Tersedia',\n      message: 'Surat telah terkirim. Mode edit telah dinonaktifkan.',\n      variant: 'info',\n      buttons: [{label: 'Tutup', variant: 'secondary', value: true}]\n    });\n    return;\n  }\n  \n  editMode=!editMode; \n  document.body.classList.toggle('edit-mode',editMode); \n  const btn=$(\"editBtn\"); \n  if(btn) btn.textContent=editMode?'üîí Tutup Mode Edit':'‚úèÔ∏è Masuk Mode Edit'; \n  if(editMode) stopPolling(); \n  else {loadOnce(false);startPolling();} \n}\nfunction cancelEdit(){renderView(lastObj||{}); if(editMode) toggleEditMode();}\n\n/* === Konsolidasi struktur payload === */\nfunction baseHref(){ return (new URL(location.href)).href; }\nfunction buildBasePayload(action){\n  const dataCloned = JSON.parse(JSON.stringify(lastObj||{}));\n  if(UPDATE_STRATEGY==='OVERWRITE_BIN') dataCloned.dokumen = normalizeDocs(lastObj?.dokumen);\n  return {\n    action,\n    id_user: DATA_REF,\n    id_surat: baseHref(),\n    data: { ...dataCloned, id_user: DATA_REF, id_surat: baseHref() }\n  };\n}\nasync function sendJSON(action, extras={}){\n  const targetUrl = getWebhookUrl();\n  if(!targetUrl){\n    throw new Error('Service endpoint not configured. Please verify configuration settings.');\n  }\n  const payload = { ...buildBasePayload(action), ...extras };\n  const resp = await fetch(targetUrl,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });\n  const text = await resp.text();\n  if(!resp.ok) throw new Error('HTTP '+resp.status+' ‚Äî '+text.slice(0,200));\n  return text;\n}\n\nasync function saveChanges(){\n  try{\n    if(!lastObj||typeof lastObj!=='object') lastObj={}; if(!lastObj.pemohon) lastObj.pemohon={};\n    const p=lastObj.pemohon;\n    p.nama=EDIT.nama?.value??p.nama; p.nik=EDIT.nik?.value??p.nik; p.ttl=EDIT.ttl?.value??p.ttl; p.agama=EDIT.agama?.value??p.agama;\n    p.jenis_kelamin=EDIT.jk?.value??p.jenis_kelamin; p.status_perkawinan=EDIT.status?.value??p.status_perkawinan;\n    p.pekerjaan=EDIT.pekerjaan?.value??p.pekerjaan; p.alamat=EDIT.alamat?.value??p.alamat;\n    p['kelurahan/kampung']=EDIT.kelurahan?.value??p['kelurahan/kampung']??p.kelurahan; p.kecamatan=EDIT.kecamatan?.value??p.kecamatan;\n    p.kota_kab=EDIT.kota_kab?.value??p.kota_kab; p.provinsi=EDIT.provinsi?.value??p.provinsi;\n\n    showLoading(true,'Menyimpan perubahan data ke server‚Ä¶');\n    await sendJSON('UPDATE_ONLY', { strategy: UPDATE_STRATEGY });\n    renderView(lastObj); if(editMode) toggleEditMode();\n    await successModal('Perubahan Disimpan','Perubahan data telah berhasil disimpan di server.');\n  }catch(e){\n    await showModal({icon:'‚ö†Ô∏è',title:'Gagal Menyimpan',message:'Terjadi kendala saat menyimpan perubahan.<br><span class=\"mono\">'+(e.message||e)+'</span>',variant:'danger',buttons:[{label:'Tutup',variant:'secondary',value:true}]});\n  }finally{ showLoading(false); }\n}\n\n/* ================= 11) LOAD JSON ================= */\nasync function loadOnce(showLoader=true){\n  try{\n    if(!API_ENDPOINT){ return; }\n    if(showLoader && !firstLoadDone) showLoading(true,'Memuat data‚Ä¶ Mohon menunggu.');\n    const res=await fetch(API_ENDPOINT+'?t='+Date.now(),{cache:'no-store'});\n    const text=await res.text();\n    if(!res.ok) throw new Error('HTTP '+res.status+' ‚Äî '+text.slice(0,200));\n    let data; try{data=JSON.parse(text);}catch(err){ if(!isJSONResponse(res)) throw new Error('Respon bukan JSON'); throw err; }\n    const h=await hashText(JSON.stringify(data));\n    if(h!==lastHash){lastHash=h; lastJSON=data; lastObj=pickObj(data)||{}; renderView(lastObj);} \n    if(!firstLoadDone){firstLoadDone=true; showLoading(false);} \n  }catch(e){\n    if(!firstLoadDone){\n      showLoading(false);\n      await showModal({icon:'‚ö†Ô∏è',title:'Gagal Memuat Data',message:'Sistem tidak dapat memuat data awal.<br><span class=\"mono\">'+(e.message||e)+'</span>',variant:'danger',buttons:[{label:'Tutup',variant:'secondary',value:true}]});\n    }\n  }\n}\nfunction startRealtime(){renderStatic();loadOnce(true);startPolling();}\n\n/* ================= 12) CREATE / DELETE ================= */\nasync function confirmCreateAndSend(){\n  const docs = normalizeDocs(lastObj?.dokumen);\n  if(!docs || docs.length === 0){\n    await showModal({ icon:'‚ö†Ô∏è', title:'Belum Ada File yang Dilampirkan', message:'Silakan upload minimal satu file pendukung sebelum membuat surat.', variant:'danger', buttons:[{label:'Tutup',variant:'secondary',value:true}] });\n    return;\n  }\n  const ok = await confirmModal('Konfirmasi Pembuatan Surat','Dengan menekan <b>Setujui & Proses</b>, sistem akan membuat dokumen berdasarkan data saat ini dan mengirimkannya.',{okLabel:'Setujui & Proses',cancelLabel:'Tinjau Kembali',icon:'üì®'});\n  if(!ok) return;\n  await generateAndSendLetter();\n}\nasync function generateAndSendLetter(){\n  try{\n    if(editMode) await saveChanges();\n    showLoading(true,'Memproses pembuatan surat dan pengiriman data‚Ä¶');\n    await sendJSON('CREATE_AND_SEND');\n    await successModal('Surat Berhasil Dibuat','Data dan surat telah dikirim untuk verifikasi.');\n  }catch(e){\n    await showModal({icon:'‚ö†Ô∏è',title:'Gagal Membuat Surat',message:'Terjadi kendala saat membuat atau mengirim surat.<br><span class=\"mono\">'+(e.message||e)+'</span>',variant:'danger',buttons:[{label:'Tutup',variant:'secondary',value:true}]});\n  }finally{ showLoading(false); }\n}\n\nasync function confirmDeleteAll(){\n  const ok = await showModal({ icon:'üóëÔ∏è',title:'Konfirmasi Penghapusan', message:'Tindakan ini akan <b>menghapus seluruh data dan surat</b> terkait referensi ini. Lanjutkan?', variant:'confirm', buttons:[ {label:'Batal',variant:'secondary',value:false}, {label:'Ya, Hapus Semua',danger:true,value:true} ] });\n  if(!ok) return; await deleteLetterAndData();\n}\nasync function deleteLetterAndData(){\n  try{\n    showLoading(true,'Menghapus surat dan seluruh data terkait‚Ä¶');\n    await sendJSON('DELETE_ALL');\n    await successModal('Penghapusan Berhasil','Surat dan seluruh data terkait telah dihapus dari sistem.');\n    location.reload();\n  }catch(e){\n    await showModal({ icon:'‚ö†Ô∏è', title:'Gagal Menghapus', message:'Terjadi kendala saat menghapus surat atau data.<br><span class=\"mono\">'+(e.message||e)+'</span>', variant:'danger', buttons:[{label:'Tutup',variant:'secondary',value:true}] }).then(()=>location.reload());\n  }finally{ showLoading(false); }\n}\n\n/* ================= 13) UPLOAD ================= */\nfunction handleFileSelect(ev){pendingFiles=Array.from(ev.target.files||[]);refreshPendingFilesUI();}\nfunction handleDragOver(ev){ev.preventDefault();ev.stopPropagation();ev.currentTarget.style.borderColor='rgba(56,189,248,.6)';ev.currentTarget.style.background='rgba(56,189,248,.06)';}\nfunction handleDragLeave(ev){ev.preventDefault();ev.stopPropagation();ev.currentTarget.style.borderColor='';ev.currentTarget.style.background='';}\nfunction handleDrop(ev){ev.preventDefault();ev.stopPropagation();ev.currentTarget.style.borderColor='';ev.currentTarget.style.background='';pendingFiles=Array.from(ev.dataTransfer.files||[]);refreshPendingFilesUI();}\nfunction refreshPendingFilesUI(){ if(!elFileInfo||!elUploadBtn) return; if(!pendingFiles.length){elFileInfo.style.display='none';elUploadBtn.style.display='none';return;} elFileInfo.style.display=''; elUploadBtn.style.display=''; elFileInfo.innerHTML = '<div style=\"font-weight:600;margin-bottom:6px\">File akan diunggah:</div>' + pendingFiles.map(f => `<div style=\"font-size:12px; margin-bottom:8px\">‚Ä¢ ${f.name}</div>`).join(''); }\nasync function uploadFiles(){\n  try{\n    if(!pendingFiles.length) return infoModal('Tidak Ada File','Silakan pilih minimal satu file untuk diunggah.');\n    if(!lastObj && !lastJSON) return infoModal('Data Utama Belum Ada','Muat ulang halaman, lalu coba kembali.');\n    if(editMode) await saveChanges();\n\n    const form=new FormData();\n    form.append('action','UPLOAD_FILES');\n    form.append('id_user', DATA_REF);\n    form.append('id_surat', baseHref());\n    form.append('data', JSON.stringify({ ...((lastObj)||{}), id_user: DATA_REF, id_surat: baseHref() }));\n    pendingFiles.forEach(f=>form.append('files[]',f,f.name));\n\n    if(elProg) elProg.style.display=''; if(elProgBar) elProgBar.style.width='8%';\n    const targetUrl = getWebhookUrl();\n    if(!targetUrl){\n      throw new Error('Service endpoint not configured. Please verify configuration settings.');\n    }\n    showLoading(true,'Mengunggah berkas‚Ä¶');\n    const resp=await fetch(targetUrl,{method:'POST',body:form}); const text=await resp.text();\n    if(!resp.ok) throw new Error('HTTP '+resp.status+' ‚Äî '+text.slice(0,200));\n    if(elProgBar) elProgBar.style.width='100%';\n    await successModal('Unggah Berhasil','Berkas berhasil diunggah dan ditautkan ke data pemohon.');\n\n    pendingFiles=[]; if(elFileInput) elFileInput.value=''; refreshPendingFilesUI(); await loadOnce(false);\n  }catch(e){\n    await showModal({icon:'‚ö†Ô∏è',title:'Unggah Gagal',message:'Terjadi kendala saat mengunggah berkas.<br><span class=\"mono\">'+(e.message||e)+'</span>',variant:'danger',buttons:[{label:'Tutup',variant:'secondary',value:true}]});\n  }finally{ setTimeout(()=>{if(elProg) elProg.style.display='none';},600); if(elProgBar) elProgBar.style.width='0%'; showLoading(false); }\n}\n\n/* ================= 14) HAPUS DOKUMEN ================= */\nasync function confirmDeleteDocs(docs=[]){\n  if(!docs.length) return;\n  const listHtml=docs.map(d=>{ const sizeTxt = d.size!=null ? humanSize(d.size) : '‚Äî'; return `üìÑ <b>${toStr(d.name,'(tanpa nama)')}</b><br>Ukuran: ${sizeTxt}${d.mimeType?(' ‚Ä¢ '+d.mimeType):''}<br>ID: <span class=\"mono\">${toStr(d.file_id,'‚Äî')}</span>`; }).join('<hr style=\"border:0;border-top:1px solid rgba(148,163,184,.25);margin:8px 0\">');\n  const ok = await showModal({ icon:'üóÇÔ∏è', title:'Konfirmasi Penghapusan Dokumen', message:`Dokumen berikut akan dihapus dari sistem:<br><br>${listHtml}<br><br>Tindakan ini tidak dapat dibatalkan. Lanjutkan?`, variant:'confirm', buttons:[ {label:'Batal',variant:'secondary',value:false}, {label:'Hapus Dokumen',danger:true,value:true} ] });\n  if(!ok) return; await deleteDocumentsByFileIds(docs.map(d=>d.file_id).filter(Boolean));\n}\nasync function deleteDocumentsByFileIds(fileIds=[]){\n  if(!fileIds.length) return;\n  try{\n    showLoading(true,'Menghapus dokumen terpilih‚Ä¶');\n    await sendJSON('DELETE_DOCS', { delete_file_ids: fileIds });\n    await loadOnce(false);\n    await successModal('Dokumen Dihapus','Dokumen terpilih telah berhasil dihapus dari sistem.');\n  }catch(e){\n    await showModal({icon:'‚ö†Ô∏è',title:'Gagal Menghapus Dokumen',message:'Terjadi kendala saat menghapus dokumen.<br><span class=\"mono\">'+(e.message||e)+'</span>',variant:'danger',buttons:[{label:'Tutup',variant:'secondary',value:true}]});\n  }finally{ showLoading(false); }\n}\n\n/* ================= 15) FILE VALIDATION ================= */\nfunction updateCreateSendButton(hasFiles = false){ const btn=$(\"createSendBtn\"); if(!btn) return; btn.style.opacity = hasFiles ? '1' : '0.5'; btn.style.cursor = hasFiles ? 'pointer' : 'not-allowed'; btn.disabled = !hasFiles; }\n\n/* ================= 16) STATUS CHECK & BUTTON DISABLE ================= */\nfunction checkStatusAndDisableButtons(obj) {\n  const status = obj?.status || '';\n  const isLetterSent = status.toLowerCase().includes('terkirim');\n  \n  if (isLetterSent) {\n    disableAllButtons();\n    showStatusMessage('Surat telah terkirim');\n  } else {\n    enableAllButtons();\n  }\n}\n\nfunction disableAllButtons() {\n  \n  // Disable specific buttons by ID\n  const specificButtons = [\n    'createSendBtn',    // Tombol kirim surat dan data\n    'editBtn',          // Tombol edit\n    'uploadBtn'         // Tombol upload\n  ];\n  \n  specificButtons.forEach(buttonId => {\n    const button = document.getElementById(buttonId);\n    if (button) {\n      button.disabled = true;\n      button.classList.add('disabled');\n    }\n  });\n  \n  // Disable all buttons with specific onclick functions\n  const functionalButtons = document.querySelectorAll('button[onclick], .btn[onclick]');\n  functionalButtons.forEach(button => {\n    button.disabled = true;\n    button.classList.add('disabled');\n    // Remove click handlers\n    const originalOnclick = button.onclick;\n    button.onclick = function(e) {\n      e.preventDefault();\n      e.stopPropagation();\n      showModal({\n        icon: 'üîí',\n        title: 'Aksi Tidak Tersedia',\n        message: 'Surat telah terkirim. Semua tombol telah dinonaktifkan.',\n        variant: 'info',\n        buttons: [{label: 'Tutup', variant: 'secondary', value: true}]\n      });\n      return false;\n    };\n    button.setAttribute('data-original-onclick', originalOnclick ? originalOnclick.toString() : '');\n  });\n  \n  // Disable all delete document buttons (dynamically created)\n  const deleteDocButtons = document.querySelectorAll('.file-actions .btn.danger');\n  deleteDocButtons.forEach(button => {\n    button.disabled = true;\n    button.classList.add('disabled');\n    button.onclick = function(e) {\n      e.preventDefault();\n      showModal({\n        icon: 'üîí',\n        title: 'Hapus Dokumen Tidak Tersedia',\n        message: 'Surat telah terkirim. Dokumen tidak dapat dihapus.',\n        variant: 'info',\n        buttons: [{label: 'Tutup', variant: 'secondary', value: true}]\n      });\n    };\n  });\n  \n  // Disable file input\n  const fileInput = document.getElementById('fileInput');\n  if (fileInput) {\n    fileInput.disabled = true;\n  }\n  \n  // Disable file upload container drag and drop\n  const uploadContainer = document.querySelector('.file-upload-container');\n  if (uploadContainer) {\n    uploadContainer.style.pointerEvents = 'none';\n    uploadContainer.style.opacity = '0.5';\n    uploadContainer.ondragover = null;\n    uploadContainer.ondragleave = null;\n    uploadContainer.ondrop = null;\n  }\n  \n  // Disable edit mode if active and prevent future edit mode activation\n  if (editMode) {\n    document.body.classList.remove('edit-mode');\n    editMode = false;\n  }\n  \n  // Mark system as disabled to prevent edit mode activation\n  window.systemDisabled = true;\n}\n\nfunction enableAllButtons() {\n  \n  // Enable specific buttons by ID\n  const specificButtons = [\n    'createSendBtn',    // Tombol kirim surat dan data\n    'editBtn',          // Tombol edit\n    'uploadBtn'         // Tombol upload\n  ];\n  \n  specificButtons.forEach(buttonId => {\n    const button = document.getElementById(buttonId);\n    if (button) {\n      button.disabled = false;\n      button.classList.remove('disabled');\n    }\n  });\n  \n  // Enable all buttons and restore original onclick functions\n  const functionalButtons = document.querySelectorAll('button[onclick], .btn[onclick]');\n  functionalButtons.forEach(button => {\n    button.disabled = false;\n    button.classList.remove('disabled');\n    \n    // Restore original onclick if it was saved\n    const originalOnclick = button.getAttribute('data-original-onclick');\n    if (originalOnclick && originalOnclick !== '') {\n      try {\n        button.onclick = new Function(originalOnclick);\n      } catch (e) {\n        // Could not restore original onclick\n      }\n    }\n    button.removeAttribute('data-original-onclick');\n  });\n  \n  // Enable file input\n  const fileInput = document.getElementById('fileInput');\n  if (fileInput) {\n    fileInput.disabled = false;\n  }\n  \n  // Enable file upload container drag and drop\n  const uploadContainer = document.querySelector('.file-upload-container');\n  if (uploadContainer) {\n    uploadContainer.style.pointerEvents = '';\n    uploadContainer.style.opacity = '';\n    uploadContainer.ondragover = handleDragOver;\n    uploadContainer.ondragleave = handleDragLeave;\n    uploadContainer.ondrop = handleDrop;\n  }\n  \n  // Mark system as enabled\n  window.systemDisabled = false;\n}\n\nfunction showStatusMessage(message) {\n  // Create or update status message\n  let statusDiv = document.getElementById('statusMessage');\n  if (!statusDiv) {\n    statusDiv = document.createElement('div');\n    statusDiv.id = 'statusMessage';\n    statusDiv.style.cssText = `\n      background: rgba(34,197,94,.1);\n      border: 1px solid rgba(34,197,94,.35);\n      border-radius: 12px;\n      padding: 12px 14px;\n      margin: 14px 0;\n      font-size: 14px;\n      color: #d1fae5;\n      text-align: center;\n      font-weight: 700;\n      animation: slideIn 0.5s ease-out;\n    `;\n    \n    // Insert after the brand section\n    const topbar = document.querySelector('.topbar');\n    if (topbar && topbar.nextSibling) {\n      topbar.parentNode.insertBefore(statusDiv, topbar.nextSibling);\n    }\n  }\n  \n  statusDiv.innerHTML = `üü¢ ${message}`;\n  statusDiv.style.display = 'block';\n  \n  // Add slide-in animation\n  const style = document.createElement('style');\n  style.textContent = `\n    @keyframes slideIn {\n      from { opacity: 0; transform: translateY(-10px); }\n      to { opacity: 1; transform: translateY(0); }\n    }\n  `;\n  if (!document.querySelector('style[data-status-animation]')) {\n    style.setAttribute('data-status-animation', 'true');\n    document.head.appendChild(style);\n  }\n}\n\n/* ================= 17) START ================= */\nwindow.toggleEditMode=toggleEditMode; window.saveChanges=saveChanges; window.cancelEdit=cancelEdit;\nwindow.uploadFiles=uploadFiles; window.confirmCreateAndSend=confirmCreateAndSend; window.confirmDeleteAll=confirmDeleteAll;\nwindow.handleFileSelect=handleFileSelect; window.handleDragOver=handleDragOver; window.handleDragLeave=handleDragLeave; window.handleDrop=handleDrop;\nwindow.checkStatusAndDisableButtons=checkStatusAndDisableButtons;\n\ndocument.addEventListener('DOMContentLoaded',startRealtime);\n</script>\n\n</body>\n</html>\n"
        },
        "type": "n8n-nodes-base.html",
        "typeVersion": 1.2,
        "position": [
          440,
          160
        ],
        "id": "db996d2e-f693-4101-abcc-cfb33d267267",
        "name": "HTML1"
      },
      {
        "parameters": {
          "jsCode": "/**\n * Generate Payload Surat ‚Äî gabung data form + banyak file Drive\n * Mode   : Run Once for All Items\n * Input  : 1 item Webhook (body.action, body.id_user, body.delete_file_ids, body.data[...])\n * Output : 1 item { json: payload }\n */\n\n/* ===================== Utils ===================== */\nconst clean = (s) => (s ?? '').toString().normalize('NFKC').trim();\nconst lower = (s) => clean(s).toLowerCase();\nconst ensure = (x, f='-') => { const v = clean(x); return v ? v : f; };\n\nconst toNull = (x) => {\n  if (x === undefined || x === null) return null;\n  const v = (typeof x === 'string') ? x.trim() : x;\n  if (v === '' || v === 'undefined' || v === 'null') return null;\n  return v;\n};\n\nconst baseName = (name) => lower((name || '').replace(/\\.[^./\\\\]+$/, ''));\n\nconst safeParseJSON = (maybeJSON) => {\n  try {\n    if (typeof maybeJSON === 'string') return JSON.parse(maybeJSON);\n    if (typeof maybeJSON === 'object' && maybeJSON !== null) return maybeJSON;\n  } catch {}\n  return {};\n};\n\nconst tryParse = (x) => {\n  if (typeof x === 'string') {\n    let s = x;\n    if (/%[0-9A-Fa-f]{2}/.test(x) && (x.includes('%7B') || x.includes('%5B'))) {\n      try { s = decodeURIComponent(x); } catch {}\n    }\n    let obj = safeParseJSON(s);\n    if (typeof obj === 'string') obj = safeParseJSON(obj); // double-stringified\n    return obj;\n  }\n  return safeParseJSON(x);\n};\n\nconst uniqArray = (arr) => Array.from(new Set((arr || []).filter(Boolean)));\nconst firstDefined = (...args) => args.find(v => v !== undefined && v !== null);\n\n/* ===================== Ambil wrapper (body) ===================== */\nconst firstItem = items[0]?.json ?? {};\nconst root = (firstItem && typeof firstItem.body === 'object' && firstItem.body !== null)\n  ? firstItem.body\n  : firstItem;\n\n// Wrapper fields\nconst wrapperAction     = root.action ?? null;\nconst wrapperIdUser     = root.id_user ?? null;\nconst wrapperDeleteIds  = Array.isArray(root.delete_file_ids) ? root.delete_file_ids : [];\nlet   rawData           = root.data ?? null;\n\n/* ===================== Parse data (object/array/string) ===================== */\nlet bodyData = tryParse(rawData);\nif (typeof bodyData !== 'object' || bodyData === null) bodyData = {};\n\nlet bodyArray = null;\nif (Array.isArray(bodyData)) {\n  bodyArray = bodyData;\n  bodyData = bodyData[0] || {};\n}\n\n/* ===================== Action & Delete IDs ===================== */\nconst actionRaw = firstDefined(wrapperAction, bodyData?.action);\nconst action    = toNull(actionRaw) || null;\n\nconst deleteIds = uniqArray(\n  wrapperDeleteIds.concat(Array.isArray(bodyData?.delete_file_ids) ? bodyData.delete_file_ids : [])\n);\nconst deletedSet = new Set(deleteIds);\n\n/* ===================== Kebijakan struktur baru vs lama ===================== */\nlet mdCandidate = bodyData;\nif (bodyData && typeof bodyData.mandatory_data === 'object' && bodyData.mandatory_data !== null) {\n  mdCandidate = bodyData.mandatory_data;\n}\nif (Array.isArray(mdCandidate)) mdCandidate = mdCandidate[0] || {};\nconst md = (typeof mdCandidate === 'object' && mdCandidate !== null) ? mdCandidate : {};\n\n// files_info untuk audit/unggah (tidak dipakai saat DELETE_DOCS untuk mengisi dokumen)\nlet filesInfo = [];\nif (Array.isArray(bodyData.files_info)) filesInfo = bodyData.files_info;\nelse if (Array.isArray(md.files_info)) filesInfo = md.files_info;\nelse if (bodyArray && Array.isArray(bodyArray[0]?.files_info)) filesInfo = bodyArray[0].files_info;\n\n/* ===================== Kolektor dokumen ===================== */\nconst map = new Map();\n\nconst uniqKey = (base) => {\n  let k = base || 'lampiran';\n  if (!map.has(k)) return k;\n  let i = 2;\n  while (map.has(`${k}_${i}`)) i++;\n  return `${k}_${i}`;\n};\nconst put = (key, obj) => map.set(key, Object.assign(map.get(key) || {}, obj));\nconst normKey = (label) => lower(label || 'lampiran').replace(/\\s+/g,'_').replace(/[^a-z0-9_\\-]/g,'');\n\nconst add = (label, obj={}) => {\n  const key = uniqKey(normKey(label || 'lampiran'));\n  put(key, {\n    label: key, file_id:null, download_url:null, view_url:null,\n    name:null, mimeType:null, size:null, iconLink:null, thumbnailLink:null, createdTime:null,\n    ...obj,\n  });\n};\n\n// 1) md.dokumen (DI-FILTER terhadap delete_file_ids)\nif (Array.isArray(md.dokumen)) {\n  for (const d of md.dokumen) {\n    const fid = toNull(d?.file_id);\n    if (fid && deletedSet.has(fid)) continue; // buang yang akan dihapus\n    add(d?.label ?? d?.name ?? 'lampiran', {\n      file_id     : fid,\n      download_url: toNull(d?.download_url),\n      view_url    : toNull(d?.view_url),\n      name        : toNull(d?.name),\n      mimeType    : toNull(d?.mimeType),\n      size        : (Number.isFinite(+d?.size) ? +d.size : null),\n    });\n  }\n}\n\n// 2) files_info ‚Üí HANYA jika BUKAN DELETE_DOCS (hindari muncul lagi saat timpa)\nif (action !== 'DELETE_DOCS') {\n  for (const f of (Array.isArray(filesInfo) ? filesInfo : [])) {\n    const key = uniqKey(baseName(f?.name || 'lampiran'));\n    put(key, {\n      label   : key,\n      name    : toNull(f?.name) ?? null,\n      mimeType: toNull(f?.type) ?? null,\n      size    : (Number.isFinite(+f?.size) ? +f.size : null),\n    });\n  }\n}\n\nconst dokumen = Array.from(map.values());\n\n/* ===================== Normalisasi bidang teks ===================== */\nconst pemohonRaw = md?.pemohon ?? {};\nconst kelurahan  = ensure(toNull(pemohonRaw.kelurahan));\nconst kecamatan  = ensure(toNull(pemohonRaw.kecamatan));\nconst kotaKab    = ensure(toNull(pemohonRaw.kota_kab ?? pemohonRaw.kabupaten));\nconst provinsi   = ensure(toNull(pemohonRaw.provinsi));\n\nlet domisili = toNull(pemohonRaw.domisili);\nif (!domisili) domisili = `${kelurahan}, ${kecamatan}, ${kotaKab}, ${provinsi}`;\n\n/* ===================== Metadata umum (tanpa campur || dan ??) ===================== */\nconst idUserRaw = firstDefined(wrapperIdUser,\n                               (bodyArray && bodyArray[0]) ? bodyArray[0].id_user : undefined,\n                               bodyData?.id_user);\nconst id_user = toNull(idUserRaw);\n\nconst urlWebRaw = firstDefined((bodyArray && bodyArray[0]) ? bodyArray[0].url_web_link : undefined,\n                               bodyData?.url_web_link);\nconst url_web_link = toNull(urlWebRaw);\n\nconst actionInRaw = firstDefined(action,\n                                 (bodyArray && bodyArray[0]) ? bodyArray[0].action : undefined,\n                                 bodyData?.action);\nconst actionIn = toNull(actionInRaw);\n\nconst tsRaw = firstDefined((bodyArray && bodyArray[0]) ? bodyArray[0].timestamp : undefined,\n                           bodyData?.timestamp);\nconst timestamp = toNull(tsRaw);\n\n/* ===================== Payload akhir ===================== */\nconst payload = {\n  jenis_surat   : toNull(md?.jenis_surat),\n  nomor_surat   : toNull(md?.nomor_surat),\n  tanggal_surat : toNull(md?.tanggal_surat),\n\n  pemohon: {\n    nama             : toNull(pemohonRaw?.nama),\n    nik              : toNull(pemohonRaw?.nik),\n    ttl              : toNull(pemohonRaw?.ttl),\n    agama            : toNull(pemohonRaw?.agama),\n    jenis_kelamin    : toNull(pemohonRaw?.jenis_kelamin),\n    status_perkawinan: toNull(pemohonRaw?.status_perkawinan),\n    pekerjaan        : toNull(pemohonRaw?.pekerjaan),\n    alamat           : toNull(pemohonRaw?.alamat),\n    kelurahan, kecamatan,\n    kota_kab         : kotaKab,\n    provinsi,\n    domisili,\n  },\n\n  dokumen, // sudah difilter\n\n  penandatangan: {\n    nama   : toNull(md?.penandatangan?.nama),\n    nip    : toNull(md?.penandatangan?.nip),\n    jabatan: toNull(md?.penandatangan?.jabatan),\n  },\n\n  operator                 : toNull(md?.operator),\n  ref                      : toNull(md?.ref),\n  WAHA_Trigger_session     : toNull(md?.WAHA_Trigger_session),\n  WAHA_Trigger_payload_from: toNull(md?.WAHA_Trigger_payload_from),\n  LogoURL                  : toNull(md?.LogoURL),\n\n  URL_CREATE     : toNull(md?.URL_CREATE),\n  URL_UPDATE     : toNull(md?.URL_UPDATE),\n  URL_DELETE     : toNull(md?.URL_DELETE),\n  URL_UPLOAD     : toNull(md?.URL_UPLOAD),\n  URL_DELETE_FILE: toNull(md?.URL_DELETE_FILE),\n\n  // Metadata\n  id_user,\n  url_web_link,\n  action    : actionIn,\n  timestamp,\n\n  // Audit\n  files_info: Array.isArray(filesInfo) ? filesInfo : [],\n\n  // daftar id file untuk dihapus fisik\n  delete_file_ids: deleteIds,\n};\n\n// console.log({ id_user, actionIn, deleteIds, dokumen_len: dokumen.length });\nreturn [{ json: payload }];\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -660,
          1420
        ],
        "id": "23ba8db9-8ffe-4b8b-b491-1955b74b6407",
        "name": "Code5"
      },
      {
        "parameters": {
          "operation": "toJson",
          "options": {
            "fileName": "={{ DateTime.now().setZone('Asia/Tokyo').setLocale('id').toFormat('dd_MM_yyyy_HH_mm_ss') + '_' + ($json.pemohon.nama).trim().replace(/\\s+/g,'-').toUpperCase() + '_' + ($json.pemohon.nik) }}\n"
          }
        },
        "type": "n8n-nodes-base.convertToFile",
        "typeVersion": 1.1,
        "position": [
          -440,
          1420
        ],
        "id": "e16deb67-f7e9-4a88-b070-78cb8fd492c7",
        "name": "Convert to File5"
      },
      {
        "parameters": {
          "operation": "update",
          "fileId": {
            "__rl": true,
            "value": "={{ $('Code5').item.json.id_user }}",
            "mode": "id"
          },
          "changeFileContent": true,
          "options": {}
        },
        "type": "n8n-nodes-base.googleDrive",
        "typeVersion": 3,
        "position": [
          -220,
          1420
        ],
        "id": "d83288ef-011c-41a0-b955-0486474c0385",
        "name": "Update file4",
        "credentials": {
          "googleDriveOAuth2Api": {
            "id": "jyiiyKxh6DOyPVt5",
            "name": "Google Drive account"
          }
        }
      },
      {
        "parameters": {
          "method": "DELETE",
          "url": "=https://www.googleapis.com/drive/v3/files/{{ $('Delete file').item.json.body.delete_file_ids[0] }}?supportsAllDrives=true",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "googleOAuth2Api",
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          220,
          1420
        ],
        "id": "3549c92b-9f7d-4133-9ef5-995d1d0c460e",
        "name": "Delete File",
        "credentials": {
          "googleOAuth2Api": {
            "id": "L31Mzf4p7TJyr4bB",
            "name": "Google account"
          }
        }
      },
      {
        "parameters": {
          "httpMethod": "POST",
          "path": "737cd7f5-bfa1-4b9c-b55a-21aa718bfc3d",
          "options": {}
        },
        "type": "n8n-nodes-base.webhook",
        "typeVersion": 2,
        "position": [
          -880,
          3320
        ],
        "id": "0592378a-2658-4698-9d8a-6e4983f97d68",
        "name": "Kirim data",
        "webhookId": "737cd7f5-bfa1-4b9c-b55a-21aa718bfc3d"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 2
            },
            "conditions": [
              {
                "id": "6f618e27-f826-40e5-b7bd-00023db65711",
                "leftValue": "={{ $('Code5').item.json.delete_file_ids[0] }}",
                "rightValue": "",
                "operator": {
                  "type": "string",
                  "operation": "notEmpty",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.2,
        "position": [
          0,
          1420
        ],
        "id": "f81386e7-0904-40c5-a071-91698f5389f2",
        "name": "If"
      },
      {
        "parameters": {
          "httpMethod": "POST",
          "path": "e1863045-3bfd-497d-b8a3-fc2c7c23eaa7",
          "options": {}
        },
        "type": "n8n-nodes-base.webhook",
        "typeVersion": 2,
        "position": [
          -880,
          1420
        ],
        "id": "adba6025-0e13-43e4-b62a-c8986c688497",
        "name": "Delete file",
        "webhookId": "e1863045-3bfd-497d-b8a3-fc2c7c23eaa7"
      },
      {
        "parameters": {
          "httpMethod": "POST",
          "path": "d240d7b5-7395-4a13-9b1c-ebd4d6fe4589",
          "options": {}
        },
        "type": "n8n-nodes-base.webhook",
        "typeVersion": 2,
        "position": [
          -880,
          2860
        ],
        "id": "32f53b52-742b-471d-959d-4627bb194ba0",
        "name": "Hapus Surat",
        "webhookId": "d240d7b5-7395-4a13-9b1c-ebd4d6fe4589"
      },
      {
        "parameters": {
          "jsCode": "// Input: item tunggal dari Webhook\nconst body = $json.body || {};\nconst data = body.data || {};\n\n// ==== helper: ambil segmen terakhir dari URL / path / string biasa ====\nfunction tailId(v){\n  if (typeof v !== 'string') return '';\n  const s = v.trim();\n  if (!s) return '';\n  try {\n    const u = new URL(s);                      // jika URL valid\n    const parts = u.pathname.split('/').filter(Boolean);\n    return parts.length ? parts[parts.length - 1] : s;\n  } catch {\n    // jika bukan URL valid, fallback: split '/' biasa\n    const parts = s.split('/').filter(Boolean);\n    return parts.length ? parts[parts.length - 1] : s;\n  }\n}\n\n// 1) id_user\nconst idUser = (data.id_user || body.id_user || '').trim();\n\n// 2) id_surat ‚Üí ambil ID belakang link\nconst idSuratRaw = data.id_surat || body.id_surat || '';\nconst idSurat    = tailId(idSuratRaw);\n\n// 3) file_id dari dokumen\nconst fromDocs = Array.isArray(data.dokumen)\n  ? data.dokumen.map(d => d?.file_id)\n  : [];\n\n// 4) delete_file_ids (jika ada)\nconst explicit = Array.isArray(data.delete_file_ids)\n  ? data.delete_file_ids\n  : [];\n\n// 5) gabungkan semua sumber + bersihkan\nconst allIds = []\n  .concat(idUser, idSurat, explicit, fromDocs)\n  .filter(x => typeof x === 'string' && x.trim().length > 0);\n\n// 6) unik\nconst uniq = [...new Set(allIds.map(x => x.trim()))];\n\n// 7) keluarkan sebagai array items n8n\nreturn uniq.map(id => ({ json: { fileId: id } }));\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -660,
          2860
        ],
        "id": "bdc007f6-f622-4899-8355-2f52da372198",
        "name": "Code4"
      },
      {
        "parameters": {
          "method": "DELETE",
          "url": "=https://www.googleapis.com/drive/v3/files/{{ $json.fileId }}\n?supportsAllDrives=true",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "googleOAuth2Api",
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          -440,
          2860
        ],
        "id": "6f3d5925-2739-4f65-bd9a-421cd3dd0d66",
        "name": "Hapus Semua",
        "credentials": {
          "googleOAuth2Api": {
            "id": "L31Mzf4p7TJyr4bB",
            "name": "Google account"
          }
        }
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://n8n-qz8tp6856ibc.bgxy.sumopod.my.id/webhook/5af2b097-ff31-46e8-86d8-1dcb4800c60b",
          "sendQuery": true,
          "queryParameters": {
            "parameters": [
              {
                "name": "name_file",
                "value": "={{ (Date.now().toString(36) + Math.random().toString(36).slice(2,6)).toUpperCase() }}\n"
              },
              {
                "name": "session_waha",
                "value": "KaweNia"
              },
              {
                "name": "id_waha",
                "value": "=6285230047347@c.us"
              },
              {
                "name": "Nama",
                "value": "={{ $('Merge2').item.json.data[0].pemohon.nama }}"
              },
              {
                "name": "NIK",
                "value": "={{ $('Merge2').item.json.data[0].pemohon.nik }}"
              }
            ]
          },
          "sendBody": true,
          "contentType": "raw",
          "rawContentType": "=text/html; charset=utf-8",
          "body": "={{ $json.html }}",
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          1540,
          3320
        ],
        "id": "45ac577e-fc6f-417a-8c54-6fca5b4a8e93",
        "name": "HTTP Request1"
      },
      {
        "parameters": {
          "jsCode": "/**\n * Generate Payload Surat ‚Äî TANPA menyertakan isi dokumen\n * + Tambah id_surat (ekstrak segmen terakhir bila berupa URL)\n * Mode   : Run Once for All Items\n * Input  : 1 item Webhook (seluruh field ada di body)\n * Output : 1 item { json: payload } ‚Äî tanpa property \"dokumen\"\n */\n\n/* ===================== Utils ===================== */\nconst clean = (s) => (s ?? '').toString().normalize('NFKC').trim();\nconst lower = (s) => clean(s).toLowerCase();\nconst ensure = (x, f='-') => { const v = clean(x); return v ? v : f; };\n\nconst toNull = (x) => {\n  if (x === undefined || x === null) return null;\n  const v = (typeof x === 'string') ? x.trim() : x;\n  if (v === '' || v === 'undefined' || v === 'null') return null;\n  return v;\n};\n\nconst safeParseJSON = (maybeJSON) => {\n  try {\n    if (typeof maybeJSON === 'string') return JSON.parse(maybeJSON);\n    if (typeof maybeJSON === 'object' && maybeJSON !== null) return maybeJSON;\n  } catch {}\n  return {};\n};\n\nconst tryParse = (x) => {\n  if (typeof x === 'string') {\n    let s = x;\n    if (/%[0-9A-Fa-f]{2}/.test(x) && (x.includes('%7B') || x.includes('%5B'))) {\n      try { s = decodeURIComponent(x); } catch {}\n    }\n    let obj = safeParseJSON(s);\n    if (typeof obj === 'string') obj = safeParseJSON(obj); // double-stringified\n    return obj;\n  }\n  return safeParseJSON(x);\n};\n\nconst uniqArray = (arr) => Array.from(new Set((arr || []).filter(Boolean)));\nconst firstDefined = (...args) => args.find(v => v !== undefined && v !== null);\nconst hasKeys = (o) => o && typeof o === 'object' && Object.keys(o).length > 0;\n\n/* Ambil segmen terakhir dari URL/path/string biasa */\nconst tailId = (v) => {\n  const s = toNull(v);\n  if (!s) return null;\n  try {\n    const u = new URL(s);\n    const parts = u.pathname.split('/').filter(Boolean);\n    return parts.length ? parts[parts.length - 1] : s;\n  } catch {\n    const parts = s.split('/').filter(Boolean);\n    return parts.length ? parts[parts.length - 1] : s;\n  }\n};\n\n/* ===================== Ambil wrapper (body) ===================== */\nconst firstItem = items[0]?.json ?? {};\nconst root      = (firstItem && typeof firstItem.body === 'object' && firstItem.body !== null)\n  ? firstItem.body\n  : firstItem;\n\n/* ===================== Compat: struktur lama (data/mandatory_data) vs baru (langsung di body) ===================== */\nconst rawData   = root.data ?? null;                 // bisa null\nlet   bodyData  = tryParse(rawData);\nif (!hasKeys(bodyData)) bodyData = {};               // objek kosong jika tak ada\n\n// Kandidat ‚Äúmaster data‚Äù (md): prioritas data.mandatory_data ‚Üí data ‚Üí body (root)\nlet md = null;\nif (hasKeys(bodyData?.mandatory_data)) md = bodyData.mandatory_data;\nelse if (hasKeys(bodyData))            md = bodyData;\nelse                                    md = root;  // fallback\n\n/* ===================== Action, Delete IDs, files_info ===================== */\nconst wrapperAction = root.action ?? null;\nconst wrapperIdUser = root.id_user ?? null;\n\nconst deleteIds = uniqArray([\n  ...(Array.isArray(root.delete_file_ids) ? root.delete_file_ids : []),\n  ...(Array.isArray(bodyData.delete_file_ids) ? bodyData.delete_file_ids : []),\n]);\n\nlet filesInfo = [];\nif (Array.isArray(bodyData.files_info)) filesInfo = bodyData.files_info;\nelse if (Array.isArray(md.files_info))  filesInfo = md.files_info;\nelse if (Array.isArray(root.files_info)) filesInfo = root.files_info;\n\n/* ===================== Normalisasi bidang teks ===================== */\nconst pemohonRaw = hasKeys(md?.pemohon) ? md.pemohon\n                 : hasKeys(root?.pemohon) ? root.pemohon\n                 : {};\nconst kelurahan  = ensure(toNull(pemohonRaw.kelurahan));\nconst kecamatan  = ensure(toNull(pemohonRaw.kecamatan));\nconst kotaKab    = ensure(toNull(pemohonRaw.kota_kab ?? pemohonRaw.kabupaten));\nconst provinsi   = ensure(toNull(pemohonRaw.provinsi));\n\nlet domisili = toNull(pemohonRaw.domisili);\nif (!domisili) domisili = `${kelurahan}, ${kecamatan}, ${kotaKab}, ${provinsi}`;\n\n/* ===================== Metadata umum ===================== */\nconst id_user      = toNull(firstDefined(wrapperIdUser, bodyData?.id_user, md?.id_user, root?.id_user));\nconst url_web_link = toNull(firstDefined(bodyData?.url_web_link, md?.url_web_link, root?.url_web_link));\nconst timestamp    = toNull(firstDefined(bodyData?.timestamp, md?.timestamp, root?.timestamp));\nconst actionIn     = toNull(firstDefined(wrapperAction, bodyData?.action, md?.action));\n\n/* ====== NEW: id_surat_raw & id_surat (tail) ====== */\nconst id_surat_raw = toNull(firstDefined(root?.id_surat, md?.id_surat, url_web_link));\nconst id_surat     = tailId(id_surat_raw);\n\n/* ===================== Payload akhir (TANPA dokumen) ===================== */\nconst payload = {\n  // Header surat\n  jenis_surat  : toNull(firstDefined(md?.jenis_surat,  root?.jenis_surat)),\n  nomor_surat  : toNull(firstDefined(md?.nomor_surat,  root?.nomor_surat)),\n  tanggal_surat: toNull(firstDefined(md?.tanggal_surat,root?.tanggal_surat)),\n\n  // Pemohon\n  pemohon: {\n    nama             : toNull(pemohonRaw?.nama),\n    nik              : toNull(pemohonRaw?.nik),\n    ttl              : toNull(pemohonRaw?.ttl),\n    agama            : toNull(pemohonRaw?.agama),\n    jenis_kelamin    : toNull(pemohonRaw?.jenis_kelamin),\n    status_perkawinan: toNull(pemohonRaw?.status_perkawinan),\n    pekerjaan        : toNull(pemohonRaw?.pekerjaan),\n    alamat           : toNull(pemohonRaw?.alamat),\n    kelurahan, kecamatan,\n    kota_kab         : kotaKab,\n    provinsi,\n    domisili,\n  },\n\n  // Penandatangan\n  penandatangan: {\n    nama   : toNull(firstDefined(md?.penandatangan?.nama,   root?.penandatangan?.nama)),\n    nip    : toNull(firstDefined(md?.penandatangan?.nip,    root?.penandatangan?.nip)),\n    jabatan: toNull(firstDefined(md?.penandatangan?.jabatan,root?.penandatangan?.jabatan)),\n  },\n\n  // Lain-lain\n  operator                 : toNull(firstDefined(md?.operator,  root?.operator)),\n  ref                      : toNull(firstDefined(md?.ref,       root?.ref)),\n  WAHA_Trigger_session     : toNull(firstDefined(md?.WAHA_Trigger_session,      root?.WAHA_Trigger_session)),\n  WAHA_Trigger_payload_from: toNull(firstDefined(md?.WAHA_Trigger_payload_from,  root?.WAHA_Trigger_payload_from)),\n  LogoURL                  : toNull(firstDefined(md?.LogoURL,   root?.LogoURL)),\n\n  // Endpoints\n  URL_CREATE     : toNull(firstDefined(md?.URL_CREATE,     root?.URL_CREATE)),\n  URL_UPDATE     : toNull(firstDefined(md?.URL_UPDATE,     root?.URL_UPDATE)),\n  URL_DELETE     : toNull(firstDefined(md?.URL_DELETE,     root?.URL_DELETE)),\n  URL_UPLOAD     : toNull(firstDefined(md?.URL_UPLOAD,     root?.URL_UPLOAD)),\n  URL_DELETE_FILE: toNull(firstDefined(md?.URL_DELETE_FILE,root?.URL_DELETE_FILE)),\n\n  // Metadata\n  id_user,\n  id_surat_raw,   // jejak asli (bisa URL atau ID)\n  id_surat,       // hasil ekstraksi (segmen terakhir)\n  url_web_link,\n  action    : actionIn,\n  timestamp,\n\n  // Audit (opsional disertakan)\n  files_info: Array.isArray(filesInfo) ? filesInfo : [],\n\n  // daftar id file untuk dihapus fisik (tanpa mengirim detail dokumen)\n  delete_file_ids: deleteIds,\n};\n\n// Tidak ada property \"dokumen\" di payload\nreturn [{ json: payload }];\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          0,
          3120
        ],
        "id": "d4de84b5-3fd6-4909-8b7f-ee9c103f725f",
        "name": "Code6"
      },
      {
        "parameters": {
          "operation": "toJson",
          "options": {
            "fileName": "={{ \n  DateTime.now()\n    .setZone('Asia/Tokyo')\n    .setLocale('id')\n    .toFormat('dd_MM_yyyy_HH_mm_ss')\n    + '_' \n    + ($json.pemohon.nama || '')\n        .trim()\n        .replace(/\\s+/g, '-')\n        .toUpperCase() \n    + '_' \n    + ($json.pemohon.nik || '') \n}}\n"
          }
        },
        "type": "n8n-nodes-base.convertToFile",
        "typeVersion": 1.1,
        "position": [
          660,
          3320
        ],
        "id": "e1f572f5-1ec9-4a2f-9d95-66bdd9c0ced5",
        "name": "Convert to File2"
      },
      {
        "parameters": {
          "driveId": {
            "__rl": true,
            "mode": "list",
            "value": "My Drive"
          },
          "folderId": {
            "__rl": true,
            "value": "1ufqBzk2QQ6MYnMU2cSzG3mqoab-JCP_Z",
            "mode": "list",
            "cachedResultName": "Create Surat Keterangan Tidak Mampu",
            "cachedResultUrl": "https://drive.google.com/drive/folders/1ufqBzk2QQ6MYnMU2cSzG3mqoab-JCP_Z"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleDrive",
        "typeVersion": 3,
        "position": [
          880,
          3420
        ],
        "id": "e958ba62-d329-4223-90ff-d27350e0bcd4",
        "name": "Upload file3",
        "credentials": {
          "googleDriveOAuth2Api": {
            "id": "jyiiyKxh6DOyPVt5",
            "name": "Google Drive account"
          }
        }
      },
      {
        "parameters": {
          "operation": "fromJson",
          "options": {}
        },
        "type": "n8n-nodes-base.extractFromFile",
        "typeVersion": 1,
        "position": [
          880,
          3220
        ],
        "id": "c216a56c-9a66-472e-86ff-6af9ddb1b937",
        "name": "Extract from File2"
      },
      {
        "parameters": {
          "mode": "combine",
          "combineBy": "combineAll",
          "options": {}
        },
        "type": "n8n-nodes-base.merge",
        "typeVersion": 3.2,
        "position": [
          1100,
          3320
        ],
        "id": "bfd8ab80-17ec-423a-b9da-2f7f5a12213a",
        "name": "Merge2"
      },
      {
        "parameters": {
          "html": "<!doctype html>\n<html lang=\"id\">\n<head>\n  <meta charset=\"utf-8\" />\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\n  <title>Kawe Nia ‚Ä¢ Layanan SKTM</title>\n  <style>\n    :root{\n      --bg:#0b1020; --panel:#0f172a; --ink:#e5e7eb; --muted:#9ca3af;\n      --accent:#22c55e; --accent-2:#38bdf8; --line:#1f2937;\n      --danger:#ef4444; --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.35);\n      --space:clamp(14px,2.4vw,22px);\n      --modal-radius:10px;\n      --modal-bg:#111827;\n      --modal-border:rgba(148,163,184,.45);\n      --overlay:rgba(0,0,0,.72);\n    }\n    *{box-sizing:border-box} html,body{height:100%}\n    body{\n      margin:0; color:var(--ink);\n      font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial,\"Apple Color Emoji\",\"Segoe UI Emoji\";\n      background:#0a0e1a; min-height:100svh;\n    }\n    .bg{position:fixed; inset:0; z-index:-1; pointer-events:none;\n      background:\n        radial-gradient(1400px 800px at 20% -10%, #16223f 0%, transparent 60%),\n        radial-gradient(1200px 700px at 90% -20%, rgba(56,189,248,.15) 0%, transparent 60%),\n        linear-gradient(145deg,#0a0e1a,#0f1933 55%,#0a0e1a);\n      background-attachment:fixed,fixed,fixed;}\n    body,body *{min-width:0; overflow-wrap:anywhere; word-break:break-word; white-space:normal}\n    .wrap{max-width:1100px;margin:40px auto;padding:0 20px}\n    .topbar{display:flex;align-items:center;gap:16px;margin-bottom:18px}\n    .brand{display:flex;align-items:center;gap:12px;min-width:0}\n    .brand img.logo{\n      width:120px; aspect-ratio:1/1; object-fit:contain; background:#0f172a; border-radius:12px; display:block;\n      box-shadow: inset 0 0 0 1px rgba(148,163,184,.35), 0 0 6px rgba(0,0,0,.35);\n    }\n    .brand .title{font-weight:700;font-size:clamp(16px,2.4vw,20px)}\n    .brand .sub{font-size:12px;color:var(--muted)}\n    .pill{margin-left:auto;display:flex;gap:8px;align-items:center;font-size:12px;color:#cbd5e1;\n      background:linear-gradient(180deg,rgba(56,189,248,.2),rgba(34,197,94,.15));\n      border:1px solid rgba(148,163,184,.3);padding:6px 10px;border-radius:999px;flex-shrink:0;}\n    .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.02));\n      border:1px solid rgba(148,163,184,.2); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden}\n    .card-header{display:flex;flex-wrap:wrap;gap:14px;align-items:center;justify-content:space-between;\n      padding:clamp(14px,2.2vw,20px) var(--space);\n      background:radial-gradient(800px 300px at 10% -20%, rgba(56,189,248,.15), transparent 60%),\n                 radial-gradient(600px 300px at 90% -30%, rgba(34,197,94,.18), transparent 55%);\n      border-bottom:1px solid rgba(148,163,184,.2)}\n    .hgroup{display:flex;flex-direction:column;gap:8px;min-width:0;margin-bottom:4px}\n    .h1{font-size:clamp(18px,2.8vw,26px);font-weight:800;letter-spacing:.3px;margin-bottom:2px}\n    .h2{font-size:13px;color:var(--muted);margin-top:2px}\n    .badges{display:flex;gap:8px;flex-wrap:wrap;min-width:0;margin-top:6px}\n    .badge{font-size:12px;padding:6px 10px;border-radius:999px;background:#0b1224;border:1px solid rgba(148,163,184,.26)}\n    .badge.info{border-color:rgba(56,189,248,.45);background:rgba(56,189,248,.12);color:#cffafe}\n    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:0;min-height:360px}\n    @media (max-width:960px){.grid{grid-template-columns:1fr}.side{background:transparent}.panel{border-right:none}}\n    .panel{padding:var(--space);border-right:1px solid rgba(148,163,184,.16)} .panel:last-child{border-right:none}\n    .stitle{font-size:13px;letter-spacing:.4px;text-transform:uppercase;color:#a5b4fc;font-weight:700;margin-bottom:10px}\n    .ident{display:grid; grid-template-columns:160px 10px 1fr; gap:6px 10px; align-items:start; font-size:14px;\n      background:rgba(15,23,42,.55); border:1px solid rgba(148,163,184,.15); border-radius:14px; padding:10px 12px}\n    @media (max-width:560px){ .ident{grid-template-columns:110px 8px 1fr} }\n    .lab{color:#cbd5e1} .sep{color:#475569} .val{color:#e5e7eb;font-weight:600;line-height:1.45}\n    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,\"Liberation Mono\",\"Courier New\",monospace}\n    .side{display:flex;flex-direction:column;gap:14px;padding:var(--space);\n      background:linear-gradient(180deg,rgba(2,6,23,.35),rgba(2,6,23,.15))}\n    .callout{border:1px solid rgba(56,189,248,.35);background:rgba(56,189,248,.1);border-radius:14px;padding:12px 14px;font-size:13px;color:#e0f2fe}\n    .actions{display:flex;flex-wrap:wrap;gap:10px}\n    .btn{appearance:none;border:none;cursor:pointer;font-weight:700;letter-spacing:.3px;\n      background:#0b1224;color:var(--ink);padding:10px 14px;border-radius:12px;border:1px solid rgba(148,163,184,.3);\n      display:inline-flex; align-items:center; gap:8px; justify-content:center;}\n    a.btn, a.btn:link, a.btn:visited { text-decoration:none; color:inherit; }\n    a.btn:hover, a.btn:focus { text-decoration:none; }\n    .btn.primary,.btn.success{background:linear-gradient(180deg,rgba(34,197,94,.95),rgba(16,185,129,.95));border-color:rgba(16,185,129,.95);color:#052e1a!important}\n    .btn.secondary{background:linear-gradient(180deg,rgba(56,189,248,.9),rgba(59,130,246,.9));border-color:rgba(96,165,250,.95);color:#06293a!important}\n    .btn.ghost{background:transparent}\n    .btn.danger{background:linear-gradient(180deg,rgba(239,68,68,.95),rgba(220,38,38,.95));border-color:rgba(220,38,38,.95);color:#fef2f2!important}\n    .btn:active{transform:translateY(1px)}\n    .uploaded-files-container{background:rgba(15,23,42,.55);border:1px solid rgba(148,163,184,.15);border-radius:14px;padding:14px;min-height:60px}\n    .no-files-message{color:#9ca3af;font-size:13px;text-align:center;font-style:italic}\n    .uploaded-file-item{display:flex;flex-direction:column;gap:8px;padding:10px 12px;background:rgba(34,197,94,.06);\n      border:1px solid rgba(34,197,94,.25);border-radius:12px;margin-bottom:8px}\n    .file-name{color:#d1fae5;font-weight:700;line-height:1.35}\n    .file-meta{color:#a5b4fc;font-size:12px}\n    .file-actions{display:flex;flex-wrap:wrap;gap:8px;margin-top:4px}\n    .file-actions .btn{padding:6px 10px;border-radius:10px}\n    .note-box{background:rgba(15,23,42,.55);border:1px solid rgba(148,163,184,.15);border-radius:14px;padding:12px 14px}\n    .note-input{width:100%;min-height:110px;resize:vertical;color:#e5e7eb;font-size:14px;line-height:1.6;\n      background:#0e162b;border:1px solid rgba(56,189,248,.35);border-radius:12px;padding:12px 14px;box-shadow:inset 0 0 0 1px rgba(56,189,248,.15)}\n    .note-input::placeholder{color:#94a3b8}\n    .card-footer{display:flex;gap:14px;justify-content:space-between;align-items:center;\n      padding:12px var(--space);border-top:1px solid rgba(148,163,184,.2);color:var(--muted);font-size:12px}\n    .modal-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:1000;background:var(--overlay)}\n    .modal{width:min(480px,92vw);border-radius:var(--modal-radius);background:var(--modal-bg);\n      border:1px solid var(--modal-border);box-shadow:0 18px 50px rgba(0,0,0,.55);padding:18px 18px}\n    .modal-header{display:flex;gap:10px;align-items:center;margin-bottom:8px}\n    .modal-icon{font-size:28px}\n    .modal-title{font-weight:800;font-size:18px;letter-spacing:.3px}\n    .modal-message{color:#cbd5e1;line-height:1.7;margin:8px 0 16px;font-size:14px}\n    .modal-actions{display:flex;gap:10px;justify-content:flex-end}\n    .modal .btn{border-radius:10px;padding:10px 14px}\n    .modal--info{box-shadow:inset 4px 0 0 0 #38bdf8, 0 18px 50px rgba(0,0,0,.55)}\n    .modal--success{box-shadow:inset 4px 0 0 0 #22c55e, 0 18px 50px rgba(0,0,0,.55)}\n    .modal--confirm{box-shadow:inset 4px 0 0 0 #f59e0b, 0 18px 50px rgba(0,0,0,.55)}\n    .modal--danger{box-shadow:inset 4px 0 0 0 #ef4444, 0 18px 50px rgba(0,0,0,.55)}\n    .loading-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:900;background:rgba(2,6,23,.75)}\n    .loading-box{display:flex;flex-direction:column;align-items:center;gap:14px;padding:22px;border-radius:12px;border:1px solid rgba(148,163,184,.35);background:#0f172a}\n    .spinner{width:52px;height:52px;border-radius:50%;border:4px solid rgba(148,163,184,.35);border-top-color:#22c55e;animation:spin 1s linear infinite}\n    @keyframes spin{to{transform:rotate(360deg)}}\n    .loading-text{font-size:14px;color:#e5e7eb}\n    @media print{.side{display:none} body{background:#fff} .card{border:none;box-shadow:none} .pill,.modal-overlay,.loading-overlay{display:none!important}}\n  </style>\n</head>\n<body>\n  <div class=\"bg\" aria-hidden=\"true\"></div>\n\n  <div class=\"wrap\">\n    <div class=\"topbar\">\n      <div class=\"brand\">\n        <img class=\"logo\" id=\"LogoURL\" src=\"\" alt=\"Lambang Kabupaten\">\n        <div>\n          <div class=\"title\">Kawe Nia ‚Ä¢ Pelayanan Masyarakat</div>\n          <div class=\"sub\">Distrik Wania, Kabupaten Mimika</div>\n        </div>\n      </div>\n      <div class=\"pill\">üü¢ Layanan aktif ‚Ä¢ 24/7</div>\n    </div>\n\n    <section class=\"card\" role=\"region\" aria-label=\"Layanan SKTM\">\n      <header class=\"card-header\">\n        <div class=\"hgroup\">\n          <div class=\"h1\" id=\"jenis_surat\"></div>\n          <div class=\"h2\">Nomor: <span class=\"mono\" id=\"nomor_surat\"></span></div>\n        </div>\n        <div class=\"badges\"><span class=\"badge info\">Status: Menunggu Tanda Tangan</span></div>\n      </header>\n\n      <div class=\"grid\">\n        <div class=\"panel\">\n          <div class=\"stitle\">Data Pemohon</div>\n          <div class=\"ident\" aria-label=\"Identitas Pemohon\">\n            <div class=\"lab\">Nama</div><div class=\"sep\">:</div><div class=\"val\" id=\"nama\"></div>\n            <div class=\"lab\">NIK</div><div class=\"sep\">:</div><div class=\"val mono\" id=\"nik\"></div>\n            <div class=\"lab\">Tempat/Tgl Lahir</div><div class=\"sep\">:</div><div class=\"val\" id=\"ttl\"></div>\n            <div class=\"lab\">Agama</div><div class=\"sep\">:</div><div class=\"val\" id=\"agama\"></div>\n            <div class=\"lab\">Jenis Kelamin</div><div class=\"sep\">:</div><div class=\"val\" id=\"jenis_kelamin\"></div>\n            <div class=\"lab\">Status Perkawinan</div><div class=\"sep\">:</div><div class=\"val\" id=\"status_perkawinan\"></div>\n            <div class=\"lab\">Pekerjaan</div><div class=\"sep\">:</div><div class=\"val\" id=\"pekerjaan\"></div>\n            <div class=\"lab\">Alamat</div><div class=\"sep\">:</div><div class=\"val\" id=\"alamat\"></div>\n            <div class=\"lab\">Kelurahan</div><div class=\"sep\">:</div><div class=\"val\" id=\"kelurahan\"></div>\n            <div class=\"lab\">Kecamatan</div><div class=\"sep\">:</div><div class=\"val\" id=\"kecamatan\"></div>\n            <div class=\"lab\">Kota/Kabupaten</div><div class=\"sep\">:</div><div class=\"val\" id=\"kota_kab\"></div>\n            <div class=\"lab\">Provinsi</div><div class=\"sep\">:</div><div class=\"val\" id=\"provinsi\"></div>\n          </div>\n\n          <div class=\"stitle\" style=\"margin-top:16px\">File Terupload</div>\n          <div class=\"uploaded-files-container\">\n            <div id=\"uploadedFilesList\"><div class=\"no-files-message\">Belum ada file yang diupload</div></div>\n          </div>\n\n          <div class=\"stitle\" style=\"margin-top:16px\">Keterangan</div>\n          <div class=\"uploaded-files-container\" style=\"margin-bottom:16px;line-height:1.6;font-size:14px\">\n            <div style=\"margin-bottom:8px\">1. Tersebut namanya di atas adalah benar-benar penduduk <strong id=\"keterangan_kelurahan\"></strong>.</div>\n            <div style=\"margin-bottom:8px\">2. Tersebut namanya di atas adalah benar-berstatus ekonomi lemah yang tidak mampu menebus atau membayar biaya pengobatan <strong>BPJS / KIS</strong>.</div>\n            <div style=\"margin-bottom:8px\">3. Mohon surat keterangan ini digunakan sebagaimana mestinya.</div>\n            <div style=\"margin-top:12px;font-style:italic\">Demikian surat keterangan tidak mampu ini kami buat untuk dapat digunakan sebagaimana mestinya.</div>\n          </div>\n\n          <div class=\"stitle\" style=\"margin-top:16px\">Catatan Kepala Distrik</div>\n          <div class=\"note-box\" style=\"margin-bottom:16px\">\n            <textarea id=\"noteText\" class=\"note-input\" placeholder=\"Tulis catatan atau instruksi untuk pemohon (wajib saat Minta Perbaikan / Tolak)‚Ä¶\"></textarea>\n            <div style=\"display:flex;justify-content:flex-end;margin-top:10px\">\n              <button class=\"btn secondary\" onclick=\"sendNote()\">üì® Kirim Pesan</button>\n            </div>\n          </div>\n        </div>\n\n        <aside class=\"side\">\n          <div class=\"stitle\">Tindakan</div>\n          <div class=\"actions\">\n            <button class=\"btn primary\" onclick=\"confirmCreateAndSend()\">‚úÖ Setujui & TTD</button>\n            <button class=\"btn danger\" onclick=\"confirmDeleteAll()\">‚õî Tolak & Hapus</button>\n          </div>\n\n          <div class=\"stitle\" style=\"margin-top:10px\">Ringkasan</div>\n          <div class=\"callout\">\n            <div><b>üë§ Operator:</b> <span id=\"operator\"></span></div>\n            <div><b>üìÖ Tanggal:</b> <span id=\"tanggal_surat\"></span></div>\n            <div><b>üîó Referensi:</b> <span id=\"ref\"></span></div>\n            <div><b>üß≠ From:</b> <span id=\"WAHA_Trigger_payload_from\"></span></div>\n          </div>\n        </aside>\n      </div>\n\n      <footer class=\"card-footer\">\n        <div>¬© <span id=\"tahun\"></span> Pemerintah Distrik Wania ‚Ä¢ Kawe Nia</div>\n      </footer>\n    </section>\n  </div>\n\n  <div class=\"loading-overlay\" id=\"loadingOverlay\" aria-live=\"polite\" aria-busy=\"true\">\n    <div class=\"loading-box\">\n      <div class=\"spinner\" aria-hidden=\"true\"></div>\n      <div class=\"loading-text\" id=\"loadingText\">Memuat data‚Ä¶ Mohon menunggu.</div>\n    </div>\n  </div>\n\n  <div class=\"modal-overlay\" id=\"modalOverlay\" role=\"dialog\" aria-modal=\"true\">\n    <div class=\"modal modal--info\" id=\"modalBox\" role=\"document\">\n      <div class=\"modal-header\">\n        <div class=\"modal-icon\" id=\"modalIcon\">‚ÑπÔ∏è</div>\n        <div class=\"modal-title\" id=\"modalTitle\">Informasi</div>\n      </div>\n      <div class=\"modal-message\" id=\"modalMessage\">Pesan‚Ä¶</div>\n      <div class=\"modal-actions\" id=\"modalActions\"></div>\n    </div>\n  </div>\n\n<script>\n/* ===== Webhook Endpoints ===== */\nconst WEBHOOK_CREATE='https://n8n-qz8tp6856ibc.bgxy.sumopod.my.id/webhook/1e87058d-af1d-4cf2-918e-93e7682dda01';\nconst WEBHOOK_UPDATE='https://n8n-qz8tp6856ibc.bgxy.sumopod.my.id/webhook/e1863045-3bfd-497d-b8a3-fc2c7c23eaa7';\nconst WEBHOOK_UPLOAD='https://n8n-qz8tp6856ibc.bgxy.sumopod.my.id/webhook/1ae8a1a1-9f9d-4792-8505-9c84e1d3654b';\nconst WEBHOOK_DELETE='https://n8n-qz8tp6856ibc.bgxy.sumopod.my.id/webhook/d240d7b5-7395-4a13-9b1c-ebd4d6fe4589';\n/* === Permintaan khusus: const PESAN untuk kirim pesan === */\nconst PESAN='https://n8n-qz8tp6856ibc.bgxy.sumopod.my.id/webhook/646a0ac9-0b1c-4283-ae20-fe42f0ad4384';\n\nconst UPDATE_STRATEGY='OVERWRITE_BIN';\nconst POLL_MS=500;\n\n/* ===== ID & JSON Source ===== */\nconst ID_USER_RAW=\"{{ $json.id }}\";\nfunction resolveIdUser(){\n  if(/\\{\\{\\s*\\$json\\.id\\s*\\}\\}/.test(ID_USER_RAW)){\n    const u=new URL(location.href);\n    const q=u.searchParams.get('id'); if(q) return q.trim();\n    const segs=u.pathname.split('/').filter(Boolean); if(segs.length) return segs[segs.length-1];\n    return \"\";\n  }\n  return (ID_USER_RAW||\"\").trim();\n}\nconst ID_USER=resolveIdUser();\nconst JSON_URL=ID_USER?(\"https://distrikwania.com/data/\"+encodeURIComponent(ID_USER)):\"\";\n\n/* ===== Utils ===== */\nconst $=id=>document.getElementById(id);\nconst toStr=(x,fb='-')=>{const v=(x??'').toString().trim();return v.length?v:fb;}\nconst isJSONResponse=res=>(res.headers.get('content-type')||'').toLowerCase().includes('application/json');\nasync function hashText(txt){const buf=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(txt));return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');}\nfunction pickObj(root){if(!root)return{}; if(Array.isArray(root?.data)&&root.data[0])return root.data[0]; if(Array.isArray(root)&&root[0])return root[0]; return root;}\nfunction humanSize(bytes){if(!bytes&&bytes!==0)return null; const u=['B','KB','MB','GB']; let i=0, n=Number(bytes); while(n>=1024&&i<u.length-1){n/=1024;i++} return (Math.round(n*10)/10)+' '+u[i];}\n\n/* ===== State ===== */\nlet lastJSON=null,lastObj={},lastHash=null;\nlet pollHandle=null, firstLoadDone=false;\n\n/* ===== View Map ===== */\nconst VIEW={\n  logo:$('LogoURL'),jenis_surat:$('jenis_surat'),nomor_surat:$('nomor_surat'),\n  operator:$('operator'),tanggal_surat:$('tanggal_surat'),ref:$('ref'),from:$('WAHA_Trigger_payload_from'),tahun:$('tahun'),\n  nama:$('nama'),nik:$('nik'),ttl:$('ttl'),agama:$('agama'),jenis_kelamin:$('jenis_kelamin'),status_perkawinan:$('status_perkawinan'),\n  pekerjaan:$('pekerjaan'),alamat:$('alamat'),kelurahan:$('kelurahan'),kecamatan:$('kecamatan'),kota_kab:$('kota_kab'),provinsi:$('provinsi'),\n  ket_kel:$('keterangan_kelurahan'),filesList:$('uploadedFilesList')\n};\n\n/* ===== Render ===== */\nfunction renderStatic(){ if(VIEW.tahun) VIEW.tahun.textContent=String(new Date().getFullYear()); }\nfunction normalizeDocs(docs){\n  const arr=Array.isArray(docs)?docs.filter(Boolean):[];\n  const seen=new Set(); const out=[];\n  for(const d of arr){\n    const fid=d?.file_id||d?.id||d?.fileId||null;\n    const hasUrl=!!(d?.view_url||d?.download_url);\n    if(!fid && !hasUrl) continue;\n    const key=fid?`fid:${fid}`:`name:${(d?.name||'').toLowerCase()}|size:${d?.size||0}`;\n    if(seen.has(key)) continue; seen.add(key);\n    out.push({\n      label:d?.label??d?.name??'-',\n      name:d?.name??d?.label??'-',\n      file_id:fid,\n      view_url:d?.view_url??null,\n      download_url:d?.download_url??(d?.view_url??null),\n      size:d?.size??null,\n      mimeType:d?.mimeType??d?.mime??null\n    });\n  }\n  return out;\n}\nfunction renderFiles(obj){\n  const wrap=VIEW.filesList; if(!wrap) return;\n  const docs=normalizeDocs(obj?.dokumen);\n  wrap.innerHTML='';\n  if(!docs.length){\n    const div=document.createElement('div'); div.className='no-files-message'; div.textContent='Belum ada file yang diupload'; wrap.appendChild(div); return;\n  }\n  docs.forEach(d=>{\n    const row=document.createElement('div'); row.className='uploaded-file-item';\n    const nameEl=document.createElement('div'); nameEl.className='file-name'; nameEl.textContent=toStr(d.name,'(tanpa nama)'); row.appendChild(nameEl);\n    const metaParts=[]; if(d.size!=null) metaParts.push('Ukuran: '+humanSize(d.size)); if(d.mimeType) metaParts.push(d.mimeType);\n    const metaEl=document.createElement('div'); metaEl.className='file-meta'; metaEl.textContent=metaParts.join(' ‚Ä¢ ')||'‚Äî'; row.appendChild(metaEl);\n    const act=document.createElement('div'); act.className='file-actions';\n    if(d.view_url){ const a=document.createElement('a'); a.href=d.view_url; a.target='_blank'; a.rel='noopener'; a.textContent='üëÅÔ∏è Lihat'; a.className='btn success'; act.appendChild(a); }\n    if(d.download_url){ const dl=document.createElement('a'); dl.href=d.download_url; dl.setAttribute('download',''); dl.textContent='üì• Unduh'; dl.className='btn secondary'; act.appendChild(dl); }\n    row.appendChild(act);\n    wrap.appendChild(row);\n  });\n}\nfunction renderView(obj){\n  if(VIEW.jenis_surat) VIEW.jenis_surat.textContent=toStr(obj.jenis_surat,'Surat Keterangan Tidak Mampu (SKTM)');\n  if(VIEW.nomor_surat) VIEW.nomor_surat.textContent=toStr(obj.nomor_surat,'‚Äî');\n  if(VIEW.operator) VIEW.operator.textContent=toStr(obj.operator,'‚Äî');\n  if(VIEW.tanggal_surat) VIEW.tanggal_surat.textContent=toStr(obj.tanggal_surat,new Date().toLocaleDateString('id-ID'));\n  if(VIEW.ref) VIEW.ref.textContent=toStr(obj.ref,ID_USER||'‚Äî');\n  if(VIEW.from) VIEW.from.textContent=toStr(obj.WAHA_Trigger_payload_from,'‚Äî');\n  if(VIEW.logo){ const logo=obj.LogoURL||obj.logo_url||''; if(logo) VIEW.logo.src=logo; }\n  const p=obj.pemohon||{};\n  VIEW.nama&&(VIEW.nama.textContent=toStr(p.nama)); VIEW.nik&&(VIEW.nik.textContent=toStr(p.nik));\n  VIEW.ttl&&(VIEW.ttl.textContent=toStr(p.ttl)); VIEW.agama&&(VIEW.agama.textContent=toStr(p.agama));\n  VIEW.jenis_kelamin&&(VIEW.jenis_kelamin.textContent=toStr(p.jenis_kelamin));\n  VIEW.status_perkawinan&&(VIEW.status_perkawinan.textContent=toStr(p.status_perkawinan));\n  VIEW.pekerjaan&&(VIEW.pekerjaan.textContent=toStr(p.pekerjaan));\n  VIEW.alamat&&(VIEW.alamat.textContent=toStr(p.alamat));\n  VIEW.kelurahan&&(VIEW.kelurahan.textContent=toStr(p.kelurahan));\n  VIEW.kecamatan&&(VIEW.kecamatan.textContent=toStr(p.kecamatan));\n  VIEW.kota_kab&&(VIEW.kota_kab.textContent=toStr(p.kota_kab));\n  VIEW.provinsi&&(VIEW.provinsi.textContent=toStr(p.provinsi));\n  VIEW.ket_kel&&(VIEW.ket_kel.textContent=toStr(p.kelurahan));\n  renderFiles(obj);\n}\n\n/* ===== Polling ===== */\nfunction startPolling(){ stopPolling(); pollHandle=setInterval(()=>{ loadOnce(false); }, POLL_MS); }\nfunction stopPolling(){ if(pollHandle){ clearInterval(pollHandle); pollHandle=null; } }\n\n/* ===== Loading ===== */\nconst loadingOverlay=$('loadingOverlay'), loadingText=$('loadingText');\nfunction showLoading(show,text){ if(text) loadingText.textContent=text; loadingOverlay.style.display=show?'flex':'none'; }\n\n/* ===== Modal ===== */\nconst modalOverlay=$('modalOverlay'), modalBox=$('modalBox');\nconst modalIcon=$('modalIcon'), modalTitle=$('modalTitle'), modalMessage=$('modalMessage'), modalActions=$('modalActions');\nfunction showModal({icon='‚ÑπÔ∏è',title='Informasi',message='',buttons=[{label:'Tutup',variant:'secondary',value:true}],variant='info',closable=true}={}){\n  return new Promise(resolve=>{\n    modalIcon.textContent=icon; modalTitle.textContent=title; modalMessage.innerHTML=message; modalActions.innerHTML='';\n    modalBox.className='modal modal--'+variant;\n    buttons.forEach(btn=>{\n      const el=document.createElement('button');\n      el.className='btn '+(btn.primary?'primary':btn.danger?'danger':btn.variant||'secondary');\n      el.textContent=btn.label||'OK';\n      el.onclick=()=>{ hide(); resolve(btn.value); };\n      modalActions.appendChild(el);\n    });\n    function onEsc(e){ if(e.key==='Escape' && closable){ hide(); resolve(null);} }\n    function hide(){ modalOverlay.style.display='none'; document.removeEventListener('keydown',onEsc); }\n    modalOverlay.style.display='flex'; document.addEventListener('keydown',onEsc);\n  });\n}\nfunction infoModal(title,message){ return showModal({icon:'‚ÑπÔ∏è',title,message,variant:'info',buttons:[{label:'Tutup',variant:'secondary',value:true}]}); }\nfunction successModal(title,message){ return showModal({icon:'‚úÖ',title,message,variant:'success',buttons:[{label:'Tutup',variant:'secondary',value:true}]}); }\nfunction confirmModal(title,message,{okLabel='Lanjutkan',cancelLabel='Batal',icon='‚ùì',danger=false}={}){\n  return showModal({icon,title,message,variant:'confirm',buttons:[{label:cancelLabel,variant:'secondary',value:false},{label:okLabel,primary:!danger,danger, value:true}]});\n}\n\n/* ===== Load JSON ===== */\nasync function loadOnce(showLoader=true){\n  try{\n    if(!JSON_URL){ console.warn('ID_USER kosong.'); return; }\n    if(showLoader && !firstLoadDone) showLoading(true,'Memuat data‚Ä¶ Mohon menunggu.');\n    const res=await fetch(JSON_URL+'?t='+Date.now(),{cache:'no-store'});\n    const text=await res.text();\n    if(!res.ok) throw new Error('HTTP '+res.status+' ‚Äî '+text.slice(0,200));\n    let data; try{data=JSON.parse(text);}catch(err){ if(!isJSONResponse(res)) throw new Error('Respon bukan JSON'); throw err; }\n    const h=await hashText(JSON.stringify(data));\n    if(h!==lastHash){lastHash=h; lastJSON=data; lastObj=pickObj(data)||{}; renderView(lastObj);}\n    if(!firstLoadDone){firstLoadDone=true; showLoading(false);}\n  }catch(e){\n    console.error('Load error:',e.message);\n    if(!firstLoadDone){\n      showLoading(false);\n      await showModal({icon:'‚ö†Ô∏è',title:'Gagal Memuat Data',message:'Sistem tidak dapat memuat data awal.<br><span class=\"mono\">'+(e.message||e)+'</span><br>Periksa koneksi dan sumber data, lalu muat ulang halaman.',variant:'danger',buttons:[{label:'Tutup',variant:'secondary',value:true}]});\n    }\n  }\n}\nfunction startRealtime(){renderStatic();loadOnce(true);startPolling();}\n\n/* ===== Create / Delete Surat ===== */\nasync function confirmCreateAndSend(){\n  const ok = await confirmModal(\n    'Konfirmasi Tanda Tangan',\n    'Apakah Anda yakin ingin <b>MENYETUJUI dan MENANDATANGANI</b> surat ini?<br><br>Pastikan seluruh data pemohon telah diverifikasi dan benar sebelum melanjutkan.',\n    { okLabel:'Ya, Setujui & TTD', cancelLabel:'Batal', icon:'üñäÔ∏è' }\n  );\n  if(!ok) return; \n  await generateAndSendLetter();\n}\nasync function generateAndSendLetter(){\n  try{\n    showLoading(true,'Memproses pembuatan surat dan pengiriman untuk tanda tangan‚Ä¶');\n    const resp=await fetch(WEBHOOK_CREATE,{\n      method:'POST',\n      headers:{'Content-Type':'application/json'},\n      body:JSON.stringify({...lastObj,id_user:ID_USER,id_surat:(new URL(location.href)).href})\n    });\n    const text=await resp.text(); \n    if(!resp.ok){throw new Error('HTTP '+resp.status+' ‚Äî '+text.slice(0,200));}\n    await successModal('Berhasil Diproses','Surat berhasil dibuat dan diteruskan untuk penandatanganan Kepala Distrik.');\n  }catch(e){\n    await showModal({\n      icon:'‚ö†Ô∏è',\n      title:'Gagal Memproses Surat',\n      message:'Terjadi kendala saat membuat/ mengirim surat untuk tanda tangan.<br><span class=\"mono\">'+(e.message||e)+'</span>',\n      variant:'danger',\n      buttons:[{label:'Tutup',variant:'secondary',value:true}]\n    });\n  }finally{ showLoading(false); }\n}\n\nasync function confirmDeleteAll(){\n  const ok = await showModal({\n    icon:'‚õî',\n    title:'Konfirmasi Penolakan Surat',\n    message:'Apakah Anda yakin ingin <b>MENOLAK dan MENGHAPUS</b> surat ini beserta seluruh data terkait?<br><br><b>Catatan:</b> Tindakan ini bersifat permanen dan tidak dapat dibatalkan.',\n    variant:'confirm',\n    buttons:[\n      {label:'Batal', variant:'secondary', value:false},\n      {label:'Ya, Tolak & Hapus', danger:true, value:true}\n    ]\n  });\n  if(!ok) return; \n  await deleteLetterAndData();\n}\nasync function deleteLetterAndData(){\n  try{\n    showLoading(true,'Menghapus surat dan seluruh data terkait‚Ä¶');\n    const resp=await fetch(WEBHOOK_DELETE,{\n      method:'POST',\n      headers:{'Content-Type':'application/json'},\n      body:JSON.stringify({\n        action:'DELETE_ALL',\n        id_user:ID_USER,\n        id_surat:(new URL(location.href)).href,\n        data:{...lastObj,id_user:ID_USER,id_surat:(new URL(location.href)).href}\n      })\n    });\n    const text=await resp.text(); \n    if(!resp.ok){throw new Error('HTTP '+resp.status+' ‚Äî '+text.slice(0,200));}\n    await successModal('Penghapusan Berhasil','Surat dan seluruh data terkait telah dihapus dari sistem.');\n    location.reload();\n  }catch(e){\n    await showModal({\n      icon:'‚ö†Ô∏è',\n      title:'Gagal Menghapus',\n      message:'Terjadi kendala saat menghapus surat atau data.<br><span class=\"mono\">'+(e.message||e)+'</span>',\n      variant:'danger',\n      buttons:[{label:'Tutup',variant:'secondary',value:true}]\n    }).then(()=>location.reload());\n  }finally{ showLoading(false); }\n}\n\n/* ===== Kirim Catatan / Pesan ===== */\nasync function sendNote(){\n  try{\n    const textNote=( $('noteText').value || '' ).trim();\n    if(!textNote) return infoModal('Catatan Kosong','Silakan tulis catatan terlebih dahulu.');\n\n    const ok = await confirmModal(\n      'Kirim Pesan kepada Pemohon',\n      'Pesan berikut akan dikirim:<br><br><i>\"'+textNote.replace(/</g,'&lt;').replace(/>/g,'&gt;')+'\"</i>',\n      { okLabel:'Kirim Sekarang', cancelLabel:'Batal', icon:'‚úâÔ∏è' }\n    );\n    if(!ok) return;\n\n    showLoading(true,'Mengirim pesan‚Ä¶');\n\n    const payload={\n      id_user: ID_USER,\n      id_surat: (new URL(location.href)).href,\n      message: textNote,\n      json: lastObj || {},\n      data: lastObj || {},\n      meta: { ref: lastObj?.ref || ID_USER, operator: lastObj?.operator || null, at: new Date().toISOString() }\n    };\n\n    const resp=await fetch(PESAN,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});\n    const bodyText=await resp.text();\n    if(!resp.ok){ throw new Error('HTTP '+resp.status+' ‚Äî '+bodyText.slice(0,200)); }\n\n    $('noteText').value='';\n    await successModal('Pesan Terkirim','Catatan/instruksi berhasil dikirim ke sistem.');\n  }catch(e){\n    await showModal({\n      icon:'‚ö†Ô∏è',\n      title:'Gagal Mengirim Pesan',\n      message:'Tidak dapat mengirim pesan.<br><span class=\"mono\">'+(e.message||e)+'</span>',\n      variant:'danger',\n      buttons:[{label:'Tutup',variant:'secondary',value:true}]\n    });\n  }finally{ showLoading(false); }\n}\n\n/* ===== Start ===== */\nwindow.confirmCreateAndSend=confirmCreateAndSend;\nwindow.confirmDeleteAll=confirmDeleteAll;\nwindow.sendNote=sendNote;\ndocument.addEventListener('DOMContentLoaded',startRealtime);\n</script>\n</body>\n</html>\n"
        },
        "type": "n8n-nodes-base.html",
        "typeVersion": 1.2,
        "position": [
          1320,
          3320
        ],
        "id": "c1ee0e91-527e-4e4d-9b65-649168e01e92",
        "name": "HTML"
      },
      {
        "parameters": {
          "name": "={{ $json.query.name_file }}",
          "driveId": {
            "__rl": true,
            "mode": "list",
            "value": "My Drive"
          },
          "folderId": {
            "__rl": true,
            "value": "1ufqBzk2QQ6MYnMU2cSzG3mqoab-JCP_Z",
            "mode": "list",
            "cachedResultName": "Create Surat Keterangan Tidak Mampu",
            "cachedResultUrl": "https://drive.google.com/drive/folders/1ufqBzk2QQ6MYnMU2cSzG3mqoab-JCP_Z"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleDrive",
        "typeVersion": 3,
        "position": [
          -660,
          3780
        ],
        "id": "cd15335e-e05d-43b2-92da-2ccd57410c3b",
        "name": "Upload file4",
        "credentials": {
          "googleDriveOAuth2Api": {
            "id": "jyiiyKxh6DOyPVt5",
            "name": "Google Drive account"
          }
        }
      },
      {
        "parameters": {
          "resource": "Chatting",
          "operation": "Send Text",
          "session": "={{ $('Webhook').item.json.query.session_waha }}",
          "chatId": "=6281396650844@c.us",
          "text": "=Surat Masuk Atas Nama {{ $('Webhook').item.json.query.Nama }}\nNomor KTP {{ $('Webhook').item.json.query.NIK }}\n\nLink Surat\nhttps://distrikwania.com/data/{{ $json.id }}",
          "requestOptions": {}
        },
        "type": "@devlikeapro/n8n-nodes-waha.WAHA",
        "typeVersion": 202502,
        "position": [
          -440,
          3780
        ],
        "id": "14930f5c-889e-43af-b9e5-865032e24a58",
        "name": "Send a text message1",
        "credentials": {
          "wahaApi": {
            "id": "uivlaHVGkUY1vyJT",
            "name": "WAHA account"
          }
        }
      },
      {
        "parameters": {
          "httpMethod": "POST",
          "path": "5af2b097-ff31-46e8-86d8-1dcb4800c60b",
          "options": {}
        },
        "type": "n8n-nodes-base.webhook",
        "typeVersion": 2,
        "position": [
          -880,
          3780
        ],
        "id": "5bb7a88a-ff1c-4f3a-ace6-b19bc20465ac",
        "name": "Webhook",
        "webhookId": "5af2b097-ff31-46e8-86d8-1dcb4800c60b"
      },
      {
        "parameters": {
          "jsCode": "// Input: item tunggal dari Webhook\nconst body = Array.isArray($json.body) ? $json.body[0] : $json.body || {};\nconst data = body.data || {};\n\n// ==== Ambil semua file_id dari dokumen ====\nconst dokumen = Array.isArray(body.dokumen) \n  ? body.dokumen\n  : Array.isArray(data.dokumen) \n    ? data.dokumen \n    : [];\n\nconst ids = dokumen\n  .map(d => (d?.file_id || '').trim())\n  .filter(x => x.length > 0);\n\n// ==== Unik (hapus duplikat) ====\nconst uniq = [...new Set(ids)];\n\n// Output array items untuk n8n\nreturn uniq.map(id => ({ json: { fileId: id } }));\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -660,
          3520
        ],
        "id": "83f5fb58-f631-4433-a2d6-a7ce4eebb3f2",
        "name": "Code7"
      },
      {
        "parameters": {
          "operation": "download",
          "fileId": {
            "__rl": true,
            "value": "={{ $json.fileId }}",
            "mode": "id"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleDrive",
        "typeVersion": 3,
        "position": [
          -440,
          3520
        ],
        "id": "8b7be1c0-e001-4a95-9105-c6fcc130b0d3",
        "name": "Download file",
        "credentials": {
          "googleDriveOAuth2Api": {
            "id": "jyiiyKxh6DOyPVt5",
            "name": "Google Drive account"
          }
        }
      },
      {
        "parameters": {
          "inputDataFieldName": "={{ $json.binaryProperty }}",
          "name": "={{ $binary[$json.binaryProperty].fileName }}",
          "driveId": {
            "__rl": true,
            "mode": "list",
            "value": "My Drive"
          },
          "folderId": {
            "__rl": true,
            "value": "1ufqBzk2QQ6MYnMU2cSzG3mqoab-JCP_Z",
            "mode": "list",
            "cachedResultName": "Create Surat Keterangan Tidak Mampu",
            "cachedResultUrl": "https://drive.google.com/drive/folders/1ufqBzk2QQ6MYnMU2cSzG3mqoab-JCP_Z"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleDrive",
        "typeVersion": 3,
        "position": [
          0,
          3520
        ],
        "id": "d8139f75-a11c-4c2c-82b4-621229db0c0a",
        "name": "Upload file5",
        "credentials": {
          "googleDriveOAuth2Api": {
            "id": "jyiiyKxh6DOyPVt5",
            "name": "Google Drive account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// Run Once for All Items\nconst out = [];\nfor (const item of items) {\n  const bin = item.binary || {};\n  const keys = Object.keys(bin);\n  if (keys.length === 0) { out.push(item); continue; }\n  for (const k of keys) {\n    out.push({\n      json: { binaryProperty: k },\n      binary: { [k]: bin[k] },\n    });\n  }\n}\nreturn out;\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -220,
          3520
        ],
        "id": "b97f4c49-7a6c-494c-85c6-794b7a6b5797",
        "name": "Code8"
      },
      {
        "parameters": {
          "jsCode": "/**\n * Generate Payload Surat ‚Äî gabung data form + banyak file Drive (ANTI NULL + SEMUA ID)\n * Mode   : Run Once for All Items\n * Input  : Kumpulan item: (A) hasil Upload (>=1 item), (B) 1 item berisi body.data (string JSON atau object/array)\n * Output : 1 item { json: payload }\n */\n\n/* ===================== Utils ===================== */\nconst has     = (o, k) => Object.prototype.hasOwnProperty.call(o ?? {}, k);\nconst clean   = (s) => (s ?? '').toString().normalize('NFKC').trim();\nconst lower   = (s) => clean(s).toLowerCase();\nconst ensure  = (x, f='') => { const v = clean(x); return v ? v : f; };\n\n/** Normalisasi ‚Üí string kosong jika kosong/undefined/null/\"undefined\"/\"null\" */\nconst toStr = (x) => {\n  if (x === undefined || x === null) return '';\n  const v = (typeof x === 'string') ? x.trim() : x;\n  if (v === '' || v === 'undefined' || v === 'null') return '';\n  return (typeof v === 'string') ? v : JSON.stringify(v);\n};\n\nconst baseName = (name) => lower((name || '').replace(/\\.[^./\\\\]+$/, ''));\n\n// Aman parse JSON (+decodeURIComponent jika terlihat urlencoded)\nconst safeParseJSON = (maybeJSON) => {\n  try {\n    if (typeof maybeJSON === 'string') return JSON.parse(maybeJSON);\n    if (typeof maybeJSON === 'object' && maybeJSON !== null) return maybeJSON;\n  } catch {}\n  return {};\n};\n\nconst tryParse = (x) => {\n  if (typeof x === 'string') {\n    let s = x;\n    if (/%[0-9A-Fa-f]{2}/.test(x) && (x.includes('%7B') || x.includes('%5B'))) {\n      try { s = decodeURIComponent(x); } catch(e) {}\n    }\n    let obj = safeParseJSON(s);\n    if (typeof obj === 'string') obj = safeParseJSON(obj);\n    return obj;\n  }\n  return safeParseJSON(x);\n};\n\n/** Ekstrak id_surat dari URL https://distrikwania.com/data/<ID> */\nconst extractSuratId = (raw) => {\n  const s = toStr(raw);\n  if (!s) return '';\n  // coba pola khusus /data/<ID>\n  const m = s.match(/\\/data\\/([^/?#]+)/i);\n  if (m && m[1]) return m[1].trim();\n  // fallback: ambil segmen terakhir yg non-kosong\n  const segs = s.split('/').filter(Boolean);\n  return (segs.length ? segs[segs.length-1] : '').trim();\n};\n\n/* ===================== Ambil body.data dari salah satu item ===================== */\nlet rawData = null;\nfor (const it of items) {\n  const s = it.json || {};\n  // pola umum dari Webhook ‚Üí body.data\n  if (s && s.body && s.body.data !== undefined) { rawData = s.body.data; break; }\n  if (s && s.data !== undefined)               { rawData = s.data;      break; }\n}\n\nlet bodyData = tryParse(rawData);\nlet bodyArray = null;\n\n// === Fallback baru: cari langsung di items top-level ===\nif (!rawData || typeof bodyData !== 'object' || bodyData === null || Array.isArray(bodyData)) {\n  // Kumpulkan kandidat item yang terlihat seperti ‚Äúkepala surat‚Äù\n  const heads = [];\n  for (const it of items) {\n    const j = it?.json || {};\n    const looksLikeHead =\n      (typeof j === 'object') &&\n      (j !== null) &&\n      (\n        has(j,'jenis_surat') || has(j,'pemohon') || has(j,'id_user') ||\n        has(j,'id_surat') || has(j,'id_surat_raw')\n      );\n    if (looksLikeHead) heads.push(j);\n  }\n\n  if (heads.length === 1) {\n    bodyData = heads[0];\n  } else if (heads.length > 1) {\n    // jika banyak, pilih yang paling lengkap (punya paling banyak kunci penting)\n    const score = (o) => ['jenis_surat','pemohon','id_user','id_surat','id_surat_raw','URL_CREATE','URL_UPDATE'].reduce((n,k)=>n+(has(o,k)?1:0),0);\n    heads.sort((a,b)=>score(b)-score(a));\n    // gabungkan kepala pertama dengan sisanya (non-destructive)\n    const merged = Object.assign({}, heads[0]);\n    for (let i=1;i<heads.length;i++){\n      for (const [k,v] of Object.entries(heads[i])) {\n        if (merged[k] === undefined || merged[k] === null || merged[k] === '' ) merged[k] = v;\n      }\n    }\n    bodyData = merged;\n  } else {\n    // tidak ada kandidat ‚Üí tetap pakai parse hasil awal\n    if (typeof bodyData !== 'object' || bodyData === null) bodyData = {};\n  }\n}\n\n// Jika bodyData berupa array ‚Üí ambil elemen pertamanya sebagai head\nif (Array.isArray(bodyData)) { bodyArray = bodyData; bodyData = bodyData[0] || {}; }\n\n\n/* ===================== Skema baru vs lama ===================== */\nlet mdCandidate = bodyData;\nif (bodyData && typeof bodyData.mandatory_data === 'object' && bodyData.mandatory_data !== null) {\n  mdCandidate = bodyData.mandatory_data;\n}\nif (Array.isArray(mdCandidate)) mdCandidate = mdCandidate[0] || {};\nconst md = (typeof mdCandidate === 'object' && mdCandidate !== null) ? mdCandidate : {};\n\n/* ===================== files_info & delete_file_ids ===================== */\nlet filesInfo = [];\nif (Array.isArray(bodyData.files_info)) filesInfo = bodyData.files_info;\nelse if (Array.isArray(md.files_info)) filesInfo = md.files_info;\nelse if (bodyArray && Array.isArray(bodyArray[0]?.files_info)) filesInfo = bodyArray[0].files_info;\n\nlet deleteFileIds = [];\nif (Array.isArray(bodyData.delete_file_ids)) deleteFileIds = bodyData.delete_file_ids;\nelse if (Array.isArray(md.delete_file_ids)) deleteFileIds = md.delete_file_ids;\nelse if (bodyArray && Array.isArray(bodyArray[0]?.delete_file_ids)) deleteFileIds = bodyArray[0].delete_file_ids;\n\n/* ===================== Kolektor dokumen (dipadankan dg file Drive) ===================== */\nconst map = new Map();\nconst uniq = (base) => { let k = base || 'lampiran'; if (!map.has(k)) return k; let i=2; while(map.has(`${k}_${i}`)) i++; return `${k}_${i}`; };\nconst put  = (key, obj) => map.set(key, Object.assign(map.get(key) || {}, obj));\nconst normKey = (label) => lower(label || 'lampiran').replace(/\\s+/g,'_').replace(/[^a-z0-9_\\-]/g,'');\nconst add = (label, obj={}) => {\n  const key = uniq(normKey(label || 'lampiran'));\n  put(key, {\n    label: key,\n    file_id: '', download_url:'', view_url:'',\n    name:'', mimeType:'', size:'', iconLink:'', thumbnailLink:'', createdTime:'',\n    // ID penting per dokumen:\n    parents: [], permissionIds: [], headRevisionId:'',\n    owners_permissionIds: [], lastModifyingUser_permissionId:'', permissions_ids: [],\n    ...obj,\n  });\n};\n\n// 1) md.dokumen (opsional)\nif (Array.isArray(md.dokumen)) {\n  for (const d of md.dokumen) {\n    add(d?.label ?? d?.name ?? 'lampiran', {\n      file_id     : toStr(d?.file_id),\n      download_url: toStr(d?.download_url),\n      view_url    : toStr(d?.view_url),\n      name        : toStr(d?.name),\n      mimeType    : toStr(d?.mimeType),\n      size        : toStr(d?.size),\n    });\n  }\n}\n\n// 2) seed dari files_info\nfor (const f of (Array.isArray(filesInfo) ? filesInfo : [])) {\n  const key = uniq(baseName(f?.name || 'lampiran'));\n  put(key, {\n    label: key,\n    name : toStr(f?.name),\n    mimeType: toStr(f?.type),\n    size: toStr(f?.size),\n  });\n}\n\n// Helper padanan Drive\nconst findBestSlot = (driveName, driveSizeStr) => {\n  const dBase = baseName(driveName || 'lampiran');\n  // a) cocok nama\n  for (const [k, v] of map.entries()) {\n    if (v.name && baseName(v.name) === dBase) return k;\n  }\n  // b) cocok label\n  for (const [k, v] of map.entries()) {\n    if (v.label && baseName(v.label) === dBase) return k;\n  }\n  // c) cocok size (string ‚Üí number)\n  const driveSize = Number(driveSizeStr);\n  if (Number.isFinite(driveSize)) {\n    for (const [k, v] of map.entries()) {\n      const vs = Number(v.size);\n      if (Number.isFinite(vs)) {\n        const diff = Math.abs(vs - driveSize);\n        if (diff <= 2048) return k;\n      }\n    }\n  }\n  return null;\n};\n\n/* ===================== Kumpulkan SEMUA ID dari semua item Drive ===================== */\nconst ids_all_unique = new Set();\nconst ids_detail = {\n  id_user: '',\n  id_surat_raw: '',\n  id_surat: '',\n  delete_file_ids: [],\n  drive_files: [],  // array objek: {id, parents[], permissionIds[], headRevisionId, owners_permissionIds[], lastModifyingUser_permissionId, permissions_ids[]}\n};\n\n// isi dasar dari bodyData/md\nconst id_user_val      = toStr(bodyData.id_user ?? md.id_user ?? (bodyArray ? bodyArray[0]?.id_user : ''));\nconst id_surat_raw_val = toStr(bodyData.id_surat_raw ?? md.id_surat_raw ?? (bodyArray ? bodyArray[0]?.id_surat_raw : ''));\nlet   id_surat_val     = toStr(bodyData.id_surat ?? md.id_surat ?? (bodyArray ? bodyArray[0]?.id_surat : ''));\n\n// auto-extract id_surat bila masih kosong namun ada URL\nif (!id_surat_val && id_surat_raw_val) id_surat_val = extractSuratId(id_surat_raw_val);\n\n// taruh ke detail + set\nids_detail.id_user      = id_user_val;\nids_detail.id_surat_raw = id_surat_raw_val;\nids_detail.id_surat     = id_surat_val;\nids_detail.delete_file_ids = Array.from(new Set((deleteFileIds||[]).map(toStr).filter(Boolean)));\n\n[id_user_val, id_surat_raw_val, id_surat_val, ...ids_detail.delete_file_ids].forEach(x => x && ids_all_unique.add(x));\n\n/* ===================== Loop semua item: mapping ke dokumen + kumpulkan ID ===================== */\nfor (const it of items) {\n  const s = it.json || {};\n  const isDrive = !!(s.id || s.webViewLink || s.webContentLink || s.name || s.originalFilename || s.mimeType);\n  if (!isDrive) continue;\n\n  const dName = s.name || s.originalFilename || 'lampiran';\n  const dSize = s.size ?? s.quotaBytesUsed ?? '';\n\n  // --- kumpulkan ID drive ---\n  const fileId = toStr(s.id);\n  const parents = Array.isArray(s.parents) ? s.parents.map(toStr).filter(Boolean) : [];\n  const permissionIds = Array.isArray(s.permissionIds) ? s.permissionIds.map(toStr).filter(Boolean) : [];\n  const headRevisionId = toStr(s.headRevisionId);\n  const owners_permissionIds = Array.isArray(s.owners)\n    ? s.owners.map(o => toStr(o?.permissionId)).filter(Boolean)\n    : [];\n  const lastModifyingUser_permissionId = toStr(s.lastModifyingUser?.permissionId);\n  const permissions_ids = Array.isArray(s.permissions)\n    ? s.permissions.map(p => toStr(p?.id)).filter(Boolean)\n    : [];\n\n  // masukkan ke detail\n  ids_detail.drive_files.push({\n    id: fileId,\n    parents,\n    permissionIds,\n    headRevisionId,\n    owners_permissionIds,\n    lastModifyingUser_permissionId,\n    permissions_ids,\n  });\n\n  // add ke set unik\n  [fileId, headRevisionId, lastModifyingUser_permissionId, ...parents, ...permissionIds, ...owners_permissionIds, ...permissions_ids]\n    .forEach(x => x && ids_all_unique.add(x));\n\n  // --- padankan ke entri dokumen ---\n  let slot = findBestSlot(dName, dSize);\n  if (!slot) {\n    const key = uniq(baseName(dName) || 'lampiran');\n    add(key, { name: dName });\n    slot = key;\n  }\n\n  put(slot, {\n    file_id      : fileId,\n    download_url : toStr(s.webContentLink),\n    view_url     : toStr(s.webViewLink),\n    name         : toStr(s.name ?? s.originalFilename ?? dName),\n    mimeType     : toStr(s.mimeType),\n    size         : toStr(dSize),\n    iconLink     : toStr(s.iconLink),\n    thumbnailLink: toStr(s.thumbnailLink),\n    createdTime  : toStr(s.createdTime),\n\n    // sertakan ID penting per dokumen\n    parents,\n    permissionIds,\n    headRevisionId,\n    owners_permissionIds,\n    lastModifyingUser_permissionId,\n    permissions_ids,\n  });\n}\n\nconst dokumen = Array.from(map.values());\n\n/* ===================== Normalisasi bidang teks pemohon ===================== */\nconst pemohonRaw = md?.pemohon ?? {};\nconst kelurahan  = ensure(toStr(pemohonRaw.kelurahan), '');\nconst kecamatan  = ensure(toStr(pemohonRaw.kecamatan), '');\nconst kotaKab    = ensure(toStr(pemohonRaw.kota_kab ?? pemohonRaw.kabupaten), '');\nconst provinsi   = ensure(toStr(pemohonRaw.provinsi), '');\nlet domisili     = toStr(pemohonRaw.domisili);\nif (!domisili) domisili = [kelurahan, kecamatan, kotaKab, provinsi].filter(Boolean).join(', ');\n\n/* ===================== Payload akhir (ANTI NULL) ===================== */\nconst payload = {\n  // header surat\n  jenis_surat   : toStr(md?.jenis_surat),\n  nomor_surat   : toStr(md?.nomor_surat),\n  tanggal_surat : toStr(md?.tanggal_surat),\n\n  // pemohon\n  pemohon: {\n    nama             : toStr(pemohonRaw?.nama),\n    nik              : toStr(pemohonRaw?.nik),\n    ttl              : toStr(pemohonRaw?.ttl),\n    agama            : toStr(pemohonRaw?.agama),\n    jenis_kelamin    : toStr(pemohonRaw?.jenis_kelamin),\n    status_perkawinan: toStr(pemohonRaw?.status_perkawinan),\n    pekerjaan        : toStr(pemohonRaw?.pekerjaan),\n    alamat           : toStr(pemohonRaw?.alamat),\n    kelurahan, kecamatan,\n    kota_kab         : kotaKab,\n    provinsi,\n    domisili,\n  },\n\n  // lampiran (sudah mengandung ID-ID penting tiap file)\n  dokumen,\n\n  // penandatangan\n  penandatangan: {\n    nama   : toStr(md?.penandatangan?.nama),\n    nip    : toStr(md?.penandatangan?.nip),\n    jabatan: toStr(md?.penandatangan?.jabatan),\n  },\n\n  // metadata lain\n  operator                 : toStr(md?.operator),\n  ref                      : toStr(md?.ref),\n  WAHA_Trigger_session     : toStr(md?.WAHA_Trigger_session),\n  WAHA_Trigger_payload_from: toStr(md?.WAHA_Trigger_payload_from),\n  LogoURL                  : toStr(md?.LogoURL),\n\n  URL_CREATE     : toStr(md?.URL_CREATE),\n  URL_UPDATE     : toStr(md?.URL_UPDATE),\n  URL_DELETE     : toStr(md?.URL_DELETE),\n  URL_UPLOAD     : toStr(md?.URL_UPLOAD),\n  URL_DELETE_FILE: toStr(md?.URL_DELETE_FILE),\n\n  // body meta (anti null)\n  id_user      : id_user_val,\n  id_surat_raw : id_surat_raw_val,\n  id_surat     : id_surat_val,\n  url_web_link : toStr((bodyArray ? bodyArray[0]?.url_web_link : bodyData?.url_web_link) ?? bodyData?.url_web_link),\n  action       : toStr((bodyArray ? bodyArray[0]?.action       : bodyData?.action)       ?? bodyData?.action),\n  timestamp    : toStr((bodyArray ? bodyArray[0]?.timestamp    : bodyData?.timestamp)    ?? bodyData?.timestamp),\n\n  // audit mentah (tetap ada walau kosong)\n  files_info       : Array.isArray(filesInfo) ? filesInfo : [],\n  delete_file_ids  : ids_detail.delete_file_ids,\n\n  // sekat ID (semua ID yang ditemukan)\n  ids: {\n    all_unique: Array.from(ids_all_unique),\n    detail   : ids_detail,\n  },\n};\n\n// console.log('PAYLOAD:', payload);\nreturn [{ json: payload }];\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          440,
          3320
        ],
        "id": "10642755-b429-4f14-8670-48938a1de84c",
        "name": "Code9"
      },
      {
        "parameters": {
          "mode": "combine",
          "combineBy": "combineAll",
          "options": {}
        },
        "type": "n8n-nodes-base.merge",
        "typeVersion": 3.2,
        "position": [
          220,
          3320
        ],
        "id": "2d2b7622-2c99-4937-afe2-4e36b052af4e",
        "name": "Merge3"
      },
      {
        "parameters": {
          "content": "## Create Web Warga\n",
          "height": 380,
          "width": 1660
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          -1000,
          80
        ],
        "typeVersion": 1,
        "id": "68b081b0-9c40-485c-a933-36fe26a4fcb1",
        "name": "Sticky Note"
      },
      {
        "parameters": {
          "content": "## Send Link HTML User",
          "height": 240,
          "width": 780
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          -1000,
          480
        ],
        "typeVersion": 1,
        "id": "392383d0-a377-4cea-a241-70bc474cf4c5",
        "name": "Sticky Note1"
      },
      {
        "parameters": {
          "content": "## Button Uploud File HTML User",
          "height": 320,
          "width": 1660
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          -1000,
          740
        ],
        "typeVersion": 1,
        "id": "059183be-6461-43b6-bbb6-2cd0c548e371",
        "name": "Sticky Note2"
      },
      {
        "parameters": {
          "content": "## Button Update Data HTML User",
          "height": 240,
          "width": 1000
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          -1000,
          1080
        ],
        "typeVersion": 1,
        "id": "fbbe050c-dcad-4d10-8df2-223cb41dfdbe",
        "name": "Sticky Note3"
      },
      {
        "parameters": {
          "content": "## Button Delete File HTML User",
          "height": 240,
          "width": 1440
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          -1000,
          1340
        ],
        "typeVersion": 1,
        "id": "0bc9d9ca-3ca1-419b-8b7b-523be7e8419b",
        "name": "Sticky Note4"
      },
      {
        "parameters": {
          "content": "## Button Delete Data & Delete Surat HTML User",
          "height": 240,
          "width": 780
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          -1000,
          2780
        ],
        "typeVersion": 1,
        "id": "4f243d37-d8d8-4cbd-982d-7da791d7405b",
        "name": "Sticky Note5"
      },
      {
        "parameters": {
          "content": "## Send Data & Create Surat & Generate HTML Admin\n",
          "height": 440,
          "width": 2760
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          -1000,
          3240
        ],
        "typeVersion": 1,
        "id": "bb0bfe5b-513e-40ad-be1e-d088cf8affbb",
        "name": "Sticky Note6"
      },
      {
        "parameters": {
          "content": "## Send Link HTML Admin",
          "height": 240,
          "width": 780
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          -1000,
          3700
        ],
        "typeVersion": 1,
        "id": "5b70b175-41d2-473e-b634-cd8a902d01b3",
        "name": "Sticky Note7"
      },
      {
        "parameters": {
          "httpMethod": "POST",
          "path": "646a0ac9-0b1c-4283-ae20-fe42f0ad4384",
          "options": {}
        },
        "type": "n8n-nodes-base.webhook",
        "typeVersion": 2,
        "position": [
          -880,
          4300
        ],
        "id": "e69b7ba3-4ff3-4cc1-a693-fe6d8e773b77",
        "name": "Webhook1",
        "webhookId": "646a0ac9-0b1c-4283-ae20-fe42f0ad4384"
      },
      {
        "parameters": {
          "resource": "Chatting",
          "operation": "Send Text",
          "session": "={{ $json.body.data.WAHA_Trigger_session }}",
          "chatId": "={{ $json.body.data.WAHA_Trigger_payload_from }}",
          "text": "=Pesan Dari Kepala Distrik\n\n{{ $json.body.message }}",
          "requestOptions": {}
        },
        "type": "@devlikeapro/n8n-nodes-waha.WAHA",
        "typeVersion": 202502,
        "position": [
          -660,
          4300
        ],
        "id": "75c3bbb1-7d7f-42cd-b9b7-fd058d0df51a",
        "name": "Send a text message2",
        "credentials": {
          "wahaApi": {
            "id": "uivlaHVGkUY1vyJT",
            "name": "WAHA account"
          }
        }
      },
      {
        "parameters": {
          "httpMethod": "POST",
          "path": "1e87058d-af1d-4cf2-918e-93e7682dda01",
          "options": {}
        },
        "type": "n8n-nodes-base.webhook",
        "typeVersion": 2,
        "position": [
          -880,
          4660
        ],
        "id": "2d83a664-9d56-4bf1-b2b7-b7d5dda3f479",
        "name": "Webhook2",
        "webhookId": "1e87058d-af1d-4cf2-918e-93e7682dda01"
      },
      {
        "parameters": {
          "operation": "update",
          "documentURL": "={{ $json.id }}",
          "actionsUi": {
            "actionFields": [
              {
                "action": "replaceAll",
                "text": "{NAMA}",
                "replaceText": "={{ $('Webhook2').item.json.body.pemohon.nama }}"
              },
              {
                "action": "replaceAll",
                "text": "{NIK}",
                "replaceText": "={{ $('Webhook2').item.json.body.pemohon.nik }}"
              },
              {
                "action": "replaceAll",
                "text": "{TTL}",
                "replaceText": "={{ $('Webhook2').item.json.body.pemohon.ttl }}"
              },
              {
                "action": "replaceAll",
                "text": "{AGAMA}",
                "replaceText": "={{ $('Webhook2').item.json.body.pemohon.agama }}"
              },
              {
                "action": "replaceAll",
                "text": "{JENISKELAMIN}",
                "replaceText": "={{ $('Webhook2').item.json.body.pemohon.jenis_kelamin }}"
              },
              {
                "action": "replaceAll",
                "text": "{STATUSPERNIKAHAN}",
                "replaceText": "={{ $('Webhook2').item.json.body.pemohon.status_perkawinan }}"
              },
              {
                "action": "replaceAll",
                "text": "{PEKERJAAN}",
                "replaceText": "={{ $('Webhook2').item.json.body.pemohon.pekerjaan }}"
              },
              {
                "action": "replaceAll",
                "text": "{ALAMAT}",
                "replaceText": "={{ $('Webhook2').item.json.body.pemohon.alamat }}"
              },
              {
                "action": "replaceAll",
                "text": "{KELURAHAN}",
                "replaceText": "={{ $('Webhook2').item.json.body.pemohon.kelurahan }}"
              },
              {
                "action": "replaceAll",
                "text": "{TANGGALSURAT}",
                "replaceText": "={{ $('Webhook2').item.json.body.tanggal_surat }}"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.googleDocs",
        "typeVersion": 2,
        "position": [
          -440,
          4660
        ],
        "id": "56ac30f0-8c21-4fd3-b33b-067a5cb89f36",
        "name": "Write Surat Usaha",
        "credentials": {
          "googleDocsOAuth2Api": {
            "id": "skUGYZC8DG94zWQo",
            "name": "Google Docs account"
          }
        }
      },
      {
        "parameters": {
          "operation": "download",
          "fileId": {
            "__rl": true,
            "value": "={{ $json.documentId }}",
            "mode": "id"
          },
          "options": {
            "binaryPropertyName": "data",
            "googleFileConversion": {
              "conversion": {
                "docsToFormat": "application/pdf"
              }
            }
          }
        },
        "type": "n8n-nodes-base.googleDrive",
        "typeVersion": 3,
        "position": [
          -220,
          4660
        ],
        "id": "3e148cee-90ab-49b8-9091-49641f824b77",
        "name": "Saved Surat Usaha",
        "credentials": {
          "googleDriveOAuth2Api": {
            "id": "jyiiyKxh6DOyPVt5",
            "name": "Google Drive account"
          }
        }
      },
      {
        "parameters": {
          "name": "={{ $('Create Surat Usaha').item.json.name }}",
          "driveId": {
            "__rl": true,
            "mode": "list",
            "value": "My Drive"
          },
          "folderId": {
            "__rl": true,
            "value": "1CbRPo1yFRv1LRtacbGzriGgcHeVXvUNX",
            "mode": "list",
            "cachedResultName": "Saved Surat Usaha",
            "cachedResultUrl": "https://drive.google.com/drive/folders/1CbRPo1yFRv1LRtacbGzriGgcHeVXvUNX"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleDrive",
        "typeVersion": 3,
        "position": [
          -880,
          5280
        ],
        "id": "bb8e7aa3-5587-4106-b5d2-ee8563b4e8f5",
        "name": "Get Link Surat Usaha",
        "credentials": {
          "googleDriveOAuth2Api": {
            "id": "jyiiyKxh6DOyPVt5",
            "name": "Google Drive account"
          }
        }
      },
      {
        "parameters": {
          "sendTo": "=agunghenditemorubun@gmail.com, mimikawania@gmail.com, kkchanmartin@gmail.com",
          "subject": "={{ $('Create Surat Usaha').item.json.name }}",
          "emailType": "text",
          "message": "={{ $('Create Surat Usaha').item.json.name }}\n{{ new Date($json.createdTime).toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' }) }}\n\n\n{{ $json.webViewLink }}\n",
          "options": {
            "appendAttribution": false
          }
        },
        "type": "n8n-nodes-base.gmail",
        "typeVersion": 2.1,
        "position": [
          -660,
          5280
        ],
        "id": "8c3a4223-2c26-4be9-9e75-34561541f416",
        "name": "Send Link Surat  Gmail",
        "webhookId": "db7dc3bb-6195-4c7c-879b-51bd85f9cc7c",
        "credentials": {
          "gmailOAuth2": {
            "id": "htg9LVNV2zQKpqQf",
            "name": "Gmail account Mimika"
          }
        }
      },
      {
        "parameters": {
          "resource": "Chatting",
          "operation": "Send Text",
          "session": "={{ $('Data Input').item.json.WAHA_Trigger_session }}",
          "chatId": "=6281396650844@c.us",
          "text": "={{ $('Create Surat Usaha').item.json.name }}\n\n\n{{ $('Get Link Surat Usaha').item.json.webViewLink }}",
          "requestOptions": {}
        },
        "type": "@devlikeapro/n8n-nodes-waha.WAHA",
        "typeVersion": 202502,
        "position": [
          -440,
          5280
        ],
        "id": "95ea92cc-1b5c-4f17-8246-bf259903b2bb",
        "name": "Send Link Surat Wa",
        "credentials": {
          "wahaApi": {
            "id": "uivlaHVGkUY1vyJT",
            "name": "WAHA account"
          }
        }
      },
      {
        "parameters": {
          "operation": "binaryToPropery",
          "options": {}
        },
        "type": "n8n-nodes-base.extractFromFile",
        "typeVersion": 1,
        "position": [
          0,
          4660
        ],
        "id": "cf7fb6ef-d15a-4fa7-881f-362bf8685d20",
        "name": "Extract from File"
      },
      {
        "parameters": {
          "resource": "Chatting",
          "operation": "Send File",
          "session": "={{ $('Webhook2').item.json.body.WAHA_Trigger_session }}",
          "chatId": "={{ $('Webhook2').item.json.body.WAHA_Trigger_payload_from }}",
          "file": "={\n  \"mimetype\": \"application/pdf\",\n  \"filename\": \"Surat Keterangan Tidak Mampu {{ $('Webhook2').item.json.body.pemohon.nama }}.pdf\",\n  \"data\": \"{{ $json.data }}\"\n}\n",
          "caption": "=Surat Keterangan Tidak Mampu \nAtas Nama {{ $('Webhook2').item.json.body.pemohon.nama }}\nNIK {{ $('Webhook2').item.json.body.pemohon.nik }}\nTelah Berhasil Di Buat",
          "requestOptions": {}
        },
        "type": "@devlikeapro/n8n-nodes-waha.WAHA",
        "typeVersion": 202502,
        "position": [
          220,
          4560
        ],
        "id": "55da257b-8845-496b-bb8e-ca1035145fa8",
        "name": "Send a file",
        "credentials": {
          "wahaApi": {
            "id": "uivlaHVGkUY1vyJT",
            "name": "WAHA account"
          }
        }
      },
      {
        "parameters": {
          "resource": "Chatting",
          "operation": "Send File",
          "session": "={{ $('Webhook2').item.json.body.WAHA_Trigger_session }}",
          "chatId": "=6281396650844@c.us",
          "file": "={\n  \"mimetype\": \"application/pdf\",\n  \"filename\": \"Surat Keterangan Tidak Mampu {{ $('Webhook2').item.json.body.pemohon.nama }}.pdf\",\n  \"data\": \"{{ $json.data }}\"\n}\n",
          "caption": "=Surat Keterangan Tidak Mampu \nAtas Nama {{ $('Webhook2').item.json.body.pemohon.nama }}\nNIK {{ $('Webhook2').item.json.body.pemohon.nik }}\nTelah di buat dan di kirim kepada {{ $('Webhook2').item.json.body.WAHA_Trigger_payload_from.replace('@c.us', '') }}\n",
          "requestOptions": {}
        },
        "type": "@devlikeapro/n8n-nodes-waha.WAHA",
        "typeVersion": 202502,
        "position": [
          220,
          4760
        ],
        "id": "b785fca5-eb0a-41a9-a5fc-7097acad2955",
        "name": "Send a file1",
        "credentials": {
          "wahaApi": {
            "id": "uivlaHVGkUY1vyJT",
            "name": "WAHA account"
          }
        }
      },
      {
        "parameters": {
          "resource": "Chatting",
          "operation": "Send Text",
          "session": "={{ $('Webhook').item.json.query.session_waha }}",
          "chatId": "=6285652240263@c.us",
          "text": "=Surat Masuk Atas Nama {{ $('Webhook').item.json.query.Nama }}\nNomor KTP {{ $('Webhook').item.json.query.NIK }}\n\nLink Surat\nhttps://distrikwania.com/data/{{ $json.id }}",
          "requestOptions": {}
        },
        "type": "@devlikeapro/n8n-nodes-waha.WAHA",
        "typeVersion": 202502,
        "position": [
          -880,
          4040
        ],
        "id": "4660ae80-a30c-498f-b44b-3d7472cd59c1",
        "name": "Send a text message3",
        "credentials": {
          "wahaApi": {
            "id": "uivlaHVGkUY1vyJT",
            "name": "WAHA account"
          }
        }
      },
      {
        "parameters": {
          "resource": "Chatting",
          "operation": "Send File",
          "session": "={{ $('Webhook2').item.json.body.WAHA_Trigger_session }}",
          "chatId": "=6285652240263@c.us",
          "file": "={\n  \"mimetype\": \"application/pdf\",\n  \"filename\": \"Surat Keterangan Tidak Mampu {{ $('Webhook2').item.json.body.pemohon.nama }}.pdf\",\n  \"data\": \"{{ $json.data }}\"\n}\n",
          "caption": "=Surat Keterangan Tidak Mampu \nAtas Nama {{ $('Webhook2').item.json.body.pemohon.nama }}\nNIK {{ $('Webhook2').item.json.body.pemohon.nik }}\nTelah di buat dan di kirim kepada {{ $('Webhook2').item.json.body.WAHA_Trigger_payload_from.replace('@c.us', '') }}\n",
          "requestOptions": {}
        },
        "type": "@devlikeapro/n8n-nodes-waha.WAHA",
        "typeVersion": 202502,
        "position": [
          -880,
          5020
        ],
        "id": "61612dc0-6973-4c76-ad4a-1df1f6511464",
        "name": "Send a file2",
        "credentials": {
          "wahaApi": {
            "id": "uivlaHVGkUY1vyJT",
            "name": "WAHA account"
          }
        }
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 2
            },
            "conditions": [
              {
                "id": "0ebbf789-ae3b-4ee1-a549-f71a35821b95",
                "leftValue": "={{ $json.body.dokumen }}",
                "rightValue": "",
                "operator": {
                  "type": "array",
                  "operation": "empty",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.2,
        "position": [
          0,
          3320
        ],
        "id": "54b64750-7ad3-4dc5-a4f6-bceabf90f968",
        "name": "If1"
      },
      {
        "parameters": {
          "operation": "copy",
          "fileId": {
            "__rl": true,
            "value": "1oAfXARAJXHPRK2K6ALm2_LKoZgopK5-xNh7p55Zs5yM",
            "mode": "list",
            "cachedResultName": "Create Surat Keterangan Tidak Mampu",
            "cachedResultUrl": "https://docs.google.com/document/d/1oAfXARAJXHPRK2K6ALm2_LKoZgopK5-xNh7p55Zs5yM/edit?usp=drivesdk"
          },
          "name": "=SKTM-{{$json.body.pemohon.nama}}",
          "options": {
            "copyRequiresWriterPermission": false
          }
        },
        "type": "n8n-nodes-base.googleDrive",
        "typeVersion": 3,
        "position": [
          -660,
          4660
        ],
        "id": "94cf7b4d-edee-4849-903f-2bef44f93993",
        "name": "Copy file",
        "credentials": {
          "googleDriveOAuth2Api": {
            "id": "jyiiyKxh6DOyPVt5",
            "name": "Google Drive account"
          }
        }
      },
      {
        "parameters": {
          "resource": "Chatting",
          "operation": "Send Text",
          "text": "Data ",
          "requestOptions": {}
        },
        "type": "@devlikeapro/n8n-nodes-waha.WAHA",
        "typeVersion": 202502,
        "position": [
          660,
          820
        ],
        "id": "3410fabc-69c3-43ae-b23e-2dafa1aa5b10",
        "name": "Send a text message4",
        "credentials": {
          "wahaApi": {
            "id": "uivlaHVGkUY1vyJT",
            "name": "WAHA account"
          }
        }
      },
      {
        "parameters": {
          "resource": "Chatting",
          "operation": "Send Text",
          "session": "={{ $('Switch').item.json.WAHA_Trigger_session }}",
          "chatId": "={{ $('Switch').item.json.WAHA_Trigger_payload_from }}",
          "text": "‚úÖ Data berhasil diubah!",
          "requestOptions": {}
        },
        "type": "@devlikeapro/n8n-nodes-waha.WAHA",
        "typeVersion": 202502,
        "position": [
          220,
          1680
        ],
        "id": "72534f29-3ada-4694-a84b-d8f9239129d9",
        "name": "Send a text message5",
        "credentials": {
          "wahaApi": {
            "id": "uivlaHVGkUY1vyJT",
            "name": "WAHA account"
          }
        }
      },
      {
        "parameters": {
          "driveId": {
            "__rl": true,
            "mode": "list",
            "value": "My Drive"
          },
          "folderId": {
            "__rl": true,
            "value": "={{ $('Create Folder Warga').item.json.id }}",
            "mode": "id"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleDrive",
        "typeVersion": 3,
        "position": [
          0,
          260
        ],
        "id": "572db00a-a6b6-42dc-9a93-414a8e85d6b3",
        "name": "Create Json Data Warga",
        "credentials": {
          "googleDriveOAuth2Api": {
            "id": "jyiiyKxh6DOyPVt5",
            "name": "Google Drive account"
          }
        }
      },
      {
        "parameters": {
          "name": "={{ $json.query.name_file }}",
          "driveId": {
            "__rl": true,
            "mode": "list",
            "value": "My Drive"
          },
          "folderId": {
            "__rl": true,
            "value": "1z6iQjNCmp39IHqZ23EWWIsbA5g__Ahr-",
            "mode": "list",
            "cachedResultName": "Data Web Warga",
            "cachedResultUrl": "https://drive.google.com/drive/folders/1z6iQjNCmp39IHqZ23EWWIsbA5g__Ahr-"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleDrive",
        "typeVersion": 3,
        "position": [
          -660,
          560
        ],
        "id": "717dfe73-277d-4811-8be5-71d5717ea243",
        "name": "Create Web Warga",
        "credentials": {
          "googleDriveOAuth2Api": {
            "id": "jyiiyKxh6DOyPVt5",
            "name": "Google Drive account"
          }
        }
      },
      {
        "parameters": {
          "resource": "folder",
          "name": "={{ DateTime.now().setZone('Asia/Tokyo').setLocale('id').toFormat('dd_MM_yyyy_HH_mm_ss') + '_' + ($('Data Input').item.json.Nama).trim().replace(/\\s+/g,'-').toUpperCase() + '_' + ($('Data Input').item.json.NIK) }}",
          "driveId": {
            "__rl": true,
            "mode": "list",
            "value": "My Drive"
          },
          "folderId": {
            "__rl": true,
            "value": "1po03k8LByOZlSZ7lOkFLWGijOWk5HZ5n",
            "mode": "list",
            "cachedResultName": "Data Warga Format json",
            "cachedResultUrl": "https://drive.google.com/drive/folders/1po03k8LByOZlSZ7lOkFLWGijOWk5HZ5n"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleDrive",
        "typeVersion": 3,
        "position": [
          -440,
          300
        ],
        "id": "35cad591-a3e7-4fb1-8f87-0e2cd3460bd4",
        "name": "Create Folder Warga",
        "credentials": {
          "googleDriveOAuth2Api": {
            "id": "jyiiyKxh6DOyPVt5",
            "name": "Google Drive account"
          }
        }
      },
      {
        "parameters": {
          "mode": "combine",
          "combineBy": "combineAll",
          "options": {}
        },
        "type": "n8n-nodes-base.merge",
        "typeVersion": 3.2,
        "position": [
          220,
          160
        ],
        "id": "0795c243-1646-4133-b949-399027f50147",
        "name": "Merge"
      },
      {
        "parameters": {
          "mode": "combine",
          "combineBy": "combineAll",
          "options": {}
        },
        "type": "n8n-nodes-base.merge",
        "typeVersion": 3.2,
        "position": [
          -220,
          260
        ],
        "id": "beb5b6ed-6069-4c54-b2a8-903760ceede0",
        "name": "Merge4"
      },
      {
        "parameters": {
          "httpMethod": "POST",
          "path": "5f3c9805-585e-4dd8-a9de-b83aa21cd301",
          "options": {}
        },
        "type": "n8n-nodes-base.webhook",
        "typeVersion": 2,
        "position": [
          -880,
          2100
        ],
        "id": "6d21e63f-43da-4f40-8e83-9a7c2dd28d94",
        "name": "Webhook3",
        "webhookId": "5f3c9805-585e-4dd8-a9de-b83aa21cd301"
      },
      {
        "parameters": {
          "rules": {
            "values": [
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "leftValue": "={{ $json.action }}",
                      "rightValue": "UPDATE_ONLY",
                      "operator": {
                        "type": "string",
                        "operation": "equals"
                      },
                      "id": "a6c9a0b4-c489-49ab-bf3f-fe62400d91b9"
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "UPDATE_ONLY"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "cc0d5e24-157a-4d73-8523-296db2e66a18",
                      "leftValue": "={{ $json.action }}",
                      "rightValue": "UPLOAD_FILES",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "UPLOAD_FILES"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "900496c4-5ae9-47e6-bc8e-1e15edcdb718",
                      "leftValue": "={{ $json.action }}",
                      "rightValue": "DELETE_DOCS",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "DELETE_DOCS"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "b18a55bc-31a8-42f4-b9eb-63c4a724604c",
                      "leftValue": "={{ $json.action }}",
                      "rightValue": "DELETE_ALL",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "DELETE_ALL"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "ef332668-f3d6-4460-936b-effd9ada2929",
                      "leftValue": "={{ $json.action }}",
                      "rightValue": "CREATE_AND_SEND",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "CREATE_AND_SEND"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.switch",
        "typeVersion": 3.2,
        "position": [
          -440,
          2080
        ],
        "id": "f4f7be21-c0cb-4228-9b83-a4121fcafc46",
        "name": "Switch"
      },
      {
        "parameters": {
          "operation": "toJson",
          "options": {
            "fileName": "={{ DateTime.now().setZone('Asia/Tokyo').setLocale('id').toFormat('dd_MM_yyyy_HH_mm_ss') + '_' + ($json.pemohon.nama).trim().replace(/\\s+/g,'-').toUpperCase() + '_' + ($json.pemohon.nik) }}\n"
          }
        },
        "type": "n8n-nodes-base.convertToFile",
        "typeVersion": 1.1,
        "position": [
          -220,
          1680
        ],
        "id": "5d9ad8d8-fae4-4775-aa55-7416de330d30",
        "name": "Convert to File6"
      },
      {
        "parameters": {
          "operation": "update",
          "fileId": {
            "__rl": true,
            "value": "={{ $('Switch').item.json.id_user }}",
            "mode": "id"
          },
          "changeFileContent": true,
          "options": {}
        },
        "type": "n8n-nodes-base.googleDrive",
        "typeVersion": 3,
        "position": [
          0,
          1680
        ],
        "id": "8a14e1ca-372e-4138-93f4-8833a0cd642d",
        "name": "Update file5",
        "credentials": {
          "googleDriveOAuth2Api": {
            "id": "jyiiyKxh6DOyPVt5",
            "name": "Google Drive account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "/**\n * n8n Code Node ‚Äî Parse & Normalize Payload Surat + Binary Split (No Icon/Thumbnail/Binary_Prop)\n * Mode   : Run Once for All Items\n * Input  : items (array dari webhook, bisa ada binary)\n * Output : [{ json, binary }]\n */\n\nconst out = [];\n\nfor (const item of items) {\n  const body = item.json?.body ?? {};\n  let s = body.data ?? item.json;\n\n  // --- dukung multipart: body.data bisa string JSON ---\n  if (typeof s === 'string') {\n    try { s = JSON.parse(s); }\n    catch { s = {}; }\n  }\n\n  // ---------------- Utils ----------------\n  const has = (o, k) => Object.prototype.hasOwnProperty.call(o ?? {}, k);\n  const val = (o, k) => {\n    if (!o || typeof o !== 'object') return null;\n    if (!has(o, k)) return null;\n    const v = o[k];\n    if (v === undefined || v === '') return null;\n    return v;\n  };\n  const ensureStr = (x, fb='-') => {\n    const v = (x ?? '').toString().trim();\n    return v.length ? v : fb;\n  };\n  const toTitleCase = (str) => {\n    if (!str) return str;\n    return str.toLowerCase().replace(/\\b\\w/g, (c) => c.toUpperCase());\n  };\n  const lower = (s) => (s ?? '').toString().trim().toLowerCase();\n\n  const guessMimeFromName = (name='') => {\n    const n = (name || '').toLowerCase();\n    if (n.endsWith('.jpg') || n.endsWith('.jpeg')) return 'image/jpeg';\n    if (n.endsWith('.png'))  return 'image/png';\n    if (n.endsWith('.pdf'))  return 'application/pdf';\n    if (n.endsWith('.docx')) return 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';\n    if (n.endsWith('.doc'))  return 'application/msword';\n    if (n.endsWith('.xlsx')) return 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';\n    if (n.endsWith('.xls'))  return 'application/vnd.ms-excel';\n    return null;\n  };\n\n  // ---------------- Binary map ----------------\n  const bin = item.binary || {};\n  const binKeys = Object.keys(bin);\n\n  const binaryIndex = {};\n  for (const k of binKeys) {\n    const b = bin[k] || {};\n    const key = lower(k);\n    binaryIndex[key] = { prop: k, ...b };\n    if (b.fileName) {\n      binaryIndex[lower(b.fileName)] = { prop: k, ...b };\n    }\n  }\n\n  // ---------------- Tangkap delete_file_ids (INI YANG HILANG) ----------------\n  const deleteIds = Array.isArray(body.delete_file_ids)\n    ? body.delete_file_ids.filter(x => typeof x === 'string' && x.trim().length > 0)\n    : [];\n\n  // ---------------- Dokumen ----------------\n  let dokumen = [];\n  if (Array.isArray(s.dokumen)) {\n    dokumen = s.dokumen.map((d = {}) => {\n      const base = {\n        name         : d?.name ?? null,\n        type         : d?.type ?? d?.mimeType ?? null,\n        file_id      : d?.file_id ?? null,\n        size         : d?.size ?? null,\n        view_url     : d?.view_url ?? null,\n        download_url : d?.download_url ?? null,\n      };\n\n      // Enrichment dari binary\n      let bMatch = null;\n      if (d?.binary_prop && binaryIndex[lower(d.binary_prop)]) {\n        bMatch = binaryIndex[lower(d.binary_prop)];\n      } else if (base.name && binaryIndex[lower(base.name)]) {\n        bMatch = binaryIndex[lower(base.name)];\n      }\n\n      if (bMatch) {\n        base.type = base.type ?? bMatch.mimeType ?? null;\n        base.size = base.size ?? (bMatch.fileSize ?? null);\n        base.name = base.name ?? bMatch.fileName ?? null;\n      }\n\n      if (!base.type && base.name) {\n        const g = guessMimeFromName(base.name);\n        if (g) base.type = g;\n      }\n\n      return base;\n    });\n  } else if (binKeys.length) {\n    dokumen = binKeys.map((k) => {\n      const b = bin[k] || {};\n      return {\n        name        : b.fileName ?? k,\n        type        : b.mimeType ?? guessMimeFromName(b.fileName ?? '') ?? null,\n        file_id     : null,\n        size        : b.fileSize ?? null,\n        view_url    : null,\n        download_url: null,\n      };\n    });\n  }\n\n  // --- Opsional: bila action = DELETE_DOCS, kosongkan dokumen agar semantik jelas\n  const topAction = body.action ?? val(s, 'action');\n  if (String(topAction).toUpperCase() === 'DELETE_DOCS') {\n    // (pilihan) tetap boleh kirim dokumen, tapi biasanya tidak diperlukan saat delete\n    // dokumen = [];\n  }\n\n  // ---------------- Alamat/domisili ----------------\n  const pem = s.pemohon ?? {};\n  const kelVal   = ensureStr(val(pem, 'kelurahan/kampung') ?? val(pem, 'Kelurahan'));\n  const kecVal   = ensureStr(val(pem, 'kecamatan') ?? val(pem, 'Kecamatan'));\n  const kotaKab  = ensureStr(val(pem, 'kota_kab') ?? val(pem, 'Kabupaten') ?? val(pem, 'Kota'));\n  const provinsi = ensureStr(val(pem, 'provinsi') ?? val(pem, 'Provinsi') ?? 'Papua Tengah');\n\n  // ---------------- Payload akhir ----------------\n  const payload = {\n    action  : topAction,\n    strategy: body.strategy ?? val(s, 'strategy') ?? null,\n    id_user : body.id_user ?? val(s, 'id_user'),\n    id_surat: body.id_surat ?? val(s, 'id_surat'),\n    date    : val(s, 'date'),\n\n    // <‚Äî TAMBAHKAN FIELD INI\n    delete_file_ids: deleteIds,\n\n    pemohon: {\n      nama               : toTitleCase(val(pem, 'nama')),\n      nik                : val(pem, 'nik'),\n      ttl                : toTitleCase(val(pem, 'ttl')),\n      agama              : toTitleCase(val(pem, 'agama')),\n      jenis_kelamin      : toTitleCase(val(pem, 'jenis_kelamin')),\n      status_perkawinan  : toTitleCase(val(pem, 'status_perkawinan')),\n      pekerjaan          : toTitleCase(val(pem, 'pekerjaan')),\n      alamat             : toTitleCase(val(pem, 'alamat')),\n      \"kelurahan/kampung\": toTitleCase(kelVal),\n      kecamatan          : toTitleCase(kecVal),\n      kota_kab           : toTitleCase(kotaKab),\n      provinsi           : toTitleCase(provinsi),\n    },\n\n    dokumen,\n\n    WAHA_Trigger_session     : val(s, 'WAHA_Trigger_session'),\n    WAHA_Trigger_payload_from: val(s, 'WAHA_Trigger_payload_from'),\n    LogoURL                  : val(s, 'LogoURL'),\n    webhook                  : val(s, 'webhook'),\n  };\n\n  // ---------------- Binary Split ----------------\n  if (binKeys.length === 0) {\n    out.push({ json: payload });\n  } else {\n    for (const k of binKeys) {\n      out.push({\n        json: { ...payload, binaryProperty: k },\n        binary: { [k]: bin[k] },\n      });\n    }\n  }\n}\n\nreturn out;\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -660,
          2100
        ],
        "id": "8d5cd7ae-af6b-4852-bc43-fd5a6c3f431d",
        "name": "Code10"
      },
      {
        "parameters": {
          "inputDataFieldName": "={{ $json.binaryProperty }}",
          "name": "={{ $binary[$json.binaryProperty].fileName }}",
          "driveId": {
            "__rl": true,
            "mode": "list",
            "value": "My Drive"
          },
          "folderId": {
            "__rl": true,
            "value": "={{ $json.id }}",
            "mode": "id"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleDrive",
        "typeVersion": 3,
        "position": [
          -220,
          2000
        ],
        "id": "b032b472-b2e5-4ca0-ad93-b6b36f7ff57d",
        "name": "Upload file",
        "credentials": {
          "googleDriveOAuth2Api": {
            "id": "jyiiyKxh6DOyPVt5",
            "name": "Google Drive account"
          }
        }
      },
      {
        "parameters": {
          "mode": "combine",
          "combineBy": "combineAll",
          "options": {}
        },
        "type": "n8n-nodes-base.merge",
        "typeVersion": 3.2,
        "position": [
          0,
          1940
        ],
        "id": "83f4ec5f-87cc-4257-96a4-c6b8534e8e41",
        "name": "Merge6"
      },
      {
        "parameters": {
          "jsCode": "/**\n * n8n Code Node ‚Äî Aggregate Uploaded Items -> Single Clean Payload (MERGE old+new docs)\n * Mode: Run Once for All Items\n */\n\nconst toTitleCase = (str) => {\n  if (!str) return str;\n  return str.toString()\n    .toLowerCase()\n    .replace(/\\b\\w/g, c => c.toUpperCase());\n};\n\nconst ensureStr = (x, fb='-') => {\n  const v = (x ?? '').toString().trim();\n  return v.length ? v : fb;\n};\n\nconst firstWith = (xs, pred) => xs.find(pred) ?? {};\nconst J = items.map(it => it.json || {});\nconst base = firstWith(J, j => j && (j.pemohon || j.action || Array.isArray(j?.dokumen))) || (J[0] || {});\n\n/* ---------------- Normalizer untuk objek dokumen ---------------- */\nconst normDoc = (d = {}) => {\n  const name        = d.name ?? d.filename ?? null;\n  const file_id     = d.file_id ?? d.id ?? null;\n  const mimetype    = d.type ?? d.mimeType ?? d.mimetype ?? d.fileExtension ?? null;\n  const view_url    = d.view_url ?? d.webViewLink ?? d.viewUrl ?? null;\n  const download_url= d.download_url ?? d.webContentLink ?? d.downloadUrl ?? null;\n  const size        = d.size != null ? Number(d.size) :\n                      (typeof d.quotaBytesUsed !== 'undefined' ? Number(d.quotaBytesUsed) : null);\n\n  // susun objek tanpa icon & binary_prop\n  const obj = {\n    name,\n    type: mimetype,\n    file_id,\n    size: Number.isFinite(size) ? size : null,\n    view_url,\n    download_url,\n    thumbnail: d.thumbnail ?? d.thumbnailLink ?? null\n  };\n\n  // filter agar property dengan null dibuang\n  return Object.fromEntries(\n    Object.entries(obj).filter(([_, v]) => v !== null && v !== undefined)\n  );\n};\n\n/* ---------------- Kumpulkan dokumen lama (jika ada) ---------------- */\nconst oldDocs = [];\nfor (const j of J) {\n  if (j && Array.isArray(j.dokumen)) {\n    for (const d of j.dokumen) {\n      oldDocs.push(normDoc(d));\n    }\n  }\n}\n\n/* ---------------- Kumpulkan dokumen baru dari setiap item upload ---------------- */\nconst newDocs = [];\nfor (const j of J) {\n  const looksLikeFile =\n    j && (j.id || j.file_id) && (j.name || j.filename || j.originalFilename || j.fullFileExtension);\n\n  if (!looksLikeFile) continue;\n\n  const d = {\n    name: j.name ?? j.filename ?? j.originalFilename ?? null,\n    type: j.mimeType ?? j.mimetype ?? j.fileExtension ?? j.fullFileExtension ?? null,\n    file_id: j.id ?? j.file_id ?? null,\n    size: j.size ?? j.quotaBytesUsed ?? null,\n    view_url: j.webViewLink ?? null,\n    download_url: j.webContentLink ?? null,\n    thumbnail: j.thumbnailLink ?? null\n  };\n\n  newDocs.push(normDoc(d));\n}\n\n/* ---------------- Merge + de-duplicate ---------------- */\nconst keyOf = (d) => {\n  if (d.file_id) return `id:${d.file_id}`;\n  if (d.download_url) return `dl:${d.download_url}`;\n  if (d.view_url) return `vw:${d.view_url}`;\n  return `ns:${d.name || '-'}#${d.size || '-'}`;\n};\n\nconst seen = new Set();\nconst dokumen = [];\n\nfor (const d of oldDocs) {\n  const k = keyOf(d);\n  if (seen.has(k)) continue;\n  seen.add(k);\n  dokumen.push(d);\n}\nfor (const d of newDocs) {\n  const k = keyOf(d);\n  if (seen.has(k)) continue;\n  seen.add(k);\n  dokumen.push(d);\n}\n\n/* ---------------- Normalisasi alamat/domisili ---------------- */\nconst kel = ensureStr(base?.pemohon?.['kelurahan/kampung'] ?? base?.pemohon?.Kelurahan);\nconst kec = ensureStr(base?.pemohon?.kecamatan ?? base?.pemohon?.Kecamatan);\nconst kab = ensureStr(base?.pemohon?.kota_kab ?? base?.pemohon?.Kabupaten ?? base?.pemohon?.Kota);\nconst prov= ensureStr(base?.pemohon?.provinsi ?? base?.pemohon?.Provinsi ?? 'Papua Tengah');\n\n/* ---------------- Payload akhir ---------------- */\nconst payload = {\n  action   : base.action ?? J[0]?.action ?? 'UPLOAD_FILES',\n  strategy : base.strategy ?? J[0]?.strategy ?? 'OVERWRITE_BIN',\n  id_user  : base.id_user ?? J[0]?.id_user ?? null,\n  id_surat : base.id_surat ?? J[0]?.id_surat ?? null,\n  date     : base.date ?? null,\n\n  pemohon: {\n    nama              : toTitleCase(base?.pemohon?.nama ?? base?.Nama),\n    nik               : base?.pemohon?.nik ?? base?.NIK ?? null,\n    ttl               : toTitleCase(base?.pemohon?.ttl ?? base?.TTL),\n    agama             : toTitleCase(base?.pemohon?.agama ?? base?.Agama),\n    jenis_kelamin     : toTitleCase(base?.pemohon?.jenis_kelamin ?? base?.JenisKelamin),\n    status_perkawinan : toTitleCase(base?.pemohon?.status_perkawinan ?? base?.StatusPerkawinan),\n    pekerjaan         : toTitleCase(base?.pemohon?.pekerjaan ?? base?.Pekerjaan),\n    alamat            : toTitleCase(base?.pemohon?.alamat ?? base?.Alamat),\n\n    \"kelurahan/kampung\": toTitleCase(kel),\n    kecamatan          : toTitleCase(kec),\n    kota_kab           : toTitleCase(kab),\n    provinsi           : toTitleCase(prov),\n  },\n\n  dokumen,\n\n  WAHA_Trigger_session      : base.WAHA_Trigger_session ?? null,\n  WAHA_Trigger_payload_from : base.WAHA_Trigger_payload_from ?? null,\n  LogoURL                   : base.LogoURL ?? null,\n  webhook                   : base.webhook ?? base.URL_POST ?? null,\n};\n\nreturn [{ json: payload }];\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          220,
          1940
        ],
        "id": "b2314c07-0281-4936-b439-9769597d0b70",
        "name": "Code12"
      },
      {
        "parameters": {
          "operation": "toJson",
          "options": {
            "fileName": "={{ DateTime.now().setZone('Asia/Tokyo').setLocale('id').toFormat('dd_MM_yyyy_HH_mm_ss') + '_' + ($json.pemohon.nama).trim().replace(/\\s+/g,'-').toUpperCase() + '_' + ($json.pemohon.nik) }}\n"
          }
        },
        "type": "n8n-nodes-base.convertToFile",
        "typeVersion": 1.1,
        "position": [
          440,
          1940
        ],
        "id": "2ee84597-0936-455d-a781-d002cc950539",
        "name": "Convert to File4"
      },
      {
        "parameters": {
          "operation": "update",
          "fileId": {
            "__rl": true,
            "value": "={{ $('Code12').item.json.id_user }}",
            "mode": "id"
          },
          "changeFileContent": true,
          "options": {}
        },
        "type": "n8n-nodes-base.googleDrive",
        "typeVersion": 3,
        "position": [
          660,
          1940
        ],
        "id": "e111346e-1391-4dc7-a318-9acef5098524",
        "name": "Update file1",
        "credentials": {
          "googleDriveOAuth2Api": {
            "id": "jyiiyKxh6DOyPVt5",
            "name": "Google Drive account"
          }
        }
      },
      {
        "parameters": {
          "resource": "Chatting",
          "operation": "Send Text",
          "session": "={{ $('Code12').item.json.WAHA_Trigger_session }}",
          "chatId": "={{ $('Code12').item.json.WAHA_Trigger_payload_from }}",
          "text": "‚úÖ File berhasil terupload!",
          "requestOptions": {}
        },
        "type": "@devlikeapro/n8n-nodes-waha.WAHA",
        "typeVersion": 202502,
        "position": [
          880,
          1940
        ],
        "id": "e4493264-01a4-473c-ab28-a03d3a8dbd41",
        "name": "Send a text message6",
        "credentials": {
          "wahaApi": {
            "id": "uivlaHVGkUY1vyJT",
            "name": "WAHA account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// Ambil data dari input\nconst input = items[0].json;  \n\n// Ambil langsung field delete_file_ids\nconst output = {\n  delete_file_ids: input.delete_file_ids || []\n};\n\n// Kembalikan hasil\nreturn [{ json: output }];\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -220,
          2400
        ],
        "id": "9d179c8a-8bd2-41d7-b496-4933c7488ac7",
        "name": "Code11"
      },
      {
        "parameters": {
          "method": "DELETE",
          "url": "=https://www.googleapis.com/drive/v3/files/{{ $('Code11').item.json.delete_file_ids }}?supportsAllDrives=true",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "googleOAuth2Api",
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          0,
          2400
        ],
        "id": "957ac85a-418b-48db-9dd7-1a2bf52cc140",
        "name": "Delete File1",
        "credentials": {
          "googleOAuth2Api": {
            "id": "L31Mzf4p7TJyr4bB",
            "name": "Google account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "/**\n * n8n Code Node ‚Äî Ambil Semua ID dari Payload\n * Mode   : Run Once for Single Item\n * Input  : { json }\n * Output : Array of items { json: { fileId } }\n */\n\n// ==== Helper: Ambil segmen terakhir dari URL / path ====\nfunction tailId(v) {\n  if (typeof v !== 'string') return '';\n  const s = v.trim();\n  if (!s) return '';\n\n  try {\n    // Jika URL valid\n    const u = new URL(s);\n    const parts = u.pathname.split('/').filter(Boolean);\n    return parts.length ? parts[parts.length - 1] : s;\n  } catch {\n    // Jika bukan URL valid ‚Üí fallback split biasa\n    const parts = s.split('/').filter(Boolean);\n    return parts.length ? parts[parts.length - 1] : s;\n  }\n}\n\n// Ambil body & data\nconst body = $json.body || {};\nconst data = body.data || $json || {};\n\n// 1) id_user\nconst idUser = (data.id_user || body.id_user || '').trim();\n\n// 2) id_surat ‚Üí ambil ID terakhir dari link\nconst idSuratRaw = data.id_surat || body.id_surat || '';\nconst idSurat = tailId(idSuratRaw);\n\n// 3) file_id dari dokumen\nconst fromDocs = Array.isArray(data.dokumen)\n  ? data.dokumen.map(d => d?.file_id).filter(Boolean)\n  : [];\n\n// 4) delete_file_ids (jika ada)\nconst explicit = Array.isArray(data.delete_file_ids)\n  ? data.delete_file_ids.filter(Boolean)\n  : [];\n\n// 5) Gabungkan semua sumber\nconst allIds = []\n  .concat(idUser, idSurat, explicit, fromDocs)\n  .filter(x => typeof x === 'string' && x.trim().length > 0);\n\n// 6) Buat unik\nconst uniq = [...new Set(allIds.map(x => x.trim()))];\n\n// 7) Return array items untuk n8n\nreturn uniq.map(id => ({ json: { fileId: id } }));\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -220,
          2600
        ],
        "id": "4b113350-376b-48a7-a901-3195460fe0ae",
        "name": "Code13",
        "alwaysOutputData": true
      },
      {
        "parameters": {
          "method": "DELETE",
          "url": "=https://www.googleapis.com/drive/v3/files/{{ $json.fileId }}\n?supportsAllDrives=true",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "googleOAuth2Api",
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          0,
          2600
        ],
        "id": "fe5c06c3-e4af-49aa-95ca-c4c2bf94550a",
        "name": "Hapus Semua1",
        "credentials": {
          "googleOAuth2Api": {
            "id": "L31Mzf4p7TJyr4bB",
            "name": "Google account"
          }
        }
      },
      {
        "parameters": {
          "resource": "Chatting",
          "operation": "Send Text",
          "session": "={{ $('Switch').item.json.WAHA_Trigger_session }}",
          "chatId": "={{ $('Switch').item.json.WAHA_Trigger_payload_from }}",
          "reply_to": "=",
          "text": "‚úÖ Surat dan Data berhasil dihapus!",
          "requestOptions": {}
        },
        "type": "@devlikeapro/n8n-nodes-waha.WAHA",
        "typeVersion": 202502,
        "position": [
          220,
          2600
        ],
        "id": "2a1c59bb-5dd4-4d26-9cf2-0c8b0c225fb5",
        "name": "Send a text message7",
        "executeOnce": true,
        "credentials": {
          "wahaApi": {
            "id": "uivlaHVGkUY1vyJT",
            "name": "WAHA account"
          }
        }
      },
      {
        "parameters": {
          "resource": "Chatting",
          "operation": "Send Text",
          "session": "={{ $('Switch').item.json.WAHA_Trigger_session }}",
          "chatId": "={{ $('Switch').item.json.WAHA_Trigger_payload_from }}",
          "text": "‚úÖ File berhasil dihapus!",
          "requestOptions": {}
        },
        "type": "@devlikeapro/n8n-nodes-waha.WAHA",
        "typeVersion": 202502,
        "position": [
          220,
          2400
        ],
        "id": "2824fe24-7006-4920-bffa-0196d748c25d",
        "name": "Send a text message9",
        "credentials": {
          "wahaApi": {
            "id": "uivlaHVGkUY1vyJT",
            "name": "WAHA account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// Ambil data dari input\nconst input = items[0].json;  // kalau di n8n\n// const input = JSON.parse(JSON.stringify(yourJson)); // kalau manual\n\n// Ambil daftar file_id yang mau dihapus\nconst toDelete = new Set(input.delete_file_ids || []);\n\n// Filter dokumen agar tidak menyertakan file_id yang ada di delete_file_ids\nconst newDocs = (input.dokumen || []).filter(doc => !toDelete.has(doc.file_id));\n\n// Buat output baru TANPA delete_file_ids\nconst { delete_file_ids, ...rest } = input;\nconst output = {\n  ...rest,\n  dokumen: newDocs\n};\n\n// Kembalikan hasil\nreturn [{ json: output }];\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -220,
          2200
        ],
        "id": "0190b237-e1d1-4aaa-9670-9d2b712b5c0f",
        "name": "Code14"
      },
      {
        "parameters": {
          "operation": "toJson",
          "options": {
            "fileName": "={{ DateTime.now().setZone('Asia/Tokyo').setLocale('id').toFormat('dd_MM_yyyy_HH_mm_ss') + '_' + ($json.pemohon.nama).trim().replace(/\\s+/g,'-').toUpperCase() + '_' + ($json.pemohon.nik) }}\n"
          }
        },
        "type": "n8n-nodes-base.convertToFile",
        "typeVersion": 1.1,
        "position": [
          0,
          2200
        ],
        "id": "18399557-fdbb-4232-a05e-441e2a04e570",
        "name": "Convert to File8"
      },
      {
        "parameters": {
          "operation": "update",
          "fileId": {
            "__rl": true,
            "value": "={{ $('Switch').item.json.id_user }}",
            "mode": "id"
          },
          "changeFileContent": true,
          "options": {}
        },
        "type": "n8n-nodes-base.googleDrive",
        "typeVersion": 3,
        "position": [
          220,
          2200
        ],
        "id": "36be0934-7bae-4915-ab40-9bcc925fbf41",
        "name": "Update file7",
        "credentials": {
          "googleDriveOAuth2Api": {
            "id": "jyiiyKxh6DOyPVt5",
            "name": "Google Drive account"
          }
        }
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://n8n-qz8tp6856ibc.bgxy.sumopod.my.id/webhook/737cd7f5-bfa1-4b9c-b55a-21aa718bfc3d",
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={{$input.all().map(i => i.json)}}",
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          -100,
          2920
        ],
        "id": "d0e8b474-ff05-494b-9bc8-6d577f0910f5",
        "name": "HTTP Request2"
      },
      {
        "parameters": {
          "resource": "Chatting",
          "operation": "Send Text",
          "session": "={{ $('Switch').item.json.WAHA_Trigger_session }}",
          "chatId": "={{ $('Switch').item.json.WAHA_Trigger_payload_from }}",
          "text": "‚úÖ Surat dan Data berhasil Terkirim!",
          "requestOptions": {}
        },
        "type": "@devlikeapro/n8n-nodes-waha.WAHA",
        "typeVersion": 202502,
        "position": [
          160,
          2920
        ],
        "id": "ad55a5f6-cdfb-48ca-bc91-dc2dc863bc7c",
        "name": "Send a text message8",
        "credentials": {
          "wahaApi": {
            "id": "uivlaHVGkUY1vyJT",
            "name": "WAHA account"
          }
        }
      },
      {
        "parameters": {
          "resource": "Chatting",
          "operation": "Send Text",
          "session": "={{ $('Switch').item.json.WAHA_Trigger_session }}",
          "chatId": "={{ $('Switch').item.json.WAHA_Trigger_payload_from }}",
          "text": "‚úÖ Mohon tunggu notifikasi selanjutnya dari saya!",
          "requestOptions": {}
        },
        "type": "@devlikeapro/n8n-nodes-waha.WAHA",
        "typeVersion": 202502,
        "position": [
          420,
          2920
        ],
        "id": "e3ab2917-84d3-4047-b667-222e686da536",
        "name": "Send a text message10",
        "credentials": {
          "wahaApi": {
            "id": "uivlaHVGkUY1vyJT",
            "name": "WAHA account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// Ambil data dari input\nconst input = items[0].json;  // kalau di n8n\n// const input = JSON.parse(JSON.stringify(yourJson)); // kalau manual\n\n// Ambil daftar file_id yang mau dihapus\nconst toDelete = new Set(input.delete_file_ids || []);\n\n// Filter dokumen agar tidak menyertakan file_id yang ada di delete_file_ids\nconst newDocs = (input.dokumen || []).filter(doc => !toDelete.has(doc.file_id));\n\n// Buat output baru TANPA delete_file_ids\nconst { delete_file_ids, ...rest } = input;\nconst output = {\n  ...rest,\n  dokumen: newDocs,\n  status: \"terkirim\"\n};\n\n// Kembalikan hasil\nreturn [{ json: output }];\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -60,
          2780
        ],
        "id": "85c8a2c5-e697-4f3d-92e0-50df1ce4f769",
        "name": "Code15"
      },
      {
        "parameters": {
          "operation": "toJson",
          "options": {
            "fileName": "={{ DateTime.now().setZone('Asia/Tokyo').setLocale('id').toFormat('dd_MM_yyyy_HH_mm_ss') + '_' + ($json.pemohon.nama).trim().replace(/\\s+/g,'-').toUpperCase() + '_' + ($json.pemohon.nik) }}\n"
          }
        },
        "type": "n8n-nodes-base.convertToFile",
        "typeVersion": 1.1,
        "position": [
          160,
          2780
        ],
        "id": "1e076910-02be-4089-bbbd-f0b96f168ddb",
        "name": "Convert to File9"
      },
      {
        "parameters": {
          "operation": "update",
          "fileId": {
            "__rl": true,
            "value": "={{ $('Switch').item.json.id_user }}",
            "mode": "id"
          },
          "changeFileContent": true,
          "options": {}
        },
        "type": "n8n-nodes-base.googleDrive",
        "typeVersion": 3,
        "position": [
          380,
          2780
        ],
        "id": "f2b907bb-867d-48fb-aa6b-cf833cabd0e3",
        "name": "Update file8",
        "credentials": {
          "googleDriveOAuth2Api": {
            "id": "jyiiyKxh6DOyPVt5",
            "name": "Google Drive account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "/**\n * n8n Code Node ‚Äî Parse & Normalize Payload Surat + Binary Split (No Icon/Thumbnail/Binary_Prop)\n * Mode   : Run Once for All Items\n * Input  : items (array dari webhook, bisa ada binary)\n * Output : [{ json, binary }]\n */\n\nconst out = [];\n\nfor (const item of items) {\n  /* -------------------- Ambil body & normalisasi s -------------------- */\n  const rawBody = item.json?.body ?? item.json ?? {};\n  let s = null;\n\n  // Jika body sudah array (kasus Anda): ambil elemen pertama\n  if (Array.isArray(rawBody)) {\n    s = rawBody[0] ?? {};\n  } else if (typeof rawBody === 'string') {\n    // Jika body string JSON\n    try { s = JSON.parse(rawBody); } catch { s = {}; }\n  } else if (rawBody && typeof rawBody === 'object') {\n    // Bisa jadi struktur { data: ... } atau langsung payload\n    s = rawBody.data ?? rawBody;\n    if (typeof s === 'string') {\n      try { s = JSON.parse(s); } catch { s = {}; }\n    }\n  } else {\n    s = {};\n  }\n\n  /* -------------------- Utils -------------------- */\n  const has = (o, k) => Object.prototype.hasOwnProperty.call(o ?? {}, k);\n  const val = (o, k) => {\n    if (!o || typeof o !== 'object') return null;\n    if (!has(o, k)) return null;\n    const v = o[k];\n    if (v === undefined || v === '') return null;\n    return v;\n  };\n  const ensureStr = (x, fb = '-') => {\n    const v = (x ?? '').toString().trim();\n    return v.length ? v : fb;\n  };\n  const toTitleCase = (str) => {\n    if (!str) return str;\n    return str.toString().toLowerCase().replace(/\\b\\w/g, c => c.toUpperCase());\n  };\n  const lower = (x) => (x ?? '').toString().trim().toLowerCase();\n  const guessMimeFromName = (name = '') => {\n    const n = (name || '').toLowerCase();\n    if (n.endsWith('.jpg') || n.endsWith('.jpeg')) return 'image/jpeg';\n    if (n.endsWith('.png'))  return 'image/png';\n    if (n.endsWith('.pdf'))  return 'application/pdf';\n    if (n.endsWith('.docx')) return 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';\n    if (n.endsWith('.doc'))  return 'application/msword';\n    if (n.endsWith('.xlsx')) return 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';\n    if (n.endsWith('.xls'))  return 'application/vnd.ms-excel';\n    return null;\n  };\n\n  /* -------------------- Binary map (untuk multipart) -------------------- */\n  const bin = item.binary || {};\n  const binKeys = Object.keys(bin);\n\n  const binaryIndex = {};\n  for (const k of binKeys) {\n    const b = bin[k] || {};\n    const key = lower(k);\n    binaryIndex[key] = { prop: k, ...b };\n    if (b.fileName) {\n      binaryIndex[lower(b.fileName)] = { prop: k, ...b };\n    }\n  }\n\n  /* -------------------- Ambil nilai penting dari payload s -------------------- */\n  const topAction = (val(s, 'action') || '').toString().toUpperCase() || null;\n\n  // delete_file_ids (array of string)\n  const delRaw = val(s, 'delete_file_ids');\n  const deleteIds = Array.isArray(delRaw)\n    ? delRaw.filter(x => typeof x === 'string' && x.trim().length > 0)\n    : [];\n\n  /* -------------------- Dokumen -------------------- */\n  let dokumen = [];\n  if (Array.isArray(s.dokumen)) {\n    dokumen = s.dokumen.map((d = {}) => {\n      const base = {\n        name         : d?.name ?? null,\n        type         : d?.type ?? d?.mimeType ?? null,\n        file_id      : d?.file_id ?? null,\n        size         : d?.size ?? null,\n        view_url     : d?.view_url ?? null,\n        download_url : d?.download_url ?? null,\n      };\n\n      // Enrichment dari binary (cocokkan via nama/binary_prop jika ada)\n      let bMatch = null;\n      if (d?.binary_prop && binaryIndex[lower(d.binary_prop)]) {\n        bMatch = binaryIndex[lower(d.binary_prop)];\n      } else if (base.name && binaryIndex[lower(base.name)]) {\n        bMatch = binaryIndex[lower(base.name)];\n      }\n\n      if (bMatch) {\n        base.type = base.type ?? bMatch.mimeType ?? null;\n        base.size = base.size ?? (bMatch.fileSize ?? null);\n        base.name = base.name ?? bMatch.fileName ?? null;\n      }\n\n      if (!base.type && base.name) {\n        const g = guessMimeFromName(base.name);\n        if (g) base.type = g;\n      }\n\n      return base;\n    });\n  } else if (binKeys.length) {\n    // Jika tidak ada dokumen dalam JSON tapi ada binary multipart\n    dokumen = binKeys.map((k) => {\n      const b = bin[k] || {};\n      return {\n        name        : b.fileName ?? k,\n        type        : b.mimeType ?? guessMimeFromName(b.fileName ?? '') ?? null,\n        file_id     : null,\n        size        : b.fileSize ?? null,\n        view_url    : null,\n        download_url: null,\n      };\n    });\n  }\n\n  // Catatan: bila action = DELETE_DOCS, biasanya tidak perlu isi dokumen (opsional)\n  // if (topAction === 'DELETE_DOCS') dokumen = [];\n\n  /* -------------------- Pemohon & alamat -------------------- */\n  const pem = s.pemohon ?? {};\n  const kelVal   = ensureStr(val(pem, 'kelurahan/kampung') ?? val(pem, 'Kelurahan'));\n  const kecVal   = ensureStr(val(pem, 'kecamatan') ?? val(pem, 'Kecamatan'));\n  const kotaKab  = ensureStr(val(pem, 'kota_kab') ?? val(pem, 'Kabupaten') ?? val(pem, 'Kota'));\n  const provinsi = ensureStr(val(pem, 'provinsi') ?? val(pem, 'Provinsi') ?? 'Papua Tengah');\n\n  /* -------------------- Payload akhir -------------------- */\n  const payload = {\n    action   : topAction,\n    strategy : val(s, 'strategy') ?? null,\n    id_user  : val(s, 'id_user'),\n    id_surat : val(s, 'id_surat'),\n    date     : val(s, 'date'),\n\n    delete_file_ids: deleteIds,\n\n    pemohon: {\n      nama               : toTitleCase(val(pem, 'nama')),\n      nik                : val(pem, 'nik'),\n      ttl                : toTitleCase(val(pem, 'ttl')),\n      agama              : toTitleCase(val(pem, 'agama')),\n      jenis_kelamin      : toTitleCase(val(pem, 'jenis_kelamin')),\n      status_perkawinan  : toTitleCase(val(pem, 'status_perkawinan')),\n      pekerjaan          : toTitleCase(val(pem, 'pekerjaan')),\n      alamat             : toTitleCase(val(pem, 'alamat')),\n      \"kelurahan/kampung\": toTitleCase(kelVal),\n      kecamatan          : toTitleCase(kecVal),\n      kota_kab           : toTitleCase(kotaKab),\n      provinsi           : toTitleCase(provinsi),\n    },\n\n    dokumen,\n\n    WAHA_Trigger_session     : val(s, 'WAHA_Trigger_session'),\n    WAHA_Trigger_payload_from: val(s, 'WAHA_Trigger_payload_from'),\n    LogoURL                  : val(s, 'LogoURL'),\n    webhook                  : val(s, 'webhook'),\n  };\n\n  /* -------------------- Binary Split -------------------- */\n  const binKeysNow = Object.keys(item.binary || {});\n  if (binKeysNow.length === 0) {\n    out.push({ json: payload });\n  } else {\n    for (const k of binKeysNow) {\n      out.push({\n        json  : { ...payload, binaryProperty: k },\n        binary: { [k]: item.binary[k] },\n      });\n    }\n  }\n}\n\nreturn out;\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -580,
          3360
        ],
        "id": "d8a95594-6dea-4c5d-905e-a7e05e3aff1a",
        "name": "Code16"
      },
      {
        "parameters": {
          "rules": {
            "values": [
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "leftValue": "={{ $json.pemohon[\"kelurahan/kampung\"] }}",
                      "rightValue": "Inauga",
                      "operator": {
                        "type": "string",
                        "operation": "equals"
                      },
                      "id": "9d02af7b-4ad2-4636-b779-c24ad20574ff"
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Inauga"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "218927f5-f51f-471f-be4a-010701020f4f",
                      "leftValue": "={{ $json.pemohon[\"kelurahan/kampung\"] }}",
                      "rightValue": "Kamoro Jaya",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Kamoro Jaya"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "434f5383-4146-481b-ac6a-21e3af3a816a",
                      "leftValue": "={{ $json.pemohon[\"kelurahan/kampung\"] }}",
                      "rightValue": "Wonosari Jaya",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Wonosari Jaya"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "85b276dd-7c0a-4a6b-adb0-2778e24fe319",
                      "leftValue": "={{ $json.pemohon[\"kelurahan/kampung\"] }}",
                      "rightValue": "Kadun Jaya",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Kadun Jaya"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "1ef4e71e-4e0b-4555-b29d-552a3a595364",
                      "leftValue": "={{ $json.pemohon[\"kelurahan/kampung\"] }}",
                      "rightValue": "Mandiri Jaya",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Mandiri Jaya"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "ac69d6ab-7383-4492-bbdc-ae9ab541346c",
                      "leftValue": "={{ $json.pemohon[\"kelurahan/kampung\"] }}",
                      "rightValue": "Mawokau Jaya",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Mawokau Jaya"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "ff40f43b-2fe7-4567-8ec8-cdeca15f5807",
                      "leftValue": "={{ $json.pemohon[\"kelurahan/kampung\"] }}",
                      "rightValue": "Nawaripi",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Nawaripi"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.switch",
        "typeVersion": 3.2,
        "position": [
          -320,
          3240
        ],
        "id": "1548f910-a915-4b06-8e11-5c156f4359bb",
        "name": "Switch1"
      }
    ],
    "connections": {
      "Data Input": {
        "main": [
          [
            {
              "node": "Code",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Generate HTML": {
        "main": [
          [
            {
              "node": "Create Web Warga",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Code": {
        "main": [
          [
            {
              "node": "Convert to File",
              "type": "main",
              "index": 0
            },
            {
              "node": "Create Folder Warga",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Convert to File": {
        "main": [
          [
            {
              "node": "Extract from File1",
              "type": "main",
              "index": 0
            },
            {
              "node": "Merge4",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Code1": {
        "main": [
          [
            {
              "node": "Convert to File1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Convert to File1": {
        "main": [
          [
            {
              "node": "Update file",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Update file": {
        "main": [
          [
            {
              "node": "Send a text message4",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Extract from File1": {
        "main": [
          [
            {
              "node": "Merge",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Merge1": {
        "main": [
          [
            {
              "node": "Code1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Upload file2": {
        "main": [
          [
            {
              "node": "Merge1",
              "type": "main",
              "index": 1
            }
          ]
        ]
      },
      "Code2": {
        "main": [
          [
            {
              "node": "Upload file2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Uploud File": {
        "main": [
          [
            {
              "node": "Code2",
              "type": "main",
              "index": 0
            },
            {
              "node": "Merge1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Code3": {
        "main": [
          [
            {
              "node": "Convert to File3",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Convert to File3": {
        "main": [
          [
            {
              "node": "Update file2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Update Data": {
        "main": [
          [
            {
              "node": "Code3",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "HTML1": {
        "main": [
          [
            {
              "node": "HTTP Request",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Code5": {
        "main": [
          [
            {
              "node": "Convert to File5",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Convert to File5": {
        "main": [
          [
            {
              "node": "Update file4",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Update file4": {
        "main": [
          [
            {
              "node": "If",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "If": {
        "main": [
          [
            {
              "node": "Delete File",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Delete file": {
        "main": [
          [
            {
              "node": "Code5",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Hapus Surat": {
        "main": [
          [
            {
              "node": "Code4",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Code4": {
        "main": [
          [
            {
              "node": "Hapus Semua",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Code6": {
        "main": [
          [
            {
              "node": "Merge3",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Convert to File2": {
        "main": [
          [
            {
              "node": "Upload file3",
              "type": "main",
              "index": 0
            },
            {
              "node": "Extract from File2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Upload file3": {
        "main": [
          [
            {
              "node": "Merge2",
              "type": "main",
              "index": 1
            }
          ]
        ]
      },
      "Extract from File2": {
        "main": [
          [
            {
              "node": "Merge2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Merge2": {
        "main": [
          [
            {
              "node": "HTML",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "HTML": {
        "main": [
          [
            {
              "node": "HTTP Request1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Kirim data": {
        "main": [
          [
            {
              "node": "Code16",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Upload file4": {
        "main": [
          [
            {
              "node": "Send a text message1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Webhook": {
        "main": [
          [
            {
              "node": "Upload file4",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Code7": {
        "main": [
          [
            {
              "node": "Download file",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Code8": {
        "main": [
          [
            {
              "node": "Upload file5",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Download file": {
        "main": [
          [
            {
              "node": "Code8",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Upload file5": {
        "main": [
          [
            {
              "node": "Merge3",
              "type": "main",
              "index": 1
            }
          ]
        ]
      },
      "Merge3": {
        "main": [
          [
            {
              "node": "Code9",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Code9": {
        "main": [
          [
            {
              "node": "Convert to File2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Webhook1": {
        "main": [
          [
            {
              "node": "Send a text message2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Write Surat Usaha": {
        "main": [
          [
            {
              "node": "Saved Surat Usaha",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Saved Surat Usaha": {
        "main": [
          [
            {
              "node": "Extract from File",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get Link Surat Usaha": {
        "main": [
          [
            {
              "node": "Send Link Surat  Gmail",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Send Link Surat  Gmail": {
        "main": [
          [
            {
              "node": "Send Link Surat Wa",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Extract from File": {
        "main": [
          [
            {
              "node": "Send a file",
              "type": "main",
              "index": 0
            },
            {
              "node": "Send a file1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Webhook2": {
        "main": [
          [
            {
              "node": "Copy file",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "If1": {
        "main": [
          [
            {
              "node": "Merge3",
              "type": "main",
              "index": 1
            }
          ]
        ]
      },
      "Copy file": {
        "main": [
          [
            {
              "node": "Write Surat Usaha",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Create Json Data Warga": {
        "main": [
          [
            {
              "node": "Merge",
              "type": "main",
              "index": 1
            }
          ]
        ]
      },
      "Create Web Warga": {
        "main": [
          [
            {
              "node": "Send a text message",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Create Folder Warga": {
        "main": [
          [
            {
              "node": "Merge4",
              "type": "main",
              "index": 1
            }
          ]
        ]
      },
      "Merge": {
        "main": [
          [
            {
              "node": "HTML1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Merge4": {
        "main": [
          [
            {
              "node": "Create Json Data Warga",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Webhook3": {
        "main": [
          [
            {
              "node": "Code10",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Switch": {
        "main": [
          [
            {
              "node": "Convert to File6",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Merge6",
              "type": "main",
              "index": 0
            },
            {
              "node": "Upload file",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Code14",
              "type": "main",
              "index": 0
            },
            {
              "node": "Code11",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Code13",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "HTTP Request2",
              "type": "main",
              "index": 0
            },
            {
              "node": "Code15",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Convert to File6": {
        "main": [
          [
            {
              "node": "Update file5",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Update file5": {
        "main": [
          [
            {
              "node": "Send a text message5",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Code10": {
        "main": [
          [
            {
              "node": "Switch",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Upload file": {
        "main": [
          [
            {
              "node": "Merge6",
              "type": "main",
              "index": 1
            }
          ]
        ]
      },
      "Merge6": {
        "main": [
          [
            {
              "node": "Code12",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Code12": {
        "main": [
          [
            {
              "node": "Convert to File4",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Convert to File4": {
        "main": [
          [
            {
              "node": "Update file1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Update file1": {
        "main": [
          [
            {
              "node": "Send a text message6",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Code11": {
        "main": [
          [
            {
              "node": "Delete File1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Delete File1": {
        "main": [
          [
            {
              "node": "Send a text message9",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Code13": {
        "main": [
          [
            {
              "node": "Hapus Semua1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Hapus Semua1": {
        "main": [
          [
            {
              "node": "Send a text message7",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Convert to File8": {
        "main": [
          [
            {
              "node": "Update file7",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Code14": {
        "main": [
          [
            {
              "node": "Convert to File8",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "HTTP Request2": {
        "main": [
          [
            {
              "node": "Send a text message8",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Send a text message8": {
        "main": [
          [
            {
              "node": "Send a text message10",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Code15": {
        "main": [
          [
            {
              "node": "Convert to File9",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Convert to File9": {
        "main": [
          [
            {
              "node": "Update file8",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Code16": {
        "main": [
          [
            {
              "node": "Switch1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      }
    },
    "authors": "system migration",
    "name": null,
    "description": null
  },
  "tags": []
}