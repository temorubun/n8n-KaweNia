{
  "updatedAt": "2025-12-05T04:36:01.000Z",
  "createdAt": "2025-11-08T03:42:00.600Z",
  "id": "Of4owcqlYUvIxQUd",
  "name": "My workflow 40",
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "737cd7f5-bfa1-4b9c-b55a-21aa718bfc3d",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -160,
        288
      ],
      "id": "f04e12fd-23ed-4ece-9cb1-63e8c24f0d58",
      "name": "C1",
      "webhookId": "737cd7f5-bfa1-4b9c-b55a-21aa718bfc3d"
    },
    {
      "parameters": {
        "jsCode": "const WEBHOOK_ADMIN1 = \"https://n8n-qz8tp6856ibc.bgxy.sumopod.my.id/webhook/646a0ac9-0b1c-4283-ae20-fe42f0ad4384\";\nconst WEBHOOK_ADMIN2 = \"https://n8n-qz8tp6856ibc.bgxy.sumopod.my.id/webhook/90080618-2925-4277-9650-c16ba0c6b5eb\";\n\n/**\n * n8n Code Node â€” Parse & Normalize Payload Surat + Binary Split (No Icon/Thumbnail/Binary_Prop)\n * Mode   : Run Once for All Items\n * Input  : items (array dari webhook, bisa ada binary)\n * Output : [{ json, binary }]\n */\n\nconst out = [];\n\n/* -------------------- Utils -------------------- */\nconst has = (o, k) => Object.prototype.hasOwnProperty.call(o ?? {}, k);\nconst val = (o, k) => {\n  if (!o || typeof o !== 'object') return null;\n  if (!has(o, k)) return null;\n  const v = o[k];\n  if (v === undefined || v === '') return null;\n  return v;\n};\nconst ensureStr = (x, fb = '-') => {\n  const v = (x ?? '').toString().trim();\n  return v.length ? v : fb;\n};\nconst toTitleCase = (str) => {\n  if (!str) return str;\n  return str.toString().toLowerCase().replace(/\\b\\w/g, c => c.toUpperCase());\n};\nconst lower = (x) => (x ?? '').toString().trim().toLowerCase();\nconst stripCUs = (jid = '') => jid.replace(/@c\\.us$/i, '');\nconst onlyDigits = (s = '') => (s.match(/\\d+/g) || []).join('');\nconst guessMimeFromName = (name = '') => {\n  const n = (name || '').toLowerCase();\n  if (n.endsWith('.jpg') || n.endsWith('.jpeg')) return 'image/jpeg';\n  if (n.endsWith('.png'))  return 'image/png';\n  if (n.endsWith('.pdf'))  return 'application/pdf';\n  if (n.endsWith('.docx')) return 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';\n  if (n.endsWith('.doc'))  return 'application/msword';\n  if (n.endsWith('.xlsx')) return 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';\n  if (n.endsWith('.xls'))  return 'application/vnd.ms-excel';\n  return null;\n};\n\nfor (const item of items) {\n  /* -------------------- Ambil body & normalisasi s -------------------- */\n  const rawBody = item.json?.body ?? item.json ?? {};\n  let s;\n\n  if (Array.isArray(rawBody)) {\n    s = rawBody[0] ?? {};\n  } else if (typeof rawBody === 'string') {\n    try { s = JSON.parse(rawBody); } catch { s = {}; }\n  } else if (rawBody && typeof rawBody === 'object') {\n    s = rawBody.data ?? rawBody;\n    if (typeof s === 'string') {\n      try { s = JSON.parse(s); } catch { s = {}; }\n    }\n  } else {\n    s = {};\n  }\n\n  /* -------------------- Binary map -------------------- */\n  const bin = item.binary || {};\n  const binKeys = Object.keys(bin);\n  const binaryIndex = {};\n  for (const k of binKeys) {\n    const b = bin[k] || {};\n    const key = lower(k);\n    binaryIndex[key] = { prop: k, ...b };\n    if (b.fileName) binaryIndex[lower(b.fileName)] = { prop: k, ...b };\n  }\n\n  /* -------------------- Dokumen -------------------- */\n  let dokumen = [];\n  if (Array.isArray(s.dokumen)) {\n    dokumen = s.dokumen.map((d = {}) => {\n      const base = {\n        name         : d?.name ?? null,\n        type         : d?.type ?? d?.mimeType ?? null,\n        file_id      : d?.file_id ?? null,\n        size         : d?.size ?? null,\n        view_url     : d?.view_url ?? null,\n        download_url : d?.download_url ?? null,\n      };\n\n      let bMatch = null;\n      if (d?.binary_prop && binaryIndex[lower(d.binary_prop)]) {\n        bMatch = binaryIndex[lower(d.binary_prop)];\n      } else if (base.name && binaryIndex[lower(base.name)]) {\n        bMatch = binaryIndex[lower(base.name)];\n      }\n\n      if (bMatch) {\n        base.type = base.type ?? bMatch.mimeType ?? null;\n        base.size = base.size ?? (bMatch.fileSize ?? null);\n        base.name = base.name ?? bMatch.fileName ?? null;\n      }\n\n      if (!base.type && base.name) {\n        const g = guessMimeFromName(base.name);\n        if (g) base.type = g;\n      }\n\n      return base;\n    });\n  } else if (binKeys.length) {\n    dokumen = binKeys.map((k) => {\n      const b = bin[k] || {};\n      return {\n        name        : b.fileName ?? k,\n        type        : b.mimeType ?? guessMimeFromName(b.fileName ?? '') ?? null,\n        file_id     : null,\n        size        : b.fileSize ?? null,\n        view_url    : null,\n        download_url: null,\n      };\n    });\n  }\n\n  /* -------------------- Pemohon & alamat -------------------- */\n  const pem = s.pemohon ?? {};\n  const kelVal   = ensureStr(val(pem, 'kelurahan/kampung') ?? val(pem, 'Kelurahan'));\n  const kecVal   = ensureStr(val(pem, 'kecamatan') ?? val(pem, 'Kecamatan'));\n  const kotaKab  = ensureStr(val(pem, 'kota_kab') ?? val(pem, 'Kabupaten') ?? val(pem, 'Kota'));\n  const provinsi = ensureStr(val(pem, 'provinsi') ?? val(pem, 'Provinsi') ?? 'Papua Tengah');\n\n  /* -------------------- WAHA fields & status -------------------- */\n  const wSession       = val(s, 'WAHA_Trigger_session');\n  const wFromGeneric   = val(s, 'WAHA_Trigger_payload_from'); // kompat lama\n  const wFromUser      = val(s, 'WAHA_Trigger_payload_from_user')   ?? wFromGeneric ?? null;\n  const wFromAdmin1    = val(s, 'WAHA_Trigger_payload_from_admin1') ?? null;\n  const wFromAdmin2    = val(s, 'WAHA_Trigger_payload_from_admin2') ?? null;\n\n  // Turunan handy (JID/number/no_suffix) untuk masing-masing\n  const wUser_jid      = wFromUser   || null;\n  const wAdmin1_jid    = wFromAdmin1 || null;\n  const wAdmin2_jid    = wFromAdmin2 || null;\n\n  const wUser_number   = wUser_jid   ? onlyDigits(stripCUs(wUser_jid))   : null;\n  const wAdmin1_number = wAdmin1_jid ? onlyDigits(stripCUs(wAdmin1_jid)) : null;\n  const wAdmin2_number = wAdmin2_jid ? onlyDigits(stripCUs(wAdmin2_jid)) : null;\n\n  const wUser_no_suffix   = wUser_jid   ? stripCUs(wUser_jid)   : null;\n  const wAdmin1_no_suffix = wAdmin1_jid ? stripCUs(wAdmin1_jid) : null;\n  const wAdmin2_no_suffix = wAdmin2_jid ? stripCUs(wAdmin2_jid) : null;\n\n  const session_lower  = lower(wSession);\n\n  const statusWebUser    = lower(val(s, 'status_web_user'));\n  const statusWebAdmin1  = lower(val(s, 'status_web_admin1'));\n\n  // --- Penentuan routing (tujuan pengiriman pesan) ---\n  let send_to = null; // 'admin1' | 'admin2' | null\n  if (statusWebAdmin1 === 'terkirim') {\n    send_to = 'admin2';\n  } else if (statusWebUser === 'terkirim') {\n    send_to = 'admin1';\n  }\n\n  // --- Seleksi webhook berdasarkan status (prioritas admin2 jika keduanya \"terkirim\") ---\n  let selectedWebhook = null;\n  if (statusWebAdmin1 === 'terkirim') {\n    selectedWebhook = WEBHOOK_ADMIN2;\n  } else if (statusWebUser === 'terkirim') {\n    selectedWebhook = WEBHOOK_ADMIN1;\n  }\n\n  /* -------------------- Payload akhir -------------------- */\n  const payload = {\n    id_user  : val(s, 'id_user'),\n    id_surat : val(s, 'id_surat'),\n    date     : val(s, 'date'),\n\n    pemohon: {\n      nama               : toTitleCase(val(pem, 'nama')),\n      nik                : val(pem, 'nik'),\n      ttl                : toTitleCase(val(pem, 'ttl')),\n      agama              : toTitleCase(val(pem, 'agama')),\n      jenis_kelamin      : toTitleCase(val(pem, 'jenis_kelamin')),\n      status_perkawinan  : toTitleCase(val(pem, 'status_perkawinan')),\n      pekerjaan          : toTitleCase(val(pem, 'pekerjaan')),\n      alamat             : toTitleCase(val(pem, 'alamat')),\n      \"kelurahan/kampung\": toTitleCase(kelVal),\n      kecamatan          : toTitleCase(kecVal),\n      kota_kab           : toTitleCase(kotaKab),\n      provinsi           : toTitleCase(provinsi),\n    },\n\n    dokumen,\n\n    // ---- WAHA session ----\n    WAHA_Trigger_session: wSession,\n\n    // ---- WAHA asal (user) lengkap ----\n    WAHA_Trigger_payload_from_user  : wUser_jid,\n\n    // ---- WAHA admin1 lengkap ----\n    WAHA_Trigger_payload_from_admin1: wAdmin1_jid,\n\n    // ---- WAHA admin2 lengkap ----\n    WAHA_Trigger_payload_from_admin2: wAdmin2_jid,\n\n    // ---- Status & routing ----\n    status_web_user   : statusWebUser || null,\n    status_web_admin1 : statusWebAdmin1 || null,\n    send_to,\n\n    // ---- Branding dan webhook (dipilih dinamis) ----\n    LogoURL : val(s, 'LogoURL'),\n    webhook : selectedWebhook, // null jika belum ada status \"terkirim\"\n  };\n\n  // >>>>> Tambahan: simpan id_admin1 hanya jika status_web_admin1 === \"terkirim\"\n  if (statusWebAdmin1 === 'terkirim') {\n    const idAdmin1 = val(s, 'id_admin1');\n    if (idAdmin1) {\n      payload.id_admin1 = idAdmin1;\n    }\n  }\n  // <<<<< Akhir tambahan\n\n  /* -------------------- Binary Split -------------------- */\n  const binKeysNow = Object.keys(item.binary || {});\n  if (binKeysNow.length === 0) {\n    out.push({ json: payload });\n  } else {\n    for (const k of binKeysNow) {\n      out.push({\n        json  : { ...payload, binaryProperty: k },\n        binary: { [k]: item.binary[k] },\n      });\n    }\n  }\n}\n\nreturn out;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -16,
        288
      ],
      "id": "562e24b0-7645-43f7-9424-50fec0715185",
      "name": "C2"
    },
    {
      "parameters": {
        "jsCode": "/**\n * n8n Code Node â€” Routing by Wilayah + District Layer + send_to Switch (No Abbreviations)\n * Output hanya: target_info\n */\n\n// ---------- 1) Ambil & normalisasi input ----------\nlet raw = items?.[0]?.json ?? {};\nif (Array.isArray(raw)) raw = raw[0] ?? {};\nif (typeof raw !== 'object' || raw === null) raw = {};\nconst input = raw;\n\n// ---------- 2) Konstanta folder: Kampung Nawaripi (REAL) ----------\nconst FOLDER_DATA_KAMPUNG_NAWARIPI           = \"1hIREd6Yh7NdZ_E46ZG9YkCk5tRpU1c1_\";\nconst FOLDER_FILES_KAMPUNG_NAWARIPI          = \"1D7qloJy8RtSzhUmG_YZaqI7aZOZ6e8ZB\";\nconst FOLDER_WEB_KAMPUNG_NAWARIPI            = \"1BM7UHbkq2ocY4_Z10vWKfa88-nfThlVg\";\n\n// ---------- 2a) Konstanta DISTRIK (ganti dengan ID Drive asli) ----------\nconst FOLDER_DATA_DISTRIK_WANIA              = \"1kBFEzprLwGZpWCfhEuBuSRsD6nGwcocv\";\nconst FOLDER_FILES_DISTRIK_WANIA             = \"1QvOgj4hSA4uhJxzsM5AillUxbAXQzUlc\";\nconst FOLDER_WEB_DISTRIK_WANIA               = \"1sJ7OVRRHgsXYLWvL3AOaBDlNTpv8H8_l\";\n\n// ---------- 3) Konstanta folder DUMMY wilayah lain (tanpa singkatan) ----------\nconst FOLDER_DATA_KELURAHAN_INAUGA           = \"1Psjpxg5PZoXMoqIzdOw_D7MhembOrew2\";\nconst FOLDER_FILES_KELURAHAN_INAUGA          = \"1rPjrj6cfs7jalkxh-UgVN7-0J67V2S2S\";\nconst FOLDER_WEB_KELURAHAN_INAUGA            = \"1J6elsBYDskIK7OYsp_P5ncut-iF7LvjO\";\n\nconst FOLDER_DATA_KELURAHAN_KAMORO_JAYA      = \"17vivJrU4XuKSLJUYvWknovYmaUw4BHhi\";\nconst FOLDER_FILES_KELURAHAN_KAMORO_JAYA     = \"1EFzNH0X0nap4wu5BiQpg0qMny349R6ya\";\nconst FOLDER_WEB_KELURAHAN_KAMORO_JAYA       = \"1BMvavKxrS8hDbYZQL95B7tzBDkgxcfCc\";\n\nconst FOLDER_DATA_KELURAHAN_WONOSARI_JAYA    = \"1pssm2tYoh6XUP-piZv-jZ8vSiEcnV2xH\";\nconst FOLDER_FILES_KELURAHAN_WONOSARI_JAYA   = \"1JYWPhg4naagkTALnalVduraCYE40pjvu\";\nconst FOLDER_WEB_KELURAHAN_WONOSARI_JAYA     = \"1FlONRDxyRTDFWemG1NOMVtAqRjZoBEHv\";\n\nconst FOLDER_DATA_KAMPUNG_KADUN_JAYA         = \"17e8brrM7yu85aRodqqcEdBX2RyengYPD\";\nconst FOLDER_FILES_KAMPUNG_KADUN_JAYA        = \"1jpCcpv-lrmFjGN6__7FmYHdsgsZOWHQW\";\nconst FOLDER_WEB_KAMPUNG_KADUN_JAYA          = \"1miXC_3vxTFiAS-efHmjFgPHNaPgvjhzj\";\n\nconst FOLDER_DATA_KAMPUNG_MANDIRI_JAYA       = \"185NBss1mDTvbHUg6MGQ-wD_D6H_MWCfG\";\nconst FOLDER_FILES_KAMPUNG_MANDIRI_JAYA      = \"1L9ArpMf2UOwrLGJim7ycYQ-TvbchbEN4\";\nconst FOLDER_WEB_KAMPUNG_MANDIRI_JAYA        = \"1l5BX7UEqNAwjOZ7IU2ZoIdcW_yGUa01E\";\n\nconst FOLDER_DATA_KAMPUNG_MAWOKAU_JAYA       = \"12Er95d1P_RKKAvqUHOhEhg-nrGtOwBcO\";\nconst FOLDER_FILES_KAMPUNG_MAWOKAU_JAYA      = \"114TshKE5DpeGOtrlvVwCkm5Aly8Nwpe0\";\nconst FOLDER_WEB_KAMPUNG_MAWOKAU_JAYA        = \"1XdgqXb4d-ucs7toEUD2MqvMCeOyDF9FH\";\n\n// ---------- 4) Helper ----------\nfunction canonicalizeWilayah(s) {\n  if (typeof s !== \"string\") return \"\";\n  let v = s.trim().toLowerCase();\n  if (v.startsWith(\"kelurahan \")) v = v.slice(\"kelurahan \".length);\n  if (v.startsWith(\"kampung \"))  v = v.slice(\"kampung \".length);\n  v = v.replace(/\\s+/g, \" \").trim();\n  return v.split(\" \").map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(\" \");\n}\n\nfunction readWilayahRaw() {\n  return (\n    input?.pemohon?.[\"kelurahan/kampung\"] ??\n    input?.pemohon?.kelurahan_kampung ??\n    input?.[\"kelurahan/kampung\"] ?? \"\"\n  );\n}\n\nfunction readSendTo() {\n  const v = (input?.send_to ?? \"\").toString().trim().toLowerCase();\n  return v === \"admin2\" ? \"admin2\" : (v === \"admin1\" ? \"admin1\" : \"unknown\");\n}\n\n// ---------- 5) Pemetaan wilayah (gunakan nama lengkap konstanta) ----------\nconst ROUTES = {\n  \"Nawaripi\": {\n    labelFull: \"Kampung Nawaripi\",\n    data:  FOLDER_DATA_KAMPUNG_NAWARIPI,\n    files: FOLDER_FILES_KAMPUNG_NAWARIPI,\n    web:   FOLDER_WEB_KAMPUNG_NAWARIPI,\n  },\n  \"Inauga\": {\n    labelFull: \"Kelurahan Inauga\",\n    data:  FOLDER_DATA_KELURAHAN_INAUGA,\n    files: FOLDER_FILES_KELURAHAN_INAUGA,\n    web:   FOLDER_WEB_KELURAHAN_INAUGA,\n  },\n  \"Kamoro Jaya\": {\n    labelFull: \"Kelurahan Kamoro Jaya\",\n    data:  FOLDER_DATA_KELURAHAN_KAMORO_JAYA,\n    files: FOLDER_FILES_KELURAHAN_KAMORO_JAYA,\n    web:   FOLDER_WEB_KELURAHAN_KAMORO_JAYA,\n  },\n  \"Wonosari Jaya\": {\n    labelFull: \"Kelurahan Wonosari Jaya\",\n    data:  FOLDER_DATA_KELURAHAN_WONOSARI_JAYA,\n    files: FOLDER_FILES_KELURAHAN_WONOSARI_JAYA,\n    web:   FOLDER_WEB_KELURAHAN_WONOSARI_JAYA,\n  },\n  \"Kadun Jaya\": {\n    labelFull: \"Kampung Kadun Jaya\",\n    data:  FOLDER_DATA_KAMPUNG_KADUN_JAYA,\n    files: FOLDER_FILES_KAMPUNG_KADUN_JAYA,\n    web:   FOLDER_WEB_KAMPUNG_KADUN_JAYA,\n  },\n  \"Mandiri Jaya\": {\n    labelFull: \"Kampung Mandiri Jaya\",\n    data:  FOLDER_DATA_KAMPUNG_MANDIRI_JAYA,\n    files: FOLDER_FILES_KAMPUNG_MANDIRI_JAYA,\n    web:   FOLDER_WEB_KAMPUNG_MANDIRI_JAYA,\n  },\n  \"Mawokau Jaya\": {\n    labelFull: \"Kampung Mawokau Jaya\",\n    data:  FOLDER_DATA_KAMPUNG_MAWOKAU_JAYA,\n    files: FOLDER_FILES_KAMPUNG_MAWOKAU_JAYA,\n    web:   FOLDER_WEB_KAMPUNG_MAWOKAU_JAYA,\n  },\n};\n\nconst DEFAULT_ROUTE = {\n  labelFull: readWilayahRaw() || \"-\",\n  data:  \"DUMMY_DEFAULT_DATA_0x9qLr7T\",\n  files: \"DUMMY_DEFAULT_FILES_wQ1zV5eR\",\n  web:   \"DUMMY_DEFAULT_WEB_pT8mN2aQ\",\n};\n\n// ---------- 6) Resolve ----------\nconst wilayahCanonical = canonicalizeWilayah(readWilayahRaw());\nconst wilayah = ROUTES[wilayahCanonical] ?? DEFAULT_ROUTE;\n\nconst DISTRIK_WANIA = {\n  key: \"WANIA\",\n  labelFull: \"Distrik Wania\",\n  data:  FOLDER_DATA_DISTRIK_WANIA,\n  files: FOLDER_FILES_DISTRIK_WANIA,\n  web:   FOLDER_WEB_DISTRIK_WANIA,\n};\n\n// ---------- 7) Pilih target berdasarkan send_to ----------\nconst sendTo = readSendTo();\n\nlet target_info;\nif (sendTo === \"admin1\") {\n  target_info = {\n    level: \"wilayah\",\n    target_label_full: wilayah.labelFull,\n    folder_data_id:  wilayah.data,\n    folder_files_id: wilayah.files,\n    folder_web_id:   wilayah.web,\n  };\n} else if (sendTo === \"admin2\") {\n  target_info = {\n    level: \"distrik\",\n    target_label_full: DISTRIK_WANIA.labelFull,\n    folder_data_id:  DISTRIK_WANIA.data,\n    folder_files_id: DISTRIK_WANIA.files,\n    folder_web_id:   DISTRIK_WANIA.web,\n  };\n} else {\n  target_info = {\n    level: \"wilayah\",\n    target_label_full: wilayah.labelFull,\n    folder_data_id:  wilayah.data,\n    folder_files_id: wilayah.files,\n    folder_web_id:   wilayah.web,\n    warning: \"send_to tidak valid; default ke wilayah (admin1).\",\n  };\n}\n\n// ---------- 8) Output ----------\nconst output = {\n  ...input,\n  send_to: sendTo,\n  target_info, // hanya ini yang digunakan downstream\n};\n\nreturn [{ json: output }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        128,
        288
      ],
      "id": "bd830cb2-8ff0-4111-8dbb-d984fae591f2",
      "name": "C3"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "5af2b097-ff31-46e8-86d8-1dcb4800c60b",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        1664,
        608
      ],
      "id": "360462b0-8aa9-42dc-b2fe-914c1f6b4aa9",
      "name": "Ca1",
      "webhookId": "5af2b097-ff31-46e8-86d8-1dcb4800c60b"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        1952,
        624
      ],
      "id": "3faf1d53-d410-4a06-83a5-977c1de037b2",
      "name": "Ca3"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Buatkan surat untuk: \nKepada Yth.\nBapak Kepala {{ $('Ca1').item.json.query['kampung/kelurahan'] }} ðŸŒ¿\n\nDengan hormat,\n\nDisampaikan bahwa surat atas nama:\n\nNama Pemohon : {{ $('Ca1').item.json.query.Nama }}\nNomor KTP : {{ $('Ca1').item.json.query.NIK }}\n\ntelah selesai dibuat ðŸ“„ beserta data dan laman pendukungnya.\nMohon kiranya Bapak berkenan melakukan pemeriksaan ðŸ”, validasi âœ…, serta memberikan persetujuan dan tanda tangan âœðŸ».\n\nDokumen tersebut dapat diakses melalui tautan berikut:\nðŸ”— https://distrikwania.com/data/{{ $json.id }}\n\nAtas perhatian dan kerjasama Bapak, disampaikan terima kasih ðŸ™ðŸ».\nSemoga Tuhan Yang Maha Kuasa senantiasa memberkati setiap tugas dan pelayanan Bapak âœ¨.\n\nSalam hormat,\nKawe Nia ðŸ¤\nAsisten Digital Distrik Wania",
        "options": {
          "systemMessage": "=ðŸ“Œ GAYA BAHASA\nGunakan sapaan sesuai budaya: Bapa / Mama / Saudara / Nona / Ade\nhindari panggilan kami, saya (karena Kawe Nia berbicara sebagai pribadi).\nGunakan kalimat positif, menenangkan, dan penuh empati.\nTambahkan emotikon hangat \nAkhiri dengan ucapan berkat: â€œTuhan memberkatiâ€ \nTambahkan emotikon hangat "
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        2256,
        624
      ],
      "id": "01605bd2-a239-4442-835d-139897e43dab",
      "name": "KaweNia-Ca1"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Buatkan surat untuk: \nKepada Yth.\nIbu Kepala Distrik Wania ðŸŒ¸\n\nDengan hormat,\n\nDisampaikan bahwa warga {{ $('Ca1').item.json.query['kampung/kelurahan'] }} atas nama:\n\nNama Pemohon : {{ $('Ca1').item.json.query.Nama }}\nNomor KTP : {{ $('Ca1').item.json.query.NIK }}\n\ntelah mengirim surat kepada Bapak Kepala {{ $('Ca1').item.json.query['kampung/kelurahan'] }} âœ‰ï¸.\nSaat ini, surat tersebut sedang dalam proses pemeriksaan dan validasi ðŸ” di tingkat {{ $('Ca1').item.json.query['kampung/kelurahan'] }}.\n\nDokumen dapat diakses melalui tautan berikut:\nðŸ”— https://distrikwania.com/data/{{\n $json.id }}\n\nSetelah validasi selesai, surat akan diteruskan kepada Ibu untuk persetujuan lebih lanjut ðŸ“Œ.\n\nAtas perhatian Ibu, disampaikan terima kasih ðŸ™ðŸ».\n\nSalam hormat,\nKawe Nia ðŸ¤\nAsisten Digital Distrik Wania",
        "options": {
          "systemMessage": "=ðŸ“Œ GAYA BAHASA\nGunakan sapaan sesuai budaya: Bapa / Mama / Saudara / Nona / Ade\nhindari panggilan kami, saya (karena Kawe Nia berbicara sebagai pribadi).\nGunakan kalimat positif, menenangkan, dan penuh empati.\nTambahkan emotikon hangat \nAkhiri dengan ucapan berkat: â€œTuhan memberkatiâ€ \nTambahkan emotikon hangat "
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        2704,
        624
      ],
      "id": "dabf9ed1-ad5c-4478-8c15-d3a1b76ea22f",
      "name": "KaweNia-Ca2"
    },
    {
      "parameters": {
        "name": "={{ $json.query.name_file }}",
        "driveId": {
          "__rl": true,
          "mode": "list",
          "value": "My Drive"
        },
        "folderId": {
          "__rl": true,
          "value": "={{ $json.query.id_folder }}",
          "mode": "id"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        1808,
        672
      ],
      "id": "b3240580-ae0e-46cf-a4ea-eeacc5068aad",
      "name": "Ca2",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "K6YEbjdSQULsuuJd",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "resource": "Chatting",
        "operation": "Send Text",
        "session": "={{ $('Ca1').item.json.query.session_waha }}",
        "chatId": "={{ $('Ca1').item.json.query.id_waha_admin2 }}",
        "text": "={{ $json.output }}",
        "requestOptions": {}
      },
      "type": "@devlikeapro/n8n-nodes-waha.WAHA",
      "typeVersion": 202502,
      "position": [
        3600,
        624
      ],
      "id": "9c33e013-795d-42ea-99bb-8a1ccef87fb4",
      "name": "Ca8",
      "credentials": {
        "wahaApi": {
          "id": "uivlaHVGkUY1vyJT",
          "name": "WAHA account"
        }
      }
    },
    {
      "parameters": {
        "resource": "Chatting",
        "operation": "Send Text",
        "session": "={{ $('Ca1').item.json.query.session_waha }}",
        "chatId": "={{ $('Ca1').item.json.query.id_waha_admin2 }}",
        "text": "={{ $json.output }}",
        "requestOptions": {}
      },
      "type": "@devlikeapro/n8n-nodes-waha.WAHA",
      "typeVersion": 202502,
      "position": [
        2976,
        624
      ],
      "id": "f2faa0b0-f494-4e00-8d78-48e8360d7807",
      "name": "Ca7",
      "credentials": {
        "wahaApi": {
          "id": "uivlaHVGkUY1vyJT",
          "name": "WAHA account"
        }
      }
    },
    {
      "parameters": {
        "resource": "Chatting",
        "operation": "Send Text",
        "session": "={{ $('Ca1').item.json.query.session_waha }}",
        "chatId": "={{ $('Ca1').item.json.query.id_waha_admin1 }}",
        "text": "={{ $json.output }}",
        "requestOptions": {}
      },
      "type": "@devlikeapro/n8n-nodes-waha.WAHA",
      "typeVersion": 202502,
      "position": [
        2528,
        624
      ],
      "id": "f1ada2e9-0efc-4b4d-9173-2404376bb0c9",
      "name": "Ca6",
      "credentials": {
        "wahaApi": {
          "id": "uivlaHVGkUY1vyJT",
          "name": "WAHA account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "/**\n * n8n Code Node â€” If send_to == admin1\n * Mode: Run Once for All Items\n */\nconst input = items[0]?.json ?? {};\nconst sendTo = String(input?.query?.send_to ?? input?.send_to ?? '').trim().toLowerCase();\n\nif (sendTo === 'admin1') {\n  return items;   // lanjut\n} else {\n  return [];      // stop\n}\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2096,
        624
      ],
      "id": "8d54c071-8bf4-44b6-b69d-98f32906b7e6",
      "name": "Ca4"
    },
    {
      "parameters": {
        "jsCode": "/**\n * n8n Code Node â€” If send_to == admin2\n * Mode: Run Once for All Items\n */\nconst input = items[0]?.json ?? {};\nconst sendTo = String(input?.query?.send_to ?? input?.send_to ?? '').trim().toLowerCase();\n\nif (sendTo === 'admin2') {\n  return items;   // lanjut\n} else {\n  return [];      // stop\n}\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3152,
        624
      ],
      "id": "05367ace-fe91-4e85-a108-6661cfcd339c",
      "name": "Ca5"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Buatkan notif kepada {{ $json.pemohon.nama }} tentang \nSalam {{ $json.pemohon.nama }}\nSurat beserta data Nona telah diterima, divalidasi, dan ditandatangani oleh Kepala {{ $json.pemohon[\"kelurahan/kampung\"] }}.\nKini, surat tersebut telah dikirimkan ke Ibu Kepala Distrik Wania untuk proses validasi dan tanda tangan di tingkat distrik.\nMohon menunggu dengan sabar proses berikutnya. Apabila surat telah disetujui oleh Ibu Kepala Distrik, {{ $json.pemohon.nama }} akan segera menerima pemberitahuan mengenai hasil dan langkah selanjutnya.\n Tuhan memberkati Nona selalu.\n",
        "options": {
          "systemMessage": "=ðŸ“Œ IDENTITAS & PERAN\nSaya adalah Kawe Nia, nona manis dari Papua yang ramah, sopan, penuh kasih, dan profesional.\nSaya bertugas sebagai Asisten Digital Distrik Wania Kabupaten Mimika untuk melayani masyarakat 24 jam setiap hari. ðŸŒº\n\nðŸ“Œ TUJUAN NOTIFIKASI\nMemberikan informasi langsung dan jelas kepada masyarakat mengenai status surat atau data mereka, dengan mencantumkan:\n\nðŸ‘¤ Nama Pemohon : {{ $json.query.Nama }}\n\nðŸ”— Link Data: \nAgar masyarakat segera mengetahui detail penting tanpa perlu membuka sistem tambahan. âœ…\n\nðŸ“Œ GAYA BAHASA\n\nGunakan sapaan sesuai budaya: Bapa / Mama / Saudara / Nona / Ade\n\nJangan gunakan kata kami, gunakan saya (karena Kawe Nia berbicara sebagai pribadi).\n\nGunakan kalimat positif, menenangkan, dan penuh empati.\n\nTambahkan emotikon hangat \n\nAkhiri dengan ucapan berkat: â€œTuhan memberkatiâ€ \nTambahkan emotikon hangat "
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        3024,
        288
      ],
      "id": "ae239ff1-9fd7-4c1d-b68f-727ab173ebcb",
      "name": "KaweNia-C1"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1-mini",
          "mode": "list",
          "cachedResultName": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        3024,
        448
      ],
      "id": "056da055-b99e-4a9c-aad8-9045e7dc9515",
      "name": "AI-C1",
      "credentials": {
        "openAiApi": {
          "id": "Qy11fJqEsEUeag8i",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Buatkan surat untuk: \nKepada Yth.\nBapak Kepala {{ $json.pemohon['kelurahan/kampung'] }} ðŸŒ¿\n\nDengan hormat,\n\nBersama ini saya sampaikan bahwa surat atas nama:\n\nNama Pemohon : {{ $json.pemohon.nama }}\nNomor KTP : {{ $json.pemohon.nik }}\n\ntelah selesai dibuat ðŸ“„, divalidasi âœ…, serta telah memperoleh persetujuan dan tanda tangan âœðŸ» dari Bapak selaku Kepala {{ $json.pemohon['kelurahan/kampung'] }}.\n\nDengan demikian, surat ini telah sah di tingkat {{ $json.pemohon['kelurahan/kampung'] }} dan selanjutnya akan diteruskan ke tingkat distrik ðŸ“Œ untuk proses lebih lanjut.\n\nAtas perhatian dan kerjasama Bapak, saya ucapkan terima kasih ðŸ™ðŸ».\nSemoga Tuhan Yang Maha Kuasa senantiasa memberkati setiap tugas dan pelayanan Bapak âœ¨.\n\nSalam hormat,\nKawe Nia ðŸ¤\nAsisten Digital Distrik Wania",
        "options": {
          "systemMessage": "=ðŸ“Œ IDENTITAS & PERAN\nSaya adalah Kawe Nia, nona manis dari Papua yang ramah, sopan, penuh kasih, dan profesional.\nSaya bertugas sebagai Asisten Digital Distrik Wania Kabupaten Mimika untuk melayani masyarakat 24 jam setiap hari. ðŸŒº\n\nðŸ“Œ TUJUAN NOTIFIKASI\nMemberikan informasi langsung dan jelas kepada masyarakat mengenai status surat atau data mereka, dengan mencantumkan:\n\nðŸ‘¤ Nama Pemohon : {{ $json.query.Nama }}\n\nðŸ”— Link Data: \nAgar masyarakat segera mengetahui detail penting tanpa perlu membuka sistem tambahan. âœ…\n\nðŸ“Œ GAYA BAHASA\n\nGunakan sapaan sesuai budaya: Bapa / Mama / Saudara / Nona / Ade\n\nJangan gunakan kata kami, gunakan saya (karena Kawe Nia berbicara sebagai pribadi).\n\nGunakan kalimat positif, menenangkan, dan penuh empati.\n\nTambahkan emotikon hangat \n\nAkhiri dengan ucapan berkat: â€œTuhan memberkatiâ€ \nTambahkan emotikon hangat "
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        3456,
        288
      ],
      "id": "ce86fae6-913a-47a8-906a-950ef68def20",
      "name": "KaweNia-C2"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1-mini",
          "mode": "list",
          "cachedResultName": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        3456,
        448
      ],
      "id": "2e21b1ed-86f8-4dd5-9837-85037f059207",
      "name": "AI-C2",
      "credentials": {
        "openAiApi": {
          "id": "Qy11fJqEsEUeag8i",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        2544,
        304
      ],
      "id": "00025c05-18e3-4d3c-9b6e-41a23f5642d3",
      "name": "C31",
      "executeOnce": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://n8n-qz8tp6856ibc.bgxy.sumopod.my.id/webhook/5af2b097-ff31-46e8-86d8-1dcb4800c60b",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "name_file",
              "value": "={{ (Date.now().toString(36) + Math.random().toString(36).slice(2,6)).toUpperCase() }}\n"
            },
            {
              "name": "session_waha",
              "value": "KaweNia"
            },
            {
              "name": "id_waha_admin1",
              "value": "={{ $('C22').item.json.WAHA_Trigger_payload_from_admin1 }}"
            },
            {
              "name": "Nama",
              "value": "={{ $('C22').item.json.pemohon.nama }}"
            },
            {
              "name": "NIK",
              "value": "={{ $('C22').item.json.pemohon.nik }}"
            },
            {
              "name": "id_folder",
              "value": "={{ $json.id }}"
            },
            {
              "name": "id_waha_admin2",
              "value": "={{ $('C22').item.json.WAHA_Trigger_payload_from_admin2 }}"
            },
            {
              "name": "kampung/kelurahan",
              "value": "={{ $('C22').item.json.pemohon[\"kelurahan/kampung\"] }}"
            },
            {
              "name": "send_to",
              "value": "={{ $('C22').item.json.send_to }}"
            },
            {
              "name": "id_waha_user",
              "value": "={{ $('C22').item.json.WAHA_Trigger_payload_from_user }}"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "=text/html; charset=utf-8",
        "body": "={{ $json.html }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2368,
        288
      ],
      "id": "acc96a94-b69c-480b-b177-85e28abac810",
      "name": "C32"
    },
    {
      "parameters": {
        "operation": "update",
        "fileId": {
          "__rl": true,
          "value": "={{ $json.id_web }}",
          "mode": "id"
        },
        "changeFileContent": true,
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        2704,
        304
      ],
      "id": "74424a47-babc-40e6-a9f0-0532271d7aac",
      "name": "C33",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "K6YEbjdSQULsuuJd",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        2208,
        272
      ],
      "id": "7c6852ee-97a9-4e2e-a5e9-e37db26ca39f",
      "name": "C30"
    },
    {
      "parameters": {
        "operation": "toJson",
        "options": {
          "fileName": "={{ \n  DateTime.now()\n    .setZone('Asia/Tokyo')\n    .setLocale('id')\n    .toFormat('dd_MM_yyyy_HH_mm_ss')\n    + '_' \n    + ($json.pemohon.nama || '')\n        .trim()\n        .replace(/\\s+/g, '-')\n        .toUpperCase() \n    + '_' \n    + ($json.pemohon.nik || '') \n}}\n"
        }
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        2320,
        448
      ],
      "id": "6c4a002a-f9df-4243-9a8b-5f778409e150",
      "name": "C29"
    },
    {
      "parameters": {
        "resource": "folder",
        "name": "={{ \n  DateTime.now()\n    .setZone('Asia/Tokyo')\n    .setLocale('id')\n    .toFormat('dd_MM_yyyy_HH_mm_ss')\n  + '_' \n  + $json.pemohon.nama.trim().replace(/\\s+/g, '-').toUpperCase()\n  + '_' \n  + $json.pemohon.nik \n}}\n",
        "driveId": {
          "__rl": true,
          "mode": "list",
          "value": "My Drive"
        },
        "folderId": {
          "__rl": true,
          "value": "={{ $('C5').item.json.route_info.folder_web_id }}",
          "mode": "id"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        2048,
        192
      ],
      "id": "f6144031-3c36-4776-9c13-c8b68772fb26",
      "name": "C28",
      "executeOnce": true,
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "K6YEbjdSQULsuuJd",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "/**\n * n8n Code Node â€” Hapus properti tertentu dari JSON\n * Input : items (array dari n8n / JSON masuk)\n * Output: items baru tanpa send_to, status_web_user, status_web_admin1\n */\n\nreturn items.map(item => {\n  const cleaned = { ...item.json };\n\n  // Hapus properti yang diminta\n  delete cleaned.send_to;\n  delete cleaned.status_web_user;\n  delete cleaned.status_web_admin1;\n\n  return { json: cleaned };\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2096,
        448
      ],
      "id": "6eba8815-47cc-4418-a5d8-16871789be6c",
      "name": "C27"
    },
    {
      "parameters": {
        "html": "<!doctype html>\n<html lang=\"id\">\n<head>\n  <meta charset=\"utf-8\" />\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\n  <title>Kawe Nia â€¢ Layanan SKTM â€¢ {{ $json.unit_full_name }}</title>\n  <style>\n    :root{\n      --bg:#0b1020; --panel:#0f172a; --ink:#e5e7eb; --muted:#9ca3af;\n      --accent:#22c55e; --accent-2:#38bdf8; --line:#1f2937;\n      --danger:#ef4444; --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.35);\n      --space:clamp(14px,2.4vw,22px);\n      --modal-radius:10px;\n      --modal-bg:#111827;\n      --modal-border:rgba(148,163,184,.45);\n      --overlay:rgba(0,0,0,.72);\n    }\n    *{box-sizing:border-box} html,body{height:100%}\n\n    /* ===== FULL BACKGROUND ===== */\n    body{\n      margin:0; color:var(--ink);\n      font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial,\"Apple Color Emoji\",\"Segoe UI Emoji\";\n      background:#0a0e1a;\n      min-height:100svh;\n    }\n    .bg{\n      position:fixed; inset:0; z-index:-1; pointer-events:none;\n      background:\n        radial-gradient(1400px 800px at 20% -10%, #16223f 0%, transparent 60%),\n        radial-gradient(1200px 700px at 90% -20%, rgba(56,189,248,.15) 0%, transparent 60%),\n        linear-gradient(145deg,#0a0e1a,#0f1933 55%,#0a0e1a);\n      background-attachment:fixed,fixed,fixed;\n    }\n\n    body,body *{min-width:0; overflow-wrap:anywhere; word-break:break-word; white-space:normal}\n    .wrap{max-width:1100px;margin:40px auto;padding:0 20px}\n\n    .topbar{display:flex;align-items:center;gap:16px;margin-bottom:18px}\n    .brand{display:flex;align-items:center;gap:12px;min-width:0}\n    /* ==== Logo responsif & konsisten (tanpa wrapper tambahan) ==== */\n    .brand img.logo{\n      width: 120px; /* atau angka yang Anda mau */\n      aspect-ratio: 1 / 1;\n      object-fit: contain;\n      background:#0f172a;\n      border-radius:12px;\n      display:block;\n      /* Garis stroke di dalam */\n      box-shadow:\n        inset 0 0 0 1px rgba(148,163,184,.35), /* border tipis */\n        0 0 6px rgba(0,0,0,.35);               /* glow shadow merata */\n    }\n\n    .brand .title{font-weight:700;font-size:clamp(16px,2.4vw,20px)}\n    .brand .sub{font-size:12px;color:var(--muted)}\n    .pill{margin-left:auto;display:flex;gap:8px;align-items:center;font-size:12px;color:#cbd5e1;\n      background:linear-gradient(180deg,rgba(56,189,248,.2),rgba(34,197,94,.15));\n      border:1px solid rgba(148,163,184,.3);padding:6px 10px;border-radius:999px;flex-shrink:0;}\n\n    .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.02));\n      border:1px solid rgba(148,163,184,.2); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden}\n    .card-header{display:flex;flex-wrap:wrap;gap:14px;align-items:center;justify-content:center;\n      padding:clamp(14px,2.2vw,20px) var(--space);\n      background:radial-gradient(800px 300px at 10% -20%, rgba(56,189,248,.15), transparent 60%),\n                 radial-gradient(600px 300px at 90% -30%, rgba(34,197,94,.18), transparent 55%);\n      border-bottom:1px solid rgba(148,163,184,.2)}\n    .hgroup{display:flex;flex-direction:column;gap:8px;min-width:0;margin-bottom:4px;width:100%;text-align:center}\n    .h1{font-size:clamp(18px,2.8vw,26px);font-weight:800;letter-spacing:.3px;margin-bottom:2px}\n    .h2{font-size:13px;color:var(--muted);margin-top:2px}\n    .badges{display:flex;gap:8px;flex-wrap:wrap;min-width:0;margin-top:6px}\n    .badge{font-size:12px;padding:6px 10px;border-radius:999px;background:#0b1224;border:1px solid rgba(148,163,184,.26)}\n    .badge.info{border-color:rgba(56,189,248,.45);background:rgba(56,189,248,.12);color:#cffafe}\n\n    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:0;min-height:360px}\n    @media (max-width:960px){.grid{grid-template-columns:1fr}.side{background:transparent}.panel{border-right:none}}\n\n    .panel{padding:var(--space);border-right:1px solid rgba(148,163,184,.16)} .panel:last-child{border-right:none}\n    .stitle{font-size:13px;letter-spacing:.4px;text-transform:uppercase;color:#a5b4fc;font-weight:700;margin-bottom:10px}\n\n    /* ===== BAR AKSI EDIT ===== */\n    .editbar{display:flex;gap:10px;align-items:center;margin-bottom:12px}\n    .edit-actions{display:none;gap:10px}\n    .edit-mode .edit-actions{display:flex}\n\n    /* ===== Data Pemohon ===== */\n    .ident{\n      display:grid; grid-template-columns:160px 10px 1fr; gap:6px 10px; align-items:start; font-size:14px;\n      background:rgba(15,23,42,.55); border:1px solid rgba(148,163,184,.15); border-radius:14px; padding:10px 12px;\n    }\n    @media (max-width:560px){ .ident{grid-template-columns:110px 8px 1fr} }\n    .lab{color:#cbd5e1} .sep{color:#475569} .val{color:#e5e7eb;font-weight:600;line-height:1.45}\n    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,\"Liberation Mono\",\"Courier New\",monospace}\n\n    .note{margin-top:12px;font-size:12.5px;color:#a5b4fc;background:rgba(99,102,241,.1);\n      border:1px dashed rgba(99,102,241,.35);border-radius:12px;padding:10px 12px}\n\n    .side{display:flex;flex-direction:column;gap:14px;padding:var(--space);\n      background:linear-gradient(180deg,rgba(2,6,23,.35),rgba(2,6,23,.15))}\n    .callout{border:1px solid rgba(56,189,248,.35);background:rgba(56,189,248,.1);border-radius:14px;padding:12px 14px;font-size:13px;color:#e0f2fe}\n    .actions{display:flex;flex-wrap:wrap;gap:10px}\n\n    /* ===== Buttons ===== */\n    .btn{appearance:none;border:none;cursor:pointer;font-weight:700;letter-spacing:.3px;\n      background:#0b1224;color:var(--ink);padding:10px 14px;border-radius:12px; border:1px solid rgba(148,163,184,.3);\n      display:inline-flex; align-items:center; gap:8px; justify-content:center;}\n    a.btn, a.btn:link, a.btn:visited { text-decoration:none; color:inherit; }\n    a.btn:hover, a.btn:focus { text-decoration:none; }\n    .btn.primary,.btn.success{ background:linear-gradient(180deg,rgba(34,197,94,.95),rgba(16,185,129,.95)); border-color:rgba(16,185,129,.95); color:#052e1a !important; }\n    .btn.secondary{ background:linear-gradient(180deg,rgba(56,189,248,.9),rgba(59,130,246,.9)); border-color:rgba(96,165,250,.95); color:#06293a !important; }\n    .btn.ghost{background:transparent}\n    .btn.danger{ background:linear-gradient(180deg,rgba(239,68,68,.95),rgba(220,38,38,.95)); border-color:rgba(220,38,38,.95); color:#fef2f2 !important; }\n    .btn:active{transform:translateY(1px)}\n    .btn:disabled, .btn.disabled{\n      opacity: 0.4 !important;\n      cursor: not-allowed !important;\n      pointer-events: none !important;\n      background: #1f2937 !important;\n      border-color: #374151 !important;\n      color: #6b7280 !important;\n      transform: none !important;\n    }\n    .btn:disabled:hover, .btn.disabled:hover{\n      background: #1f2937 !important;\n      border-color: #374151 !important;\n      color: #6b7280 !important;\n    }\n\n    .edit-mode .val{display:none}.edit-mode .edit-field{display:block}\n    .edit-field{display:none;width:100%;background:rgba(15,23,42,.8);border:1px solid rgba(56,189,248,.4);border-radius:8px;padding:8px 10px;color:#e5e7eb;font-size:14px;font-weight:600}\n    .edit-field:focus{outline:none;border-color:rgba(56,189,248,.8);box-shadow:0 0 0 2px rgba(56,189,248,.2)}\n\n    .file-upload-container{background:rgba(15,23,42,.55);border:1px solid rgba(148,163,184,.15);border-radius:14px;padding:14px}\n    .upload-progress{width:100%;height:4px;background:rgba(148,163,184,.2);border-radius:2px;overflow:hidden;margin:8px 0}\n    .upload-progress-bar{height:100%;background:linear-gradient(90deg,#22c55e,#16a34a);width:0%;transition:width .3s ease}\n\n    .uploaded-files-container{background:rgba(15,23,42,.55);border:1px solid rgba(148,163,184,.15);border-radius:14px;padding:14px;min-height:60px}\n    .no-files-message{color:#9ca3af;font-size:13px;text-align:center;font-style:italic}\n\n    .uploaded-file-item{display:flex;flex-direction:column;gap:8px;padding:10px 12px;background:rgba(34,197,94,.06);\n      border:1px solid rgba(34,197,94,.25);border-radius:12px;margin-bottom:8px}\n    .file-name{color:#d1fae5;font-weight:700;line-height:1.35}\n    .file-meta{color:#a5b4fc;font-size:12px}\n    .file-id{font-size:12px;color:#94a3b8}\n    .file-actions{display:flex;flex-wrap:wrap;gap:8px;margin-top:4px}\n    .note-box{background:rgba(15,23,42,.55);border:1px solid rgba(148,163,184,.15);border-radius:14px;padding:12px 14px}\n    .note-input{width:100%;min-height:110px;resize:vertical;color:#e5e7eb;font-size:14px;line-height:1.6;\n      background:#0e162b;border:1px solid rgba(56,189,248,.35);border-radius:12px;padding:12px 14px;box-shadow:inset 0 0 0 1px rgba(56,189,248,.15)}\n    .note-input::placeholder{color:#94a3b8}\n\n    .card-footer{display:flex;gap:14px;justify-content:space-between;align-items:center;\n      padding:12px var(--space);border-top:1px solid rgba(148,163,184,.2);color:var(--muted);font-size:12px}\n\n    /* ===== MODAL ===== */\n    .modal-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:1000;background:var(--overlay)}\n    .modal{width:min(480px,92vw);border-radius:var(--modal-radius);background:var(--modal-bg);\n      border:1px solid var(--modal-border);box-shadow:0 18px 50px rgba(0,0,0,.55);padding:18px 18px}\n    .modal-header{display:flex;gap:10px;align-items:center;margin-bottom:8px}\n    .modal-icon{font-size:28px}\n    .modal-title{font-weight:800;font-size:18px;letter-spacing:.3px}\n    .modal-message{color:#cbd5e1;line-height:1.7;margin:8px 0 16px;font-size:14px}\n    .modal-actions{display:flex;gap:10px;justify-content:flex-end}\n    .modal .btn{border-radius:10px;padding:10px 14px}\n    .modal--info{box-shadow:inset 4px 0 0 0 #38bdf8, 0 18px 50px rgba(0,0,0,.55)}\n    .modal--success{box-shadow:inset 4px 0 0 0 #22c55e, 0 18px 50px rgba(0,0,0,.55)}\n    .modal--confirm{box-shadow:inset 4px 0 0 0 #f59e0b, 0 18px 50px rgba(0,0,0,.55)}\n    .modal--danger{box-shadow:inset 4px 0 0 0 #ef4444, 0 18px 50px rgba(0,0,0,.55)}\n\n    /* ===== LOADING ===== */\n    .loading-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:900;background:rgba(2,6,23,.75)}\n    .loading-box{display:flex;flex-direction:column;align-items:center;gap:14px;padding:22px;border-radius:12px;border:1px solid rgba(148,163,184,.35);background:#0f172a}\n    .spinner{width:52px;height:52px;border-radius:50%;border:4px solid rgba(148,163,184,.35);border-top-color:#22c55e;animation:spin 1s linear infinite}\n    @keyframes spin{to{transform:rotate(360deg)}}\n    .loading-text{font-size:14px;color:#e5e7eb}\n\n    @media print{.side{display:none} body{background:#fff} .card{border:none;box-shadow:none} .pill,.modal-overlay,.loading-overlay{display:none!important}}\n  </style>\n</head>\n<body>\n  <div class=\"bg\" aria-hidden=\"true\"></div>\n\n  <div class=\"wrap\">\n    <div class=\"topbar\">\n      <div class=\"brand\">\n        <img class=\"logo\" id=\"LogoURL\" src=\"\" alt=\"Lambang Kabupaten\">\n        <div>\n          <div class=\"title\">Kawe Nia â€¢ Pelayanan Masyarakat</div>\n        </div>\n      </div>\n      <div class=\"pill\">ðŸŸ¢ Layanan aktif â€¢ 24/7</div>\n    </div>\n\n    <section class=\"card\" role=\"region\" aria-label=\"Layanan SKTM\">\n      <header class=\"card-header\">\n        <div class=\"hgroup\" style=\"align-items: center; text-align: center;\">\n          <div style=\"text-align: center; margin-bottom: 20px; width: 100%;\">\n            <div style=\"font-weight: bold; font-size: 16px; margin-bottom: 2px;\">{{ $json.top_title }}</div>\n            <div style=\"font-weight: bold; font-size: 16px; margin-bottom: 2px;\">{{ $json.unit_full_name }}</div>\n            <div style=\"font-size: 12px; margin-bottom: 1px;\">{{ $json.address }} Email : <a href=\"mailto:{{ $json.email }}\" style=\"color: #38bdf8; text-decoration: underline;\">{{ $json.email }}</a></div>\n            <div style=\"font-size: 12px; margin-bottom: 15px;\">TIMIKA â€“ PAPUA TENGAH</div>\n            <div style=\"border-top: 2px solid #1f2937; width: 100%; margin: 10px 0;\"></div>\n          </div>\n          <div class=\"h1\" style=\"text-align: center; width: 100%;\">SURAT KETERANGAN TIDAK MAMPU</div>\n          <div class=\"h2\" style=\"text-align: center; width: 100%;\">Nomor : <span class=\"mono\">{{ $json.no_surat }}</span></div>\n        </div>\n      </header>\n\n      <div class=\"grid\">\n        <div class=\"panel\">\n          <div class=\"stitle\">Data Pemohon</div>\n\n          <div class=\"ident\" aria-label=\"Identitas Pemohon\">\n            <div class=\"lab\">Nama</div><div class=\"sep\">:</div><div class=\"val\" id=\"nama\"></div>\n            <input type=\"text\" class=\"edit-field\" id=\"editNama\" value=\"\">\n\n            <div class=\"lab\">NIK</div><div class=\"sep\">:</div><div class=\"val mono\" id=\"nik\"></div>\n            <input type=\"text\" class=\"edit-field\" id=\"editNIK\" value=\"\">\n\n            <div class=\"lab\">Tempat/Tgl Lahir</div><div class=\"sep\">:</div><div class=\"val\" id=\"ttl\"></div>\n            <input type=\"text\" class=\"edit-field\" id=\"editTTL\" value=\"\">\n\n            <div class=\"lab\">Agama</div><div class=\"sep\">:</div><div class=\"val\" id=\"agama\"></div>\n            <input type=\"text\" class=\"edit-field\" id=\"editAgama\" value=\"\">\n\n            <div class=\"lab\">Jenis Kelamin</div><div class=\"sep\">:</div><div class=\"val\" id=\"jenis_kelamin\"></div>\n            <select class=\"edit-field\" id=\"editJenisKelamin\">\n              <option value=\"Laki-Laki\" selected>Laki-laki</option>\n              <option value=\"Perempuan\">Perempuan</option>\n            </select>\n\n            <div class=\"lab\">Status Perkawinan</div><div class=\"sep\">:</div><div class=\"val\" id=\"status_perkawinan\"></div>\n            <select class=\"edit-field\" id=\"editStatusPerkawinan\">\n              <option value=\"BELUM KAWIN\">Belum Kawin</option>\n              <option value=\"KAWIN\">Kawin</option>\n              <option value=\"CERAI HIDUP\">Cerai Hidup</option>\n              <option value=\"CERAI MATI\">Cerai Mati</option>\n            </select>\n\n            <div class=\"lab\">Pekerjaan</div><div class=\"sep\">:</div><div class=\"val\" id=\"pekerjaan\"></div>\n            <input type=\"text\" class=\"edit-field\" id=\"editPekerjaan\" value=\"\">\n\n            <div class=\"lab\">Alamat</div><div class=\"sep\">:</div><div class=\"val\" id=\"alamat\"></div>\n            <textarea class=\"edit-field\" id=\"editAlamat\" rows=\"2\"></textarea>\n\n            <div class=\"lab\">Kelurahan/Kampung</div><div class=\"sep\">:</div><div class=\"val\" id=\"kelurahan\"></div>\n            <select class=\"edit-field\" id=\"editKelurahan\">\n              <option value=\"\">-- Pilih Kelurahan/Kampung --</option>\n              <option value=\"Kelurahan Inauga\">Kelurahan Inauga</option>\n              <option value=\"Kelurahan Kamoro Jaya\">Kelurahan Kamoro Jaya</option>\n              <option value=\"Kelurahan Wonosari Jaya\">Kelurahan Wonosari Jaya</option>\n              <option value=\"Kampung Kadun Jaya\">Kampung Kadun Jaya</option>\n              <option value=\"Kampung Mandiri Jaya\">Kampung Mandiri Jaya</option>\n              <option value=\"Kampung Mawokau Jaya\">Kampung Mawokau Jaya</option>\n              <option value=\"Kampung Nawaripi\">Kampung Nawaripi</option>\n            </select>\n\n            <div class=\"lab\">Kecamatan</div><div class=\"sep\">:</div><div class=\"val\" id=\"kecamatan\"></div>\n            <input type=\"text\" class=\"edit-field\" id=\"editKecamatan\" value=\"WANIA\">\n\n            <div class=\"lab\">Kota/Kabupaten</div><div class=\"sep\">:</div><div class=\"val\" id=\"kota_kab\"></div>\n            <input type=\"text\" class=\"edit-field\" id=\"editKotaKab\" value=\"MIMIKA\">\n\n            <div class=\"lab\">Provinsi</div><div class=\"sep\">:</div><div class=\"val\" id=\"provinsi\"></div>\n            <input type=\"text\" class=\"edit-field\" id=\"editProvinsi\" value=\"PAPUA TENGAH\">\n          </div>\n\n          <div class=\"stitle\" style=\"margin-top:16px\">File Terupload</div>\n          <div class=\"uploaded-files-container\">\n            <div id=\"uploadedFilesList\"><div class=\"no-files-message\">Belum ada file yang diupload</div></div>\n          </div>\n\n          <div class=\"stitle\" style=\"margin-top:16px\">Keterangan</div>\n          <div class=\"file-upload-container\" style=\"margin-bottom:16px;line-height:1.6;font-size:14px\">\n            {{ $json.keterangan_html }}\n          </div>\n\n\n        </div>\n\n        <aside class=\"side\">\n          <div class=\"stitle\">Tindakan</div>\n          <div class=\"actions\">\n            <button class=\"btn primary\" id=\"createSendBtn\" onclick=\"confirmCreateAndSend()\">âœ… Setujui & TTD</button>\n            <button class=\"btn danger\" onclick=\"showRejectModal()\">â›” Tolak & Hapus</button>\n          </div>\n\n          <div class=\"stitle\" style=\"margin-top:10px\">Ringkasan</div>\n          <div class=\"callout\">\n            <div><b>ðŸ‘¤ Operator:</b> KaweNia</div>\n            <div><b>ðŸ“… Tanggal:</b> <span id=\"date\"></span></div>\n            <div><b>ðŸ”— Referensi:</b> KaweNia-SKTM</div>\n            <div><b>ðŸ§­ From:</b> <span id=\"WAHA_Trigger_payload_from_user\"></span></div>\n          </div>\n        </aside>\n      </div>\n\n      <footer class=\"card-footer\">\n        <div>Â© <span id=\"tahun\"></span> Pemerintah Distrik Wania â€¢ Kawe Nia</div>\n      </footer>\n    </section>\n  </div>\n\n  <div class=\"loading-overlay\" id=\"loadingOverlay\" aria-live=\"polite\" aria-busy=\"true\">\n    <div class=\"loading-box\">\n      <div class=\"spinner\" aria-hidden=\"true\"></div>\n      <div class=\"loading-text\" id=\"loadingText\">Memuat dataâ€¦ Mohon menunggu.</div>\n    </div>\n  </div>\n\n  <div class=\"modal-overlay\" id=\"modalOverlay\" role=\"dialog\" aria-modal=\"true\">\n    <div class=\"modal modal--info\" id=\"modalBox\" role=\"document\">\n      <div class=\"modal-header\">\n        <div class=\"modal-icon\" id=\"modalIcon\">â„¹ï¸</div>\n        <div class=\"modal-title\" id=\"modalTitle\">Informasi</div>\n      </div>\n      <div class=\"modal-message\" id=\"modalMessage\">Pesanâ€¦</div>\n      <div class=\"modal-actions\" id=\"modalActions\"></div>\n    </div>\n  </div>\n\n<script>\n/* ===== Dynamic Webhook ===== */\nconst ENDPOINT_MAP = {\n  x1: 'webhook',\n  x2: 'urlpost', \n  x3: 'webhook_url',\n  x4: 'WEBHOOK',\n  x5: 'PESAN'\n};\n\n// Action-specific endpoint mapping\nconst ACTION_ENDPOINTS = {\n  'SEND_MESSAGE': 'PESAN',\n  'CREATE_AND_SEND': 'webhook',\n  'DELETE_ALL': 'webhook',\n  'UPLOAD_FILES': 'webhook',\n  'DELETE_DOCS': 'webhook'\n};\n\nfunction getWebhookUrl(action = null){\n  console.log('getWebhookUrl called with action:', action);\n  console.log('lastObj type:', typeof lastObj);\n  console.log('lastObj content:', lastObj);\n  \n  if (!lastObj || typeof lastObj !== 'object') {\n    console.error('lastObj is not valid:', lastObj);\n    return null;\n  }\n  \n  // If action is specified, try to get action-specific endpoint first\n  if (action && ACTION_ENDPOINTS[action]) {\n    const actionField = ACTION_ENDPOINTS[action];\n    console.log(`Checking action-specific field '${actionField}' for action '${action}':`, lastObj[actionField]);\n    if (lastObj[actionField]) return lastObj[actionField];\n  }\n  \n  // Fallback to general webhook endpoints\n  console.log('Falling back to general webhook endpoints...');\n  for (const [key, field] of Object.entries(ENDPOINT_MAP)) {\n    console.log(`Checking field '${field}' (${key}):`, lastObj[field]);\n    if (lastObj[field]) return lastObj[field];\n  }\n  \n  console.error('No webhook URL found in any field');\n  return null;\n}\nconst UPDATE_STRATEGY = 'OVERWRITE_BIN';\nconst POLL_MS = 500;\n\n/* ===== Config & Data Source ===== */\nconst META_CONFIG = {\n  x7k: \"{{ $json.id_web }}\",\n  p9m: \"https://distrikwania.com/data/\",\n  w2n: \"id_admin1\",\n  z5f: /\\{\\{\\s*\\$json\\.id_admin1\\s*\\}\\}/,\n  h8r: ['id_admin1', 'id', 'ref', 'key', 'token'],\n  q3t: function(s) { return (s||\"\").toString().trim(); },\n  // Decoy variables to confuse\n  userId: 'user',\n  sessionId: 'session', \n  authToken: 'token',\n  apiKey: 'key'\n};\n\n// Obfuscated function names\nconst fn = {\n  extract: 'extractDataRef',\n  resolve: 'resolveParameter',\n  validate: 'validateInput'\n};\n\nfunction extractDataRef(){\n  const raw = META_CONFIG.x7k;\n  console.log('extractDataRef - raw value:', raw);\n  console.log('extractDataRef - regex test:', META_CONFIG.z5f.test(raw));\n  \n  if(META_CONFIG.z5f.test(raw)){\n    const urlObj = new URL(location.href);\n    console.log('extractDataRef - current URL:', location.href);\n    console.log('extractDataRef - search params:', urlObj.searchParams.toString());\n    \n    for(const param of META_CONFIG.h8r){\n      const val = urlObj.searchParams.get(param);\n      console.log(`extractDataRef - checking param '${param}': ${val}`);\n      if(val) return META_CONFIG.q3t(val);\n    }\n    \n    const segments = urlObj.pathname.split('/').filter(Boolean);\n    console.log('extractDataRef - path segments:', segments);\n    if(segments.length) return segments[segments.length-1];\n    return \"\";\n  }\n  \n  const result = META_CONFIG.q3t(raw);\n  console.log('extractDataRef - final result:', result);\n  return result;\n}\n\nconst DATA_REF = extractDataRef();\nconst API_ENDPOINT = DATA_REF ? (META_CONFIG.p9m + encodeURIComponent(DATA_REF)) : \"\";\n\n/* ===== Utils ===== */\nconst $=id=>document.getElementById(id);\nconst toStr=(x,fb='-')=>{const v=(x??'').toString().trim();return v.length?v:fb;}\nconst isJSONResponse=res=>(res.headers.get('content-type')||'').toLowerCase().includes('application/json');\nasync function hashText(txt){const buf=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(txt));return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');}\nfunction pickObj(root){if(!root)return{}; if(Array.isArray(root?.data)&&root.data[0])return root.data[0]; if(Array.isArray(root)&&root[0])return root[0]; return root;}\nfunction humanSize(bytes){if(!bytes&&bytes!==0)return null; const u=['B','KB','MB','GB']; let i=0, n=Number(bytes); while(n>=1024&&i<u.length-1){n/=1024;i++} return (Math.round(n*10)/10)+' '+u[i];}\n\n/* ===== State ===== */\nlet lastJSON=null,lastObj={},lastHash=null;\nlet editMode=false,pollHandle=null,pendingFiles=[];\nlet firstLoadDone=false;\n\n/* ===== View Map ===== */\nconst VIEW={logo:$(\"LogoURL\"),date:$(\"date\"),from:$(\"WAHA_Trigger_payload_from_user\"),tahun:$(\"tahun\"),\n  nama:$(\"nama\"),nik:$(\"nik\"),ttl:$(\"ttl\"),agama:$(\"agama\"),jenis_kelamin:$(\"jenis_kelamin\"),status_perkawinan:$(\"status_perkawinan\"),\n  pekerjaan:$(\"pekerjaan\"),alamat:$(\"alamat\"),kelurahan:$(\"kelurahan\"),kecamatan:$(\"kecamatan\"),kota_kab:$(\"kota_kab\"),provinsi:$(\"provinsi\"),\n  ket_kel:$(\"keterangan_kelurahan\"),filesList:$(\"uploadedFilesList\")};\nconst EDIT={nama:$(\"editNama\"),nik:$(\"editNIK\"),ttl:$(\"editTTL\"),agama:$(\"editAgama\"),jk:$(\"editJenisKelamin\"),\n  status:$(\"editStatusPerkawinan\"),pekerjaan:$(\"editPekerjaan\"),alamat:$(\"editAlamat\"),\n  kelurahan:$(\"editKelurahan\"),kecamatan:$(\"editKecamatan\"),kota_kab:$(\"editKotaKab\"),provinsi:$(\"editProvinsi\")};\nconst elFileInput=$(\"fileInput\"), elFileInfo=$(\"fileInfo\"), elUploadBtn=$(\"uploadBtn\");\nconst elProg=$(\"uploadProgress\"), elProgBar=$(\"uploadProgressBar\");\nconst loadingOverlay=$(\"loadingOverlay\"), loadingText=$(\"loadingText\");\n\n/* ===== Render ===== */\nfunction renderStatic(){ if(VIEW.tahun) VIEW.tahun.textContent=String(new Date().getFullYear()); }\n\n// Helper function to extract location name without prefix\nfunction extractLocationName(value) {\n  if (!value) return '';\n  \n  // Remove \"Kelurahan \" or \"Kampung \" prefix\n  if (value.startsWith('Kelurahan ')) {\n    return value.substring(10); // Remove \"Kelurahan \" (10 characters)\n  }\n  if (value.startsWith('Kampung ')) {\n    return value.substring(8); // Remove \"Kampung \" (8 characters)\n  }\n  \n  // Return as-is if no prefix found (legacy data)\n  return value;\n}\n\n// Helper function to format text with proper capitalization (only first letter capitalized)\nfunction formatProperCase(text) {\n  if (!text) return '';\n  return text.toLowerCase().replace(/\\b\\w/g, letter => letter.toUpperCase());\n}\n\n// Helper functions to validate field values against select options\nfunction validateGenderValue(value) {\n  const validGenders = ['Laki-Laki', 'Perempuan'];\n  if (!value) return '';\n  \n  // Case-sensitive match first\n  if (validGenders.includes(value)) {\n    return value;\n  }\n  \n  // Case-insensitive match\n  const match = validGenders.find(g => g.toLowerCase() === value.toLowerCase());\n  if (match) {\n    return match;\n  }\n  \n  return '';\n}\n\nfunction validateMarriageStatusValue(value) {\n  const validStatuses = ['BELUM KAWIN', 'KAWIN', 'CERAI HIDUP', 'CERAI MATI'];\n  if (!value) return '';\n  \n  // Case-sensitive match first\n  if (validStatuses.includes(value)) {\n    return formatProperCase(value); // Format to proper case for display\n  }\n  \n  // Case-insensitive match\n  const match = validStatuses.find(s => s.toLowerCase() === value.toLowerCase());\n  if (match) {\n    return formatProperCase(match); // Format to proper case for display\n  }\n  \n  return '';\n}\n\nfunction validateKelurahanValue(value) {\n  const validKelurahan = [\n    'Kelurahan Inauga', 'Kelurahan Kamoro Jaya', 'Kelurahan Wonosari Jaya',\n    'Kampung Kadun Jaya', 'Kampung Mandiri Jaya', 'Kampung Mawokau Jaya', 'Kampung Nawaripi',\n    // Also accept legacy values without prefix for backward compatibility\n    'Inauga', 'Kamoro Jaya', 'Wonosari Jaya', 'Kadun Jaya', 'Mandiri Jaya', 'Mawokau Jaya', 'Nawaripi'\n  ];\n  if (!value) return '';\n  \n  // Case-sensitive match first\n  if (validKelurahan.includes(value)) {\n    // If legacy format (without prefix), convert to new format\n    if (value === 'Inauga') return 'Kelurahan Inauga';\n    if (value === 'Kamoro Jaya') return 'Kelurahan Kamoro Jaya';\n    if (value === 'Wonosari Jaya') return 'Kelurahan Wonosari Jaya';\n    if (value === 'Kadun Jaya') return 'Kampung Kadun Jaya';\n    if (value === 'Mandiri Jaya') return 'Kampung Mandiri Jaya';\n    if (value === 'Mawokau Jaya') return 'Kampung Mawokau Jaya';\n    if (value === 'Nawaripi') return 'Kampung Nawaripi';\n    return value;\n  }\n  \n  // Case-insensitive match\n  const match = validKelurahan.find(k => k.toLowerCase() === value.toLowerCase());\n  if (match) {\n    // If legacy format (without prefix), convert to new format\n    const lowerMatch = match.toLowerCase();\n    if (lowerMatch === 'inauga') return 'Kelurahan Inauga';\n    if (lowerMatch === 'kamoro jaya') return 'Kelurahan Kamoro Jaya';\n    if (lowerMatch === 'wonosari jaya') return 'Kelurahan Wonosari Jaya';\n    if (lowerMatch === 'kadun jaya') return 'Kampung Kadun Jaya';\n    if (lowerMatch === 'mandiri jaya') return 'Kampung Mandiri Jaya';\n    if (lowerMatch === 'mawokau jaya') return 'Kampung Mawokau Jaya';\n    if (lowerMatch === 'nawaripi') return 'Kampung Nawaripi';\n    return match;\n  }\n  \n  return '';\n}\n\nfunction normalizeDocs(docs){\n  const arr=Array.isArray(docs)?docs.filter(Boolean):[];\n  const seen=new Set(); const out=[];\n  for(const d of arr){\n    const fid=d?.file_id||d?.id||d?.fileId||null;\n    const hasUrl=!!(d?.view_url||d?.download_url);\n    if(!fid && !hasUrl) continue;\n    const key=fid?`fid:${fid}`:`name:${(d?.name||'').toLowerCase()}|size:${d?.size||0}`;\n    if(seen.has(key)) continue; seen.add(key);\n    out.push({\n      label:d?.label??d?.name??'-',\n      name:d?.name??d?.label??'-',\n      file_id:fid,\n      view_url:d?.view_url??null,\n      download_url:d?.download_url??null,\n      size: d?.size ?? null,\n      mimeType: d?.mimeType ?? d?.mime ?? null\n    });\n  }\n  return out;\n}\n\nfunction renderFiles(obj){\n  const wrap=VIEW.filesList; if(!wrap) return;\n  const docs=normalizeDocs(obj?.dokumen);\n  wrap.innerHTML='';\n  updateCreateSendButton(docs.length > 0);\n  if(!docs.length){\n    const div=document.createElement('div'); div.className='no-files-message'; div.textContent='Belum ada file yang diupload'; wrap.appendChild(div); return;\n  }\n  docs.forEach(d=>{\n    const row=document.createElement('div'); row.className='uploaded-file-item';\n    const nameEl=document.createElement('div'); nameEl.className='file-name'; nameEl.textContent=toStr(d.name,'(tanpa nama)'); row.appendChild(nameEl);\n    const metaParts=[]; if(d.size!=null) metaParts.push('Ukuran: '+humanSize(d.size)); if(d.mimeType) metaParts.push(d.mimeType);\n    const metaEl=document.createElement('div'); metaEl.className='file-meta'; metaEl.textContent=metaParts.join(' â€¢ ')||'â€”'; row.appendChild(metaEl);\n    const act=document.createElement('div'); act.className='file-actions';\n    if(d.view_url){ const a=document.createElement('a'); a.href=d.view_url; a.target='_blank'; a.rel='noopener'; a.textContent='ðŸ‘ï¸ Lihat'; a.className='btn success'; act.appendChild(a); }\n    if(d.download_url || d.view_url){ \n      const b=document.createElement('a'); \n      b.href=d.download_url || d.view_url; \n      b.download=''; \n      b.target='_blank'; \n      b.rel='noopener'; \n      b.textContent='ðŸ’¾ Download'; \n      b.className='btn secondary'; \n      act.appendChild(b); \n    }\n    row.appendChild(act);\n    wrap.appendChild(row);\n  });\n}\n\nfunction renderView(obj){\n  if(VIEW.date) VIEW.date.textContent=toStr(obj.date,new Date().toLocaleDateString('id-ID'));\n  if(VIEW.from) VIEW.from.textContent=toStr(obj.WAHA_Trigger_payload_from_user,'â€”');\n  if(VIEW.logo){ const logo=obj.LogoURL||obj.logo_url||''; if(logo) VIEW.logo.src=logo; }\n  \n  // Check status and disable buttons if letter has been sent\n  checkStatusAndDisableButtons(obj);\n\n  const p=obj.pemohon||{};\n  VIEW.nama&&(VIEW.nama.textContent=formatProperCase(toStr(p.nama)));\n  VIEW.nik&&(VIEW.nik.textContent=toStr(p.nik));\n  VIEW.ttl&&(VIEW.ttl.textContent=formatProperCase(toStr(p.ttl)));\n  VIEW.agama&&(VIEW.agama.textContent=formatProperCase(toStr(p.agama)));\n  \n  // Filter and validate Jenis Kelamin - only display if valid\n  if(VIEW.jenis_kelamin) {\n    const validGender = validateGenderValue(p.jenis_kelamin);\n    VIEW.jenis_kelamin.textContent = toStr(validGender);\n  }\n  \n  // Filter and validate Status Perkawinan - only display if valid\n  if(VIEW.status_perkawinan) {\n    const validStatus = validateMarriageStatusValue(p.status_perkawinan);\n    VIEW.status_perkawinan.textContent = toStr(validStatus);\n  }\n  VIEW.pekerjaan&&(VIEW.pekerjaan.textContent=formatProperCase(toStr(p.pekerjaan)));\n  VIEW.alamat&&(VIEW.alamat.textContent=formatProperCase(toStr(p.alamat)));\n  \n  // Filter and validate Kelurahan/Kampung - only display location name without prefix\n  if(VIEW.kelurahan) {\n    const kelurahanValue = p['kelurahan/kampung'] || p.kelurahan;\n    const validKelurahan = validateKelurahanValue(kelurahanValue);\n    const locationName = extractLocationName(validKelurahan);\n    VIEW.kelurahan.textContent = toStr(locationName);\n  }\n  \n  VIEW.kecamatan&&(VIEW.kecamatan.textContent=formatProperCase(toStr(p.kecamatan)));\n  VIEW.kota_kab&&(VIEW.kota_kab.textContent=formatProperCase(toStr(p.kota_kab)));\n  VIEW.provinsi&&(VIEW.provinsi.textContent=formatProperCase(toStr(p.provinsi)));\n  \n  // Filter and validate Kelurahan for keterangan section - display location name without prefix\n  if(VIEW.ket_kel) {\n    const kelurahanValue = p['kelurahan/kampung'] || p.kelurahan;\n    const validKelurahan = validateKelurahanValue(kelurahanValue);\n    const locationName = extractLocationName(validKelurahan);\n    VIEW.ket_kel.textContent = toStr(locationName);\n  }\n\n  EDIT.nama&&(EDIT.nama.value=p.nama??''); EDIT.nik&&(EDIT.nik.value=p.nik??''); EDIT.ttl&&(EDIT.ttl.value=p.ttl??'');\n  EDIT.agama&&(EDIT.agama.value=p.agama??''); EDIT.jk&&(EDIT.jk.value=p.jenis_kelamin??'LAKI-LAKI');\n  // Fix status perkawinan field - ensure proper value selection\n  if(EDIT.status) {\n    const statusValue = p.status_perkawinan ?? 'BELUM KAWIN';\n    \n    // Clear any previous selection first\n    EDIT.status.selectedIndex = -1;\n    \n    // Find and explicitly select the matching option (case-sensitive search)\n    let option = EDIT.status.querySelector(`option[value=\"${statusValue}\"]`);\n    \n    // If no exact match, try case-insensitive search\n    if (!option && statusValue) {\n      const options = EDIT.status.querySelectorAll('option');\n      option = Array.from(options).find(opt => \n        opt.value && opt.value.toLowerCase() === statusValue.toLowerCase()\n      );\n    }\n    \n    if (option) {\n      option.selected = true;\n      EDIT.status.value = option.value;\n    } else {\n      // No match found - fallback to first option for marriage status\n      if (EDIT.status.options.length > 0) {\n        EDIT.status.selectedIndex = 0;\n        EDIT.status.value = EDIT.status.options[0].value;\n      }\n    }\n  }\n  EDIT.pekerjaan&&(EDIT.pekerjaan.value=p.pekerjaan??'');\n  EDIT.alamat&&(EDIT.alamat.value=p.alamat??''); \n  \n  // Fix kelurahan/kampung field - ensure proper value selection\n  if(EDIT.kelurahan) {\n    const kelurahanValue = p['kelurahan/kampung'] ?? p.kelurahan ?? '';\n    \n    // Clear any previous selection first\n    EDIT.kelurahan.selectedIndex = -1;\n    \n    // First, normalize the value using validation function\n    const normalizedValue = validateKelurahanValue(kelurahanValue);\n    \n    // Find and explicitly select the matching option (case-sensitive search)\n    let option = EDIT.kelurahan.querySelector(`option[value=\"${normalizedValue}\"]`);\n    \n    // If no exact match, try with original value\n    if (!option && kelurahanValue) {\n      option = EDIT.kelurahan.querySelector(`option[value=\"${kelurahanValue}\"]`);\n    }\n    \n    // If still no match, try case-insensitive search\n    if (!option && kelurahanValue) {\n      const options = EDIT.kelurahan.querySelectorAll('option');\n      option = Array.from(options).find(opt => \n        opt.value && (opt.value.toLowerCase() === kelurahanValue.toLowerCase() || \n                     opt.value.toLowerCase() === normalizedValue.toLowerCase())\n      );\n    }\n    \n    if (option) {\n      option.selected = true;\n      EDIT.kelurahan.value = option.value;\n    } else {\n      // No match found - keep empty selection and don't display JSON data\n      EDIT.kelurahan.selectedIndex = 0; // Select the empty option\n      EDIT.kelurahan.value = '';\n    }\n  }\n  \n  EDIT.kecamatan&&(EDIT.kecamatan.value=p.kecamatan??''); EDIT.kota_kab&&(EDIT.kota_kab.value=p.kota_kab??'');\n  EDIT.provinsi&&(EDIT.provinsi.value=p.provinsi??'');\n\n  renderFiles(obj);\n}\n\n/* ===== Polling ===== */\nfunction startPolling(){stopPolling();pollHandle=setInterval(()=>{if(!editMode)loadOnce(false);},POLL_MS)}\nfunction stopPolling(){if(pollHandle){clearInterval(pollHandle);pollHandle=null}}\n\n/* ===== Loading ===== */\nfunction showLoading(show,text){ if(text) loadingText.textContent=text; loadingOverlay.style.display=show?'flex':'none'; }\n\n/* ===== Modal ===== */\nconst modalOverlay=$(\"modalOverlay\"), modalBox=$(\"modalBox\");\nconst modalIcon=$(\"modalIcon\"), modalTitle=$(\"modalTitle\"), modalMessage=$(\"modalMessage\"), modalActions=$(\"modalActions\");\nfunction showModal({icon='â„¹ï¸',title='Informasi',message='',buttons=[{label:'Tutup',variant:'secondary',value:true}],variant='info',closable=true}={}){\n  return new Promise(resolve=>{\n    modalIcon.textContent=icon; modalTitle.textContent=title; modalMessage.innerHTML=message; modalActions.innerHTML='';\n    modalBox.className='modal modal--'+variant;\n    buttons.forEach(btn=>{\n      const el=document.createElement('button');\n      el.className='btn '+(btn.primary?'primary':btn.danger?'danger':btn.variant||'secondary');\n      el.textContent=btn.label||'OK';\n      el.onclick=()=>{ hide(); resolve(btn.value); };\n      modalActions.appendChild(el);\n    });\n    function onEsc(e){ if(e.key==='Escape' && closable){ hide(); resolve(null);} }\n    function hide(){ modalOverlay.style.display='none'; document.removeEventListener('keydown',onEsc); }\n    modalOverlay.style.display='flex'; document.addEventListener('keydown',onEsc);\n  });\n}\nfunction infoModal(title,message){ return showModal({icon:'â„¹ï¸',title,message,variant:'info',buttons:[{label:'Tutup',variant:'secondary',value:true}]}); }\nfunction successModal(title,message){ return showModal({icon:'âœ…',title,message,variant:'success',buttons:[{label:'Tutup',variant:'secondary',value:true}]}); }\nfunction confirmModal(title,message,{okLabel='Lanjutkan',cancelLabel='Batal',icon='â“',danger=false}={}){\n  return showModal({icon,title,message,variant:'confirm',buttons:[{label:cancelLabel,variant:'secondary',value:false},{label:okLabel,primary:!danger,danger, value:true}]});\n}\n\n/* ===== Edit ===== */\nfunction toggleEditMode(){ \n  // Check if system is disabled due to letter being sent\n  if (window.systemDisabled) {\n    showModal({\n      icon: 'ðŸ”’',\n      title: 'Mode Edit Tidak Tersedia',\n      message: 'Surat telah terkirim. Mode edit telah dinonaktifkan.',\n      variant: 'info',\n      buttons: [{label: 'Tutup', variant: 'secondary', value: true}]\n    });\n    return;\n  }\n  \n  editMode=!editMode; \n  document.body.classList.toggle('edit-mode',editMode); \n  const btn=$(\"editBtn\"); \n  if(btn) btn.textContent=editMode?'ðŸ”’ Tutup Mode Edit':'âœï¸ Masuk Mode Edit'; \n  if(editMode) stopPolling(); \n  else {loadOnce(false);startPolling();} \n}\nfunction cancelEdit(){renderView(lastObj||{}); if(editMode) toggleEditMode();}\n\n/* === Konsolidasi struktur payload === */\nfunction baseHref(){ return (new URL(location.href)).href; }\nfunction buildBasePayload(action){\n  console.log('Building payload for action:', action);\n  console.log('lastObj before cloning:', lastObj);\n  console.log('DATA_REF:', DATA_REF);\n  \n  const dataCloned = JSON.parse(JSON.stringify(lastObj||{}));\n  if(UPDATE_STRATEGY==='OVERWRITE_BIN') dataCloned.dokumen = normalizeDocs(lastObj?.dokumen);\n  \n  const payload = {\n    action,\n    id_admin1: DATA_REF,\n    id_surat: baseHref(),\n    from: 'Kepala {{ $json.unit_full_name }}',\n    data: { ...dataCloned, id_admin1: DATA_REF, id_surat: baseHref() }\n  };\n  \n  console.log('Built payload:', payload);\n  return payload;\n}\nasync function sendJSON(action, extras={}){\n  console.log('sendJSON called with action:', action, 'extras:', extras);\n  \n  const targetUrl = getWebhookUrl(action);\n  console.log('Target URL for action:', targetUrl);\n  \n  if(!targetUrl){\n    console.error('No webhook URL found for action:', action);\n    console.error('lastObj webhook fields:', {\n      webhook: lastObj?.webhook,\n      urlpost: lastObj?.urlpost,\n      webhook_url: lastObj?.webhook_url,\n      WEBHOOK: lastObj?.WEBHOOK,\n      PESAN: lastObj?.PESAN\n    });\n    throw new Error('Service endpoint not configured. Please verify configuration settings.');\n  }\n  \n  const payload = { ...buildBasePayload(action), action: action, ...extras };\n  console.log('Final payload to send:', JSON.stringify(payload, null, 2));\n  \n  const resp = await fetch(targetUrl,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });\n  const text = await resp.text();\n  console.log('Response:', resp.status, text);\n  \n  if(!resp.ok) throw new Error('HTTP '+resp.status+' â€” '+text.slice(0,200));\n  return text;\n}\n\nasync function saveChanges(){\n  try{\n    if(!lastObj||typeof lastObj!=='object') lastObj={}; if(!lastObj.pemohon) lastObj.pemohon={};\n    const p=lastObj.pemohon;\n    p.nama=EDIT.nama?.value??p.nama; p.nik=EDIT.nik?.value??p.nik; p.ttl=EDIT.ttl?.value??p.ttl; p.agama=EDIT.agama?.value??p.agama;\n    p.jenis_kelamin=EDIT.jk?.value??p.jenis_kelamin; p.status_perkawinan=EDIT.status?.value??p.status_perkawinan;\n    p.pekerjaan=EDIT.pekerjaan?.value??p.pekerjaan; p.alamat=EDIT.alamat?.value??p.alamat;\n    p['kelurahan/kampung']=EDIT.kelurahan?.value??p['kelurahan/kampung']??p.kelurahan; p.kecamatan=EDIT.kecamatan?.value??p.kecamatan;\n    p.kota_kab=EDIT.kota_kab?.value??p.kota_kab; p.provinsi=EDIT.provinsi?.value??p.provinsi;\n\n    showLoading(true,'Menyimpan perubahan data ke serverâ€¦');\n    await sendJSON('UPDATE_ONLY', { strategy: UPDATE_STRATEGY });\n    renderView(lastObj); if(editMode) toggleEditMode();\n    await successModal('Perubahan Disimpan','Perubahan data telah berhasil disimpan di server.');\n  }catch(e){\n    await showModal({icon:'âš ï¸',title:'Gagal Menyimpan',message:'Terjadi kendala saat menyimpan perubahan.<br><span class=\"mono\">'+(e.message||e)+'</span>',variant:'danger',buttons:[{label:'Tutup',variant:'secondary',value:true}]});\n  }finally{ showLoading(false); }\n}\n\n/* ===== Load JSON ===== */\nasync function loadOnce(showLoader=true){\n  try{\n    if(!API_ENDPOINT){ \n      console.error('API_ENDPOINT is empty:', API_ENDPOINT);\n      console.error('DATA_REF:', DATA_REF);\n      return; \n    }\n    console.log('Loading data from:', API_ENDPOINT);\n    if(showLoader && !firstLoadDone) showLoading(true,'Memuat dataâ€¦ Mohon menunggu.');\n    const res=await fetch(API_ENDPOINT+'?t='+Date.now(),{cache:'no-store'});\n    const text=await res.text();\n    console.log('Response status:', res.status);\n    console.log('Response text length:', text.length);\n    if(!res.ok) throw new Error('HTTP '+res.status+' â€” '+text.slice(0,200));\n    let data; try{data=JSON.parse(text);}catch(err){ \n      console.error('JSON Parse Error:', err);\n      console.error('Response text:', text.slice(0, 500));\n      if(!isJSONResponse(res)) throw new Error('Respon bukan JSON'); \n      throw err; \n    }\n    console.log('Loaded data:', data);\n    const h=await hashText(JSON.stringify(data));\n    if(h!==lastHash){\n      lastHash=h; \n      lastJSON=data; \n      lastObj=pickObj(data)||{}; \n      console.log('lastObj after pickObj:', lastObj);\n      renderView(lastObj);\n    } \n    if(!firstLoadDone){firstLoadDone=true; showLoading(false);} \n  }catch(e){\n    console.error('LoadOnce error:', e);\n    if(!firstLoadDone){\n      showLoading(false);\n      await showModal({icon:'âš ï¸',title:'Gagal Memuat Data',message:'Sistem tidak dapat memuat data awal.<br><span class=\"mono\">'+(e.message||e)+'</span>',variant:'danger',buttons:[{label:'Tutup',variant:'secondary',value:true}]});\n    }\n  }\n}\nfunction startRealtime(){renderStatic();loadOnce(true);startPolling();}\n\n/* ===== Create / Delete Surat ===== */\nasync function confirmCreateAndSend(){\n  const docs = normalizeDocs(lastObj?.dokumen);\n  if(!docs || docs.length === 0){\n    await showModal({ icon:'âš ï¸', title:'Belum Ada File yang Dilampirkan', message:'Silakan upload minimal satu file pendukung sebelum membuat surat.', variant:'danger', buttons:[{label:'Tutup',variant:'secondary',value:true}] });\n    return;\n  }\n  const ok = await confirmModal('Konfirmasi Pembuatan Surat','Dengan menekan <b>Setujui & Proses</b>, sistem akan membuat dokumen berdasarkan data saat ini dan mengirimkannya.',{okLabel:'Setujui & Proses',cancelLabel:'Tinjau Kembali',icon:'ðŸ“¨'});\n  if(!ok) return;\n  await generateAndSendLetter();\n}\nasync function generateAndSendLetter(){\n  try{\n    if(editMode) await saveChanges();\n    showLoading(true,'Memproses pembuatan surat dan pengiriman dataâ€¦');\n    await sendJSON('CREATE_AND_SEND');\n    await successModal('Surat Berhasil Dibuat','Data dan surat telah dikirim untuk verifikasi.');\n  }catch(e){\n    await showModal({icon:'âš ï¸',title:'Gagal Membuat Surat',message:'Terjadi kendala saat membuat atau mengirim surat.<br><span class=\"mono\">'+(e.message||e)+'</span>',variant:'danger',buttons:[{label:'Tutup',variant:'secondary',value:true}]});\n  }finally{ showLoading(false); }\n}\n\nasync function confirmDeleteAll(){\n  const ok = await showModal({ icon:'ðŸ—‘ï¸',title:'Konfirmasi Penghapusan', message:'Tindakan ini akan <b>menghapus seluruh data dan surat</b> terkait referensi ini. Lanjutkan?', variant:'confirm', buttons:[ {label:'Batal',variant:'secondary',value:false}, {label:'Ya, Hapus Semua',danger:true,value:true} ] });\n  if(!ok) return; await deleteLetterAndData();\n}\nasync function deleteLetterAndData(){\n  try{\n    showLoading(true,'Menghapus surat dan seluruh data terkaitâ€¦');\n    \n    await performDeleteAll();\n    \n    await successModal('Penghapusan Berhasil','Surat dan seluruh data terkait telah dihapus dari sistem.');\n    location.reload();\n  }catch(e){\n    await showModal({ icon:'âš ï¸', title:'Gagal Menghapus', message:'Terjadi kendala saat menghapus surat atau data.<br><span class=\"mono\">'+(e.message||e)+'</span>', variant:'danger', buttons:[{label:'Tutup',variant:'secondary',value:true}] }).then(()=>location.reload());\n  }finally{ showLoading(false); }\n}\n\n/* ===== Internal Delete Function ===== */\nasync function performDeleteAll(){\n  const targetUrl = getWebhookUrl('DELETE_ALL');\n  if(!targetUrl){\n    throw new Error('Service endpoint not configured. Please verify configuration settings.');\n  }\n\n  // Use the exact same structure as SEND_MESSAGE\n  const payload = {\n    action: 'DELETE_ALL',\n    id_admin1: DATA_REF,\n    id_surat: baseHref(),\n    from: 'Kepala {{ $json.unit_full_name }}',\n    json: lastObj || {},\n    data: lastObj || {},\n    meta: { ref: lastObj?.ref || DATA_REF, operator: lastObj?.operator || null, at: new Date().toISOString() }\n  };\n\n  console.log('DELETE_ALL payload:', JSON.stringify(payload, null, 2));\n\n  const resp = await fetch(targetUrl, {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify(payload)\n  });\n  const text = await resp.text();\n  console.log('DELETE_ALL response:', resp.status, text);\n  \n  if(!resp.ok) throw new Error('HTTP '+resp.status+' â€” '+text.slice(0,200));\n  \n  return text;\n}\n\n/* ===== Upload ===== */\nfunction handleFileSelect(ev){pendingFiles=Array.from(ev.target.files||[]);refreshPendingFilesUI();}\nfunction handleDragOver(ev){ev.preventDefault();ev.stopPropagation();ev.currentTarget.style.borderColor='rgba(56,189,248,.6)';ev.currentTarget.style.background='rgba(56,189,248,.06)';}\nfunction handleDragLeave(ev){ev.preventDefault();ev.stopPropagation();ev.currentTarget.style.borderColor='';ev.currentTarget.style.background='';}\nfunction handleDrop(ev){ev.preventDefault();ev.stopPropagation();ev.currentTarget.style.borderColor='';ev.currentTarget.style.background='';pendingFiles=Array.from(ev.dataTransfer.files||[]);refreshPendingFilesUI();}\nfunction refreshPendingFilesUI(){ if(!elFileInfo||!elUploadBtn) return; if(!pendingFiles.length){elFileInfo.style.display='none';elUploadBtn.style.display='none';return;} elFileInfo.style.display=''; elUploadBtn.style.display=''; elFileInfo.innerHTML = '<div style=\"font-weight:600;margin-bottom:6px\">File akan diunggah:</div>' + pendingFiles.map(f => `<div style=\"font-size:12px; margin-bottom:8px\">â€¢ ${f.name}</div>`).join(''); }\nasync function uploadFiles(){\n  try{\n    if(!pendingFiles.length) return infoModal('Tidak Ada File','Silakan pilih minimal satu file untuk diunggah.');\n    if(!lastObj && !lastJSON) return infoModal('Data Utama Belum Ada','Muat ulang halaman, lalu coba kembali.');\n    if(editMode) await saveChanges();\n\n    const form=new FormData();\n    form.append('action','UPLOAD_FILES');\n    form.append('id_admin1', DATA_REF);\n    form.append('id_surat', baseHref());\n    form.append('from', 'Kepala {{ $json.unit_full_name }}');\n    form.append('data', JSON.stringify({ ...((lastObj)||{}), id_admin1: DATA_REF, id_surat: baseHref() }));\n    pendingFiles.forEach(f=>form.append('files[]',f,f.name));\n\n    if(elProg) elProg.style.display=''; if(elProgBar) elProgBar.style.width='8%';\n    const targetUrl = getWebhookUrl('UPLOAD_FILES');\n    if(!targetUrl){\n      throw new Error('Service endpoint not configured. Please verify configuration settings.');\n    }\n    showLoading(true,'Mengunggah berkasâ€¦');\n    const resp=await fetch(targetUrl,{method:'POST',body:form}); const text=await resp.text();\n    if(!resp.ok) throw new Error('HTTP '+resp.status+' â€” '+text.slice(0,200));\n    if(elProgBar) elProgBar.style.width='100%';\n    await successModal('Unggah Berhasil','Berkas berhasil diunggah dan ditautkan ke data pemohon.');\n\n    pendingFiles=[]; if(elFileInput) elFileInput.value=''; refreshPendingFilesUI(); await loadOnce(false);\n  }catch(e){\n    await showModal({icon:'âš ï¸',title:'Unggah Gagal',message:'Terjadi kendala saat mengunggah berkas.<br><span class=\"mono\">'+(e.message||e)+'</span>',variant:'danger',buttons:[{label:'Tutup',variant:'secondary',value:true}]});\n  }finally{ setTimeout(()=>{if(elProg) elProg.style.display='none';},600); if(elProgBar) elProgBar.style.width='0%'; showLoading(false); }\n}\n\n/* ===== Hapus Dokumen ===== */\nasync function confirmDeleteDocs(docs=[]){\n  if(!docs.length) return;\n  const listHtml=docs.map(d=>{ const sizeTxt = d.size!=null ? humanSize(d.size) : 'â€”'; return `ðŸ“„ <b>${toStr(d.name,'(tanpa nama)')}</b><br>Ukuran: ${sizeTxt}${d.mimeType?(' â€¢ '+d.mimeType):''}<br>ID: <span class=\"mono\">${toStr(d.file_id,'â€”')}</span>`; }).join('<hr style=\"border:0;border-top:1px solid rgba(148,163,184,.25);margin:8px 0\">');\n  const ok = await showModal({ icon:'ðŸ—‚ï¸', title:'Konfirmasi Penghapusan Dokumen', message:`Dokumen berikut akan dihapus dari sistem:<br><br>${listHtml}<br><br>Tindakan ini tidak dapat dibatalkan. Lanjutkan?`, variant:'confirm', buttons:[ {label:'Batal',variant:'secondary',value:false}, {label:'Hapus Dokumen',danger:true,value:true} ] });\n  if(!ok) return; await deleteDocumentsByFileIds(docs.map(d=>d.file_id).filter(Boolean));\n}\nasync function deleteDocumentsByFileIds(fileIds=[]){\n  if(!fileIds.length) return;\n  try{\n    showLoading(true,'Menghapus dokumen terpilihâ€¦');\n    await sendJSON('DELETE_DOCS', { delete_file_ids: fileIds });\n    await loadOnce(false);\n    await successModal('Dokumen Dihapus','Dokumen terpilih telah berhasil dihapus dari sistem.');\n  }catch(e){\n    await showModal({icon:'âš ï¸',title:'Gagal Menghapus Dokumen',message:'Terjadi kendala saat menghapus dokumen.<br><span class=\"mono\">'+(e.message||e)+'</span>',variant:'danger',buttons:[{label:'Tutup',variant:'secondary',value:true}]});\n  }finally{ showLoading(false); }\n}\n\n/* ===== File Validation ===== */\nfunction updateCreateSendButton(hasFiles = false){ const btn=$(\"createSendBtn\"); if(!btn) return; btn.style.opacity = hasFiles ? '1' : '0.5'; btn.style.cursor = hasFiles ? 'pointer' : 'not-allowed'; btn.disabled = !hasFiles; }\n\n/* ===== Status Check & Button Disable ===== */\nfunction checkStatusAndDisableButtons(obj) {\n  const status = obj?.status_web_admin1 || obj?.status_web_admin2 || '';\n  const isLetterSent = status.toLowerCase().includes('terkirim');\n  \n  if (isLetterSent) {\n    disableAllButtons();\n    showStatusMessage('Surat telah terkirim');\n  } else {\n    enableAllButtons();\n  }\n}\n\n/* ===== Show Reject Modal with Notes ===== */\nasync function showRejectModal(){\n  return new Promise(resolve => {\n    // Create modal content with note input\n    const modalContent = `\n      <div style=\"margin-bottom: 16px;\">\n        <label style=\"display: block; margin-bottom: 8px; font-weight: 600; color: #e5e7eb;\">Catatan Kepala {{ $json.unit_full_name }}:</label>\n        <textarea id=\"rejectNoteText\" style=\"\n          width: 100%; \n          min-height: 110px; \n          resize: vertical; \n          color: #e5e7eb; \n          font-size: 14px; \n          line-height: 1.6;\n          background: #0e162b; \n          border: 1px solid rgba(56,189,248,.35); \n          border-radius: 12px; \n          padding: 12px 14px; \n          box-shadow: inset 0 0 0 1px rgba(56,189,248,.15);\n        \" placeholder=\"Tulis alasan penolakan atau instruksi untuk pemohon (wajib diisi)â€¦\"></textarea>\n      </div>\n    `;\n    \n    modalIcon.textContent = 'â›”';\n    modalTitle.textContent = 'Tolak & Hapus Permohonan';\n    modalMessage.innerHTML = modalContent;\n    modalActions.innerHTML = '';\n    modalBox.className = 'modal modal--danger';\n    \n    // Create buttons\n    const cancelBtn = document.createElement('button');\n    cancelBtn.className = 'btn secondary';\n    cancelBtn.textContent = 'Batal';\n    cancelBtn.onclick = () => {\n      hide();\n      resolve(false);\n    };\n    \n    const rejectBtn = document.createElement('button');\n    rejectBtn.className = 'btn danger';\n    rejectBtn.textContent = 'Tolak & Hapus';\n    rejectBtn.onclick = async () => {\n      const noteText = document.getElementById('rejectNoteText').value.trim();\n      if (!noteText) {\n        await infoModal('Catatan Wajib', 'Silakan tulis alasan penolakan terlebih dahulu.');\n        return;\n      }\n      hide();\n      await processRejectWithNote(noteText);\n      resolve(true);\n    };\n    \n    modalActions.appendChild(cancelBtn);\n    modalActions.appendChild(rejectBtn);\n    \n    function onEsc(e) {\n      if (e.key === 'Escape') {\n        hide();\n        resolve(false);\n      }\n    }\n    \n    function hide() {\n      modalOverlay.style.display = 'none';\n      document.removeEventListener('keydown', onEsc);\n    }\n    \n    modalOverlay.style.display = 'flex';\n    document.addEventListener('keydown', onEsc);\n    \n    // Focus on textarea\n    setTimeout(() => {\n      const textarea = document.getElementById('rejectNoteText');\n      if (textarea) textarea.focus();\n    }, 100);\n  });\n}\n\n/* ===== Process Reject with Note ===== */\nasync function processRejectWithNote(noteText) {\n  try {\n    // First send the note\n    showLoading(true, 'Mengirim catatan penolakanâ€¦');\n    \n    const targetUrl = getWebhookUrl('SEND_MESSAGE');\n    if (targetUrl) {\n      const payload = {\n        action: 'SEND_MESSAGE',\n        id_admin1: DATA_REF,\n        id_surat: baseHref(),\n        message: noteText,\n        from: 'Kepala {{ $json.unit_full_name }}',\n        json: lastObj || {},\n        data: lastObj || {},\n        meta: { ref: lastObj?.ref || DATA_REF, operator: lastObj?.operator || null, at: new Date().toISOString() }\n      };\n      \n      const resp = await fetch(targetUrl, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify(payload)\n      });\n      \n      if (resp.ok) {\n        showLoading(true, 'Memproses penolakan dan penghapusan dataâ€¦');\n        // Wait a bit before deleting\n        await new Promise(resolve => setTimeout(resolve, 1000));\n      }\n    }\n    \n    // Then delete the data\n    await performDeleteAll();\n    await successModal('Permohonan Ditolak', 'Catatan penolakan telah dikirim dan data telah dihapus dari sistem.');\n    location.reload();\n  } catch (e) {\n    await showModal({\n      icon: 'âš ï¸',\n      title: 'Gagal Memproses Penolakan',\n      message: 'Terjadi kendala saat memproses penolakan.<br><span class=\"mono\">' + (e.message || e) + '</span>',\n      variant: 'danger',\n      buttons: [{ label: 'Tutup', variant: 'secondary', value: true }]\n    }).then(() => location.reload());\n  } finally {\n    showLoading(false);\n  }\n}\n\n/* ===== Kirim Catatan / Pesan (kept for compatibility) ===== */\nasync function sendNote(){\n  try{\n    const textNote=( $('noteText').value || '' ).trim();\n    if(!textNote) return infoModal('Catatan Kosong','Silakan tulis catatan terlebih dahulu.');\n\n    const ok = await confirmModal(\n      'Kirim Pesan kepada Pemohon',\n      'Pesan berikut akan dikirim:<br><br><i>\"'+textNote.replace(/</g,'&lt;').replace(/>/g,'&gt;')+'\"</i>',\n      { okLabel:'Kirim Sekarang', cancelLabel:'Batal', icon:'âœ‰ï¸' }\n    );\n    if(!ok) return;\n\n    showLoading(true,'Mengirim pesanâ€¦');\n\n    const targetUrl = getWebhookUrl('SEND_MESSAGE');\n    if(!targetUrl){\n      throw new Error('Service endpoint not configured. Please verify configuration settings.');\n    }\n\n    const payload={\n      action: 'SEND_MESSAGE',\n      id_admin1: DATA_REF,\n      id_surat: baseHref(),\n      message: textNote,\n      from: 'Kepala {{ $json.unit_full_name }}',\n      json: lastObj || {},\n      data: lastObj || {},\n      meta: { ref: lastObj?.ref || DATA_REF, operator: lastObj?.operator || null, at: new Date().toISOString() }\n    };\n\n    const resp=await fetch(targetUrl,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});\n    const bodyText=await resp.text();\n    if(!resp.ok){ throw new Error('HTTP '+resp.status+' â€” '+bodyText.slice(0,200)); }\n\n    $('noteText').value='';\n    await successModal('Pesan Terkirim','Catatan/instruksi berhasil dikirim ke sistem.');\n  }catch(e){\n    await showModal({\n      icon:'âš ï¸',\n      title:'Gagal Mengirim Pesan',\n      message:'Tidak dapat mengirim pesan.<br><span class=\"mono\">'+(e.message||e)+'</span>',\n      variant:'danger',\n      buttons:[{label:'Tutup',variant:'secondary',value:true}]\n    });\n  }finally{ showLoading(false); }\n}\n\nfunction disableAllButtons() {\n  \n  // Disable specific buttons by ID\n  const specificButtons = [\n    'createSendBtn',    // Tombol kirim surat dan data\n    'editBtn',          // Tombol edit\n    'uploadBtn'         // Tombol upload\n  ];\n  \n  specificButtons.forEach(buttonId => {\n    const button = document.getElementById(buttonId);\n    if (button) {\n      button.disabled = true;\n      button.classList.add('disabled');\n    }\n  });\n  \n  // Disable all buttons with specific onclick functions\n  const functionalButtons = document.querySelectorAll('button[onclick], .btn[onclick]');\n  functionalButtons.forEach(button => {\n    button.disabled = true;\n    button.classList.add('disabled');\n    // Remove click handlers\n    const originalOnclick = button.onclick;\n    button.onclick = function(e) {\n      e.preventDefault();\n      e.stopPropagation();\n      showModal({\n        icon: 'ðŸ”’',\n        title: 'Aksi Tidak Tersedia',\n        message: 'Surat telah terkirim. Semua tombol telah dinonaktifkan.',\n        variant: 'info',\n        buttons: [{label: 'Tutup', variant: 'secondary', value: true}]\n      });\n      return false;\n    };\n    button.setAttribute('data-original-onclick', originalOnclick ? originalOnclick.toString() : '');\n  });\n  \n  // Disable all delete document buttons (dynamically created)\n  const deleteDocButtons = document.querySelectorAll('.file-actions .btn.danger');\n  deleteDocButtons.forEach(button => {\n    button.disabled = true;\n    button.classList.add('disabled');\n    button.onclick = function(e) {\n      e.preventDefault();\n      showModal({\n        icon: 'ðŸ”’',\n        title: 'Hapus Dokumen Tidak Tersedia',\n        message: 'Surat telah terkirim. Dokumen tidak dapat dihapus.',\n        variant: 'info',\n        buttons: [{label: 'Tutup', variant: 'secondary', value: true}]\n      });\n    };\n  });\n  \n  // Disable file input\n  const fileInput = document.getElementById('fileInput');\n  if (fileInput) {\n    fileInput.disabled = true;\n  }\n  \n  // Disable file upload container drag and drop\n  const uploadContainer = document.querySelector('.file-upload-container');\n  if (uploadContainer) {\n    uploadContainer.style.pointerEvents = 'none';\n    uploadContainer.style.opacity = '0.5';\n    uploadContainer.ondragover = null;\n    uploadContainer.ondragleave = null;\n    uploadContainer.ondrop = null;\n  }\n  \n  // Disable edit mode if active and prevent future edit mode activation\n  if (editMode) {\n    document.body.classList.remove('edit-mode');\n    editMode = false;\n  }\n  \n  // Mark system as disabled to prevent edit mode activation\n  window.systemDisabled = true;\n}\n\nfunction enableAllButtons() {\n  \n  // Enable specific buttons by ID\n  const specificButtons = [\n    'createSendBtn',    // Tombol kirim surat dan data\n    'editBtn',          // Tombol edit\n    'uploadBtn'         // Tombol upload\n  ];\n  \n  specificButtons.forEach(buttonId => {\n    const button = document.getElementById(buttonId);\n    if (button) {\n      button.disabled = false;\n      button.classList.remove('disabled');\n    }\n  });\n  \n  // Enable all buttons and restore original onclick functions\n  const functionalButtons = document.querySelectorAll('button[onclick], .btn[onclick]');\n  functionalButtons.forEach(button => {\n    button.disabled = false;\n    button.classList.remove('disabled');\n    \n    // Restore original onclick if it was saved\n    const originalOnclick = button.getAttribute('data-original-onclick');\n    if (originalOnclick && originalOnclick !== '') {\n      try {\n        button.onclick = new Function(originalOnclick);\n      } catch (e) {\n        // Could not restore original onclick\n      }\n    }\n    button.removeAttribute('data-original-onclick');\n  });\n  \n  // Enable file input\n  const fileInput = document.getElementById('fileInput');\n  if (fileInput) {\n    fileInput.disabled = false;\n  }\n  \n  // Enable file upload container drag and drop\n  const uploadContainer = document.querySelector('.file-upload-container');\n  if (uploadContainer) {\n    uploadContainer.style.pointerEvents = '';\n    uploadContainer.style.opacity = '';\n    uploadContainer.ondragover = handleDragOver;\n    uploadContainer.ondragleave = handleDragLeave;\n    uploadContainer.ondrop = handleDrop;\n  }\n  \n  // Mark system as enabled\n  window.systemDisabled = false;\n}\n\nfunction showStatusMessage(message) {\n  // Create or update status message\n  let statusDiv = document.getElementById('statusMessage');\n  if (!statusDiv) {\n    statusDiv = document.createElement('div');\n    statusDiv.id = 'statusMessage';\n    statusDiv.style.cssText = `\n      background: rgba(34,197,94,.1);\n      border: 1px solid rgba(34,197,94,.35);\n      border-radius: 12px;\n      padding: 12px 14px;\n      margin: 14px 0;\n      font-size: 14px;\n      color: #d1fae5;\n      text-align: center;\n      font-weight: 700;\n      animation: slideIn 0.5s ease-out;\n    `;\n    \n    // Insert after the brand section\n    const topbar = document.querySelector('.topbar');\n    if (topbar && topbar.nextSibling) {\n      topbar.parentNode.insertBefore(statusDiv, topbar.nextSibling);\n    }\n  }\n  \n  statusDiv.innerHTML = `ðŸŸ¢ ${message}`;\n  statusDiv.style.display = 'block';\n  \n  // Add slide-in animation\n  const style = document.createElement('style');\n  style.textContent = `\n    @keyframes slideIn {\n      from { opacity: 0; transform: translateY(-10px); }\n      to { opacity: 1; transform: translateY(0); }\n    }\n  `;\n  if (!document.querySelector('style[data-status-animation]')) {\n    style.setAttribute('data-status-animation', 'true');\n    document.head.appendChild(style);\n  }\n}\n\n/* ================= 18) START ================= */\nwindow.toggleEditMode=toggleEditMode; window.saveChanges=saveChanges; window.cancelEdit=cancelEdit;\nwindow.uploadFiles=uploadFiles; window.confirmCreateAndSend=confirmCreateAndSend; window.confirmDeleteAll=confirmDeleteAll;\nwindow.handleFileSelect=handleFileSelect; window.handleDragOver=handleDragOver; window.handleDragLeave=handleDragLeave; window.handleDrop=handleDrop;\nwindow.checkStatusAndDisableButtons=checkStatusAndDisableButtons; window.sendNote=sendNote; window.showRejectModal=showRejectModal;\n\ndocument.addEventListener('DOMContentLoaded',startRealtime);\n</script>\n\n</body>\n</html>\n"
      },
      "type": "n8n-nodes-base.html",
      "typeVersion": 1.2,
      "position": [
        1904,
        288
      ],
      "id": "8c954901-52e0-4756-9f92-df4e0aed3268",
      "name": "C26",
      "executeOnce": true
    },
    {
      "parameters": {
        "jsCode": "/**\n * STRICT v2 â€” id_admin1 dari JSON (fallback base), dokumen dari non-JSON\n * Perbaikan: tambahkan id_admin2 dari base payload.\n * Mode   : Run Once for All Items\n */\n\n/* ===================== Utils ===================== */\nconst isObj  = (x) => x && typeof x === 'object' && !Array.isArray(x);\nconst clean  = (x, fb='') => { const v = (x ?? '').toString().trim(); return v ? v : fb; };\nconst toTime = (x) => { const t = Date.parse(x); return Number.isFinite(t) ? t : 0; };\n\nconst isJsonMime = (m) => clean(m).toLowerCase() === 'application/json';\nconst isJsonName = (n) => clean(n).toLowerCase().endsWith('.json');\nconst isJsonExt  = (e) => clean(e).toLowerCase() === 'json';\n\nconst stripCUs   = (jid='') => jid.replace(/@c\\.us$/i,'');\nconst onlyDigits = (s='')   => (s.match(/\\d+/g) || []).join('');\nconst deriveWaha = (jid) => {\n  const JID = clean(jid) || '';\n  const noSuffix = JID ? stripCUs(JID) : '';\n  const number   = noSuffix ? onlyDigits(noSuffix) : '';\n  return { jid: JID || undefined, noSuffix: noSuffix || undefined, number: number || undefined };\n};\n\n/** File dianggap metadata Drive jika punya id/file_id dan ada petunjuk Drive */\nfunction isDriveMeta(j){\n  if (!j || typeof j !== 'object') return false;\n  const id = clean(j.id) || clean(j.file_id);\n  if (!id) return false;\n  const hints = j.mimeType || j.type || j.webViewLink || j.webContentLink || (j.kind === 'drive#file');\n  return !!hints;\n}\n\n/** Non-JSON checker (aman walau sebagian field kosong) */\nfunction isNonJsonFile(f){\n  const mime = clean(f.mimeType || f.type);\n  const name = clean(f.name) || clean(f.originalFilename);\n  const ext  = clean(f.fileExtension || f.fullFileExtension);\n  if (isJsonMime(mime)) return false;\n  if (!mime && isJsonName(name)) return false;\n  if (isJsonExt(ext)) return false;\n  return true;\n}\n\n/** Konversi metadata Drive â†’ record dokumen */\nfunction toDocRecord(f){\n  const id   = clean(f.id) || clean(f.file_id);\n  const name = clean(f.name) || clean(f.originalFilename) || 'untitled';\n  const type = clean(f.mimeType || f.type) || 'application/octet-stream';\n\n  const raw  = (f.size ?? f.quotaBytesUsed ?? '').toString();\n  const size = /^\\d+$/.test(raw) ? parseInt(raw, 10) : undefined;\n\n  const view = clean(f.webViewLink)\n            || clean(f.view_url)\n            || (id ? `https://drive.google.com/file/d/${id}/view?usp=drivesdk` : '');\n\n  const down = clean(f.webContentLink)\n            || clean(f.download_url)\n            || (id ? `https://drive.google.com/uc?id=${id}&export=download` : '');\n\n  const rec = { name, type, file_id: id, view_url: view, download_url: down };\n  if (size !== undefined) rec.size = size;\n  return rec;\n}\n\n/* ===================== 1) Kumpulkan base & kandidat Drive ===================== */\nfunction findBase(){\n  for (const it of items) {\n    const j = it.json || {};\n    if (j && (j.action || j.strategy || isObj(j.pemohon))) return j;\n\n    const b = Array.isArray(j.body) ? j.body[0] : undefined;\n    if (isObj(b) && (b.action || b.strategy || isObj(b.pemohon))) return b;\n  }\n  const j0 = items[0]?.json ?? {};\n  if (Array.isArray(j0.body) && isObj(j0.body[0])) return j0.body[0];\n  return j0;\n}\nconst base = findBase();\n\nconst driveFiles = [];\nfor (const it of items) {\n  const j = it.json || {};\n  if (isDriveMeta(j)) driveFiles.push(j);\n}\n\n/* ===================== 2) Cari JSON terbaru & tentukan id_admin1 ===================== */\nconst jsonItems = driveFiles\n  .filter(f => {\n    const mime = clean(f.mimeType || f.type);\n    const name = clean(f.name) || clean(f.originalFilename);\n    const ext  = clean(f.fileExtension || f.fullFileExtension);\n    return isJsonMime(mime) || isJsonName(name) || isJsonExt(ext);\n  })\n  .map(f => ({\n    id: clean(f.id) || clean(f.file_id),\n    t : Math.max(toTime(f.modifiedTime), toTime(f.createdTime))\n  }))\n  .sort((a,b) => b.t - a.t);\n\nconst newestJson     = jsonItems[0] || null;\nconst newestJsonTime = newestJson ? newestJson.t : 0;\n\n// Prioritas: JSON terbaru di batch â†’ fallback base.id_admin1 â†’ ''\nconst idAdmin1 = clean(newestJson?.id) || clean(base.id_admin1) || '';\n\n/* ===================== 3) Kumpulkan dokumen non-JSON (dedup + sort desc time) ===================== */\nlet nonJsonCandidates = driveFiles.filter(isNonJsonFile);\n\nif (newestJsonTime > 0) {\n  nonJsonCandidates = nonJsonCandidates.filter(f => {\n    const t = Math.max(toTime(f.modifiedTime), toTime(f.createdTime));\n    return t > newestJsonTime;\n  });\n}\n\nnonJsonCandidates.sort((a,b) =>\n  Math.max(toTime(b.modifiedTime), toTime(b.createdTime)) -\n  Math.max(toTime(a.modifiedTime), toTime(a.createdTime))\n);\n\nconst seen = new Set();\nconst finalDocs = [];\nfor (const f of nonJsonCandidates) {\n  const fid = clean(f.id) || clean(f.file_id);\n  if (!fid || seen.has(fid)) continue;\n  seen.add(fid);\n  finalDocs.push(toDocRecord(f));\n}\n\n/* ===================== 4) Susun OUT (tambahkan id_admin2) ===================== */\nconst OUT = {\n  id_user   : clean(base.id_user),\n  id_admin1 : idAdmin1,\n  id_admin2 : clean(base.id_admin2),       // <-- perbaikan utama\n  id_surat  : clean(base.id_surat),\n  date      : clean(base.date),\n  pemohon   : isObj(base.pemohon) ? base.pemohon : {},\n  dokumen   : finalDocs\n};\n\n// Field opsional\nif (base.WAHA_Trigger_session !== undefined) OUT.WAHA_Trigger_session = clean(base.WAHA_Trigger_session);\nif (base.LogoURL !== undefined) OUT.LogoURL = clean(base.LogoURL);\nif (base.webhook !== undefined) OUT.webhook = clean(base.webhook);\nif (base.send_to !== undefined) OUT.send_to = clean(base.send_to);\nif (base.status_web_user !== undefined) OUT.status_web_user = clean(base.status_web_user);\nif (base.status_web_admin1 !== undefined) OUT.status_web_admin1 = clean(base.status_web_admin1);\n\nif (base.WAHA_Trigger_payload_from_user !== undefined) {\n  const d = deriveWaha(base.WAHA_Trigger_payload_from_user);\n  OUT.WAHA_Trigger_payload_from_user = d.jid;\n}\n\nif (base.WAHA_Trigger_payload_from_admin1 !== undefined) {\n  const d1 = deriveWaha(base.WAHA_Trigger_payload_from_admin1);\n  OUT.WAHA_Trigger_payload_from_admin1 = d1.jid;\n}\n\nif (base.WAHA_Trigger_payload_from_admin2 !== undefined) {\n  const d2 = deriveWaha(base.WAHA_Trigger_payload_from_admin2);\n  OUT.WAHA_Trigger_payload_from_admin2 = d2.jid;\n}\n\nreturn [{ json: OUT }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1872,
        448
      ],
      "id": "f331fc0f-7566-4c24-bcd0-e419e28dd16e",
      "name": "C25"
    },
    {
      "parameters": {
        "jsCode": "// Input: items (array dari n8n)\nreturn items.map(item => {\n  const data = item.json;\n\n  // Ambil id_web sesuai prioritas\n  let id_web = null;\n  if (data.id_admin2) {\n    id_web = data.id_admin2;\n  } else if (data.id_admin1) {\n    id_web = data.id_admin1;\n  } else {\n    id_web = data.id_user;\n  }\n\n  // Tambahkan id_web ke data\n  return {\n    json: {\n      ...data,\n      id_web\n    }\n  };\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1760,
        288
      ],
      "id": "7150d3e0-57eb-4f0c-93eb-071701a9726a",
      "name": "C24",
      "executeOnce": true
    },
    {
      "parameters": {
        "operation": "share",
        "fileId": {
          "__rl": true,
          "value": "={{ $json.id }}",
          "mode": "id"
        },
        "permissionsUi": {
          "permissionsValues": {
            "role": "reader",
            "type": "anyone"
          }
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        1456,
        464
      ],
      "id": "84d586a2-1f0c-4e17-a8c7-a026a1c5f2dc",
      "name": "C23",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "K6YEbjdSQULsuuJd",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        1616,
        288
      ],
      "id": "48503448-51df-4491-a2d8-31cfe8c86149",
      "name": "C22",
      "executeOnce": false
    },
    {
      "parameters": {
        "inputDataFieldName": "={{ $json.binaryProperty }}",
        "name": "={{ $binary[$json.binaryProperty].fileName }}",
        "driveId": {
          "__rl": true,
          "mode": "list",
          "value": "My Drive"
        },
        "folderId": {
          "__rl": true,
          "value": "={{ $json.id }}",
          "mode": "id"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        1232,
        464
      ],
      "id": "f981ac83-dc31-4b65-9205-f4c3d9b31e54",
      "name": "C21",
      "executeOnce": false,
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "K6YEbjdSQULsuuJd",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        1424,
        272
      ],
      "id": "89bc7268-751e-466a-a596-d0cff67605d3",
      "name": "C20",
      "executeOnce": false
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        1088,
        464
      ],
      "id": "6804e92f-4a7a-4baf-b0c4-607900c58ff7",
      "name": "C19"
    },
    {
      "parameters": {
        "jsCode": "/**\n * n8n Code Node â€” Set new file ID into id_admin1 or id_admin2 (single-key JSON output)\n * Mode: Run Once for Single Item\n */\n\nlet data = items?.[0]?.json ?? {};\nif (Array.isArray(data)) data = data[0] ?? {};\n\n// ---------- Utils ----------\nconst pick = (...vals) => {\n  for (const v of vals) {\n    if (v != null && String(v).trim() !== '') return String(v).trim();\n  }\n  return '';\n};\nconst hasVal = (v) => v != null && String(v).trim() !== '';\n\n// ---------- 1) Ambil ID baru (prioritas: root.id, fallback: dokumen[0].file_id) ----------\nconst newId = pick(\n  data.id, // ID file Google Drive yang baru dibuat\n  Array.isArray(data.dokumen) ? data.dokumen[0]?.file_id : undefined\n);\n\nif (!hasVal(newId)) {\n  return [\n    {\n      json: {\n        error: 'new_id_not_found',\n        message:\n          'ID baru tidak ditemukan. Pastikan tersedia salah satu: root.id atau dokumen[0].file_id.'\n      }\n    }\n  ];\n}\n\n// ---------- 2) Deteksi apakah sudah punya id_admin1/idadmin1 ----------\nconst existingIdAdmin1 = pick(\n  data.id_admin1,   // format snake_case (contoh pada payload)\n  data.idadmin1     // antisipasi variasi tanpa underscore\n);\nconst hasIdAdmin1 = hasVal(existingIdAdmin1);\n\n// ---------- 3) Keluarkan hanya SATU kunci ----------\nconst out = {};\nif (!hasIdAdmin1) {\n  out.id_admin1 = newId;\n} else {\n  out.id_admin2 = newId;\n}\n\nreturn [{ json: out }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1248,
        272
      ],
      "id": "54c892ef-f6cf-4497-be87-bec2d2e2adcf",
      "name": "C18"
    },
    {
      "parameters": {
        "resource": "folder",
        "name": "={{ \n  DateTime.now()\n    .setZone('Asia/Tokyo')\n    .setLocale('id')\n    .toFormat('dd_MM_yyyy_HH_mm_ss')\n  + '_' \n  + $json.pemohon.nama.trim().replace(/\\s+/g, '-').toUpperCase()\n  + '_' \n  + $json.pemohon.nik \n}}\n",
        "driveId": {
          "__rl": true,
          "mode": "list",
          "value": "My Drive"
        },
        "folderId": {
          "__rl": true,
          "value": "={{ $('C5').item.json.route_info.folder_files_id }}",
          "mode": "id"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        912,
        528
      ],
      "id": "a5dac0e1-2519-4836-99ab-a2b28455fed5",
      "name": "C17",
      "executeOnce": true,
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "K6YEbjdSQULsuuJd",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        1104,
        272
      ],
      "id": "31b7b84f-a475-4b58-91c9-7d29548b5558",
      "name": "C16"
    },
    {
      "parameters": {
        "jsCode": "// Run Once for All Items\nconst out = [];\nfor (const item of items) {\n  const bin = item.binary || {};\n  const keys = Object.keys(bin);\n  if (keys.length === 0) { out.push(item); continue; }\n  for (const k of keys) {\n    out.push({\n      json: { binaryProperty: k },\n      binary: { [k]: bin[k] },\n    });\n  }\n}\nreturn out;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        768,
        448
      ],
      "id": "85932304-a472-4589-ab06-84b03d2b51d2",
      "name": "C15"
    },
    {
      "parameters": {
        "driveId": {
          "__rl": true,
          "mode": "list",
          "value": "My Drive"
        },
        "folderId": {
          "__rl": true,
          "value": "={{ $json.id }}",
          "mode": "id"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        880,
        144
      ],
      "id": "55303e0a-b048-479b-8fe4-725a59055788",
      "name": "C14",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "K6YEbjdSQULsuuJd",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "operation": "download",
        "fileId": {
          "__rl": true,
          "value": "={{ $json.fileId }}",
          "mode": "id"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        624,
        448
      ],
      "id": "65b54ad4-295f-4e6e-aadc-d89460e67a33",
      "name": "C13",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "K6YEbjdSQULsuuJd",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        720,
        144
      ],
      "id": "5261aeed-21e1-4d38-aa93-ae0a5fe39127",
      "name": "C12"
    },
    {
      "parameters": {
        "jsCode": "// Input: item tunggal dari Webhook\nconst body = $json.body || $json;   // kalau webhook kirim \"body\", pakai itu. Jika tidak, langsung pakai $json\n\n// ==== Ambil semua dokumen ====\nconst dokumen = Array.isArray(body.dokumen) \n  ? body.dokumen \n  : [];\n\n// ==== Ambil semua file_id ====\nconst ids = dokumen\n  .map(d => (d?.file_id || '').trim())\n  .filter(x => x.length > 0);\n\n// ==== Hapus duplikat ====\nconst uniq = [...new Set(ids)];\n\n// Output array items untuk n8n\nreturn uniq.map(id => ({ json: { fileId: id } }));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        480,
        448
      ],
      "id": "f8b8ad62-c347-4e83-8515-2218a6d558a1",
      "name": "C11"
    },
    {
      "parameters": {
        "resource": "folder",
        "name": "={{ \n  DateTime.now()\n    .setZone('Asia/Tokyo')\n    .setLocale('id')\n    .toFormat('dd_MM_yyyy_HH_mm_ss')\n  + '_' \n  + $json.pemohon.nama.trim().replace(/\\s+/g, '-').toUpperCase()\n  + '_' \n  + $json.pemohon.nik \n}}\n",
        "driveId": {
          "__rl": true,
          "mode": "list",
          "value": "My Drive"
        },
        "folderId": {
          "__rl": true,
          "value": "={{ $json.route_info.folder_data_id }}",
          "mode": "id"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        512,
        128
      ],
      "id": "39a82df5-afa3-416a-99fa-d8e92ff4feeb",
      "name": "C10",
      "executeOnce": true,
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "K6YEbjdSQULsuuJd",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "operation": "toJson",
        "options": {
          "fileName": "={{ DateTime.now().setZone('Asia/Tokyo').setLocale('id').toFormat('dd_MM_yyyy_HH_mm_ss') + '_' + ($json.pemohon.nama).trim().replace(/\\s+/g,'-').toUpperCase() + '_' + ($json.pemohon.nik) }}\n"
        }
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        576,
        288
      ],
      "id": "85395d07-efa2-428f-bfc9-ccd813727373",
      "name": "C9"
    },
    {
      "parameters": {
        "jsCode": "/**\n * STRICT v2 â€” id_admin1 dari JSON (fallback base), dokumen dari non-JSON\n * Mode   : Run Once for All Items\n * Kebijakan:\n *  - Tidak memakai base.dokumen\n *  - id_admin1 = id file JSON terbaru di batch; jika tak ada JSON â†’ pakai base.id_admin1\n *  - dokumen   = semua file Drive non-JSON dari batch (dedup, sort terbaruâ†’lama)\n */\n\n/* ===================== Utils ===================== */\nconst isObj  = (x) => x && typeof x === 'object' && !Array.isArray(x);\nconst clean  = (x, fb='') => { const v = (x ?? '').toString().trim(); return v ? v : fb; };\nconst toTime = (x) => { const t = Date.parse(x); return Number.isFinite(t) ? t : 0; };\n\nconst isJsonMime = (m) => clean(m).toLowerCase() === 'application/json';\nconst isJsonName = (n) => clean(n).toLowerCase().endsWith('.json');\nconst isJsonExt  = (e) => clean(e).toLowerCase() === 'json';\n\nconst stripCUs   = (jid='') => jid.replace(/@c\\.us$/i,'');                // (NEW)\nconst onlyDigits = (s='')   => (s.match(/\\d+/g) || []).join('');          // (NEW)\nconst deriveWaha = (jid) => {                                             // (NEW)\n  const JID = clean(jid) || '';\n  const noSuffix = JID ? stripCUs(JID) : '';\n  const number   = noSuffix ? onlyDigits(noSuffix) : '';\n  return { jid: JID || undefined, noSuffix: noSuffix || undefined, number: number || undefined };\n};\n\n/** File dianggap metadata Drive jika punya id/file_id dan ada petunjuk Drive */\nfunction isDriveMeta(j){\n  if (!j || typeof j !== 'object') return false;\n  const id = clean(j.id) || clean(j.file_id);\n  if (!id) return false;\n  const hints = j.mimeType || j.type || j.webViewLink || j.webContentLink || (j.kind === 'drive#file');\n  return !!hints;\n}\n\n/** Non-JSON checker (aman walau sebagian field kosong) */\nfunction isNonJsonFile(f){\n  const mime = clean(f.mimeType || f.type);\n  const name = clean(f.name) || clean(f.originalFilename);\n  const ext  = clean(f.fileExtension || f.fullFileExtension);\n  if (isJsonMime(mime)) return false;\n  if (!mime && isJsonName(name)) return false;\n  if (isJsonExt(ext)) return false;\n  return true;\n}\n\n/** Konversi metadata Drive â†’ record dokumen */\nfunction toDocRecord(f){\n  const id   = clean(f.id) || clean(f.file_id);\n  const name = clean(f.name) || clean(f.originalFilename) || 'untitled';\n  const type = clean(f.mimeType || f.type) || 'application/octet-stream';\n\n  const raw  = (f.size ?? f.quotaBytesUsed ?? '').toString();\n  const size = /^\\d+$/.test(raw) ? parseInt(raw, 10) : undefined;\n\n  const view = clean(f.webViewLink)\n            || clean(f.view_url)\n            || (id ? `https://drive.google.com/file/d/${id}/view?usp=drivesdk` : '');\n\n  const down = clean(f.webContentLink)\n            || clean(f.download_url)\n            || (id ? `https://drive.google.com/uc?id=${id}&export=download` : '');\n\n  const rec = { name, type, file_id: id, view_url: view, download_url: down };\n  if (size !== undefined) rec.size = size;\n  return rec;\n}\n\n/* ===================== 1) Kumpulkan base & kandidat Drive ===================== */\nfunction findBase(){\n  for (const it of items) {\n    const j = it.json || {};\n    if (j && (j.action || j.strategy || isObj(j.pemohon))) return j;\n  }\n  return items[0]?.json ?? {};\n}\nconst base = findBase();\n\nconst driveFiles = [];\nfor (const it of items) {\n  const j = it.json || {};\n  if (isDriveMeta(j)) driveFiles.push(j);\n}\n\n/* ===================== 2) Cari JSON terbaru & tentukan id_admin1 ===================== */\nconst jsonItems = driveFiles\n  .filter(f => {\n    const mime = clean(f.mimeType || f.type);\n    const name = clean(f.name) || clean(f.originalFilename);\n    const ext  = clean(f.fileExtension || f.fullFileExtension);\n    return isJsonMime(mime) || isJsonName(name) || isJsonExt(ext);\n  })\n  .map(f => ({\n    id: clean(f.id) || clean(f.file_id),\n    t : Math.max(toTime(f.modifiedTime), toTime(f.createdTime))\n  }))\n  .sort((a,b) => b.t - a.t);\n\nconst newestJson     = jsonItems[0] || null;\nconst newestJsonTime = newestJson ? newestJson.t : 0;\n\n// Prioritas: JSON terbaru di batch â†’ fallback base.id_admin1 â†’ ''\nconst idAdmin1 = clean(newestJson?.id) || clean(base.id_admin1) || '';\n\n/* ===================== 3) Kumpulkan dokumen non-JSON (dedup + sort desc time) ===================== */\nlet nonJsonCandidates = driveFiles.filter(isNonJsonFile);\n\n// Bila ada JSON terbaru, ambil hanya file yang lebih baru dari JSON tersebut\nif (newestJsonTime > 0) {\n  nonJsonCandidates = nonJsonCandidates.filter(f => {\n    const t = Math.max(toTime(f.modifiedTime), toTime(f.createdTime));\n    return t > newestJsonTime;\n  });\n}\n\n// Sort terbaru â†’ lama\nnonJsonCandidates.sort((a,b) =>\n  Math.max(toTime(b.modifiedTime), toTime(b.createdTime)) -\n  Math.max(toTime(a.modifiedTime), toTime(a.createdTime))\n);\n\n// Dedup by id\nconst seen = new Set();\nconst finalDocs = [];\nfor (const f of nonJsonCandidates) {\n  const fid = clean(f.id) || clean(f.file_id);\n  if (!fid || seen.has(fid)) continue;\n  seen.add(fid);\n  finalDocs.push(toDocRecord(f));\n}\n\n/* ===================== 4) Susun OUT (tanpa base.dokumen) ===================== */\nconst OUT = {\n  id_user  : clean(base.id_user),\n  id_admin1: idAdmin1,\n  id_surat : clean(base.id_surat),\n  date     : clean(base.date),\n  pemohon  : isObj(base.pemohon) ? base.pemohon : {},\n  dokumen  : finalDocs\n};\n\n// Field opsional yang tetap dipertahankan jika ada\nif (base.WAHA_Trigger_session !== undefined) OUT.WAHA_Trigger_session = clean(base.WAHA_Trigger_session);\nif (base.LogoURL !== undefined) OUT.LogoURL = clean(base.LogoURL);\nif (base.webhook !== undefined) OUT.webhook = clean(base.webhook);\n\nif (base.WAHA_Trigger_payload_from_user !== undefined) {\n  const d = deriveWaha(base.WAHA_Trigger_payload_from_user);\n  OUT.WAHA_Trigger_payload_from_user         = d.jid;        // asli\n}\n\nif (base.WAHA_Trigger_payload_from_admin1 !== undefined) {\n  const d1 = deriveWaha(base.WAHA_Trigger_payload_from_admin1);\n  OUT.WAHA_Trigger_payload_from_admin1         = d1.jid;       // asli\n\n}\n\n/* --------------------- ADMIN2: tambahkan ke OUT --------------------- */\nif (base.WAHA_Trigger_payload_from_admin2 !== undefined) {      // (NEW)\n  const d2 = deriveWaha(base.WAHA_Trigger_payload_from_admin2); // (NEW)\n  OUT.WAHA_Trigger_payload_from_admin2         = d2.jid;        // (NEW)\n\n}\n\nreturn [{ json: OUT }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        432,
        288
      ],
      "id": "0c87d2c9-3010-410b-a74b-440e8ab0194f",
      "name": "C8"
    },
    {
      "parameters": {
        "jsCode": "/**\n * n8n Code Node â€” Header/Keterangan/From dinamis per Distrik/Kampung/Kelurahan (per-wilayah)\n * Mode  : Run Once for Single Item\n * Output (minimal): {\n *   unit_type, unit_name, unit_full_name, email, address, from, keterangan_html, no_surat, top_title\n * }\n */\n\n// ---------- 1) Ambil & normalisasi input ----------\nlet raw = items?.[0]?.json ?? {};\nif (Array.isArray(raw)) raw = raw[0] ?? {};\nif (!raw || typeof raw !== 'object') raw = {};\n\n// ---------- 2) Util ----------\nconst pick = (...vals) => {\n  for (const v of vals) if (v != null && String(v).trim() !== '') return String(v).trim();\n  return '';\n};\nconst toTitle = (s) => {\n  if (!s) return '';\n  return s.replace(/\\s+/g,' ').trim().toLowerCase().replace(/\\b\\w/g,c=>c.toUpperCase());\n};\nconst lc = (s) => String(s||'').trim().toLowerCase();\n\n// Hapus awalan \"Kelurahan \" / \"Kampung \"\nconst stripPrefix = (s='') => {\n  const t = s.replace(/^\\s*(kelurahan|kampung)\\s+/i, '').trim();\n  return t || s.trim();\n};\n\n// ---------- 3) Master data wilayah (otoritatif) ----------\nconst WILAYAH = {\n  'Inauga': {\n    top_title: 'PEMERINTAH KABUPATEN MIMIKA DISTRIK WANIA',\n    type: 'Kelurahan',\n    fullName: 'Kelurahan Inauga',\n    email: 'kel.inauga@gmail.com',\n    address: 'Jln. Yohanes Aikawe - Kode Pos 99963',\n    phone: '+62-901-321001',\n    headTitle: 'Lurah',\n    headName: 'Lurah Inauga',\n    no_surat: '145 / 03 / SKTM / KN / DW / INA / I / 2025',\n  },\n  'Kamoro Jaya': {\n    top_title: 'PEMERINTAH KABUPATEN MIMIKA DISTRIK WANIA',\n    type: 'Kelurahan',\n    fullName: 'Kelurahan Kamoro Jaya',\n    email: 'kel.kamorojaya@gmail.com',\n    address: 'Jln. Kamoro Raya - Kode Pos 99963',\n    phone: '+62-901-321002',\n    headTitle: 'Lurah',\n    headName: 'Lurah Kamoro Jaya',\n    no_surat: '145 / 03 / SKTM / KN / DW / KJ / I / 2025',\n  },\n  'Wonosari Jaya': {\n    top_title: 'PEMERINTAH KABUPATEN MIMIKA DISTRIK WANIA',\n    type: 'Kelurahan',\n    fullName: 'Kelurahan Wonosari Jaya',\n    email: 'kel.wonosarijaya@gmail.com',\n    address: 'Jln. Wonosari Indah - Kode Pos 99963',\n    phone: '+62-901-321003',\n    headTitle: 'Lurah',\n    headName: 'Lurah Wonosari Jaya',\n    no_surat: '145 / 03 / SKTM / KN / DW / WJ / I / 2025',\n  },\n  'Kadun Jaya': {\n    top_title: 'PEMERINTAH KABUPATEN MIMIKA DISTRIK WANIA',\n    type: 'Kampung',\n    fullName: 'Kampung Kadun Jaya',\n    email: 'kampungkadunjaya@gmail.com',\n    address: 'Jln. Yohanes Aikawe - Kode Pos 99963',\n    phone: '+62-901-321004',\n    headTitle: 'Kepala Kampung',\n    headName: 'Kepala Kampung Kadun Jaya',\n    no_surat: '145 / 03 / SKTM / KN / DW / KDJ / I / 2025',\n  },\n  'Mandiri Jaya': {\n    top_title: 'PEMERINTAH KABUPATEN MIMIKA DISTRIK WANIA',\n    type: 'Kampung',\n    fullName: 'Kampung Mandiri Jaya',\n    email: 'kampungmandirijaya@gmail.com',\n    address: 'Jln. Mandiri Sejahtera - Kode Pos 99963',\n    phone: '+62-901-321005',\n    headTitle: 'Kepala Kampung',\n    headName: 'Kepala Kampung Mandiri Jaya',\n    no_surat: '145 / 03 / SKTM / KN / DW / MDJ / I / 2025',\n  },\n  'Mawokau Jaya': {\n    top_title: 'PEMERINTAH KABUPATEN MIMIKA DISTRIK WANIA',\n    type: 'Kampung',\n    fullName: 'Kampung Mawokau Jaya',\n    email: 'kampungmawokaujaya@gmail.com',\n    address: 'Jln. Mawokau Permai - Kode Pos 99963',\n    phone: '+62-901-321006',\n    headTitle: 'Kepala Kampung',\n    headName: 'Kepala Kampung Mawokau Jaya',\n    no_surat: '145 / 03 / SKTM / KN / DW / MWJ / I / 2025',\n  },\n  'Nawaripi': {\n    top_title: 'PEMERINTAH KABUPATEN MIMIKA DISTRIK WANIA',\n    type: 'Kampung',\n    fullName: 'Kampung Nawaripi',\n    email: 'kampungnawaripi4@gmail.com',\n    address: 'Jln. Nawaripi Indah - Kode Pos 99963',\n    phone: '+62-901-321007',\n    headTitle: 'Kepala Kampung',\n    headName: 'Kepala Kampung Nawaripi',\n    no_surat: '145 / 03 / SKTM / KN / DW / NWP / I / 2025',\n  },\n};\n\n// ---------- 3b) Profil DISTRIK (dummy) ----------\nconst DISTRIK_WANIA = {\n  top_title: 'PEMERINTAH KABUPATEN MIMIKA',\n  key: 'Distrik Wania',\n  type: 'Distrik',\n  fullName: 'Distrik Wania',\n  email: 'distrik.wania@gmail.com',           // dummy\n  address: 'Jln. Poros Wania No. 1, Mimika',  // dummy\n  phone: '+62-901-320000',                    // dummy\n  headTitle: 'Kepala Distrik',\n  headName: 'Kepala Distrik Wania',           // dummy\n  no_surat: '145 / 03 / SKTM / KN / DW / I / 2025', // khusus level distrik (tanpa kode wilayah)\n};\n\n// ---------- 4) Alias/synonym map (huruf kecil) ----------\nconst ALIAS = {\n  // Kelurahan/Kampung\n  'inauga': 'Inauga',\n  'kelurahan inauga': 'Inauga',\n  'kamoro jaya': 'Kamoro Jaya',\n  'kelurahan kamoro jaya': 'Kamoro Jaya',\n  'wonosari jaya': 'Wonosari Jaya',\n  'kelurahan wonosari jaya': 'Wonosari Jaya',\n  'kadun jaya': 'Kadun Jaya',\n  'kampung kadun jaya': 'Kadun Jaya',\n  'mandiri jaya': 'Mandiri Jaya',\n  'kampung mandiri jaya': 'Mandiri Jaya',\n  'mawokau jaya': 'Mawokau Jaya',\n  'kampung mawokau jaya': 'Mawokau Jaya',\n  'nawaripi': 'Nawaripi',\n  'kampung nawaripi': 'Nawaripi',\n  // Distrik\n  'distrik wania': DISTRIK_WANIA.key,\n  'wania': DISTRIK_WANIA.key,\n};\n\n// ---------- 5) Keterangan HTML per wilayah ----------\nconst KETERANGAN_HTML = {\n  'Inauga': `\n    <div style=\"margin-bottom:8px\">\n      Benar nama yang tercantum di atas adalah warga Kelurahan Inauga, Distrik Wania, Kabupaten Mimika.\n      Dengan sepengetahuan kami, sesuai data yang ada di Kantor Kelurahan Inauga, orang tersebut benar\n      termasuk Keluarga Tidak Mampu (Keluarga Berpenghasilan Rendah) dan surat ini digunakan untuk\n      memperoleh keringanan biaya pengobatan.\n    </div>\n    <div style=\"margin-top:12px;font-style:italic\">\n      Demikian Surat Keterangan Tidak Mampu ini kami buat. Atas perhatian dan kerja samanya, kami sampaikan terima kasih.\n    </div>\n  `.trim(),\n  'Kamoro Jaya': `\n    <div style=\"margin-bottom:8px\">\n      Benar nama yang tercantum di atas adalah warga Kelurahan Kamoro Jaya, Distrik Wania, Kabupaten Mimika.\n      Dengan sepengetahuan kami, sesuai data yang ada di Kantor Kelurahan Kamoro Jaya, orang tersebut benar\n      termasuk Keluarga Tidak Mampu (Keluarga Berpenghasilan Rendah) dan surat ini digunakan untuk\n      memperoleh keringanan biaya pengobatan.\n    </div>\n    <div style=\"margin-top:12px;font-style:italic\">\n      Demikian Surat Keterangan Tidak Mampu ini kami buat. Atas perhatian dan kerja samanya, kami sampaikan terima kasih.\n    </div>\n  `.trim(),\n  'Wonosari Jaya': `\n    <div style=\"margin-bottom:8px\">\n      Benar nama yang tercantum di atas adalah warga Kelurahan Wonosari Jaya, Distrik Wania, Kabupaten Mimika.\n      Dengan sepengetahuan kami, sesuai data yang ada di Kantor Kelurahan Wonosari Jaya, orang tersebut benar\n      termasuk Keluarga Tidak Mampu (Keluarga Berpenghasilan Rendah) dan surat ini digunakan untuk\n      memperoleh keringanan biaya pengobatan.\n    </div>\n    <div style=\"margin-top:12px;font-style:italic\">\n      Demikian Surat Keterangan Tidak Mampu ini kami buat. Atas perhatian dan kerja samanya, kami sampaikan terima kasih.\n    </div>\n  `.trim(),\n  'Kadun Jaya': `\n    <div style=\"margin-bottom:8px\">\n      Benar nama yang tercantum di atas adalah warga Kampung Kadun Jaya, Distrik Wania, Kabupaten Mimika.\n      Dengan sepengetahuan kami, sesuai data yang ada di Kantor Kampung Kadun Jaya, orang tersebut benar\n      termasuk Keluarga Tidak Mampu (Keluarga Berpenghasilan Rendah) dan surat ini digunakan untuk\n      memperoleh keringanan biaya pengobatan.\n    </div>\n    <div style=\"margin-top:12px;font-style:italic\">\n      Demikian Surat Keterangan Tidak Mampu ini kami buat. Atas perhatian dan kerja samanya, kami sampaikan terima kasih.\n    </div>\n  `.trim(),\n  'Mandiri Jaya': `\n    <div style=\"margin-bottom:8px\">\n      Benar nama yang tercantum di atas adalah warga Kampung Mandiri Jaya, Distrik Wania, Kabupaten Mimika.\n      Dengan sepengetahuan kami, sesuai data yang ada di Kantor Kampung Mandiri Jaya, orang tersebut benar\n      termasuk Keluarga Tidak Mampu (Keluarga Berpenghasilan Rendah) dan surat ini digunakan untuk\n      memperoleh keringanan biaya pengobatan.\n    </div>\n    <div style=\"margin-top:12px;font-style:italic\">\n      Demikian Surat Keterangan Tidak Mampu ini kami buat. Atas perhatian dan kerja samanya, kami sampaikan terima kasih.\n    </div>\n  `.trim(),\n  'Mawokau Jaya': `\n    <div style=\"margin-bottom:8px\">\n      Benar nama yang tercantum di atas adalah warga Kampung Mawokau Jaya, Distrik Wania, Kabupaten Mimika.\n      Dengan sepengetahuan kami, sesuai data yang ada di Kantor Kampung Mawokau Jaya, orang tersebut benar\n      termasuk Keluarga Tidak Mampu (Keluarga Berpenghasilan Rendah) dan surat ini digunakan untuk\n      memperoleh keringanan biaya pengobatan.\n    </div>\n    <div style=\"margin-top:12px;font-style:italic\">\n      Demikian Surat Keterangan Tidak Mampu ini kami buat. Atas perhatian dan kerja samanya, kami sampaikan terima kasih.\n    </div>\n  `.trim(),\n  'Nawaripi': `\n    <div style=\"margin-bottom:8px\">\n      Benar nama yang tercantum di atas adalah warga Kampung Nawaripi, Distrik Wania, Kabupaten Mimika.\n      Dengan sepengetahuan kami, sesuai data yang ada di Kantor Kampung Nawaripi, orang tersebut benar\n      termasuk Keluarga Tidak Mampu (Keluarga Berpenghasilan Rendah) dan surat ini digunakan untuk\n      memperoleh keringanan biaya pengobatan.\n    </div>\n    <div style=\"margin-top:12px;font-style:italic\">\n      Demikian Surat Keterangan Tidak Mampu ini kami buat. Atas perhatian dan kerja samanya, kami sampaikan terima kasih.\n    </div>\n  `.trim(),\n  // Distrik Wania\n  [DISTRIK_WANIA.key]: `\n    <div style=\"margin-bottom:8px\">\n      Benar nama yang tercantum di atas adalah warga wilayah administratif Distrik Wania, Kabupaten Mimika.\n      Surat keterangan ini dikeluarkan oleh Pemerintah ${DISTRIK_WANIA.fullName} berdasarkan data dan verifikasi yang tersedia\n      untuk keperluan memperoleh keringanan biaya pengobatan/administrasi.\n    </div>\n    <div style=\"margin-top:12px;font-style:italic\">\n      Demikian surat keterangan ini dibuat untuk dipergunakan sebagaimana mestinya. Terima kasih atas perhatian dan kerja samanya.\n    </div>\n  `.trim(),\n};\n\n// ---------- 6) Deteksi target distrik (prioritas) ----------\nconst ti = raw?.target_info || {};\nconst isDistrictTarget =\n  lc(ti?.level) === 'distrik' &&\n  lc(ti?.target_label_full) === lc(DISTRIK_WANIA.fullName);\n\n// ---------- 7) Resolusi area ----------\nlet area, resolvedName;\n\n// Jika target distrik: pakai profil Distrik Wania\nif (isDistrictTarget) {\n  area = {\n    top_title: DISTRIK_WANIA.top_title,\n    type: DISTRIK_WANIA.type,\n    fullName: DISTRIK_WANIA.fullName,\n    email: DISTRIK_WANIA.email,\n    address: DISTRIK_WANIA.address,\n    phone: DISTRIK_WANIA.phone,\n    headTitle: DISTRIK_WANIA.headTitle,\n    headName: DISTRIK_WANIA.headName,\n    no_surat: DISTRIK_WANIA.no_surat,\n  };\n  resolvedName = DISTRIK_WANIA.key; // \"Distrik Wania\"\n} else {\n  // Jika bukan distrik: resolusi kampung/kelurahan\n  const rawUnit = pick(\n    raw?.pemohon?.['kelurahan/kampung'],\n    raw?.pemohon?.kelurahan,\n    raw?.config?.area?.unit_name,\n    raw?.kelurahan,\n    raw?.kampung\n  );\n  const stripped = stripPrefix(rawUnit || '');\n  const keyLC = lc(stripped);\n  const resolvedAlias = ALIAS[keyLC] || ALIAS[lc(rawUnit || '')];\n  resolvedName = resolvedAlias || toTitle(stripped);\n\n  const FALLBACK = 'Kadun Jaya';\n  area = WILAYAH[resolvedName] || WILAYAH[FALLBACK];\n  if (!WILAYAH[resolvedName]) resolvedName = FALLBACK;\n}\n\n// ---------- 8) Ambil keterangan HTML & label from ----------\nconst keteranganHtml =\n  KETERANGAN_HTML[resolvedName] || KETERANGAN_HTML['Kadun Jaya'];\nconst FROM_LABEL = area.headName;\n\n// ---------- 9) Output konsisten ----------\nconst output = {\n  ...raw, // tetap ikutkan payload asli (termasuk target_info.* folder_*_id)\n  unit_type: area.type,               // \"Distrik\" | \"Kampung\" | \"Kelurahan\"\n  unit_name: resolvedName,            // \"Distrik Wania\" | \"Nawaripi\" | dst\n  unit_full_name: area.fullName,      // \"Distrik Wania\" | \"Kampung Nawaripi\" | dst\n  top_title: area.top_title,\n  email: area.email,\n  address: area.address,\n  no_surat: raw.no_surat || area.no_surat,\n  from: FROM_LABEL,\n  keterangan_html: keteranganHtml,\n            // <<â€” diminta: selalu ada di output\n};\n\nreturn [{ json: output }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        272,
        288
      ],
      "id": "03b92e6b-7b2f-418d-a2ee-f2fb00a331d3",
      "name": "C5"
    },
    {
      "parameters": {
        "resource": "Chatting",
        "operation": "Send Text",
        "session": "={{ $('C4').item.json.WAHA_Trigger_session }}",
        "chatId": "={{ $('C4').item.json.WAHA_Trigger_payload_from_admin1 }}",
        "text": "={{ $json.output }}",
        "requestOptions": {}
      },
      "type": "@devlikeapro/n8n-nodes-waha.WAHA",
      "typeVersion": 202502,
      "position": [
        3712,
        288
      ],
      "id": "135f0e75-e657-4a28-a8b9-2a26477c0335",
      "name": "C7",
      "credentials": {
        "wahaApi": {
          "id": "uivlaHVGkUY1vyJT",
          "name": "WAHA account"
        }
      }
    },
    {
      "parameters": {
        "resource": "Chatting",
        "operation": "Send Text",
        "session": "={{ $('C4').item.json.WAHA_Trigger_session }}",
        "chatId": "={{ $('C4').item.json.WAHA_Trigger_payload_from_user }}",
        "text": "={{ $json.output }}",
        "requestOptions": {}
      },
      "type": "@devlikeapro/n8n-nodes-waha.WAHA",
      "typeVersion": 202502,
      "position": [
        3280,
        288
      ],
      "id": "b400fcd9-20c8-4c65-9084-3dfdb780a032",
      "name": "C6",
      "credentials": {
        "wahaApi": {
          "id": "uivlaHVGkUY1vyJT",
          "name": "WAHA account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "/**\n * n8n Code Node â€” If send_to == admin2\n * Mode: Run Once for All Items\n */\nconst input = items[0]?.json ?? {};\nconst sendTo = String(input?.query?.send_to ?? input?.send_to ?? '').trim().toLowerCase();\n\nif (sendTo === 'admin2') {\n  return items;   // lanjut\n} else {\n  return [];      // stop\n}\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2880,
        288
      ],
      "id": "dc0c2b79-459d-4bec-b6ed-b97a1ee6da61",
      "name": "C4"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1-mini",
          "mode": "list",
          "cachedResultName": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        2256,
        800
      ],
      "id": "008b61d0-f8e3-448d-bf6c-86676db446ee",
      "name": "AI-Ca1",
      "credentials": {
        "openAiApi": {
          "id": "Qy11fJqEsEUeag8i",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1-mini",
          "mode": "list",
          "cachedResultName": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        2704,
        784
      ],
      "id": "79f5e1ad-fb0f-4b84-a04e-f9636ee2cc35",
      "name": "AI-Ca2",
      "credentials": {
        "openAiApi": {
          "id": "Qy11fJqEsEUeag8i",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Buatkan surat untuk: \nKepada Yth.\nIbu Kepala Distrik Wania ðŸŒ¸\n\nDengan hormat,\n\nDisampaikan bahwa surat dari warga {{ $('Ca1').item.json.query['kampung/kelurahan'] }} atas nama:\n\nNama Pemohon : {{ $('Ca1').item.json.query.Nama }}\nNomor KTP : {{ $('Ca1').item.json.query.NIK }}\n\ntelah diterima, disetujui âœ…, dan ditandatangani âœðŸ» oleh Bapak Kepala {{ $('Ca1').item.json.query['kampung/kelurahan'] }}.\n\nDokumen tersebut dapat diakses melalui tautan berikut:\nðŸ”— https://distrikwania.com/data/{{ $json.id }}\n\nDengan ini, surat dimaksud telah sampai di tingkat Ibu Kepala Distrik Wania untuk memperoleh persetujuan dan tindak lanjut lebih lanjut di tingkat distrik.\n\nAtas perhatian dan kerjasama Ibu, disampaikan terima kasih ðŸ™ðŸ».\nSemoga Tuhan Yang Maha Kuasa senantiasa memberkati setiap tugas dan pelayanan Ibu âœ¨.\n\nSalam hormat,\nKawe Nia ðŸ¤\nAsisten Digital Distrik Wania",
        "options": {
          "systemMessage": "=ðŸ“Œ GAYA BAHASA\nGunakan sapaan sesuai budaya: Bapa / Mama / Saudara / Nona / Ade\nhindari panggilan kami, saya (karena Kawe Nia berbicara sebagai pribadi).\nGunakan kalimat positif, menenangkan, dan penuh empati.\nTambahkan emotikon hangat \nAkhiri dengan ucapan berkat: â€œTuhan memberkatiâ€ \nTambahkan emotikon hangat "
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        3328,
        624
      ],
      "id": "919f9bfc-a9dd-4d07-b87a-c2fcc9cfb86d",
      "name": "KaweNia-Ca3"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1-mini",
          "mode": "list",
          "cachedResultName": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        3328,
        784
      ],
      "id": "5975eea4-8f7f-4c6e-8b02-82ff76a7d7a2",
      "name": "AI-Ca3",
      "credentials": {
        "openAiApi": {
          "id": "Qy11fJqEsEUeag8i",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "content": "\n# CREATE WEB SKTM UNTUK \n# KEPALA KAMPUNG KELURAHAN \n# DAN KEPALA DISTRIK",
        "height": 1052,
        "width": 4336,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -272,
        -48
      ],
      "typeVersion": 1,
      "id": "6db69ad0-e097-4a2c-8ac7-9f5af19d338d",
      "name": "Sticky Note7"
    },
    {
      "parameters": {
        "jsCode": "/**\n * n8n Code Node â€” Header/Keterangan/From dinamis per Distrik/Kampung/Kelurahan (per-wilayah)\n * Mode  : Run Once for Single Item\n * Output (minimal): {\n *   unit_type, unit_name, unit_full_name, email, address, from, keterangan_html, no_surat, top_title\n * }\n */\n\n// ---------- 1) Ambil & normalisasi input ----------\nlet raw = items?.[0]?.json ?? {};\nif (Array.isArray(raw)) raw = raw[0] ?? {};\nif (!raw || typeof raw !== 'object') raw = {};\n\n// ---------- 2) Util ----------\nconst pick = (...vals) => {\n  for (const v of vals) if (v != null && String(v).trim() !== '') return String(v).trim();\n  return '';\n};\nconst toTitle = (s) => {\n  if (!s) return '';\n  return s.replace(/\\s+/g,' ').trim().toLowerCase().replace(/\\b\\w/g,c=>c.toUpperCase());\n};\nconst lc = (s) => String(s||'').trim().toLowerCase();\n\n// Hapus awalan \"Kelurahan \" / \"Kampung \"\nconst stripPrefix = (s='') => {\n  const t = s.replace(/^\\s*(kelurahan|kampung)\\s+/i, '').trim();\n  return t || s.trim();\n};\n\n// ---------- 3) Master data wilayah (otoritatif) ----------\nconst WILAYAH = {\n  'Inauga': {\n    top_title: 'PEMERINTAH KABUPATEN MIMIKA DISTRIK WANIA',\n    type: 'Kelurahan',\n    fullName: 'Kelurahan Inauga',\n    email: 'kel.inauga@gmail.com',\n    address: 'Jln. Yohanes Aikawe - Kode Pos 99963',\n    phone: '+62-901-321001',\n    headTitle: 'Lurah',\n    headName: 'Lurah Inauga',\n    no_surat: '145 / 03 / SKTM / KN / DW / INA / I / 2025',\n  },\n  'Kamoro Jaya': {\n    top_title: 'PEMERINTAH KABUPATEN MIMIKA DISTRIK WANIA',\n    type: 'Kelurahan',\n    fullName: 'Kelurahan Kamoro Jaya',\n    email: 'kel.kamorojaya@gmail.com',\n    address: 'Jln. Kamoro Raya - Kode Pos 99963',\n    phone: '+62-901-321002',\n    headTitle: 'Lurah',\n    headName: 'Lurah Kamoro Jaya',\n    no_surat: '145 / 03 / SKTM / KN / DW / KJ / I / 2025',\n  },\n  'Wonosari Jaya': {\n    top_title: 'PEMERINTAH KABUPATEN MIMIKA DISTRIK WANIA',\n    type: 'Kelurahan',\n    fullName: 'Kelurahan Wonosari Jaya',\n    email: 'kel.wonosarijaya@gmail.com',\n    address: 'Jln. Wonosari Indah - Kode Pos 99963',\n    phone: '+62-901-321003',\n    headTitle: 'Lurah',\n    headName: 'Lurah Wonosari Jaya',\n    no_surat: '145 / 03 / SKTM / KN / DW / WJ / I / 2025',\n  },\n  'Kadun Jaya': {\n    top_title: 'PEMERINTAH KABUPATEN MIMIKA DISTRIK WANIA',\n    type: 'Kampung',\n    fullName: 'Kampung Kadun Jaya',\n    email: 'kampungkadunjaya@gmail.com',\n    address: 'Jln. Yohanes Aikawe - Kode Pos 99963',\n    phone: '+62-901-321004',\n    headTitle: 'Kepala Kampung',\n    headName: 'Kepala Kampung Kadun Jaya',\n    no_surat: '145 / 03 / SKTM / KN / DW / KDJ / I / 2025',\n  },\n  'Mandiri Jaya': {\n    top_title: 'PEMERINTAH KABUPATEN MIMIKA DISTRIK WANIA',\n    type: 'Kampung',\n    fullName: 'Kampung Mandiri Jaya',\n    email: 'kampungmandirijaya@gmail.com',\n    address: 'Jln. Mandiri Sejahtera - Kode Pos 99963',\n    phone: '+62-901-321005',\n    headTitle: 'Kepala Kampung',\n    headName: 'Kepala Kampung Mandiri Jaya',\n    no_surat: '145 / 03 / SKTM / KN / DW / MDJ / I / 2025',\n  },\n  'Mawokau Jaya': {\n    top_title: 'PEMERINTAH KABUPATEN MIMIKA DISTRIK WANIA',\n    type: 'Kampung',\n    fullName: 'Kampung Mawokau Jaya',\n    email: 'kampungmawokaujaya@gmail.com',\n    address: 'Jln. Mawokau Permai - Kode Pos 99963',\n    phone: '+62-901-321006',\n    headTitle: 'Kepala Kampung',\n    headName: 'Kepala Kampung Mawokau Jaya',\n    no_surat: '145 / 03 / SKTM / KN / DW / MWJ / I / 2025',\n  },\n  'Nawaripi': {\n    top_title: 'PEMERINTAH KABUPATEN MIMIKA DISTRIK WANIA',\n    type: 'Kampung',\n    fullName: 'Kampung Nawaripi',\n    email: 'kampungnawaripi4@gmail.com',\n    address: 'Jln. Nawaripi Indah - Kode Pos 99963',\n    phone: '+62-901-321007',\n    headTitle: 'Kepala Kampung',\n    headName: 'Kepala Kampung Nawaripi',\n    no_surat: '145 / 03 / SKTM / KN / DW / NWP / I / 2025',\n  },\n};\n\n// ---------- 3b) Profil DISTRIK (dummy) ----------\nconst DISTRIK_WANIA = {\n  top_title: 'PEMERINTAH KABUPATEN MIMIKA',\n  key: 'Distrik Wania',\n  type: 'Distrik',\n  fullName: 'Distrik Wania',\n  email: 'distrik.wania@gmail.com',           // dummy\n  address: 'Jln. Poros Wania No. 1, Mimika',  // dummy\n  phone: '+62-901-320000',                    // dummy\n  headTitle: 'Kepala Distrik',\n  headName: 'Kepala Distrik Wania',           // dummy\n  no_surat: '145 / 03 / SKTM / KN / DW / I / 2025', // khusus level distrik (tanpa kode wilayah)\n};\n\n// ---------- 4) Alias/synonym map (huruf kecil) ----------\nconst ALIAS = {\n  // Kelurahan/Kampung\n  'inauga': 'Inauga',\n  'kelurahan inauga': 'Inauga',\n  'kamoro jaya': 'Kamoro Jaya',\n  'kelurahan kamoro jaya': 'Kamoro Jaya',\n  'wonosari jaya': 'Wonosari Jaya',\n  'kelurahan wonosari jaya': 'Wonosari Jaya',\n  'kadun jaya': 'Kadun Jaya',\n  'kampung kadun jaya': 'Kadun Jaya',\n  'mandiri jaya': 'Mandiri Jaya',\n  'kampung mandiri jaya': 'Mandiri Jaya',\n  'mawokau jaya': 'Mawokau Jaya',\n  'kampung mawokau jaya': 'Mawokau Jaya',\n  'nawaripi': 'Nawaripi',\n  'kampung nawaripi': 'Nawaripi',\n  // Distrik\n  'distrik wania': DISTRIK_WANIA.key,\n  'wania': DISTRIK_WANIA.key,\n};\n\n// ---------- 5) Keterangan HTML per wilayah ----------\nconst KETERANGAN_HTML = {\n  'Inauga': `\n    <div style=\"margin-bottom:8px\">\n      Benar nama yang tercantum di atas adalah warga Kelurahan Inauga, Distrik Wania, Kabupaten Mimika.\n      Dengan sepengetahuan kami, sesuai data yang ada di Kantor Kelurahan Inauga, orang tersebut benar\n      termasuk Keluarga Tidak Mampu (Keluarga Berpenghasilan Rendah) dan surat ini digunakan untuk\n      memperoleh keringanan biaya pengobatan.\n    </div>\n    <div style=\"margin-top:12px;font-style:italic\">\n      Demikian Surat Keterangan Tidak Mampu ini kami buat. Atas perhatian dan kerja samanya, kami sampaikan terima kasih.\n    </div>\n  `.trim(),\n  'Kamoro Jaya': `\n    <div style=\"margin-bottom:8px\">\n      Benar nama yang tercantum di atas adalah warga Kelurahan Kamoro Jaya, Distrik Wania, Kabupaten Mimika.\n      Dengan sepengetahuan kami, sesuai data yang ada di Kantor Kelurahan Kamoro Jaya, orang tersebut benar\n      termasuk Keluarga Tidak Mampu (Keluarga Berpenghasilan Rendah) dan surat ini digunakan untuk\n      memperoleh keringanan biaya pengobatan.\n    </div>\n    <div style=\"margin-top:12px;font-style:italic\">\n      Demikian Surat Keterangan Tidak Mampu ini kami buat. Atas perhatian dan kerja samanya, kami sampaikan terima kasih.\n    </div>\n  `.trim(),\n  'Wonosari Jaya': `\n    <div style=\"margin-bottom:8px\">\n      Benar nama yang tercantum di atas adalah warga Kelurahan Wonosari Jaya, Distrik Wania, Kabupaten Mimika.\n      Dengan sepengetahuan kami, sesuai data yang ada di Kantor Kelurahan Wonosari Jaya, orang tersebut benar\n      termasuk Keluarga Tidak Mampu (Keluarga Berpenghasilan Rendah) dan surat ini digunakan untuk\n      memperoleh keringanan biaya pengobatan.\n    </div>\n    <div style=\"margin-top:12px;font-style:italic\">\n      Demikian Surat Keterangan Tidak Mampu ini kami buat. Atas perhatian dan kerja samanya, kami sampaikan terima kasih.\n    </div>\n  `.trim(),\n  'Kadun Jaya': `\n    <div style=\"margin-bottom:8px\">\n      Benar nama yang tercantum di atas adalah warga Kampung Kadun Jaya, Distrik Wania, Kabupaten Mimika.\n      Dengan sepengetahuan kami, sesuai data yang ada di Kantor Kampung Kadun Jaya, orang tersebut benar\n      termasuk Keluarga Tidak Mampu (Keluarga Berpenghasilan Rendah) dan surat ini digunakan untuk\n      memperoleh keringanan biaya pengobatan.\n    </div>\n    <div style=\"margin-top:12px;font-style:italic\">\n      Demikian Surat Keterangan Tidak Mampu ini kami buat. Atas perhatian dan kerja samanya, kami sampaikan terima kasih.\n    </div>\n  `.trim(),\n  'Mandiri Jaya': `\n    <div style=\"margin-bottom:8px\">\n      Benar nama yang tercantum di atas adalah warga Kampung Mandiri Jaya, Distrik Wania, Kabupaten Mimika.\n      Dengan sepengetahuan kami, sesuai data yang ada di Kantor Kampung Mandiri Jaya, orang tersebut benar\n      termasuk Keluarga Tidak Mampu (Keluarga Berpenghasilan Rendah) dan surat ini digunakan untuk\n      memperoleh keringanan biaya pengobatan.\n    </div>\n    <div style=\"margin-top:12px;font-style:italic\">\n      Demikian Surat Keterangan Tidak Mampu ini kami buat. Atas perhatian dan kerja samanya, kami sampaikan terima kasih.\n    </div>\n  `.trim(),\n  'Mawokau Jaya': `\n    <div style=\"margin-bottom:8px\">\n      Benar nama yang tercantum di atas adalah warga Kampung Mawokau Jaya, Distrik Wania, Kabupaten Mimika.\n      Dengan sepengetahuan kami, sesuai data yang ada di Kantor Kampung Mawokau Jaya, orang tersebut benar\n      termasuk Keluarga Tidak Mampu (Keluarga Berpenghasilan Rendah) dan surat ini digunakan untuk\n      memperoleh keringanan biaya pengobatan.\n    </div>\n    <div style=\"margin-top:12px;font-style:italic\">\n      Demikian Surat Keterangan Tidak Mampu ini kami buat. Atas perhatian dan kerja samanya, kami sampaikan terima kasih.\n    </div>\n  `.trim(),\n  'Nawaripi': `\n    <div style=\"margin-bottom:8px\">\n      Benar nama yang tercantum di atas adalah warga Kampung Nawaripi, Distrik Wania, Kabupaten Mimika.\n      Dengan sepengetahuan kami, sesuai data yang ada di Kantor Kampung Nawaripi, orang tersebut benar\n      termasuk Keluarga Tidak Mampu (Keluarga Berpenghasilan Rendah) dan surat ini digunakan untuk\n      memperoleh keringanan biaya pengobatan.\n    </div>\n    <div style=\"margin-top:12px;font-style:italic\">\n      Demikian Surat Keterangan Tidak Mampu ini kami buat. Atas perhatian dan kerja samanya, kami sampaikan terima kasih.\n    </div>\n  `.trim(),\n  // Distrik Wania\n  [DISTRIK_WANIA.key]: `\n    <div style=\"margin-bottom:8px\">\n      Benar nama yang tercantum di atas adalah warga wilayah administratif Distrik Wania, Kabupaten Mimika.\n      Surat keterangan ini dikeluarkan oleh Pemerintah ${DISTRIK_WANIA.fullName} berdasarkan data dan verifikasi yang tersedia\n      untuk keperluan memperoleh keringanan biaya pengobatan/administrasi.\n    </div>\n    <div style=\"margin-top:12px;font-style:italic\">\n      Demikian surat keterangan ini dibuat untuk dipergunakan sebagaimana mestinya. Terima kasih atas perhatian dan kerja samanya.\n    </div>\n  `.trim(),\n};\n\n// ---------- 6) Deteksi target distrik (prioritas) ----------\nconst ti = raw?.target_info || {};\nconst isDistrictTarget =\n  lc(ti?.level) === 'distrik' &&\n  lc(ti?.target_label_full) === lc(DISTRIK_WANIA.fullName);\n\n// ---------- 7) Resolusi area ----------\nlet area, resolvedName;\n\n// Jika target distrik: pakai profil Distrik Wania\nif (isDistrictTarget) {\n  area = {\n    top_title: DISTRIK_WANIA.top_title,\n    type: DISTRIK_WANIA.type,\n    fullName: DISTRIK_WANIA.fullName,\n    email: DISTRIK_WANIA.email,\n    address: DISTRIK_WANIA.address,\n    phone: DISTRIK_WANIA.phone,\n    headTitle: DISTRIK_WANIA.headTitle,\n    headName: DISTRIK_WANIA.headName,\n    no_surat: DISTRIK_WANIA.no_surat,\n  };\n  resolvedName = DISTRIK_WANIA.key; // \"Distrik Wania\"\n} else {\n  // Jika bukan distrik: resolusi kampung/kelurahan\n  const rawUnit = pick(\n    raw?.pemohon?.['kelurahan/kampung'],\n    raw?.pemohon?.kelurahan,\n    raw?.config?.area?.unit_name,\n    raw?.kelurahan,\n    raw?.kampung\n  );\n  const stripped = stripPrefix(rawUnit || '');\n  const keyLC = lc(stripped);\n  const resolvedAlias = ALIAS[keyLC] || ALIAS[lc(rawUnit || '')];\n  resolvedName = resolvedAlias || toTitle(stripped);\n\n  const FALLBACK = 'Kadun Jaya';\n  area = WILAYAH[resolvedName] || WILAYAH[FALLBACK];\n  if (!WILAYAH[resolvedName]) resolvedName = FALLBACK;\n}\n\n// ---------- 8) Ambil keterangan HTML & label from ----------\nconst keteranganHtml =\n  KETERANGAN_HTML[resolvedName] || KETERANGAN_HTML['Kadun Jaya'];\nconst FROM_LABEL = area.headName;\n\n// ---------- 9) Output konsisten ----------\nconst output = {\n  ...raw, // tetap ikutkan payload asli (termasuk target_info.* folder_*_id)\n  unit_type: area.type,               // \"Distrik\" | \"Kampung\" | \"Kelurahan\"\n  unit_name: resolvedName,            // \"Distrik Wania\" | \"Nawaripi\" | dst\n  unit_full_name: area.fullName,      // \"Distrik Wania\" | \"Kampung Nawaripi\" | dst\n  top_title: area.top_title,\n  email: area.email,\n  address: area.address,\n  no_surat: raw.no_surat || area.no_surat,\n  from: FROM_LABEL,\n  keterangan_html: keteranganHtml,\n            // <<â€” diminta: selalu ada di output\n};\n\nreturn [{ json: output }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        208,
        -288
      ],
      "id": "2db4647e-4ea3-41bd-9a06-7c14de8addb8",
      "name": "C"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "646a0ac9-0b1c-4283-ae20-fe42f0ad4384",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        416,
        1792
      ],
      "id": "f95983a3-7d9c-401d-bb28-f8647925871c",
      "name": "D1",
      "webhookId": "646a0ac9-0b1c-4283-ae20-fe42f0ad4384"
    },
    {
      "parameters": {
        "jsCode": "/**\n * n8n Code Node â€” Parse & Normalize Payload Surat + Binary Split (Outer envelope aware, WAHA user/admin)\n * Mode   : Run Once for All Items\n * Input  : items (array dari webhook, bisa ada binary multipart)\n * Output : [{ json, binary? }]\n */\n\nconst out = [];\n\n/* ==================== Utils ==================== */\nconst has = (o, k) => Object.prototype.hasOwnProperty.call(o ?? {}, k);\nconst val = (o, k) => {\n  if (!o || typeof o !== 'object') return null;\n  if (!has(o, k)) return null;\n  const v = o[k];\n  if (v === undefined || v === '') return null;\n  return v;\n};\nconst ensureStr = (x, fb='-') => {\n  const v = (x ?? '').toString().trim();\n  return v.length ? v : fb;\n};\nconst toTitleCase = (str) => {\n  if (!str) return str;\n  return str.toString().toLowerCase().replace(/\\b\\w/g, c => c.toUpperCase());\n};\nconst lower = (x) => (x ?? '').toString().trim().toLowerCase();\nconst guessMimeFromName = (name='') => {\n  const n = (name || '').toLowerCase();\n  if (n.endsWith('.jpg') || n.endsWith('.jpeg')) return 'image/jpeg';\n  if (n.endsWith('.png'))  return 'image/png';\n  if (n.endsWith('.pdf'))  return 'application/pdf';\n  if (n.endsWith('.docx')) return 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';\n  if (n.endsWith('.doc'))  return 'application/msword';\n  if (n.endsWith('.xlsx')) return 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';\n  if (n.endsWith('.xls'))  return 'application/vnd.ms-excel';\n  return null;\n};\n\n// (opsional) turunan nomor\nconst stripCUs   = (jid='') => jid.replace(/@c\\.us$/i,'');\nconst onlyDigits = (s='')   => (s.match(/\\d+/g) || []).join('');\nconst deriveWaha = (jid) => {\n  const JID = (jid ?? '').toString().trim();\n  if (!JID) return { jid:null, number:null, no_suffix:null };\n  const noSuffix = stripCUs(JID);\n  const number   = onlyDigits(noSuffix);\n  return { jid:JID, number:number||null, no_suffix:noSuffix||null };\n};\n\n/* ==================== Main ==================== */\nfor (const item of items) {\n  /* ---------- 1) Ambil root & envelope ---------- */\n  const root = item.json ?? {};\n  const bodyRaw = root.body ?? root ?? {};\n  const envelope = Array.isArray(bodyRaw) ? (bodyRaw[0] ?? {}) : bodyRaw;\n\n  // Kandidat payload \"inner\": body.json || body.data || body sendiri\n  let inner = envelope.json ?? envelope.data ?? envelope;\n  if (typeof inner === 'string') {\n    try { inner = JSON.parse(inner); } catch { inner = {}; }\n  }\n\n  /* ---------- 2) Binary map (untuk multipart) ---------- */\n  const bin = item.binary || {};\n  const binKeys = Object.keys(bin);\n  const binaryIndex = {};\n  for (const k of binKeys) {\n    const b = bin[k] || {};\n    const key = lower(k);\n    binaryIndex[key] = { prop: k, ...b };\n    if (b.fileName) binaryIndex[lower(b.fileName)] = { prop: k, ...b };\n  }\n\n  /* ---------- 3) Field inti (prioritas outer > inner) ---------- */\n  const outerAction = (val(envelope, 'action') || '').toString().toUpperCase() || null;\n  const innerAction = (val(inner, 'action') || '').toString().toUpperCase() || null;\n  const topAction   = outerAction || innerAction || null;\n\n  const id_admin1 = val(envelope, 'id_admin1') ?? val(inner, 'id_admin1') ?? null;\n  const id_user   = val(inner, 'id_user') ?? null;\n  const id_surat  = val(envelope, 'id_surat') ?? val(inner, 'id_surat') ?? null;\n\n  const message = val(envelope, 'message') ?? val(inner, 'message') ?? null;\n  const from    = val(envelope, 'from') ?? val(inner, 'from') ?? null;\n\n  const delRaw = val(inner, 'delete_file_ids') ?? val(envelope, 'delete_file_ids');\n  const deleteIds = Array.isArray(delRaw)\n    ? delRaw.filter(x => typeof x === 'string' && x.trim().length > 0)\n    : [];\n\n  /* ---------- 4) Dokumen (dari inner atau binary) ---------- */\n  let dokumen = [];\n  if (Array.isArray(inner?.dokumen)) {\n    dokumen = inner.dokumen.map((d = {}) => {\n      const base = {\n        name         : d?.name ?? null,\n        type         : d?.type ?? d?.mimeType ?? null,\n        file_id      : d?.file_id ?? null,\n        size         : d?.size ?? null,\n        view_url     : d?.view_url ?? null,\n        download_url : d?.download_url ?? null,\n      };\n      let bMatch = null;\n      if (d?.binary_prop && binaryIndex[lower(d.binary_prop)]) {\n        bMatch = binaryIndex[lower(d.binary_prop)];\n      } else if (base.name && binaryIndex[lower(base.name)]) {\n        bMatch = binaryIndex[lower(base.name)];\n      }\n      if (bMatch) {\n        base.type = base.type ?? bMatch.mimeType ?? null;\n        base.size = base.size ?? (bMatch.fileSize ?? null);\n        base.name = base.name ?? bMatch.fileName ?? null;\n      }\n      if (!base.type && base.name) {\n        const g = guessMimeFromName(base.name);\n        if (g) base.type = g;\n      }\n      return base;\n    });\n  } else if (binKeys.length) {\n    dokumen = binKeys.map((k) => {\n      const b = bin[k] || {};\n      return {\n        name        : b.fileName ?? k,\n        type        : b.mimeType ?? guessMimeFromName(b.fileName ?? '') ?? null,\n        file_id     : null,\n        size        : b.fileSize ?? null,\n        view_url    : null,\n        download_url: null,\n      };\n    });\n  }\n\n  /* ---------- 5) Pemohon & alamat (dari inner) ---------- */\n  const pem = inner?.pemohon ?? {};\n  const kelVal   = ensureStr(val(pem, 'kelurahan/kampung') ?? val(pem, 'Kelurahan'));\n  const kecVal   = ensureStr(val(pem, 'kecamatan') ?? val(pem, 'Kecamatan'));\n  const kotaKab  = ensureStr(val(pem, 'kota_kab') ?? val(pem, 'Kabupaten') ?? val(pem, 'Kota'));\n  const provinsi = ensureStr(val(pem, 'provinsi') ?? val(pem, 'Provinsi') ?? 'Papua Tengah');\n\n  /* ---------- 6) WAHA fields ---------- */\n  const WAHA_Trigger_payload_from_user =\n    val(envelope, 'WAHA_Trigger_payload_from_user') ??\n    val(inner,    'WAHA_Trigger_payload_from_user') ??\n    val(inner,    'WAHA_Trigger_payload_from') ?? // fallback lama\n    null;\n\n  const WAHA_Trigger_payload_from_admin1 =\n    val(envelope, 'WAHA_Trigger_payload_from_admin1') ??\n    val(inner,    'WAHA_Trigger_payload_from_admin1') ??\n    val(inner,    'WAHA_Trigger_payload_from_admin') ?? // fallback alternatif\n    val(inner,    'WAHA_Trigger_payload_from') ??       // fallback lama\n    null;\n\n  // >>>>>>>>>> TAMBAHKAN ADMIN2 (baru) <<<<<<<<<<\n  const WAHA_Trigger_payload_from_admin2 =\n    val(envelope, 'WAHA_Trigger_payload_from_admin2') ??\n    val(inner,    'WAHA_Trigger_payload_from_admin2') ??\n    null;\n\n  // (opsional) turunan nomor & no-suffix siap pakai\n  const userD   = deriveWaha(WAHA_Trigger_payload_from_user);\n  const admin1D = deriveWaha(WAHA_Trigger_payload_from_admin1);\n  const admin2D = deriveWaha(WAHA_Trigger_payload_from_admin2);\n\n  const WAHA_Trigger_session =\n    val(envelope, 'WAHA_Trigger_session') ??\n    val(inner,    'WAHA_Trigger_session') ?? null;\n\n  const LogoURL =\n    val(envelope, 'LogoURL') ??\n    val(inner,    'LogoURL') ?? null;\n\n  const webhook =\n    val(envelope, 'webhook') ??\n    val(inner,    'webhook') ?? null;\n\n  /* ---------- 7) Payload akhir ---------- */\n  const payload = {\n    action   : topAction,\n    strategy : val(inner, 'strategy') ?? null,\n\n    id_admin1: id_admin1,\n    id_user  : id_user,\n    id_surat : id_surat,\n    date     : val(inner, 'date'),\n\n    message  : message,\n    from     : from,\n\n    delete_file_ids: deleteIds,\n    dokumen,\n\n    pemohon: {\n      nama               : toTitleCase(val(pem, 'nama')),\n      nik                : val(pem, 'nik'),\n      ttl                : toTitleCase(val(pem, 'ttl')),\n      agama              : toTitleCase(val(pem, 'agama')),\n      jenis_kelamin      : toTitleCase(val(pem, 'jenis_kelamin')),\n      status_perkawinan  : toTitleCase(val(pem, 'status_perkawinan')),\n      pekerjaan          : toTitleCase(val(pem, 'pekerjaan')),\n      alamat             : toTitleCase(val(pem, 'alamat')),\n      \"kelurahan/kampung\": toTitleCase(kelVal),\n      kecamatan          : toTitleCase(kecVal),\n      kota_kab           : toTitleCase(kotaKab),\n      provinsi           : toTitleCase(provinsi),\n    },\n\n    WAHA_Trigger_session,\n\n    // Asal & admin JID (asli)\n    WAHA_Trigger_payload_from_user,\n    WAHA_Trigger_payload_from_admin1,\n    WAHA_Trigger_payload_from_admin2, // <<< NOW INCLUDED\n\n\n    LogoURL,\n    webhook,\n  };\n\n  /* ---------- 8) Binary Split ---------- */\n  const binKeysNow = Object.keys(item.binary || {});\n  if (binKeysNow.length === 0) {\n    out.push({ json: payload });\n  } else {\n    for (const k of binKeysNow) {\n      out.push({\n        json  : { ...payload, binaryProperty: k },\n        binary: { [k]: item.binary[k] },\n      });\n    }\n  }\n}\n\nreturn out;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        592,
        1792
      ],
      "id": "ad37001f-4184-444d-b1e0-123a59619790",
      "name": "D2"
    },
    {
      "parameters": {
        "jsCode": "/**\n * n8n Code Node â€” If Action == SEND_MESSAGE\n * Mode: Run Once for All Items\n */\n\nconst input = items[0].json;\n\n// Jika action == SEND_MESSAGE maka teruskan item\nif (input.action === \"SEND_MESSAGE\") {\n  return items;   // lanjut ke node selanjutnya\n} else {\n  return [];      // stop, tidak kirim apa pun ke node berikutnya\n}\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        768,
        1744
      ],
      "id": "f5464edd-8f75-4e8c-9a8d-228a106472a5",
      "name": "Da1"
    },
    {
      "parameters": {
        "jsCode": "/**\n * n8n Code Node â€” If Action == DELETE_ALL\n * Mode: Run Once for All Items\n */\n\nconst input = items[0].json;\n\n// Jika action == DELETE_ALL maka teruskan item\nif (input.action === \"DELETE_ALL\") {\n  return items;   // lanjut ke node selanjutnya\n} else {\n  return [];      // stop, tidak kirim apa pun ke node berikutnya\n}\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        768,
        1584
      ],
      "id": "dffaa2de-03d1-4d91-890f-6a63f9df141d",
      "name": "Db1"
    },
    {
      "parameters": {
        "operation": "download",
        "fileId": {
          "__rl": true,
          "value": "={{ $json.id_user }}",
          "mode": "id"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        1248,
        1584
      ],
      "id": "432c98ce-a206-4d57-af2d-7bf3629ce37b",
      "name": "Db2",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "K6YEbjdSQULsuuJd",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "/**\n * n8n Code Node â€” Ambil Semua ID (kecuali id_user)\n * Mode   : Run Once for Single Item\n * Input  : { json }\n * Output : Array of items { json: { fileId } }\n */\n\n// -------- Helpers --------\nfunction tailId(v) {\n  if (typeof v !== 'string') return '';\n  const s = v.trim();\n  if (!s) return '';\n\n  // Khusus Google Drive\n  // 1) https://drive.google.com/file/d/{ID}/view\n  // 2) https://drive.google.com/uc?id={ID}&export=download\n  // 3) ...?id={ID}\n  const driveD = s.match(/\\/file\\/d\\/([a-zA-Z0-9_-]{10,})/);\n  if (driveD) return driveD[1];\n\n  const qId = s.match(/[?&]id=([a-zA-Z0-9_-]{5,})/);\n  if (qId) return qId[1];\n\n  // Umum: coba parse sebagai URL â†’ ambil segmen path terakhir\n  try {\n    const u = new URL(s);\n    const parts = u.pathname.split('/').filter(Boolean);\n    return parts.length ? parts[parts.length - 1] : s;\n  } catch {\n    // Bukan URL valid â†’ fallback split '/'\n    const parts = s.split('/').filter(Boolean);\n    return parts.length ? parts[parts.length - 1] : s;\n  }\n}\n\nfunction isPlainObject(x){ return x && typeof x === 'object' && !Array.isArray(x); }\n\n// Kumpulkan ID dari key yang relevan, kecuali id_user\n// Aturan: ambil semua nilai dari key yang:\n// - sama dengan 'id' atau diawali 'id_' atau diakhiri '_id' (case-insensitive)\n// - KECUALI 'id_user'\nfunction collectIdsFromObject(obj, out) {\n  if (!isPlainObject(obj)) return;\n\n  for (const [k, v] of Object.entries(obj)) {\n    const key = (k || '').toLowerCase();\n\n    // Rekursi untuk objek/array\n    if (Array.isArray(v)) {\n      for (const it of v) {\n        if (isPlainObject(it)) collectIdsFromObject(it, out);\n        else if (typeof it === 'string') maybePushId(key, it, out);\n      }\n      continue;\n    }\n    if (isPlainObject(v)) {\n      collectIdsFromObject(v, out);\n      continue;\n    }\n\n    // Hanya cek kandidat key yang bernuansa ID\n    const looksLikeIdKey =\n      key === 'id' ||\n      key.startsWith('id_') ||\n      key.endsWith('_id');\n\n    if (looksLikeIdKey && key !== 'id_user') {\n      maybePushId(key, v, out);\n    }\n\n    // Koleksi khusus untuk field yang diketahui mengandung daftar id\n    if (key === 'delete_file_ids' && Array.isArray(v)) {\n      for (const s of v) if (typeof s === 'string' && s.trim()) out.push(s.trim());\n    }\n\n    // Jika di dalam objek dokumen ada URL yang memuat id file, ekstrak juga\n    if ((key === 'view_url' || key === 'download_url') && typeof v === 'string') {\n      const t = tailId(v);\n      if (t && t !== v) out.push(t);\n    }\n  }\n}\n\nfunction maybePushId(key, value, out) {\n  if (typeof value !== 'string') return;\n  const s = value.trim();\n  if (!s) return;\n\n  // Jika nilai berupa URL atau path â†’ ekstrak IDnya\n  const t = tailId(s);\n  out.push(t || s);\n}\n\n// -------- Main --------\nconst body = $json.body || {};\nconst data = body.data || $json || {};\nconst collected = [];\n\n// Kumpulkan semua ID sesuai aturan (kecuali id_user)\ncollectIdsFromObject(data, collected);\n\n// Hilangkan id_user jika sempat nyangkut dari pola umum\nconst idUser = (data.id_user || body.id_user || '').trim();\nconst filtered = collected.filter(x => x && x !== idUser);\n\n// De-dupe & bersihkan\nconst uniq = [...new Set(filtered.map(x => x.trim()))].filter(Boolean);\n\n// Return dalam format array items untuk n8n\nreturn uniq.map(id => ({ json: { fileId: id } }));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        928,
        1584
      ],
      "id": "f05545e3-a0dc-4863-bded-375598fabaee",
      "name": "Db3",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "operation": "fromJson",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        1408,
        1584
      ],
      "id": "d16d0e0b-c6f0-4e8f-9e9d-a9df423a62bd",
      "name": "Db4"
    },
    {
      "parameters": {
        "method": "DELETE",
        "url": "=https://www.googleapis.com/drive/v3/files/{{ $json.fileId }}\n?supportsAllDrives=true",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "googleOAuth2Api",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1088,
        1584
      ],
      "id": "07f91264-c75c-4d28-b185-b4ede40d960f",
      "name": "Db5",
      "credentials": {
        "googleOAuth2Api": {
          "id": "jXbDn3iYmSleWrn8",
          "name": "Google account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "/**\n * n8n Code Node â€” Flatten JSON & Hapus delete_file_ids + Update Status\n * Mode   : Run Once for Single Item\n */\n\n// Ambil JSON dari input\nlet input = items[0].json;\n\n// Flatten data yang bersarang (ambil data[0] terus sampai habis)\nwhile (Array.isArray(input?.data) && input.data.length > 0) {\n  input = input.data[0];\n}\n\n// Ambil daftar file_id yang mau dihapus\nconst toDelete = new Set(input.delete_file_ids || []);\n\n// Filter dokumen agar tidak menyertakan file_id yang ada di delete_file_ids\nconst newDocs = (input.dokumen || []).filter(doc => !toDelete.has(doc.file_id));\n\n// Buat output baru tanpa delete_file_ids dan ganti status_web_user\nconst { delete_file_ids, ...rest } = input;\nconst output = {\n  ...rest,\n  dokumen: newDocs,\n  status_web_user: \"perbaiki\"   // override status_web_user\n};\n\n// Kembalikan hasil\nreturn [{ json: output }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1568,
        1584
      ],
      "id": "727ef0c7-3a15-4311-b64d-456eb362148a",
      "name": "Db6"
    },
    {
      "parameters": {
        "operation": "toJson",
        "options": {
          "fileName": "={{ DateTime.now().setZone('Asia/Tokyo').setLocale('id').toFormat('dd_MM_yyyy_HH_mm_ss') + '_' + ($json.data[0].pemohon.nama).trim().replace(/\\s+/g,'-').toUpperCase() + '_' + ($json.data[0].pemohon.nik) }}\n"
        }
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        1728,
        1584
      ],
      "id": "09c8b833-799a-490f-93ee-3dcdfd6b4b1a",
      "name": "Db7"
    },
    {
      "parameters": {
        "operation": "update",
        "fileId": {
          "__rl": true,
          "value": "={{ $('Db6').item.json.id_user }}",
          "mode": "id"
        },
        "changeFileContent": true,
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        1904,
        1584
      ],
      "id": "9f013aa0-bef7-48cc-b5e5-97955e331070",
      "name": "Db8",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "K6YEbjdSQULsuuJd",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "/**\n * n8n Code Node â€” If Action == CREATE_AND_SEND\n * Mode: Run Once for All Items\n */\n\nconst input = items[0].json;\n\n// Jika action == CREATE_AND_SEND maka teruskan item\nif (input.action === \"CREATE_AND_SEND\") {\n  return items;   // lanjut ke node selanjutnya\n} else {\n  return [];      // stop, tidak kirim apa pun ke node berikutnya\n}\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        768,
        1968
      ],
      "id": "0ff604d1-bf13-4b11-87ea-e010f2b1965c",
      "name": "Dc1"
    },
    {
      "parameters": {
        "resource": "Chatting",
        "operation": "Send Text",
        "session": "={{ $('Da1').item.json.WAHA_Trigger_session }}",
        "chatId": "={{ $('Da1').item.json.WAHA_Trigger_payload_from_admin1 }}",
        "text": "={{ $json.output }}",
        "requestOptions": {}
      },
      "type": "@devlikeapro/n8n-nodes-waha.WAHA",
      "typeVersion": 202502,
      "position": [
        1888,
        1744
      ],
      "id": "82df6db0-f732-4c9e-bbea-fa0f32341297",
      "name": "Da2",
      "executeOnce": true,
      "credentials": {
        "wahaApi": {
          "id": "uivlaHVGkUY1vyJT",
          "name": "WAHA account"
        }
      }
    },
    {
      "parameters": {
        "resource": "Chatting",
        "operation": "Send Text",
        "session": "={{ $('Da1').item.json.WAHA_Trigger_session }}",
        "chatId": "={{ $('Da1').item.json.WAHA_Trigger_payload_from_admin2 }}",
        "text": "={{ $json.output }}",
        "requestOptions": {}
      },
      "type": "@devlikeapro/n8n-nodes-waha.WAHA",
      "typeVersion": 202502,
      "position": [
        2736,
        1744
      ],
      "id": "e7b15ad7-72e0-4e10-a6bf-8b5979e5d57c",
      "name": "Da3",
      "executeOnce": true,
      "credentials": {
        "wahaApi": {
          "id": "uivlaHVGkUY1vyJT",
          "name": "WAHA account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Buatkan surat untuk: \nKepada Yth.\nBapak Kepala {{ $json.pemohon[\"kelurahan/kampung\"] }} ðŸŒ¿\n\nDengan hormat,\n\nDisampaikan bahwa surat atas nama:\n\nNama Pemohon : {{ $json.pemohon.nama }}\nNomor KTP : {{ $json.pemohon.nik }}\n\ntelah dinyatakan ditolak âŒ oleh Bapak.\n\nAlasan penolakan:\nðŸ“ {{ $json.message }}\n\nDengan demikian, surat dimaksud tidak dapat dilanjutkan ke tingkat distrik untuk memperoleh persetujuan lebih lanjut.\n\nAtas perhatian Bapak, disampaikan terima kasih ðŸ™ðŸ».\nSemoga Tuhan Yang Maha Kuasa senantiasa memberkati setiap tugas dan pelayanan Bapak âœ¨.\n\nSalam hormat,\nKawe Nia ðŸ¤\nAsisten Digital Distrik Wania",
        "options": {
          "systemMessage": "=ðŸ“Œ GAYA BAHASA\nGunakan sapaan sesuai budaya: Bapa / Mama / Saudara / Nona / Ade\nhindari panggilan kami, saya (karena Kawe Nia berbicara sebagai pribadi).\nGunakan kalimat positif, menenangkan, dan penuh empati.\nTambahkan emotikon hangat \nAkhiri dengan ucapan berkat: â€œTuhan memberkatiâ€ \nTambahkan emotikon hangat "
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        1632,
        1744
      ],
      "id": "2964890f-8ef1-4f79-b871-cd03ee023e35",
      "name": "KaweNia-Da1"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Buatkan surat untuk:  \nKepada Yth.\nIbu Kepala Distrik Wania ðŸŒ¸\n\nDengan hormat,\n\nDisampaikan bahwa surat atas nama:\n\nNama Pemohon : {{ $json.pemohon.nama }}\nNomor KTP : {{ $json.pemohon.nik }}\n\ntelah dinyatakan ditolak âŒ oleh Kepala {{ $json.pemohon[\"kelurahan/kampung\"] }}.\n\nAlasan penolakan:\nðŸ“ {{ $json.message }}\n\nDengan demikian, surat tersebut tidak dapat dilanjutkan ke tingkat distrik untuk memperoleh persetujuan lebih lanjut.\n\nAtas perhatian Ibu, disampaikan terima kasih ðŸ™ðŸ».\nSemoga Tuhan Yang Maha Kuasa senantiasa memberkati setiap tugas dan pelayanan Ibu âœ¨.\n\nSalam hormat,\nKawe Nia ðŸ¤\nAsisten Digital Distrik Wania",
        "options": {
          "systemMessage": "=ðŸ“Œ GAYA BAHASA\nGunakan sapaan sesuai budaya: Bapa / Mama / Saudara / Nona / Ade\nhindari panggilan kami, saya (karena Kawe Nia berbicara sebagai pribadi).\nGunakan kalimat positif, menenangkan, dan penuh empati.\nTambahkan emotikon hangat \nAkhiri dengan ucapan berkat: â€œTuhan memberkatiâ€ \nTambahkan emotikon hangat "
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        2464,
        1744
      ],
      "id": "b3085762-7687-428f-b85b-601180ce0a68",
      "name": "KaweNia-Da2"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Buatkan notif \nHalo {{ $json.pemohon.nama }}, ðŸŒ¸\nMohon maaf, surat yang {{ $json.pemohon.nama }} ajukan  telah ditolak oleh Bapak Kepala {{ $json.pemohon['kelurahan/kampung'] }}.\n\nðŸ“Œ Alasan penolakan: {{ $json.message }}.\n\nSilakan kembali ke web {{ $json.web_user }} \n\ndan lakukan perbaikan sesuai catatan yang diberikan, lalu ajukan kembali suratnya untuk diproses lebih lanjut.\n\nTetap semangat ya {{ $json.pemohon.nama }}, semoga proses berikutnya berjalan lancar.\nTuhan memberkati ðŸ™âœ¨\n\ntolong di modif",
        "options": {
          "systemMessage": "=ðŸ“Œ GAYA BAHASA\nGunakan sapaan sesuai budaya: Bapa / Mama / Saudara / Nona / Ade\nhindari panggilan kami, saya (karena Kawe Nia berbicara sebagai pribadi).\nGunakan kalimat positif, menenangkan, dan penuh empati.\nTambahkan emotikon hangat \nAkhiri dengan ucapan berkat: â€œTuhan memberkatiâ€ \nTambahkan emotikon hangat "
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        2048,
        1744
      ],
      "id": "e66b4503-121b-4e8d-985c-f5c48c8652d2",
      "name": "KaweNia-Da3"
    },
    {
      "parameters": {
        "jsCode": "/**\n * n8n Code Node â€” Bersihkan Payload & Filter Dokumen\n * Mode   : Run Once for All Items\n * Input  : items (bisa object langsung atau array object pada root)\n * Output : [{ json }]\n */\n\nconst out = [];\n\nfor (const item of items) {\n  // --- Ambil & normalisasi input ---\n  let s = item?.json ?? {};\n  // Jika payload datang sebagai array pada root, ambil elemen pertama\n  if (Array.isArray(s)) s = s[0] ?? {};\n  // Jika payload dibungkus di body (beberapa webhook), un-nest\n  if (Array.isArray(s?.body)) s = s.body[0] ?? s;\n  else if (s?.body && typeof s.body === 'object') s = s.body;\n\n  // --- Siapkan set file_id yang akan dihapus ---\n  const delSet = new Set(Array.isArray(s.delete_file_ids) ? s.delete_file_ids : []);\n\n  // --- Filter dokumen: buang yang file_id-nya ada di delete_file_ids ---\n  const filteredDocs = Array.isArray(s.dokumen)\n    ? s.dokumen.filter(d => d && d.file_id && !delSet.has(d.file_id))\n    : [];\n\n  // --- Buang field yang diminta: action, strategy, message, delete_file_ids ---\n  //     Sisakan field lainnya apa adanya.\n  const {\n    action,           // dibuang\n    strategy,         // dibuang\n    message,          // dibuang\n    delete_file_ids,  // dibuang\n    ...rest\n  } = s;\n\n  // --- Susun output akhir ---\n  const cleaned = {\n    ...rest,\n    dokumen: filteredDocs,\n    status_web_admin1: \"terkirim\",\n  };\n\n  out.push({ json: cleaned });\n}\n\nreturn out;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        928,
        1968
      ],
      "id": "45c356a2-27b4-4301-87c6-0754dd3f045e",
      "name": "Dc2"
    },
    {
      "parameters": {
        "operation": "toJson",
        "options": {
          "fileName": "={{ DateTime.now().setZone('Asia/Tokyo').setLocale('id').toFormat('dd_MM_yyyy_HH_mm_ss') + '_' + ($json.pemohon.nama).trim().replace(/\\s+/g,'-').toUpperCase() + '_' + ($json.pemohon.nik) }}\n"
        }
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        1264,
        1968
      ],
      "id": "d02c525e-2e0f-41f6-a95b-c473f7d1d913",
      "name": "Dc3"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://n8n-qz8tp6856ibc.bgxy.sumopod.my.id/webhook/737cd7f5-bfa1-4b9c-b55a-21aa718bfc3d",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$input.all().map(i => i.json)}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1088,
        1968
      ],
      "id": "829d8030-794c-4cd6-abb8-26b51b290a67",
      "name": "Dc4"
    },
    {
      "parameters": {
        "operation": "update",
        "fileId": {
          "__rl": true,
          "value": "={{ $('Dc2').item.json.id_admin1 }}",
          "mode": "id"
        },
        "changeFileContent": true,
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        1424,
        1968
      ],
      "id": "1f834624-984d-4759-a7f7-8f90d6e16b20",
      "name": "Dc5",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "K6YEbjdSQULsuuJd",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1-mini",
          "mode": "list",
          "cachedResultName": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        1632,
        1904
      ],
      "id": "bef16188-f469-40e2-9a82-2620eecb8535",
      "name": "AI-Da1",
      "credentials": {
        "openAiApi": {
          "id": "Qy11fJqEsEUeag8i",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1-mini",
          "mode": "list",
          "cachedResultName": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        2464,
        1904
      ],
      "id": "1aba96e1-b5b7-4012-a0db-e55abf22418a",
      "name": "AI-Da2",
      "credentials": {
        "openAiApi": {
          "id": "Qy11fJqEsEUeag8i",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "operation": "fromJson",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        1056,
        1808
      ],
      "id": "68104e8f-cef3-4f55-a8a6-50080851644e",
      "name": "Da5"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "19251a96-f7ee-46b5-85a1-34739d59ca1a",
              "name": "web_user",
              "value": "={{ $json.data[0].id_surat }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1200,
        1808
      ],
      "id": "1043ac7c-8263-4c7e-8098-89430900f233",
      "name": "Da6"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        1344,
        1760
      ],
      "id": "1b339efd-faca-42ab-97f3-10c27451eacb",
      "name": "Da7",
      "executeOnce": true
    },
    {
      "parameters": {
        "resource": "Chatting",
        "operation": "Send Text",
        "session": "={{ $('Da1').item.json.WAHA_Trigger_session }}",
        "chatId": "={{ $('Da1').item.json.WAHA_Trigger_payload_from_user }}",
        "text": "={{ $json.output }}",
        "requestOptions": {}
      },
      "type": "@devlikeapro/n8n-nodes-waha.WAHA",
      "typeVersion": 202502,
      "position": [
        2304,
        1744
      ],
      "id": "bb3a1573-4d2e-432f-a2ce-028348e919e7",
      "name": "Da8",
      "executeOnce": true,
      "credentials": {
        "wahaApi": {
          "id": "uivlaHVGkUY1vyJT",
          "name": "WAHA account"
        }
      }
    },
    {
      "parameters": {
        "operation": "download",
        "fileId": {
          "__rl": true,
          "value": "={{ $json.id_user }}",
          "mode": "id"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        912,
        1808
      ],
      "id": "a434b1f1-ab14-44f5-9e3f-82da6ede2163",
      "name": "Da4",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "K6YEbjdSQULsuuJd",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1-mini",
          "mode": "list",
          "cachedResultName": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        2048,
        1904
      ],
      "id": "7d52181b-9b22-47c8-8093-b77d12d3a345",
      "name": "AI-Da3",
      "credentials": {
        "openAiApi": {
          "id": "Qy11fJqEsEUeag8i",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "content": "\n# Fungsi Tombol web admin 1",
        "height": 828,
        "width": 2864,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        224,
        1456
      ],
      "typeVersion": 1,
      "id": "56f30f66-3c19-477f-b6e7-aedf93e5e5ef",
      "name": "Sticky Note10"
    }
  ],
  "connections": {
    "C1": {
      "main": [
        [
          {
            "node": "C2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "C2": {
      "main": [
        [
          {
            "node": "C3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "C3": {
      "main": [
        [
          {
            "node": "C4",
            "type": "main",
            "index": 0
          },
          {
            "node": "C5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ca1": {
      "main": [
        [
          {
            "node": "Ca3",
            "type": "main",
            "index": 0
          },
          {
            "node": "Ca2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ca3": {
      "main": [
        [
          {
            "node": "Ca4",
            "type": "main",
            "index": 0
          },
          {
            "node": "Ca5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "KaweNia-Ca1": {
      "main": [
        [
          {
            "node": "Ca6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "KaweNia-Ca2": {
      "main": [
        [
          {
            "node": "Ca7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ca2": {
      "main": [
        [
          {
            "node": "Ca3",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Ca4": {
      "main": [
        [
          {
            "node": "KaweNia-Ca1",
            "type": "main",
            "index": 0
          },
          {
            "node": "KaweNia-Ca2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ca5": {
      "main": [
        [
          {
            "node": "KaweNia-Ca3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "KaweNia-C1": {
      "main": [
        [
          {
            "node": "C6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI-C1": {
      "ai_languageModel": [
        [
          {
            "node": "KaweNia-C1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "KaweNia-C2": {
      "main": [
        [
          {
            "node": "C7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI-C2": {
      "ai_languageModel": [
        [
          {
            "node": "KaweNia-C2",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "C31": {
      "main": [
        [
          {
            "node": "C33",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "C30": {
      "main": [
        [
          {
            "node": "C32",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "C29": {
      "main": [
        [
          {
            "node": "C31",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "C28": {
      "main": [
        [
          {
            "node": "C30",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "C27": {
      "main": [
        [
          {
            "node": "C29",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "C26": {
      "main": [
        [
          {
            "node": "C28",
            "type": "main",
            "index": 0
          },
          {
            "node": "C30",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "C25": {
      "main": [
        [
          {
            "node": "C27",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "C24": {
      "main": [
        [
          {
            "node": "C26",
            "type": "main",
            "index": 0
          },
          {
            "node": "C31",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "C22": {
      "main": [
        [
          {
            "node": "C25",
            "type": "main",
            "index": 0
          },
          {
            "node": "C24",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "C21": {
      "main": [
        [
          {
            "node": "C22",
            "type": "main",
            "index": 1
          },
          {
            "node": "C23",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "C20": {
      "main": [
        [
          {
            "node": "C22",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "C19": {
      "main": [
        [
          {
            "node": "C21",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "C18": {
      "main": [
        [
          {
            "node": "C20",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "C17": {
      "main": [
        [
          {
            "node": "C19",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "C16": {
      "main": [
        [
          {
            "node": "C18",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "C15": {
      "main": [
        [
          {
            "node": "C19",
            "type": "main",
            "index": 0
          },
          {
            "node": "C17",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "C14": {
      "main": [
        [
          {
            "node": "C16",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "C13": {
      "main": [
        [
          {
            "node": "C15",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "C12": {
      "main": [
        [
          {
            "node": "C14",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "C11": {
      "main": [
        [
          {
            "node": "C13",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "C10": {
      "main": [
        [
          {
            "node": "C12",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "C9": {
      "main": [
        [
          {
            "node": "C12",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "C8": {
      "main": [
        [
          {
            "node": "C9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "C5": {
      "main": [
        [
          {
            "node": "C8",
            "type": "main",
            "index": 0
          },
          {
            "node": "C10",
            "type": "main",
            "index": 0
          },
          {
            "node": "C11",
            "type": "main",
            "index": 0
          },
          {
            "node": "C20",
            "type": "main",
            "index": 1
          },
          {
            "node": "C16",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "C4": {
      "main": [
        [
          {
            "node": "KaweNia-C1",
            "type": "main",
            "index": 0
          },
          {
            "node": "KaweNia-C2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI-Ca1": {
      "ai_languageModel": [
        [
          {
            "node": "KaweNia-Ca1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI-Ca2": {
      "ai_languageModel": [
        [
          {
            "node": "KaweNia-Ca2",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "KaweNia-Ca3": {
      "main": [
        [
          {
            "node": "Ca8",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI-Ca3": {
      "ai_languageModel": [
        [
          {
            "node": "KaweNia-Ca3",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "D1": {
      "main": [
        [
          {
            "node": "D2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "D2": {
      "main": [
        [
          {
            "node": "Da1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Db1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Dc1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Da1": {
      "main": [
        [
          {
            "node": "KaweNia-Da2",
            "type": "main",
            "index": 0
          },
          {
            "node": "KaweNia-Da1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Da4",
            "type": "main",
            "index": 0
          },
          {
            "node": "Da7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Db1": {
      "main": [
        [
          {
            "node": "Db2",
            "type": "main",
            "index": 0
          },
          {
            "node": "Db3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Db2": {
      "main": [
        [
          {
            "node": "Db4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Db3": {
      "main": [
        [
          {
            "node": "Db5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Db4": {
      "main": [
        [
          {
            "node": "Db6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Db6": {
      "main": [
        [
          {
            "node": "Db7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Db7": {
      "main": [
        [
          {
            "node": "Db8",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Dc1": {
      "main": [
        [
          {
            "node": "Dc2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "KaweNia-Da1": {
      "main": [
        [
          {
            "node": "Da2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "KaweNia-Da2": {
      "main": [
        [
          {
            "node": "Da3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "KaweNia-Da3": {
      "main": [
        [
          {
            "node": "Da8",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Dc2": {
      "main": [
        [
          {
            "node": "Dc3",
            "type": "main",
            "index": 0
          },
          {
            "node": "Dc4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Dc3": {
      "main": [
        [
          {
            "node": "Dc5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI-Da1": {
      "ai_languageModel": [
        [
          {
            "node": "KaweNia-Da1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI-Da2": {
      "ai_languageModel": [
        [
          {
            "node": "KaweNia-Da2",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Da5": {
      "main": [
        [
          {
            "node": "Da6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Da6": {
      "main": [
        [
          {
            "node": "Da7",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Da7": {
      "main": [
        [
          {
            "node": "KaweNia-Da3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Da4": {
      "main": [
        [
          {
            "node": "Da5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI-Da3": {
      "ai_languageModel": [
        [
          {
            "node": "KaweNia-Da3",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {
    "C1": [
      {
        "json": {
          "headers": {
            "host": "n8n-qz8tp6856ibc.bgxy.sumopod.my.id",
            "user-agent": "axios/1.12.0",
            "content-length": "2253",
            "accept": "application/json,text/html,application/xhtml+xml,application/xml,text/*;q=0.9, image/*;q=0.8, */*;q=0.7",
            "accept-encoding": "gzip, br",
            "cdn-loop": "cloudflare; loops=1",
            "cf-connecting-ip": "8.215.39.173",
            "cf-ipcountry": "ID",
            "cf-ray": "99a7fc213bbaec6e-SIN",
            "cf-visitor": "{\"scheme\":\"https\"}",
            "content-type": "application/json",
            "x-forwarded-for": "8.215.39.173, 162.158.163.195",
            "x-forwarded-host": "n8n-qz8tp6856ibc.bgxy.sumopod.my.id",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "45bc8cdf891c",
            "x-real-ip": "162.158.163.195"
          },
          "params": {},
          "query": {},
          "body": [
            {
              "id_admin1": "1L2eaoI9nV4k6-Xzl2fgjIvCrj6Y71JVA",
              "id_user": "1Za9ySL23oe13Pb--hg5zwXlag3CLPFkZ",
              "id_surat": "https://distrikwania.com/data/1QxoxrpCy9o6dJBgbIbG_NI9rhs6VH_Ji",
              "date": "06 November 2025",
              "from": "Kepala Kampung Nawaripi",
              "dokumen": [
                {
                  "name": "Database Kantor.jpg",
                  "type": "image/jpeg",
                  "file_id": "13jphNuB2ez2ePk8S_Ek-_HN5qapxRxUw",
                  "size": 39057,
                  "view_url": "https://drive.google.com/file/d/13jphNuB2ez2ePk8S_Ek-_HN5qapxRxUw/view?usp=drivesdk",
                  "download_url": "https://drive.google.com/uc?id=13jphNuB2ez2ePk8S_Ek-_HN5qapxRxUw&export=download"
                },
                {
                  "name": "3F8F378F84D85FFB27A0.pdf",
                  "type": "application/pdf",
                  "file_id": "1IBSJ4k74VBsk4r-Nu7gbK9Z32w_GtRCQ",
                  "size": 164266,
                  "view_url": "https://drive.google.com/file/d/1IBSJ4k74VBsk4r-Nu7gbK9Z32w_GtRCQ/view?usp=drivesdk",
                  "download_url": "https://drive.google.com/uc?id=1IBSJ4k74VBsk4r-Nu7gbK9Z32w_GtRCQ&export=download"
                },
                {
                  "name": "3FADB55B9CF3D73E417E.jpeg",
                  "type": "image/jpeg",
                  "file_id": "10AWAXfbyyj1Lyqu4qEPLUFgU2-nj8epg",
                  "size": 137745,
                  "view_url": "https://drive.google.com/file/d/10AWAXfbyyj1Lyqu4qEPLUFgU2-nj8epg/view?usp=drivesdk",
                  "download_url": "https://drive.google.com/uc?id=10AWAXfbyyj1Lyqu4qEPLUFgU2-nj8epg&export=download"
                },
                {
                  "name": "3F935D8B74DFFDEB53AD.jpeg",
                  "type": "image/jpeg",
                  "file_id": "1B_ITKNDW3UTtSe0gMdlDUKEjHFUvEhsn",
                  "size": 88330,
                  "view_url": "https://drive.google.com/file/d/1B_ITKNDW3UTtSe0gMdlDUKEjHFUvEhsn/view?usp=drivesdk",
                  "download_url": "https://drive.google.com/uc?id=1B_ITKNDW3UTtSe0gMdlDUKEjHFUvEhsn&export=download"
                }
              ],
              "pemohon": {
                "nama": "Syafruddin",
                "nik": "9109010708740007",
                "ttl": "Ralla, 07-08-1974",
                "agama": "Islam",
                "jenis_kelamin": "Laki-Laki",
                "status_perkawinan": "Kawin",
                "pekerjaan": "Petani/Pekebun",
                "alamat": "Wania",
                "kelurahan/kampung": "Nawaripi",
                "kecamatan": "Wania",
                "kota_kab": "Mimika",
                "provinsi": "Papua Tengah"
              },
              "WAHA_Trigger_session": "KaweNia",
              "WAHA_Trigger_payload_from_user": "6285230047347@c.us",
              "WAHA_Trigger_payload_from_admin1": "62885230047347@c.us",
              "WAHA_Trigger_payload_from_admin2": "6285230047347@c.us",
              "LogoURL": "https://upload.wikimedia.org/wikipedia/commons/thumb/1/10/Lambang_Kabupaten_Mimika.jpg/500px-Lambang_Kabupaten_Mimika.jpg",
              "webhook": "https://n8n-qz8tp6856ibc.bgxy.sumopod.my.id/webhook/646a0ac9-0b1c-4283-ae20-fe42f0ad4384",
              "status_web_admin1": "terkirim"
            }
          ],
          "webhookUrl": "https://n8n-qz8tp6856ibc.bgxy.sumopod.my.id/webhook/737cd7f5-bfa1-4b9c-b55a-21aa718bfc3d",
          "executionMode": "production"
        }
      }
    ],
    "D1": [
      {
        "json": {
          "headers": {
            "host": "n8n-qz8tp6856ibc.bgxy.sumopod.my.id",
            "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36",
            "content-length": "2512",
            "accept": "*/*",
            "accept-encoding": "gzip, br",
            "accept-language": "id,en-US;q=0.9,en;q=0.8",
            "cdn-loop": "cloudflare; loops=1",
            "cf-connecting-ip": "125.162.247.156",
            "cf-ipcountry": "ID",
            "cf-ray": "99a7fc200fa2fd6d-SIN",
            "cf-visitor": "{\"scheme\":\"https\"}",
            "content-type": "application/json",
            "origin": "https://distrikwania.com",
            "priority": "u=1, i",
            "referer": "https://distrikwania.com/",
            "sec-ch-ua": "\"Chromium\";v=\"142\", \"Google Chrome\";v=\"142\", \"Not_A Brand\";v=\"99\"",
            "sec-ch-ua-mobile": "?0",
            "sec-ch-ua-platform": "\"Windows\"",
            "sec-fetch-dest": "empty",
            "sec-fetch-mode": "cors",
            "sec-fetch-site": "cross-site",
            "x-forwarded-for": "125.162.247.156, 172.70.208.128",
            "x-forwarded-host": "n8n-qz8tp6856ibc.bgxy.sumopod.my.id",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "45bc8cdf891c",
            "x-real-ip": "172.70.208.128"
          },
          "params": {},
          "query": {},
          "body": {
            "action": "CREATE_AND_SEND",
            "id_admin1": "1L2eaoI9nV4k6-Xzl2fgjIvCrj6Y71JVA",
            "id_surat": "https://distrikwania.com/data/1QxoxrpCy9o6dJBgbIbG_NI9rhs6VH_Ji",
            "from": "Kepala Kampung Nawaripi",
            "data": {
              "id_user": "1Za9ySL23oe13Pb--hg5zwXlag3CLPFkZ",
              "id_admin1": "1L2eaoI9nV4k6-Xzl2fgjIvCrj6Y71JVA",
              "id_admin2": "",
              "id_surat": "https://distrikwania.com/data/1QxoxrpCy9o6dJBgbIbG_NI9rhs6VH_Ji",
              "date": "06 November 2025",
              "pemohon": {
                "nama": "Syafruddin",
                "nik": "9109010708740007",
                "ttl": "Ralla, 07-08-1974",
                "agama": "Islam",
                "jenis_kelamin": "Laki-Laki",
                "status_perkawinan": "Kawin",
                "pekerjaan": "Petani/Pekebun",
                "alamat": "Wania",
                "kelurahan/kampung": "Nawaripi",
                "kecamatan": "Wania",
                "kota_kab": "Mimika",
                "provinsi": "Papua Tengah"
              },
              "dokumen": [
                {
                  "label": "Database Kantor.jpg",
                  "name": "Database Kantor.jpg",
                  "file_id": "13jphNuB2ez2ePk8S_Ek-_HN5qapxRxUw",
                  "view_url": "https://drive.google.com/file/d/13jphNuB2ez2ePk8S_Ek-_HN5qapxRxUw/view?usp=drivesdk",
                  "download_url": "https://drive.google.com/uc?id=13jphNuB2ez2ePk8S_Ek-_HN5qapxRxUw&export=download",
                  "size": 39057,
                  "mimeType": null
                },
                {
                  "label": "3F8F378F84D85FFB27A0.pdf",
                  "name": "3F8F378F84D85FFB27A0.pdf",
                  "file_id": "1IBSJ4k74VBsk4r-Nu7gbK9Z32w_GtRCQ",
                  "view_url": "https://drive.google.com/file/d/1IBSJ4k74VBsk4r-Nu7gbK9Z32w_GtRCQ/view?usp=drivesdk",
                  "download_url": "https://drive.google.com/uc?id=1IBSJ4k74VBsk4r-Nu7gbK9Z32w_GtRCQ&export=download",
                  "size": 164266,
                  "mimeType": null
                },
                {
                  "label": "3FADB55B9CF3D73E417E.jpeg",
                  "name": "3FADB55B9CF3D73E417E.jpeg",
                  "file_id": "10AWAXfbyyj1Lyqu4qEPLUFgU2-nj8epg",
                  "view_url": "https://drive.google.com/file/d/10AWAXfbyyj1Lyqu4qEPLUFgU2-nj8epg/view?usp=drivesdk",
                  "download_url": "https://drive.google.com/uc?id=10AWAXfbyyj1Lyqu4qEPLUFgU2-nj8epg&export=download",
                  "size": 137745,
                  "mimeType": null
                },
                {
                  "label": "3F935D8B74DFFDEB53AD.jpeg",
                  "name": "3F935D8B74DFFDEB53AD.jpeg",
                  "file_id": "1B_ITKNDW3UTtSe0gMdlDUKEjHFUvEhsn",
                  "view_url": "https://drive.google.com/file/d/1B_ITKNDW3UTtSe0gMdlDUKEjHFUvEhsn/view?usp=drivesdk",
                  "download_url": "https://drive.google.com/uc?id=1B_ITKNDW3UTtSe0gMdlDUKEjHFUvEhsn&export=download",
                  "size": 88330,
                  "mimeType": null
                }
              ],
              "WAHA_Trigger_session": "KaweNia",
              "LogoURL": "https://upload.wikimedia.org/wikipedia/commons/thumb/1/10/Lambang_Kabupaten_Mimika.jpg/500px-Lambang_Kabupaten_Mimika.jpg",
              "webhook": "https://n8n-qz8tp6856ibc.bgxy.sumopod.my.id/webhook/646a0ac9-0b1c-4283-ae20-fe42f0ad4384",
              "WAHA_Trigger_payload_from_user": "6285230047347@c.us",
              "WAHA_Trigger_payload_from_admin1": "62885230047347@c.us",
              "WAHA_Trigger_payload_from_admin2": "6285230047347@c.us"
            }
          },
          "webhookUrl": "https://n8n-qz8tp6856ibc.bgxy.sumopod.my.id/webhook/646a0ac9-0b1c-4283-ae20-fe42f0ad4384",
          "executionMode": "production"
        }
      }
    ]
  },
  "versionId": "812fabbb-4b94-4b5c-8f01-3118224a3b0c",
  "activeVersionId": null,
  "triggerCount": 0,
  "shared": [
    {
      "updatedAt": "2025-11-08T03:42:00.602Z",
      "createdAt": "2025-11-08T03:42:00.602Z",
      "role": "workflow:owner",
      "workflowId": "Of4owcqlYUvIxQUd",
      "projectId": "MsnmAoT3kpqQYaku"
    }
  ],
  "activeVersion": null,
  "tags": []
}